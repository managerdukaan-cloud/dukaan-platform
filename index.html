<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raashanmart - Online Shopping</title>
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/3082/3082383.png" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging-compat.js"></script>
    <style>
    :root {
    --primary: #0F2C59; --primary-dark: #0A1F3D; --secondary: #FFFFFF; --accent: #3A8EF6; 
    --accent-hover: #2D7AE6; --success: #10B981; --warning: #F59E0B; --danger: #EF4444;
    --neutral: #F8FAFC; --text-dark: #1E293B; --text-light: #64748B; --border: #E2E8F0;
    --shadow: 0 4px 20px rgba(0, 0, 0, 0.08); --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.12);
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Inter', sans-serif; background: var(--neutral); color: var(--text-dark); line-height: 1.6; padding-bottom: 80px; }
.app-header { background: var(--primary); color: white; padding: 12px 0; position: sticky; top: 0; z-index: 1000; }
.header-container { max-width: 1200px; margin: 0 auto; padding: 0 16px; display: flex; align-items: center; justify-content: space-between; gap: 20px; }
.brand { display: flex; align-items: center; gap: 12px; font-weight: 800; font-size: 1.4rem; text-decoration: none; color: white; }
.brand-logo { width: 40px; height: 40px; background: var(--accent); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; }
.search-container { flex: 1; position: relative; margin: 0 20px; max-width: 600px; }
.search-bar { width: 100%; padding: 12px 45px 12px 16px; border-radius: 10px; border: none; font-size: 15px; background: white; box-shadow: var(--shadow); transition: all 0.3s ease; }
.search-bar:focus { outline: none; box-shadow: 0 4px 20px rgba(58, 142, 246, 0.25); }
.search-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--text-light); }
.search-results { position: absolute; top: 100%; left: 0; right: 0; background: white; border-radius: 0 0 10px 10px; box-shadow: var(--shadow-lg); max-height: 300px; overflow-y: auto; z-index: 1001; display: none; }
.search-result-item { padding: 12px 16px; border-bottom: 1px solid var(--border); cursor: pointer; display: flex; align-items: center; gap: 12px; }
.search-result-item:hover { background: var(--neutral); }
.search-result-image { width: 40px; height: 40px; border-radius: 8px; object-fit: cover; }
.search-result-info { flex: 1; }
.search-result-name { font-weight: 600; font-size: 14px; margin-bottom: 2px; }
.search-result-category { font-size: 12px; color: var(--text-light); }
.search-result-price { font-weight: 700; color: var(--accent); font-size: 14px; }
.bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding: 12px 0; z-index: 1000; box-shadow: 0 -2px 20px rgba(0, 0, 0, 0.1); }
.nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; text-decoration: none; color: var(--text-light); transition: all 0.2s; flex: 1; position: relative; }
.nav-item.active { color: var(--accent); }
.nav-icon { font-size: 20px; }
.nav-label { font-size: 12px; font-weight: 500; }
.nav-badge {
    position: absolute;
    top: -5px;
    right: 50px;
    background: var(--accent);
    color: white;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 700;
    min-width: 18px;
    text-align: center;
}
.container-main { max-width: 1200px; margin: 24px auto; padding: 0 16px; }
.hero-banner { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 40px 20px; border-radius: 20px; margin-bottom: 30px; position: relative; overflow: hidden; }
.hero-content { position: relative; z-index: 2; max-width: 600px; }
.hero-badge { display: inline-flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600; margin-bottom: 20px; }
.hero-title { font-size: 2.5rem; font-weight: 800; margin-bottom: 15px; line-height: 1.2; }
.hero-subtitle { font-size: 1.1rem; margin-bottom: 25px; opacity: 0.9; }
.btn-primary { background: var(--accent); color: white; border: none; padding: 12px 30px; border-radius: 10px; font-weight: 600; font-size: 16px; cursor: pointer; transition: all 0.3s ease; }
.btn-primary:hover { background: var(--accent-hover); transform: translateY(-2px); }
.btn-outline { background: transparent; color: var(--accent); border: 2px solid var(--accent); padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
.btn-outline:hover { background: var(--accent); color: white; }
.hero-pattern { position: absolute; top: 0; right: 0; bottom: 0; width: 50%; background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" fill="rgba(255,255,255,0.05)"><circle cx="20" cy="20" r="5"/><circle cx="50" cy="50" r="8"/><circle cx="80" cy="80" r="5"/></svg>'); }
.orders-page { display: none; }
.wishlist-page { display: none; }
.product-detail-page { display: none; }
.order-card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: var(--shadow); border: 1px solid var(--border); }
.wishlist-card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: var(--shadow); border: 1px solid var(--border); display: flex; gap: 15px; align-items: center; }
.wishlist-image { width: 80px; height: 80px; border-radius: 8px; object-fit: cover; }
.wishlist-info { flex: 1; }
.wishlist-actions { display: flex; gap: 10px; }
.order-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--border); }
.order-id { font-weight: 700; color: var(--text-dark); }
.order-status { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
.status-delivered { background: var(--success); color: white; }
.status-pending { background: var(--warning); color: white; }
.status-cancelled { background: var(--danger); color: white; }
.status-preparing { background: var(--accent); color: white; }
.status-dispatched { background: #8B5CF6; color: white; }
.status-packed { background: #7C3AED; color: white; }
.status-ready-for-pickup { background: #10B981; color: white; }
.status-out-for-delivery { background: #3A8EF6; color: white; }
.order-items { margin-bottom: 12px; }
.order-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; }
.order-footer { display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 1px solid var(--border); }
.order-total { font-weight: 700; font-size: 16px; color: var(--text-dark); }
.btn-reorder { background: var(--accent); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; }
.product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; }
.product-card { background: white; border-radius: 16px; padding: 16px; box-shadow: var(--shadow); transition: all 0.3s ease; border: 1px solid var(--border); display: flex; flex-direction: column; height: 100%; position: relative; overflow: hidden; }
.product-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); }
.product-badge { position: absolute; top: 12px; left: 12px; background: var(--success); color: white; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; }
.wishlist-btn { position: absolute; top: 12px; right: 12px; background: rgba(255,255,255,0.9); border: none; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; color: var(--text-light); }
.wishlist-btn:hover { background: white; transform: scale(1.1); }
.wishlist-btn.active { background: var(--danger); color: white; }
.product-image { height: 160px; border-radius: 12px; object-fit: cover; width: 100%; background: var(--neutral); margin-bottom: 12px; cursor: pointer; }
.product-title { font-weight: 700; font-size: 16px; margin-bottom: 6px; color: var(--text-dark); cursor: pointer; }
.product-category { font-size: 13px; color: var(--text-light); margin-bottom: 10px; }
.product-price { display: flex; align-items: center; gap: 8px; margin-top: auto; }
.current-price { font-weight: 800; font-size: 18px; color: var(--accent); }
.original-price { color: var(--text-light); text-decoration: line-through; font-size: 14px; }
.discount { color: var(--success); font-size: 13px; font-weight: 600; }
.card-actions { display: flex; justify-content: center; margin-top: 15px; }
/* ✅ FIXED QUANTITY COUNTER BUTTON */
.btn-quantity-card {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    background: var(--accent);
    color: white !important;
    border: none;
    padding: 10px 16px;
    border-radius: 10px;
    font-weight: 600;
    width: 100%;
    transition: all 0.2s;
}
.btn-quantity-card:hover {
    background: var(--accent-hover);
    transform: scale(1.02);
}
.quantity-btn-card {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    color: white;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}
.quantity-btn-card:hover {
    background: rgba(255, 255, 255, 0.3);
}
.quantity-value-card {
    font-weight: 700;
    min-width: 24px;
    text-align: center;
    font-size: 15px;
    color: white;
}
/* ✅ FIXED ADD TO CART BUTTON */
.btn-add-cart {
    background: var(--accent);
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 10px;
    font-weight: 600;
    width: 100%;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    white-space: nowrap;
    font-size: 14px;
}
.btn-add-cart:hover {
    background: var(--accent-hover);
    transform: scale(1.02);
}
.shop-badge { position: absolute; top: 12px; right: 55px; background: var(--primary); color: white; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 600; }
.bottom-sheet { position: fixed; left: 0; right: 0; bottom: 0; background: white; border-top-left-radius: 20px; border-top-right-radius: 20px; box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.15); transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.22, 1, 0.36, 1); z-index: 1001; max-height: 85vh; overflow: auto; }
.bottom-sheet.open { transform: translateY(0); }
.sheet-handle { width: 60px; height: 5px; background: #E2E8F0; border-radius: 99px; margin: 12px auto; display: block; }
.sheet-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
.sheet-title { font-weight: 700; font-size: 1.3rem; color: var(--text-dark); }
.sheet-close { background: none; border: none; font-size: 24px; color: var(--text-light); cursor: pointer; }
.sheet-body { padding: 20px; }
.coupon-section { margin: 20px 0; padding: 15px; background: var(--neutral); border-radius: 12px; border: 1px solid var(--border); }
.coupon-input-group { display: flex; gap: 10px; margin-bottom: 10px; }
.coupon-input { flex: 1; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; }
.btn-apply-coupon { background: var(--accent); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; }
.btn-apply-coupon:disabled { background: var(--text-light); cursor: not-allowed; }
.coupon-login-required { color: var(--warning); font-size: 14px; margin-top: 8px; text-align: center; }
.coupon-success { color: var(--success); font-size: 14px; font-weight: 600; margin-top: 8px; }
.coupon-error { color: var(--danger); font-size: 14px; margin-top: 8px; }
.phone-valid { border-color: var(--success) !important; }
.phone-invalid { border-color: var(--danger) !important; }
.validation-message { font-size: 12px; margin-top: 4px; }
.validation-success { color: var(--success); }
.validation-error { color: var(--danger); }
.order-item-summary { display: flex; justify-content: space-between; align-items: flex-start; padding: 12px 0; border-bottom: 1px solid var(--border); }
.order-item-shop-name {
    font-size: 12px;
    color: var(--text-light);
    margin-top: 4px;
    display: flex;
    align-items: center;
    gap: 4px;
}
.order-item-shop-name i {
    font-size: 10px;
}
.discount-row { display: flex; justify-content: space-between; padding: 8px 0; color: var(--success); font-weight: 600; }
.order-total-summary { display: flex; justify-content: space-between; padding: 15px 0; margin-top: 10px; border-top: 2px solid var(--border); font-weight: 800; font-size: 18px; }
.payment-methods { margin: 20px 0; }
.payment-option { display: flex; align-items: center; gap: 12px; padding: 15px; border: 2px solid var(--border); border-radius: 10px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s ease; }
.payment-option.selected { border-color: var(--accent); background: rgba(58, 142, 246, 0.05); }
.payment-icon { width: 40px; height: 40px; background: var(--neutral); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
.payment-info { flex: 1; }
.payment-title { font-weight: 600; margin-bottom: 4px; }
.payment-desc { font-size: 12px; color: var(--text-light); }
.qr-modal { text-align: center; padding: 20px; position: relative; }
.qr-code { width: 100%; max-width: 280px; margin: 20px auto; padding: 20px; background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 2px solid #f1f3f4; }
.qr-code-content { display: flex; flex-direction: column; align-items: center; gap: 15px; }
.qr-image-container { width: 200px; height: 200px; border-radius: 12px; overflow: hidden; border: 2px solid #34A853; background: white; }
.qr-image-container img { width: 100%; height: 100%; object-fit: contain; }
.upi-details { background: #f8f9fa; padding: 12px; border-radius: 10px; width: 100%; text-align: center; }
.utr-input { margin: 15px 0; }
.utr-input .form-control { margin-top: 8px; }
.empty-state { text-align: center; padding: 40px 20px; }
.empty-icon { font-size: 60px; color: var(--border); margin-bottom: 15px; }
.empty-text { color: var(--text-light); font-size: 16px; }
.auth-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); padding: 20px; }
.auth-card { background: white; border-radius: 20px; padding: 40px; box-shadow: var(--shadow-lg); width: 100%; max-width: 450px; }
.auth-header { text-align: center; margin-bottom: 30px; }
.auth-logo { width: 60px; height: 60px; background: var(--accent); border-radius: 15px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.5rem; color: white; margin: 0 auto 15px; }
.auth-title { font-size: 1.8rem; font-weight: 700; color: var(--text-dark); margin-bottom: 8px; }
.auth-subtitle { color: var(--text-light); font-size: 1rem; }
.form-group { margin-bottom: 20px; }
.form-label { font-weight: 600; margin-bottom: 8px; color: var(--text-dark); display: block; }
.form-control { width: 100%; padding: 12px 16px; border: 1px solid var(--border); border-radius: 10px; font-size: 15px; transition: all 0.2s; }
.form-control:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(58, 142, 246, 0.1); }
.auth-footer { text-align: center; margin-top: 25px; color: var(--text-light); }
.auth-link { color: var(--accent); text-decoration: none; font-weight: 600; }
.auth-link:hover { text-decoration: underline; }
.address-grid { display: grid; gap: 12px; margin-bottom: 15px; }
.address-card { padding: 15px; border: 2px solid var(--border); border-radius: 10px; cursor: pointer; transition: all 0.3s ease; }
.address-card.selected { border-color: var(--accent); background: rgba(58, 142, 246, 0.05); }
.address-title { font-weight: 600; margin-bottom: 5px; }
.address-details { color: var(--text-light); font-size: 14px; margin-bottom: 5px; }
.address-phone { font-size: 12px; color: var(--text-light); }
.address-form { background: var(--neutral); padding: 20px; border-radius: 12px; margin-top: 15px; }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
.order-timeline {
    display: flex;
    justify-content: space-between;
    position: relative;
    margin: 20px 0;
    padding: 0 10px;
}
.order-timeline::before {
    content: '';
    position: absolute;
    top: 15px;
    left: 5%;
    right: 5%;
    height: 3px;
    background: var(--border);
    z-index: 1;
}
.timeline-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    z-index: 2;
    flex: 1;
}
.step-icon {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    background: var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 8px;
    transition: all 0.3s ease;
}
.step-icon.active {
    background: var(--accent);
    color: white;
}
.step-icon.completed {
    background: var(--success);
    color: white;
}
.step-label {
    font-size: 11px;
    text-align: center;
    color: var(--text-light);
    font-weight: 500;
    line-height: 1.2;
}
.step-label.active {
    color: var(--accent);
    font-weight: 600;
}
.step-label.completed {
    color: var(--success);
    font-weight: 600;
}
.step-time {
    font-size: 9px;
    color: var(--text-light);
    margin-top: 2px;
    text-align: center;
    line-height: 1.2;
}
.product-detail-container {
    background: white;
    border-radius: 20px;
    padding: 0;
    overflow: hidden;
    box-shadow: var(--shadow);
    margin-bottom: 30px;
}
.product-detail-image {
    width: 100%;
    height: 400px;
    object-fit: cover;
}
.product-detail-content {
    padding: 30px;
}
.product-detail-header {
    margin-bottom: 20px;
    border-bottom: 1px solid var(--border);
    padding-bottom: 20px;
}
.product-detail-title {
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: 10px;
}
.product-detail-category {
    color: var(--text-light);
    font-size: 1rem;
    margin-bottom: 15px;
}
.product-detail-price {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
}
.product-detail-current {
    font-size: 2rem;
    font-weight: 800;
    color: var(--accent);
}
.product-detail-original {
    font-size: 1.5rem;
    color: var(--text-light);
    text-decoration: line-through;
}
.product-detail-discount {
    background: var(--success);
    color: white;
    padding: 5px 12px;
    border-radius: 20px;
    font-weight: 600;
}
.product-detail-actions {
    display: flex;
    gap: 15px;
    margin-bottom: 30px;
    align-items: center;
}
.btn-quantity {
    display: flex;
    align-items: center;
    gap: 15px;
    background: var(--neutral);
    padding: 10px 15px;
    border-radius: 10px;
}
.quantity-btn {
    background: none;
    border: none;
    font-size: 1.2rem;
    cursor: pointer;
    color: var(--accent);
}
.quantity-value {
    font-weight: 600;
    min-width: 30px;
    text-align: center;
}
.specifications-section {
    background: white;
    border-radius: 15px;
    padding: 25px;
    margin-top: 20px;
    box-shadow: var(--shadow);
}
.specs-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 15px;
    margin-top: 15px;
}
.spec-item {
    display: flex;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px dashed var(--border);
}
.spec-label {
    color: var(--text-light);
    font-weight: 500;
}
.spec-value {
    font-weight: 600;
    color: var(--text-dark);
}
.return-policy-section {
    background: var(--neutral);
    border-radius: 15px;
    padding: 25px;
    margin-top: 20px;
    border-left: 4px solid var(--accent);
}
.return-policy-list {
    list-style: none;
    padding: 0;
    margin: 15px 0 0 0;
}
.return-policy-list li {
    padding: 8px 0;
    color: var(--text-light);
    display: flex;
    align-items: flex-start;
    gap: 10px;
}
.return-policy-list li i {
    color: var(--success);
    margin-top: 3px;
}
.reviews-section {
    margin-top: 40px;
    padding: 30px;
    background: white;
    border-radius: 20px;
    box-shadow: var(--shadow);
}
.rating-summary {
    display: flex;
    align-items: center;
    gap: 40px;
    margin-bottom: 30px;
    padding-bottom: 30px;
    border-bottom: 2px solid var(--border);
}
.average-rating {
    text-align: center;
}
.rating-stars {
    display: flex;
    gap: 2px;
    margin-bottom: 10px;
    justify-content: center;
}
.rating-star {
    color: #ddd;
    font-size: 24px;
}
.rating-star.filled {
    color: #FFB800;
}
.rating-value {
    font-size: 3rem;
    font-weight: 700;
    color: var(--text-dark);
    line-height: 1;
}
.rating-count {
    color: var(--text-light);
    font-size: 16px;
}
.rating-distribution {
    flex: 1;
}
.rating-bar {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 12px;
}
.bar-label {
    width: 80px;
    font-size: 14px;
    color: var(--text-light);
}
.bar-container {
    flex: 1;
    height: 10px;
    background: #f0f0f0;
    border-radius: 5px;
    overflow: hidden;
}
.bar-fill {
    height: 100%;
    background: #FFB800;
    border-radius: 5px;
    transition: width 0.3s ease;
}
.bar-count {
    width: 40px;
    text-align: right;
    font-size: 14px;
    color: var(--text-light);
}
.reviews-list {
    margin-bottom: 30px;
}
.review-card {
    padding: 20px;
    border: 1px solid var(--border);
    border-radius: 12px;
    margin-bottom: 20px;
    background: var(--neutral);
}
.review-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 15px;
}
.review-user {
    display: flex;
    align-items: center;
    gap: 12px;
}
.user-avatar {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background: var(--accent);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 18px;
}
.user-info h5 {
    margin: 0;
    font-size: 16px;
    margin-bottom: 5px;
}
.verified-badge {
    background: var(--success);
    color: white;
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
}
.review-rating {
    display: flex;
    gap: 2px;
}
.review-star {
    color: #FFB800;
    font-size: 16px;
}
.review-date {
    color: var(--text-light);
    font-size: 14px;
}
.review-content {
    color: var(--text-dark);
    line-height: 1.6;
    font-size: 15px;
}
.review-form-section {
    background: white;
    padding: 25px;
    border-radius: 15px;
    border: 2px solid var(--border);
}
.review-form-title {
    font-size: 1.3rem;
    font-weight: 600;
    margin-bottom: 20px;
    color: var(--text-dark);
}
.star-rating-input {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
}
.star-input {
    background: none;
    border: none;
    font-size: 28px;
    color: #ddd;
    cursor: pointer;
    transition: all 0.2s;
    padding: 5px;
}
.star-input:hover,
.star-input.active {
    color: #FFB800;
    transform: scale(1.1);
}
.review-textarea {
    width: 100%;
    padding: 15px;
    border: 1px solid var(--border);
    border-radius: 10px;
    font-size: 15px;
    resize: vertical;
    min-height: 120px;
    margin-bottom: 15px;
    transition: all 0.2s;
}
.review-textarea:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(58, 142, 246, 0.1);
}
.review-requirements {
    background: var(--neutral);
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
}
.requirements-title {
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--text-dark);
}
.requirements-list {
    list-style: none;
    padding: 0;
    margin: 0;
}
.requirements-list li {
    padding: 5px 0;
    color: var(--text-light);
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
}
.requirements-list li i {
    color: var(--success);
    font-size: 12px;
}
.no-reviews {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-light);
}
.no-reviews-icon {
    font-size: 60px;
    margin-bottom: 15px;
    color: var(--border);
}
.profile-page { display: none; }
.profile-header { 
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    padding: 30px 20px;
    text-align: center;
    border-radius: 20px;
    margin-bottom: 30px;
    position: relative;
}
.profile-avatar {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    background: var(--accent);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 15px;
    font-size: 2.5rem;
    font-weight: bold;
    color: white;
    border: 4px solid white;
    position: relative;
    overflow: hidden;
}
.profile-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}
.avatar-upload {
    position: absolute;
    bottom: 5px;
    right: 5px;
    background: var(--accent);
    border: 2px solid white;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: white;
    font-size: 14px;
}
.profile-name {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 5px;
}
.profile-email {
    opacity: 0.9;
    font-size: 1rem;
}
.profile-section {
    background: white;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: var(--shadow);
}
.section-title {
    font-size: 1.2rem;
    font-weight: 700;
    margin-bottom: 20px;
    color: var(--text-dark);
    display: flex;
    align-items: center;
    gap: 10px;
}
.profile-menu {
    list-style: none;
    padding: 0;
    margin: 0;
}
.profile-menu-item {
    padding: 15px 0;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    transition: all 0.3s ease;
}
.profile-menu-item:last-child {
    border-bottom: none;
}
.profile-menu-item:hover {
    background: var(--neutral);
    margin: 0 -20px;
    padding: 15px 20px;
}
.menu-item-content {
    display: flex;
    align-items: center;
    gap: 15px;
    flex: 1;
}
.menu-item-icon {
    width: 40px;
    height: 40px;
    background: var(--neutral);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--accent);
    font-size: 1.2rem;
}
.menu-item-text {
    flex: 1;
}
.menu-item-title {
    font-weight: 600;
    margin-bottom: 4px;
    color: var(--text-dark);
}
.menu-item-desc {
    font-size: 0.9rem;
    color: var(--text-light);
}
.menu-item-arrow {
    color: var(--text-light);
}
.security-badge {
    background: var(--success);
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
}
.login-session {
    padding: 15px;
    border: 1px solid var(--border);
    border-radius: 10px;
    margin-bottom: 10px;
    background: var(--neutral);
}
.session-active {
    border-left: 4px solid var(--success);
}
.session-inactive {
    border-left: 4px solid var(--text-light);
}
.preference-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 0;
    border-bottom: 1px solid var(--border);
}
.preference-item:last-child {
    border-bottom: none;
}
.preference-info {
    flex: 1;
}
.preference-title {
    font-weight: 600;
    margin-bottom: 4px;
}
.preference-desc {
    font-size: 0.9rem;
    color: var(--text-light);
}
.switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
}
.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}
.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 24px;
}
.slider:before {
    position: absolute;
    content: "";
    height: 16px;
    width: 16px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}
input:checked + .slider {
    background-color: var(--accent);
}
input:checked + .slider:before {
    transform: translateX(26px);
}
.search-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 9998;
    display: none;
}
.search-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: white;
    z-index: 9999;
    border-radius: 0 0 20px 20px;
    box-shadow: var(--shadow-lg);
    display: none;
}
.search-modal-header {
    padding: 15px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 15px;
}
.search-modal-input {
    flex: 1;
    padding: 12px 16px;
    border: 1px solid var(--border);
    border-radius: 10px;
    font-size: 16px;
    outline: none;
}
.search-modal-input:focus {
    border-color: var(--accent);
}
.search-modal-close {
    background: none;
    border: none;
    font-size: 1.2rem;
    color: var(--text-light);
    cursor: pointer;
}
.search-modal-body {
    max-height: 60vh;
    overflow-y: auto;
    padding: 20px;
}
.search-section {
    margin-bottom: 25px;
}
.search-section-title {
    font-weight: 600;
    margin-bottom: 15px;
    color: var(--text-dark);
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.clear-recent {
    background: none;
    border: none;
    color: var(--accent);
    font-size: 0.9rem;
    cursor: pointer;
}
.recent-searches {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}
.recent-search-item {
    background: var(--neutral);
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 1px solid var(--border);
}
.recent-search-item:hover {
    background: var(--accent);
    color: white;
}
.popular-searches {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
}
.popular-search-item {
    background: white;
    padding: 12px;
    border: 1px solid var(--border);
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
}
.popular-search-item:hover {
    border-color: var(--accent);
    transform: translateY(-2px);
}
.search-suggestions {
    list-style: none;
    padding: 0;
    margin: 0;
}
.search-suggestion-item {
    padding: 12px 0;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
}
.search-suggestion-item:last-child {
    border-bottom: none;
}
.search-suggestion-item:hover {
    background: var(--neutral);
    margin: 0 -20px;
    padding: 12px 20px;
}
.suggestion-icon {
    color: var(--text-light);
    font-size: 1rem;
}
.advanced-filters {
    background: white;
    border-radius: 15px;
    padding: 20px;
    margin-top: 15px;
    box-shadow: var(--shadow);
}
.filter-group {
    margin-bottom: 20px;
}
.filter-title {
    font-weight: 600;
    margin-bottom: 12px;
    color: var(--text-dark);
}
.price-range {
    padding: 0 10px;
}
.price-inputs {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}
.price-input {
    flex: 1;
    padding: 8px 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
}
.rating-filters {
    display: flex;
    flex-direction: column;
    gap: 8px;
}
.rating-filter-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 0;
    cursor: pointer;
}
.rating-stars-small {
    display: flex;
    gap: 2px;
}
.rating-star-small {
    color: #FFB800;
    font-size: 14px;
}
.shop-filters {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
}
.shop-filter-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px;
    border: 1px solid var(--border);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}
.shop-filter-item:hover {
    border-color: var(--accent);
}
.shop-filter-item.selected {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
}
.filter-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}
.sorting-options {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
    align-items: center;
}
.sort-label {
    font-weight: 600;
    color: var(--text-dark);
    white-space: nowrap;
}
.sort-select {
    padding: 10px 16px;
    border: 2px solid var(--border);
    border-radius: 10px;
    background: white;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    min-width: 160px;
}
.sort-select:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(58, 142, 246, 0.1);
}
.sort-select:hover {
    border-color: var(--accent);
}
.sort-badges {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}
.sort-badge {
    padding: 8px 16px;
    background: var(--neutral);
    border: 2px solid var(--border);
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    white-space: nowrap;
}
.sort-badge:hover {
    border-color: var(--accent);
    transform: translateY(-2px);
}
.sort-badge.active {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
}
.order-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}
.order-actions button {
    font-size: 12px;
    padding: 6px 12px;
}
.delivery-agent-info {
    border-left: 4px solid var(--accent);
}
.eta-section {
    border-left: 4px solid var(--success);
}
.order-tracking-details p {
    margin-bottom: 8px;
}
.notifications-page { display: none; }
.notification-item { 
    padding: 15px; 
    border-bottom: 1px solid var(--border);
    display: flex;
    gap: 12px;
}
.notification-unread { background: rgba(58, 142, 246, 0.05); }
.quantity-cart-container {
    display: flex;
    gap: 15px;
    align-items: center;
    width: 100%;
}
.btn-add-cart-detail {
    flex: 1;
    min-width: 200px;
}
.product-detail-actions {
    display: flex;
    gap: 15px;
    align-items: center;
    flex-wrap: wrap;
}
#hamburgerMenu .nav-badge {
    display: none !important;
}
.quantity-cart-container {
    display: flex;
    gap: 15px;
    align-items: center;
    flex: 1;
}
.btn-quantity {
    display: flex;
    align-items: center;
    gap: 15px;
    background: var(--neutral);
    padding: 10px 15px;
    border-radius: 10px;
    border: 1px solid var(--border);
}
.product-detail-actions {
    display: flex;
    gap: 15px;
    align-items: center;
    width: 100%;
}
.btn-add-cart-detail {
    flex: 1;
    min-width: 160px;
}
.quantity-cart-container {
    display: flex;
    align-items: center;
    gap: 15px;
    width: 100%;
}
.btn-quantity {
    display: flex;
    align-items: center;
    gap: 10px;
    background: var(--neutral);
    padding: 10px 15px;
    border-radius: 10px;
    border: 1px solid var(--border);
}
.btn-add-cart-detail {
    flex: 1;
}
.product-detail-actions {
    display: flex;
    align-items: center;
    gap: 15px;
}
#hamburgerMenu .nav-badge {
    display: none !important;
}
.bottom-nav .nav-item {
    position: relative;
}
.bottom-nav .nav-badge {
    position: absolute;
    top: -6px;
    left: 50%;
    right: auto;
    transform: translateX(4px);
    background: var(--accent);
    color: white;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 700;
    min-width: 18px;
    text-align: center;
}
.product-detail-actions {
    display: flex;
    align-items: center;
    gap: 15px;
}
.quantity-cart-container {
    display: flex;
    align-items: center;
    gap: 15px;
    flex: 1;
}
#hamburgerWishlistCount {
    display: none !important;
}
#bottomCartCount { background: red !important; }
#hamburgerWishlistCount { background: blue !important; }
#hamburgerWishlistCount {
    display: none !important;
}
#hamburgerMenu .nav-badge {
    display: none !important;
}
.quantity-cart-container {
    display: flex !important;
    flex-direction: row !important;
    align-items: center !important;
    gap: 15px !important;
    width: 100% !important;
}
.btn-quantity {
    display: flex !important;
    flex-direction: row !important;
    align-items: center !important;
    gap: 10px !important;
    white-space: nowrap !important;
}
#hamburgerMenu .nav-badge,
.nav-item[onclick*="openHamburgerMenu"] .nav-badge {
    display: none !important;
}
.nav-item[data-page] .nav-badge {
    display: block;
}
.delivery-options {
    margin: 10px 0;
}
.delivery-option {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 15px;
    border: 2px solid var(--border);
    border-radius: 10px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
}
.delivery-option.selected {
    border-color: var(--accent);
    background: rgba(58, 142, 246, 0.05);
}
.delivery-option:hover {
    border-color: var(--accent);
}
.btn-outline:hover {
    background: var(--accent);
    color: white;
}
.share-options-modal {
    background: white;
    padding: 20px;
    border-radius: 15px;
    box-shadow: var(--shadow-lg);
    max-width: 300px;
    margin: 20px auto;
}
.share-buttons {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}
.btn-share {
    flex: 1;
    padding: 10px;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}
.btn-share.whatsapp {
    background: #25D366;
    color: white;
}
.btn-share.copy {
    background: var(--accent);
    color: white;
}
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
}
.modal-overlay.active {
    display: flex;
}
.modal-content {
    background: white;
    border-radius: 20px;
    padding: 30px;
    width: 100%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.12);
    position: relative;
}
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--border);
}
.modal-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-dark);
}
.modal-close {
    background: none;
    border: none;
    font-size: 24px;
    color: var(--text-light);
    cursor: pointer;
}
.modal-body {
    margin-bottom: 20px;
}
.modal-footer {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    padding-top: 20px;
    border-top: 1px solid var(--border);
}
.orders-count-badge {
    position: absolute;
    top: -8px;
    right: 10px;
    background: var(--danger);
    color: white;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 700;
    min-width: 18px;
    text-align: center;
}
.status-preparing { background: #F59E0B; color: white; }
.status-dispatched { background: #8B5CF6; color: white; }
.status-packed { background: #7C3AED; color: white; }
.status-ready-for-pickup { background: #10B981; color: white; }
.status-out-for-delivery { background: #3A8EF6; color: white; }
.order-update-notification {
    position: fixed;
    top: 70px;
    right: 20px;
    background: var(--success);
    color: white;
    padding: 12px 20px;
    border-radius: 10px;
    box-shadow: var(--shadow-lg);
    z-index: 9999;
    display: none;
    animation: slideIn 0.3s ease;
}
@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
.refund-notification {
    position: fixed;
    top: 80px;
    right: 20px;
    background: linear-gradient(135deg, #10B981, #059669);
    color: white;
    padding: 15px 20px;
    border-radius: 10px;
    box-shadow: var(--shadow-lg);
    z-index: 9999;
    max-width: 300px;
    animation: slideIn 0.3s ease;
}
.refund-message {
    background: linear-gradient(135deg, #FEF3C7, #FDE68A);
    padding: 10px 15px;
    border-radius: 8px;
    margin: 10px 0;
    border-left: 4px solid #F59E0B;
}
.refund-status-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    margin-left: 10px;
}
.refund-pending {
    background: #FEF3C7;
    color: #92400E;
}
.refund-processing {
    background: #DBEAFE;
    color: #1E40AF;
}
.refund-completed {
    background: #D1FAE5;
    color: #065F46;
}
.offline-notification {
    position: fixed;
    top: 60px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--danger);
    color: white;
    padding: 12px 24px;
    border-radius: 10px;
    box-shadow: var(--shadow-lg);
    z-index: 9999;
    display: none;
    animation: slideDown 0.3s ease;
    text-align: center;
    max-width: 90%;
}
.online-notification {
    position: fixed;
    top: 60px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--success);
    color: white;
    padding: 12px 24px;
    border-radius: 10px;
    box-shadow: var(--shadow-lg);
    z-index: 9999;
    display: none;
    animation: slideDown 0.3s ease;
    text-align: center;
    max-width: 90%;
}
@keyframes slideDown {
    from { transform: translate(-50%, -100%); opacity: 0; }
    to { transform: translate(-50%, 0); opacity: 1; }
}
.offline-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 10000;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
}
.offline-content {
    background: white;
    border-radius: 20px;
    padding: 30px;
    max-width: 400px;
    width: 100%;
    text-align: center;
    box-shadow: var(--shadow-lg);
}
.offline-icon {
    font-size: 60px;
    color: var(--danger);
    margin-bottom: 20px;
}
.offline-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-dark);
    margin-bottom: 10px;
}
.offline-message {
    color: var(--text-light);
    margin-bottom: 20px;
    line-height: 1.6;
}
.reload-button {
    background: var(--accent);
    color: white;
    border: none;
    padding: 12px 30px;
    border-radius: 10px;
    font-weight: 600;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 10px;
}
.reload-button:hover {
    background: var(--accent-hover);
    transform: translateY(-2px);
}
@media (max-width: 768px) {
    .product-grid {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 12px !important;
        padding: 0 8px !important;
    }
    .product-card {
        padding: 12px !important;
        border-radius: 12px !important;
        min-height: 280px !important;
        display: flex !important;
        flex-direction: column !important;
    }
    .product-image {
        height: 120px !important;
        border-radius: 8px !important;
        margin-bottom: 8px !important;
    }
    .product-title {
        font-size: 14px !important;
        line-height: 1.3 !important;
        margin-bottom: 4px !important;
        display: -webkit-box !important;
        -webkit-line-clamp: 2 !important;
        -webkit-box-orient: vertical !important;
        overflow: hidden !important;
    }
    .product-category {
        font-size: 11px !important;
        margin-bottom: 8px !important;
    }
    .product-price {
        margin-top: auto !important;
        padding-top: 8px !important;
    }
    .current-price {
        font-size: 16px !important;
    }
    .original-price {
        font-size: 12px !important;
    }
    .discount {
        font-size: 11px !important;
    }
    .btn-add-cart {
        padding: 8px 12px !important;
        font-size: 12px !important;
        border-radius: 8px !important;
    }
    .product-badge {
        font-size: 10px !important;
        padding: 3px 8px !important;
        top: 8px !important;
        left: 8px !important;
    }
    .shop-badge {
        font-size: 9px !important;
        padding: 2px 6px !important;
        top: 8px !important;
        right: 8px !important;
    }
    .wishlist-btn {
        position: absolute !important;
        bottom: 60px !important;
        right: 12px !important;
        top: auto !important;
        width: 32px !important;
        height: 32px !important;
        background: rgba(255,255,255,0.9) !important;
        border: none !important;
        border-radius: 50% !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        cursor: pointer !important;
        transition: all 0.3s ease !important;
        color: var(--text-light) !important;
        z-index: 3 !important;
    }
    .wishlist-btn:hover {
        background: white !important;
        transform: scale(1.1) !important;
    }
    .wishlist-btn.active {
        background: var(--danger) !important;
        color: white !important;
    }
    @media (max-width: 768px) {
        .wishlist-btn {
            bottom: 50px !important;
            right: 8px !important;
            width: 28px !important;
            height: 28px !important;
        }
    }
    .header-container { 
        flex-direction: column; 
        gap: 12px; 
        position: relative;
    }
    .search-container { 
        margin: 0 auto; 
        width: 100%; 
        max-width: 500px;
    }
    .container-main {
        margin: 16px auto !important;
        padding: 0 8px !important;
    }
    .container-main {
        margin: 16px auto !important;
        padding: 0 8px !important;
    }
    .hero-banner {
        padding: 20px 16px !important;
        margin-bottom: 20px !important;
        border-radius: 16px !important;
    }
    .hero-content { 
        max-width: 100%; 
    }
    .hero-title { 
        font-size: 1.5rem !important;
        margin-bottom: 10px !important;
    }
    .hero-subtitle {
        font-size: 0.9rem !important;
        margin-bottom: 15px !important;
    }
    .filter-section > div {
        flex-direction: column !important;
        gap: 12px !important;
    }
    .filter-section .d-flex {
        width: 100% !important;
        justify-content: space-between !important;
        margin-bottom: 15px !important;
    }
    .category-filter {
        flex: 1 !important;
        margin: 0 4px !important;
    }
    .sorting-options {
        width: 100% !important;
        justify-content: space-between !important;
    }
    .sort-select {
        min-width: 140px !important;
    }
    .auth-card { 
        padding: 30px 25px; 
    }
    .form-row { 
        grid-template-columns: 1fr; 
    }
    .wishlist-card { 
        flex-direction: column; 
        text-align: center; 
    }
    .wishlist-actions { 
        justify-content: center; 
    }
    .rating-summary { 
        flex-direction: column; 
        gap: 20px; 
        text-align: center; 
    }
    .product-detail-actions { 
        flex-direction: column; 
    }
    .product-detail-image { 
        height: 300px; 
    }
    .order-actions {
        justify-content: center;
    }
    .order-actions button {
        flex: 1;
        min-width: 80px;
    }
    .search-modal-body {
        max-height: 70vh;
    }
    .popular-searches {
        grid-template-columns: 1fr;
    }
    .shop-filters {
        grid-template-columns: 1fr;
    }
    .recent-searches {
        flex-direction: column;
    }
    .recent-search-item {
        text-align: center;
    }
    .order-timeline {
        padding: 0 5px !important;
    }
    .step-label {
        font-size: 9px !important;
    }
    .step-time {
        font-size: 8px !important;
    }
    .step-icon {
        width: 30px !important;
        height: 30px !important;
        font-size: 12px !important;
    }
    .specifications-section,
    .return-policy-section {
        padding: 15px !important;
    }
    .specs-grid {
        grid-template-columns: 1fr !important;
    }
}
.app-header .header-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 20px;
    position: relative;
}
.app-header .search-container {
    flex: 1;
    max-width: 500px;
    margin: 0 auto;
    position: relative;
}
.app-header .header-actions {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-left: auto;
}
@media (min-width: 769px) {
    .app-header .header-container {
        position: relative;
    }
    .app-header .search-container {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        width: 400px;
    }
    .app-header .header-actions {
        margin-left: auto;
    }
}
@media (max-width: 768px) {
    .app-header .header-container {
        flex-direction: column;
        gap: 12px;
    }
    .app-header .search-container {
        order: 2;
        width: 100%;
        max-width: none;
    }
    .app-header .header-actions {
        order: 3;
        width: 100%;
        justify-content: flex-end;
    }
}
.preference-item[style*="color: var(--danger)"] {
    cursor: pointer;
    transition: all 0.3s ease;
}
.preference-item[style*="color: var(--danger)"]:hover {
    background: #FEE2E2;
    border-radius: 8px;
    padding: 12px;
    margin: -12px -12px -12px -12px;
}
@media (max-width: 480px) {
    .product-grid {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 8px !important;
        padding: 0 4px !important;
    }
    .product-card {
        padding: 10px !important;
        min-height: 260px !important;
    }
    .product-image {
        height: 110px !important;
    }
    .product-title {
        font-size: 13px !important;
    }
    .current-price {
        font-size: 15px !important;
    }
    .container-main { 
        padding: 0 12px; 
    }
    .hero-banner { 
        padding: 20px; 
    }
    .product-detail-content { 
        padding: 20px; 
    }
    .reviews-section { 
        padding: 20px; 
    }
    .order-timeline {
        padding: 0 2px !important;
    }
    .step-label {
        font-size: 8px !important;
    }
    .step-time {
        font-size: 7px !important;
    }
    .step-icon {
        width: 25px !important;
        height: 25px !important;
        font-size: 10px !important;
    }
}
@media (min-width: 769px) and (max-width: 1024px) {
    .product-grid {
        grid-template-columns: repeat(3, 1fr) !important;
        gap: 16px !important;
    }
}
@media (min-width: 769px) {
    .product-grid {
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        gap: 20px;
    }
}
.orders-count-badge {
    position: absolute;
    top: -8px;
    right: 10px;
    background: var(--danger);
    color: white;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 700;
    min-width: 18px;
    text-align: center;
}
.status-preparing { background: #F59E0B; color: white; }
.status-dispatched { background: #8B5CF6; color: white; }
.status-packed { background: #7C3AED; color: white; }
.status-ready-for-pickup { background: #10B981; color: white; }
.status-out-for-delivery { background: #3A8EF6; color: white; }
.order-update-notification {
    position: fixed;
    top: 70px;
    right: 20px;
    background: var(--success);
    color: white;
    padding: 12px 20px;
    border-radius: 10px;
    box-shadow: var(--shadow-lg);
    z-index: 9999;
    display: none;
    animation: slideIn 0.3s ease;
}
@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
.search-container.active .search-bar {
    box-shadow: 0 4px 20px rgba(58, 142, 246, 0.4);
}
.product-description {
    margin: 25px 0;
    padding: 20px;
    background: var(--neutral);
    border-radius: 15px;
}
.product-description h4 {
    margin-bottom: 15px;
    color: var(--text-dark);
    font-size: 1.2rem;
}
.product-description p {
    line-height: 1.6;
    color: var(--text-light);
}
.refund-status {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    margin-left: 10px;
}
.refund-pending { background: #FEF3C7; color: #92400E; }
.refund-processing { background: #DBEAFE; color: #1E40AF; }
.refund-completed { background: #D1FAE5; color: #065F46; }
.refund-rejected { background: #FEE2E2; color: #991B1B; }
.wishlist-page .product-grid {
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
}
.delivery-charge-section {
    display: none !important;
}
.new-order-badge {
    background: var(--success);
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 600;
    margin-left: 8px;
}
.address-phone-optional {
    color: var(--text-light);
    font-size: 12px;
}
    </style>
</head>
<body>
    <!-- Exit Confirmation Dialog for Mobile Back Button -->
    <div id="exitDialog" class="exit-dialog">
        <div class="exit-dialog-content">
            <div class="exit-dialog-icon">
                <i class="fas fa-sign-out-alt"></i>
            </div>
            <h3 class="exit-dialog-title">Exit Raashanmart?</h3>
            <p class="exit-dialog-message">Are you sure you want to exit the app?</p>
            <div class="exit-dialog-buttons">
                <button class="btn btn-exit-no" onclick="hideExitDialog()">
                    <i class="fas fa-times"></i> No, Stay
                </button>
                <button class="btn btn-exit-yes" onclick="confirmExit()">
                    <i class="fas fa-check"></i> Yes, Exit
                </button>
            </div>
        </div>
    </div>

    <div id="offlineOverlay" class="offline-overlay">
        <div class="offline-content">
            <div class="offline-icon">
                <i class="fas fa-wifi-slash"></i>
            </div>
            <h3 class="offline-title">No Internet Connection</h3>
            <p class="offline-message">
                You're currently offline. Please check your internet connection and try again.
                <br><br>
                <small>Some features may not work properly while offline.</small>
            </p>
            <button class="reload-button" onclick="checkInternetAndReload()">
                <i class="fas fa-sync-alt"></i> Retry Connection
            </button>
        </div>
    </div>
    <div id="offlineNotification" class="offline-notification">
        <i class="fas fa-wifi-slash"></i> You are offline
    </div>
    <div id="onlineNotification" class="online-notification">
        <i class="fas fa-wifi"></i> You are back online
    </div>
    <div id="authScreen">
        <div class="auth-container">
            <div class="auth-card">
                <div class="auth-header">
                    <div class="auth-logo">R</div>
                    <h1 class="auth-title">Welcome to Raashanmart</h1>
                    <p class="auth-subtitle">Sign in to your account</p>
                </div>
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="loginEmail" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" id="loginPassword" placeholder="Enter your password" required>
                    </div>
                    <button type="submit" class="btn-primary w-100" style="padding: 12px;">Sign In</button>
                    <div class="forgot-password">
                        <a href="#" onclick="showForgotPassword()">Forgot Password?</a>
                    </div>
                </form>
                <form id="signupForm" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="signupName" placeholder="Enter your full name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="signupEmail" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" id="signupPassword" placeholder="Create a password" required>
                    </div>
                    <button type="submit" class="btn-primary w-100" style="padding: 12px;">Create Account</button>
                </form>
                <div class="auth-footer">
                    <p id="loginFooter">Don't have an account? <a href="#" class="auth-link" id="showSignup">Sign up</a></p>
                    <p id="signupFooter" style="display: none;">Already have an account? <a href="#" class="auth-link" id="showLogin">Sign in</a></p>
                </div>
            </div>
        </div>
    </div>
    <div id="appScreen" style="display: none;">
        <header class="app-header">
            <div class="header-container">
                <a href="#" class="brand">
                    <div class="brand-logo">R</div>
                    <span>Raashanmart</span>
                </a>
                <div class="search-container">
                    <input type="text" id="search" class="search-bar" placeholder="Search for products, categories...">
                    <div class="search-icon"><i class="fas fa-search"></i></div>
                    <div class="search-results" id="searchResults"></div>
                </div>
                <div class="header-actions">
                </div>
            </div>
        </header>
        <div id="orderUpdateNotification" class="order-update-notification">
            <i class="fas fa-bell"></i> Order status updated!
        </div>
        <div class="container-main">
            <div id="homePage">
                <div class="hero-banner">
                    <div class="hero-content">
                        <div class="hero-badge">
                            <i class="fas fa-bolt"></i>
                            <span>Fast Delivery • Best Prices</span>
                        </div>
                        <h1 class="hero-title">Groceries Delivered to Your Doorstep</h1>
                        <p class="hero-subtitle">Fresh products, competitive prices, and quick delivery</p>
                        <button class="btn-primary">Shop Now</button>
                    </div>
                    <div class="hero-pattern"></div>
                </div>
                <div id="searchOverlay" class="search-overlay"></div>
                <div id="searchModal" class="search-modal">
                    <div class="search-modal-header">
                        <div style="position: relative; flex: 1;">
                            <input type="text" id="enhancedSearchInput" class="search-modal-input" placeholder="Search for products, shops, categories...">
                            <div id="searchSuggestions" class="search-results" style="display: none;"></div>
                        </div>
                        <button class="search-modal-close" onclick="closeEnhancedSearch()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="search-modal-body">
                        <div class="search-section" id="recentSearchesSection">
                            <div class="search-section-title">
                                <span>Recent Searches</span>
                                <button class="clear-recent" onclick="clearRecentSearches()">Clear all</button>
                            </div>
                            <div class="recent-searches" id="recentSearchesList">
                            </div>
                        </div>
                        <div class="search-section">
                            <div class="search-section-title">
                                <span>Popular Searches</span>
                            </div>
                            <div class="popular-searches" id="popularSearchesList">
                            </div>
                        </div>
                        <div class="search-section" id="searchSuggestionsSection" style="display: none;">
                            <div class="search-section-title">
                                <span>Suggestions</span>
                            </div>
                            <ul class="search-suggestions" id="searchSuggestionsList">
                            </ul>
                        </div>
                        <div class="advanced-filters" id="advancedFilters">
                            <div class="filter-group">
                                <div class="filter-title">Price Range</div>
                                <div class="price-range">
                                    <input type="range" id="priceRange" min="0" max="5000" value="5000" class="form-range">
                                    <div class="price-inputs">
                                        <input type="number" id="minPrice" class="price-input" placeholder="Min" value="0">
                                        <input type="number" id="maxPrice" class="price-input" placeholder="Max" value="5000">
                                    </div>
                                </div>
                            </div>
                            <div class="filter-group">
                                <div class="filter-title">Customer Rating</div>
                                <div class="rating-filters">
                                    <label class="rating-filter-item">
                                        <input type="checkbox" class="rating-filter" value="4">
                                        <div class="rating-stars-small">
                                            <i class="fas fa-star rating-star-small"></i>
                                            <i class="fas fa-star rating-star-small"></i>
                                            <i class="fas fa-star rating-star-small"></i>
                                            <i class="fas fa-star rating-star-small"></i>
                                            <i class="fas fa-star rating-star-small"></i>
                                        </div>
                                        <span>4+ Stars</span>
                                    </label>
                                    <label class="rating-filter-item">
                                        <input type="checkbox" class="rating-filter" value="3">
                                        <div class="rating-stars-small">
                                            <i class="fas fa-star rating-star-small"></i>
                                            <i class="fas fa-star rating-star-small"></i>
                                            <i class="fas fa-star rating-star-small"></i>
                                            <i class="fas fa-star rating-star-small"></i>
                                            <i class="far fa-star rating-star-small"></i>
                                        </div>
                                        <span>3+ Stars</span>
                                    </label>
                                </div>
                            </div>
                            <div class="filter-group">
                                <div class="filter-title">Shops</div>
                                <div class="shop-filters" id="shopFiltersList">
                                </div>
                            </div>
                            <div class="filter-actions">
                                <button class="btn-outline" onclick="resetFilters()" style="flex: 1;">
                                    <i class="fas fa-refresh"></i> Reset
                                </button>
                                <button class="btn-primary" onclick="applyAdvancedFilters()" style="flex: 1;">
                                    <i class="fas fa-check"></i> Apply
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="filter-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4>Products</h4>
                        <div class="sorting-options">
                            <span class="sort-label">Sort by:</span>
                            <select id="sortSelect" class="sort-select">
                                <option value="">Default</option>
                                <option value="price_low_high">Price: Low to High</option>
                                <option value="price_high_low">Price: High to Low</option>
                                <option value="newest">Newest First</option>
                            </select>
                        </div>
                    </div>
                    <div class="d-flex gap-3 mb-4">
                        <select id="shopFilter" class="category-filter form-select">
                            <option value="">All Shops</option>
                        </select>
                        <select id="categoryFilter" class="category-filter form-select">
                            <option value="">All Categories</option>
                        </select>
                    </div>
                </div>
                <div id="productGrid" class="product-grid"></div>
                <div id="empty" class="empty-state" style="display: none;">
                    <div class="empty-icon"><i class="fas fa-box-open"></i></div>
                    <div class="empty-text">No products found. Try adjusting your filters.</div>
                </div>
            </div>
            <div id="ordersPage" class="orders-page">
                <h3 class="mb-4">My Orders</h3>
                <div id="ordersList"></div>
                <div id="noOrders" class="empty-state" style="display: none;">
                    <div class="empty-icon"><i class="fas fa-receipt"></i></div>
                    <div class="empty-text">No orders yet. Start shopping!</div>
                </div>
            </div>
            <div id="wishlistPage" class="wishlist-page">
                <h3 class="mb-4">My Wishlist</h3>
                <div id="wishlistItems" class="product-grid"></div>
                <div id="noWishlist" class="empty-state" style="display: none;">
                    <div class="empty-icon"><i class="fas fa-heart"></i></div>
                    <div class="empty-text">Your wishlist is empty</div>
                </div>
            </div>
            <div id="productDetailPage" class="product-detail-page">
                <div class="product-detail-container">
                    <img id="productDetailImage" class="product-detail-image" src="" alt="">
                    <div class="product-detail-content">
                        <div class="product-detail-header">
                            <h1 id="productDetailTitle" class="product-detail-title"></h1>
                            <p id="productDetailCategory" class="product-detail-category"></p>
                            <div class="product-detail-price">
                                <span id="productDetailCurrent" class="product-detail-current"></span>
                                <span id="productDetailOriginal" class="product-detail-original"></span>
                                <span id="productDetailDiscount" class="product-detail-discount"></span>
                            </div>
                            <div class="product-detail-actions">
                                <div class="btn-quantity">
                                    <button class="quantity-btn" onclick="changeQuantity(-1)">-</button>
                                    <span id="quantityValue" class="quantity-value">1</span>
                                    <button class="quantity-btn" onclick="changeQuantity(1)">+</button>
                                </div>
                                <button class="btn-add-cart-detail btn-primary" onclick="addToCartFromDetail()">
                                    <i class="fas fa-shopping-cart"></i> Add to Cart
                                </button>
                                <button id="wishlistDetailBtn" class="wishlist-btn" onclick="toggleWishlistFromDetail()">
                                    <i class="fas fa-heart"></i>
                                </button>
                            </div>
                        </div>
                        <div class="product-description">
                            <h4>Description</h4>
                            <p id="productDetailDescription"></p>
                        </div>
                        <div class="specifications-section">
                            <h4>Specifications</h4>
                            <div class="specs-grid" id="productSpecifications"></div>
                        </div>
                        <div class="return-policy-section">
                            <h4>Return Policy</h4>
                            <ul class="return-policy-list" id="returnPolicyList"></ul>
                        </div>
                        <div class="reviews-section">
                            <h4>Customer Reviews</h4>
                            <div class="rating-summary">
                                <div class="average-rating">
                                    <div class="rating-stars" id="averageRatingStars"></div>
                                    <div id="averageRatingValue" class="rating-value">0.0</div>
                                    <div id="totalReviewsCount" class="rating-count">0 reviews</div>
                                </div>
                                <div class="rating-distribution"></div>
                            </div>
                            <div id="reviewsList" class="reviews-list"></div>
                            <div id="noReviews" class="no-reviews">
                                <div class="no-reviews-icon"><i class="fas fa-comment-dots"></i></div>
                                <div class="empty-text">No reviews yet. Be the first to review this product!</div>
                            </div>
                            <div id="reviewFormSection" class="review-form-section" style="display: none;">
                                <h5 class="review-form-title">Write a Review</h5>
                                <div class="star-rating-input">
                                    <button class="star-input" data-rating="1">★</button>
                                    <button class="star-input" data-rating="2">★</button>
                                    <button class="star-input" data-rating="3">★</button>
                                    <button class="star-input" data-rating="4">★</button>
                                    <button class="star-input" data-rating="5">★</button>
                                </div>
                                <textarea id="reviewText" class="review-textarea" placeholder="Share your experience with this product..."></textarea>
                                <div class="review-requirements">
                                    <div class="requirements-title">Review Requirements:</div>
                                    <ul class="requirements-list">
                                        <li><i class="fas fa-check-circle"></i> Must have purchased this product</li>
                                        <li><i class="fas fa-check-circle"></i> Review must be at least 10 characters</li>
                                        <li><i class="fas fa-check-circle"></i> Be honest and respectful</li>
                                    </ul>
                                </div>
                                <button id="reviewSubmitBtn" class="btn-primary">Submit Review</button>
                            </div>
                        </div>
                    </div>
                </div>
                <button class="btn-outline w-100" onclick="closeProductDetail()">
                    <i class="fas fa-arrow-left"></i> Back to Products
                </button>
            </div>
            <div id="profilePage" class="profile-page">
                <div class="profile-header">
                    <div class="profile-avatar" id="profileAvatar">
                        <div id="avatarText">U</div>
                        <div class="avatar-upload" onclick="changeProfilePicture()">
                            <i class="fas fa-camera"></i>
                        </div>
                    </div>
                    <input type="file" id="avatarUpload" accept="image/*" style="display: none;">
                    <h3 id="profileUserName" class="profile-name">User Name</h3>
                    <p id="profileUserEmail" class="profile-email">user@email.com</p>
                </div>
                <div class="profile-section">
                    <div class="section-title"><i class="fas fa-user"></i> Personal Information</div>
                    <ul class="profile-menu">
                        <li class="profile-menu-item" onclick="editPersonalDetails()">
                            <div class="menu-item-content">
                                <div class="menu-item-icon"><i class="fas fa-user-edit"></i></div>
                                <div class="menu-item-text">
                                    <div class="menu-item-title">Edit Profile</div>
                                    <div class="menu-item-desc">Update your name, phone number</div>
                                </div>
                            </div>
                            <div class="menu-item-arrow"><i class="fas fa-chevron-right"></i></div>
                        </li>
                        <li class="profile-menu-item" onclick="changePassword()">
                            <div class="menu-item-content">
                                <div class="menu-item-icon"><i class="fas fa-lock"></i></div>
                                <div class="menu-item-text">
                                    <div class="menu-item-title">Change Password</div>
                                    <div class="menu-item-desc">Update your login password</div>
                                </div>
                            </div>
                            <div class="menu-item-arrow"><i class="fas fa-chevron-right"></i></div>
                        </li>
                        <li class="profile-menu-item" onclick="savedAddresses()">
                            <div class="menu-item-content">
                                <div class="menu-item-icon"><i class="fas fa-map-marker-alt"></i></div>
                                <div class="menu-item-text">
                                    <div class="menu-item-title">Saved Addresses</div>
                                    <div class="menu-item-desc">Manage your delivery addresses</div>
                                </div>
                            </div>
                            <div class="menu-item-arrow"><i class="fas fa-chevron-right"></i></div>
                        </li>
                    </ul>
                </div>
                <div class="profile-section">
                    <div class="section-title"><i class="fas fa-bell"></i> Notifications</div>
                    <div class="preference-item">
                        <div class="preference-info">
                            <div class="preference-title">Order Updates</div>
                            <div class="preference-desc">Get notified about your order status</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="orderUpdatesToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="preference-item">
                        <div class="preference-info">
                            <div class="preference-title">Price Alerts</div>
                            <div class="preference-desc">Get notified when prices drop</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="priceAlertsToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="preference-item">
                        <div class="preference-info">
                            <div class="preference-title">Promotions</div>
                            <div class="preference-desc">Receive offers and discounts</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="promotionsToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="preference-item">
                        <div class="preference-info">
                            <div class="preference-title">Push Notifications</div>
                            <div class="preference-desc">Browser notifications</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="pushNotificationsToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div class="profile-section" id="loginHistorySection" style="display: none;">
                    <div class="section-title"><i class="fas fa-history"></i> Login History</div>
                    <div id="loginHistoryList"></div>
                </div>
                <div class="profile-section">
                    <div class="section-title"><i class="fas fa-shield-alt"></i> Security</div>
                    <ul class="profile-menu">
                        <li class="profile-menu-item" onclick="showLoginHistory()">
                            <div class="menu-item-content">
                                <div class="menu-item-icon"><i class="fas fa-history"></i></div>
                                <div class="menu-item-text">
                                    <div class="menu-item-title">Login History</div>
                                    <div class="menu-item-desc">View your recent login sessions</div>
                                </div>
                            </div>
                            <div class="menu-item-arrow"><i class="fas fa-chevron-right"></i></div>
                        </li>
                        <li class="profile-menu-item" onclick="changeLanguage()">
                            <div class="menu-item-content">
                                <div class="menu-item-icon"><i class="fas fa-language"></i></div>
                                <div class="menu-item-text">
                                    <div class="menu-item-title">Language</div>
                                    <div class="menu-item-desc">Change app language</div>
                                </div>
                            </div>
                            <div class="menu-item-arrow"><i class="fas fa-chevron-right"></i></div>
                        </li>
                    </ul>
                </div>
                <div class="profile-section">
                    <div class="section-title"><i class="fas fa-question-circle"></i> Support</div>
                    <ul class="profile-menu">
                        <li class="profile-menu-item" onclick="openPrivacyPolicy()">
                            <div class="menu-item-content">
                                <div class="menu-item-icon"><i class="fas fa-user-shield"></i></div>
                                <div class="menu-item-text">
                                    <div class="menu-item-title">Privacy Policy</div>
                                    <div class="menu-item-desc">How we protect your data</div>
                                </div>
                            </div>
                            <div class="menu-item-arrow"><i class="fas fa-chevron-right"></i></div>
                        </li>
                        <li class="profile-menu-item" onclick="openTermsConditions()">
                            <div class="menu-item-content">
                                <div class="menu-item-icon"><i class="fas fa-file-contract"></i></div>
                                <div class="menu-item-text">
                                    <div class="menu-item-title">Terms & Conditions</div>
                                    <div class="menu-item-desc">App usage terms</div>
                                </div>
                            </div>
                            <div class="menu-item-arrow"><i class="fas fa-chevron-right"></i></div>
                        </li>
                        <li class="profile-menu-item" onclick="openRefundPolicy()">
                            <div class="menu-item-content">
                                <div class="menu-item-icon"><i class="fas fa-undo-alt"></i></div>
                                <div class="menu-item-text">
                                    <div class="menu-item-title">Refund Policy</div>
                                    <div class="menu-item-desc">Refund and cancellation policy</div>
                                </div>
                            </div>
                            <div class="menu-item-arrow"><i class="fas fa-chevron-right"></i></div>
                        </li>
                        <li class="profile-menu-item" style="color: var(--danger);" onclick="logout()">
                            <div class="menu-item-content">
                                <div class="menu-item-icon" style="color: var(--danger);"><i class="fas fa-sign-out-alt"></i></div>
                                <div class="menu-item-text">
                                    <div class="menu-item-title">Logout</div>
                                    <div class="menu-item-desc">Sign out from your account</div>
                                </div>
                            </div>
                            <div class="menu-item-arrow"><i class="fas fa-chevron-right"></i></div>
                        </li>
                    </ul>
                </div>
            </div>
            <div id="notificationsPage" class="notifications-page">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3>Notifications</h3>
                    <button class="btn-outline" id="clearNotificationsBtn">Clear All</button>
                </div>
                <div id="notificationsList"></div>
                <div id="noNotifications" class="empty-state">
                    <div class="empty-icon"><i class="fas fa-bell"></i></div>
                    <div class="empty-text">No notifications yet</div>
                </div>
            </div>
        </div>
        <div class="bottom-sheet" id="bsheet">
            <span class="sheet-handle"></span>
            <div class="sheet-header">
                <strong class="sheet-title">Your Cart</strong>
                <button class="sheet-close" id="closeB">&times;</button>
            </div>
            <div class="sheet-body">
                <div id="orderList"></div>
                <div id="discountSection" class="discount-row" style="display: none;">
                    <span>Discount</span>
                    <span id="discountAmount">-₹0</span>
                </div>
                <div class="order-total-summary">
                    <span>Total</span>
                    <span id="orderTotal">₹0</span>
                </div>
                <div class="coupon-section">
                    <div class="coupon-input-group">
                        <input type="text" id="couponCode" class="coupon-input" placeholder="Enter coupon code">
                        <button id="applyCouponBtn" class="btn-apply-coupon">Apply</button>
                    </div>
                    <div id="couponMessage"></div>
                    <div id="couponLoginRequired" class="coupon-login-required" style="display: none;">
                        Please login to apply coupons
                    </div>
                </div>
                <div class="address-section">
                    <h5>Delivery Address</h5>
                    <div id="addresses" class="address-grid"></div>
                    <div class="address-form">
                        <div class="form-group">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="checkoutName" placeholder="Enter your full name">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone Number <span class="address-phone-optional">(Optional if saved in address)</span></label>
                            <input type="tel" class="form-control" id="checkoutPhone" placeholder="Enter your phone number" oninput="validatePhone()">
                            <small id="phoneValidation" class="validation-message"></small>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">City</label>
                                <input type="text" class="form-control" id="checkoutCity" placeholder="City">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Pincode</label>
                                <input type="text" class="form-control" id="checkoutPincode" placeholder="Pincode">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Address</label>
                            <textarea class="form-control" id="checkoutAddress" placeholder="House no., Building, Street, Area" rows="2"></textarea>
                        </div>
                        <button class="btn-outline w-100" onclick="addNewAddress()">
                            <i class="fas fa-plus"></i> Add New Address
                        </button>
                    </div>
                </div>
                <div class="payment-methods">
    <h5>Payment Method</h5>
    
    <!-- Cash on Delivery Option - ADD ID HERE -->
    <div class="payment-option" id="codPaymentOption" data-method="cod">
        <div class="payment-icon"><i class="fas fa-money-bill-wave"></i></div>
        <div class="payment-info">
            <div class="payment-title">Cash on Delivery</div>
            <div class="payment-desc">Pay when you receive your order</div>
        </div>
        <!-- ADD RADIO BUTTON -->
        <input type="radio" id="paymentMethodCod" name="paymentMethod" value="cod" style="margin-left: auto;">
    </div>
    
    <!-- QR Code Payment Option - ADD ID HERE -->
    <div class="payment-option" id="upiPaymentOption" data-method="qr">
        <div class="payment-icon"><i class="fas fa-qrcode"></i></div>
        <div class="payment-info">
            <div class="payment-title">QR Code Payment</div>
            <div class="payment-desc">Scan and pay via UPI</div>
        </div>
        <!-- ADD RADIO BUTTON -->
        <input type="radio" id="paymentMethodUpi" name="paymentMethod" value="upi" style="margin-left: auto;">
    </div>
</div>

<!-- QR Code Section - ADD ID HERE for upiDetailsSection -->
<div id="qrCodeSection" class="qr-modal" style="display: none;">
    <div class="qr-code">
        <div class="qr-code-content">
            <h5>Scan to Pay</h5>
            <div class="qr-image-container">
                <!-- CHANGE ID HERE -->
                <img id="qrCodeImage" alt="QR Code">
            </div>
            <div class="upi-details">
                <strong>UPI ID:</strong> 
                <!-- CHANGE ID HERE -->
                <span id="displayUpiId"></span><br>
                <strong>Amount:</strong> <span id="qrAmount">₹0</span>
            </div>
            <div class="utr-input">
                <label class="form-label">Enter UTR Number</label>
                <input type="text" class="form-control" id="utrNumber" placeholder="Enter 12-digit UTR number" oninput="validateUTR()">
                <small id="utrValidation" class="validation-message"></small>
            </div>
            <button id="confirmQrPayment" class="btn-primary w-100">Confirm QR Payment</button>
        </div>
    </div>
</div>
                <button id="placeOrderBtn" class="btn-primary w-100 mt-3" onclick="placeOrder()" disabled>
                    <i class="fas fa-lock"></i> Place Order Securely
                </button>
            </div>
        </div>
        <div class="bottom-sheet" id="orderTracking">
            <span class="sheet-handle"></span>
            <div class="sheet-header">
                <strong class="sheet-title">Track Your Order</strong>
                <button class="sheet-close" onclick="closeOrderTracking()">&times;</button>
            </div>
            <div class="sheet-body">
                <div class="order-timeline" id="orderTimeline">
                    <div class="timeline-step">
                        <div class="step-icon completed" id="stepConfirmed">
                            <i class="fas fa-check"></i>
                        </div>
                        <div class="step-label completed">Order Confirmed</div>
                        <div class="step-time" id="timeConfirmed">Today, 10:30 AM</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-icon active" id="stepPreparing">
                            <i class="fas fa-utensils"></i>
                        </div>
                        <div class="step-label active">Preparing</div>
                        <div class="step-time" id="timePreparing">In progress</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-icon" id="stepPacked">
                            <i class="fas fa-box"></i>
                        </div>
                        <div class="step-label">Packed</div>
                        <div class="step-time" id="timePacked">--</div>
                    </div>
                    <div class="timeline-step" id="stepDispatchedContainer">
                        <div class="step-icon" id="stepDispatched">
                            <i class="fas fa-shipping-fast"></i>
                        </div>
                        <div class="step-label">Dispatched</div>
                        <div class="step-time" id="timeDispatched">--</div>
                    </div>
                    <div class="timeline-step" id="finalStepContainer">
                        <div class="step-icon" id="stepFinal">
                            <i class="fas fa-home" id="finalIcon"></i>
                        </div>
                        <div class="step-label" id="finalLabel">Delivered</div>
                        <div class="step-time" id="timeFinal">--</div>
                    </div>
                </div>
                <div class="order-details-card">
                    <h5>Order Details</h5>
                    <div id="trackingOrderDetails"></div>
                </div>
                <button class="btn-outline w-100 mt-3" id="pickupLocationBtn" onclick="showPickupLocation()" style="display: none;">
                    <i class="fas fa-map-marker-alt"></i> View Pickup Location
                </button>
                <button class="btn-outline w-100 mt-3" id="cancelOrderBtn" onclick="cancelOrder()">
                    <i class="fas fa-times"></i> Cancel Order
                </button>
            </div>
        </div>
        <div class="modal fade" id="confirmationModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header" style="background: var(--primary); color: white;">
                        <h5 class="modal-title" id="confirmationTitle">Confirm Action</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="confirmationMessage"></div>
                    <div class="modal-footer">
                        <button type="button" class="btn-outline" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn-primary" id="confirmAction">Confirm</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="bottom-nav">
        <a href="#" class="nav-item active" data-page="home">
            <i class="fas fa-home nav-icon"></i>
            <span class="nav-label">Home</span>
        </a>
        <a href="#" class="nav-item" data-page="orders">
            <i class="fas fa-receipt nav-icon"></i>
            <span class="nav-label">Orders</span>
            <span id="ordersNavBadge" class="nav-badge" style="display: none;">0</span>
        </a>
        <a href="#" class="nav-item" data-page="wishlist">
            <i class="fas fa-heart nav-icon"></i>
            <span class="nav-label">Wishlist</span>
            <span id="wishlistCount" class="nav-badge" style="display: none;">0</span>
        </a>
        <a href="#" class="nav-item" data-page="account">
            <i class="fas fa-user nav-icon"></i>
            <span class="nav-label">Account</span>
        </a>
        <a href="#" class="nav-item" id="bottomNavCart" data-page="cart">
            <i class="fas fa-shopping-cart nav-icon"></i>
            <span class="nav-label">Cart</span>
            <span id="bottomCartCount" class="nav-badge" style="display: none;">0</span>
        </a>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD2-yz4xwYD5S_oXs6ryhNP8XIC94jzda4",
            authDomain: "dukaan-platform.firebaseapp.com",
            projectId: "dukaan-platform",
            storageBucket: "dukaan-platform.firebasestorage.app",
            messagingSenderId: "75765851780",
            appId: "1:75765851780:web:dd9567db1d39c3b09c84d1"
        };

        try {
            firebase.initializeApp(firebaseConfig);
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.log('Firebase already initialized');
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        let messaging = null;
        try {
            messaging = firebase.messaging();
            console.log('Firebase Messaging initialized');
        } catch (error) {
            console.log('Firebase Messaging not available:', error);
        }
        auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

        // Data variables
        let SHOPS = {};
        let PRODUCTS = [];
        let ALL_CATEGORIES = new Set();
        let currentUser = null;
        let cart = JSON.parse(localStorage.getItem('dukaan_cart')) || [];
        let wishlist = JSON.parse(localStorage.getItem('dukaan_wishlist')) || [];
        let addresses = JSON.parse(localStorage.getItem('userAddresses')) || [];
        let orders = JSON.parse(localStorage.getItem('dukaan_orders')) || [];
        let productReviews = JSON.parse(localStorage.getItem('dukaan_product_reviews')) || [];
        let notifications = JSON.parse(localStorage.getItem('dukaan_notifications')) || [];
        let appliedCoupon = null;
        let selectedPaymentMethod = null;
        let selectedAddress = null;
        let currentProductDetail = null;
        let selectedRating = 0;
        let isOnline = navigator.onLine;
        let currentTrackingOrder = null;
        let SHOP_CONFIG = null;
        let SHOP_COUPONS = [];
        let SHOP_DATA = null;

        // Mobile back button handling
        let currentPage = 'home';
        let isBottomSheetOpen = false;
        let backButtonCount = 0;
        const backButtonTimeout = 2000; // 2 seconds

        // Setup mobile back button handling
        function setupMobileBackButton() {
            // Listen for back button (for mobile browsers)
            window.addEventListener('popstate', function(event) {
                event.preventDefault();
                handleBackButton();
            });

            // Also handle physical back button on mobile devices
            document.addEventListener('backbutton', handleBackButton, false);
            
            // Initialize history state
            history.pushState({ page: 'home' }, '', '');
        }

        function handleBackButton() {
            console.log('Back button pressed, current page:', currentPage, 'Bottom sheet open:', isBottomSheetOpen);
            
            if (isBottomSheetOpen) {
                // Close bottom sheet first
                closeBottomSheet();
                return;
            }
            
            if (currentPage !== 'home') {
                // Navigate to home if not already there
                navigateToPage('home');
                // Push new state
                history.pushState({ page: 'home' }, '', '');
            } else {
                // Already on home page, show exit dialog
                showExitDialog();
            }
        }

        function showExitDialog() {
            document.getElementById('exitDialog').classList.add('active');
        }

        function hideExitDialog() {
            document.getElementById('exitDialog').classList.remove('active');
        }

        function confirmExit() {
            // For PWA, close the app
            if (window.navigator && window.navigator.app) {
                window.navigator.app.exitApp();
            } else {
                // For browser, go back in history
                window.history.back();
            }
        }

        // ==================== FIX 1: PRODUCT CARD QUANTITY COUNTER ====================
        // Updated addToCart function with two-way sync
        async function addToCart(productId) {
            try {
                const product = PRODUCTS.find(p => p.id === productId);
                if (!product) return;
                
                // Check if cart already has items from different shop
                if (cart.length > 0) {
                    const firstShopId = cart[0].shopId;
                    if (firstShopId !== product.shopId) {
                        showToast(`Cannot add items from different shops. Please complete your order from ${cart[0].shopName} first.`, 'warning');
                        return;
                    }
                }
                
                const existingItem = cart.find(item => item.id === productId);
                
                if (existingItem) {
                    existingItem.quantity += 1;
                } else {
                    cart.push({
                        id: product.id,
                        name: product.name,
                        price: product.price,
                        image: product.image,
                        quantity: 1,
                        shopId: product.shopId,
                        shopName: product.shopName
                    });
                }
                
                localStorage.setItem('dukaan_cart', JSON.stringify(cart));
                updateCartUI();
                updateProductCardButton(productId); // Update product card button
                showToast('Product added to cart!');
                
                // 🔥 CRITICAL FIX: Load shop config when first item is added
                if (cart.length === 1) {
                    loadAndListenToShop();
                }
                
                // Load shop data for coupon validation
                await loadShopData();
                
            } catch (error) {
                console.error('Error adding to cart:', error);
                showToast('Error adding product to cart');
            }
        }

        // New function to update product card button based on cart quantity
        function updateProductCardButton(productId) {
            const productCard = document.querySelector(`.product-card[data-product-id="${productId}"]`);
            if (!productCard) return;
            
            const cartItem = cart.find(item => item.id === productId);
            const quantity = cartItem ? cartItem.quantity : 0;
            
            const actionsDiv = productCard.querySelector('.card-actions');
            if (!actionsDiv) return;
            
            if (quantity > 0) {
                // Show quantity counter
                actionsDiv.innerHTML = `
                    <div class="btn-quantity-card" data-product-id="${productId}">
                        <button class="quantity-btn-card" onclick="decreaseCartQuantity('${productId}')">-</button>
                        <span class="quantity-value-card">${quantity}</span>
                        <button class="quantity-btn-card" onclick="increaseCartQuantity('${productId}')">+</button>
                    </div>
                `;
            } else {
                // Show Add to Cart button
                actionsDiv.innerHTML = `
                    <button class="btn-add-cart" onclick="addToCart('${productId}')">
                        <i class="fas fa-shopping-cart"></i> Add to Cart
                    </button>
                `;
            }
        }

        // Functions to handle quantity changes from product card
        function increaseCartQuantity(productId) {
            const cartItem = cart.find(item => item.id === productId);
            if (cartItem) {
                if (cartItem.quantity >= 10) {
                    showToast('Maximum 10 items allowed');
                    return;
                }
                cartItem.quantity += 1;
                localStorage.setItem('dukaan_cart', JSON.stringify(cart));
                updateCartUI();
                updateProductCardButton(productId);
                showToast('Quantity increased');
            }
        }

        function decreaseCartQuantity(productId) {
            const cartItemIndex = cart.findIndex(item => item.id === productId);
            if (cartItemIndex !== -1) {
                if (cart[cartItemIndex].quantity > 1) {
                    cart[cartItemIndex].quantity -= 1;
                    showToast('Quantity decreased');
                } else {
                    // Remove item completely if quantity becomes 0
                    cart.splice(cartItemIndex, 1);
                    showToast('Item removed from cart');
                }
                localStorage.setItem('dukaan_cart', JSON.stringify(cart));
                updateCartUI();
                updateProductCardButton(productId);
            }
        }

        // Update renderProducts to include product ID in data attribute and check cart quantity
        function renderProducts(products) {
            const productGrid = document.getElementById('productGrid');
            const emptyState = document.getElementById('empty');
            
            if (!productGrid) return;

            productGrid.innerHTML = '';
            
            if (products.length === 0) {
                if (emptyState) emptyState.style.display = 'block';
                return;
            }
            
            if (emptyState) emptyState.style.display = 'none';
            
            products.forEach(product => {
                const shopName = product.shopName || 'Unknown Shop';
                const discount = product.mrp ? Math.round(((product.mrp - product.price) / product.mrp) * 100) : 0;
                const isInWishlist = wishlist.includes(product.id);
                const cartItem = cart.find(item => item.id === product.id);
                const quantity = cartItem ? cartItem.quantity : 0;
                
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.setAttribute('data-product-id', product.id);
                
                let actionButton = '';
                if (quantity > 0) {
                    // Show quantity counter
                    actionButton = `
                        <div class="btn-quantity-card" data-product-id="${product.id}">
                            <button class="quantity-btn-card" onclick="decreaseCartQuantity('${product.id}')">-</button>
                            <span class="quantity-value-card">${quantity}</span>
                            <button class="quantity-btn-card" onclick="increaseCartQuantity('${product.id}')">+</button>
                        </div>
                    `;
                } else {
                    // Show Add to Cart button
                    actionButton = `
                        <button class="btn-add-cart" onclick="addToCart('${product.id}')">
                            <i class="fas fa-shopping-cart"></i> Add to Cart
                        </button>
                    `;
                }
                
                productCard.innerHTML = `
                    <div class="shop-badge">${shopName}</div>
                    <button class="wishlist-btn ${isInWishlist ? 'active' : ''}" onclick="toggleWishlist('${product.id}')">
                        <i class="fas fa-heart"></i>
                    </button>
                    <img src="${product.image}" alt="${product.name}" class="product-image" onclick="showProductDetail('${product.id}')">
                    <h3 class="product-title" onclick="showProductDetail('${product.id}')">${product.name}</h3>
                    <p class="product-category">${product.category} • ${product.deliveryTime || '10-15 min'}</p>
                    <div class="product-price">
                        <span class="current-price">₹${product.price}</span>
                        ${product.mrp ? `<span class="original-price">₹${product.mrp}</span>` : ''}
                        ${discount > 0 ? `<span class="discount">${discount}% OFF</span>` : ''}
                    </div>
                    <div class="card-actions">
                        ${actionButton}
                    </div>
                `;
                productGrid.appendChild(productCard);
            });
        }

        // Update updateCartUI to refresh all product cards
        function updateCartUI() {
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            const bottomCartCount = document.getElementById('bottomCartCount');
            
            if (bottomCartCount) {
                bottomCartCount.textContent = totalItems;
                bottomCartCount.style.display = totalItems > 0 ? 'block' : 'none';
            }
            
            updateOrderSummary();
            
            // Update all product card buttons
            PRODUCTS.forEach(product => {
                updateProductCardButton(product.id);
            });
            
            // 🔥 CRITICAL FIX: Setup payment selection when cart opens
            if (cart.length > 0) {
                setupPaymentSelection();
            }
        }

        // ==================== FIX 3: SHOP NAME IN CART ITEMS ====================
        // Update updateOrderSummary function to show shop name
        function updateOrderSummary() {
            const orderList = document.getElementById('orderList');
            if (!orderList) return;
            
            orderList.innerHTML = '';
            let subtotal = 0;
            
            cart.forEach((item, index) => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;
                
                const orderItem = document.createElement('div');
                orderItem.className = 'order-item-summary';
                orderItem.innerHTML = `
                    <div style="flex: 1;">
                        <strong>${item.name}</strong>
                        <div class="order-item-shop-name">
                            <i class="fas fa-store"></i> ${item.shopName || 'Unknown Shop'}
                        </div>
                        <div class="text-muted">₹${item.price} each</div>
                        <div class="quantity-controls" style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">
                            <button onclick="updateCartQuantity(${index}, -1)" 
                                    style="width: 30px; height: 30px; border-radius: 50%; border: 1px solid var(--border); background: var(--neutral); display: flex; align-items: center; justify-content: center;">-</button>
                            <span style="font-weight: 600; min-width: 20px; text-align: center;">${item.quantity}</span>
                            <button onclick="updateCartQuantity(${index}, 1)" 
                                    style="width: 30px; height: 30px; border-radius: 50%; border: 1px solid var(--border); background: var(--neutral); display: flex; align-items: center; justify-content: center;">+</button>
                        </div>
                    </div>
                    <div>₹${itemTotal}</div>
                `;
                orderList.appendChild(orderItem);
            });
            
            let discount = 0;
            if (appliedCoupon) {
                // Validate coupon minimum order value
                if (subtotal < appliedCoupon.minOrder) {
                    // Remove coupon if cart value is below minimum
                    appliedCoupon = null;
                    document.getElementById('couponCode').value = '';
                    document.getElementById('couponMessage').textContent = 'Cart value is below coupon minimum. Coupon removed.';
                    document.getElementById('couponMessage').className = 'coupon-error';
                } else {
                    if (appliedCoupon.type === 'percentage') {
                        discount = (subtotal * appliedCoupon.value) / 100;
                    } else {
                        discount = appliedCoupon.value;
                    }
                    discount = Math.min(discount, subtotal);
                }
            }
            
            const total = Math.max(0, subtotal - discount);
            const orderTotal = document.getElementById('orderTotal');
            const qrAmount = document.getElementById('qrAmount');
            
            if (orderTotal) orderTotal.textContent = `₹${Math.max(0, total)}`;
            if (qrAmount) qrAmount.textContent = `₹${Math.max(0, total)}`;
            
            const placeOrderBtn = document.getElementById('placeOrderBtn');
            if (placeOrderBtn) {
                placeOrderBtn.disabled = cart.length === 0;
            }
        }

        // ==================== FIX 4: FIREBASE PUSH NOTIFICATIONS ====================
        async function setupFirebaseMessaging() {
            if (!messaging) {
                console.log('Firebase Messaging not available');
                return;
            }
            
            try {
                // Request permission for notifications
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    console.log('Notification permission granted');
                    
                    // Get FCM token
                    const token = await messaging.getToken();
                    console.log('FCM Token:', token);
                    
                    if (currentUser && token) {
                        // Save token to user's profile
                        await db.collection('users').doc(currentUser.uid).update({
                            fcmToken: token,
                            notificationEnabled: true
                        });
                        
                        console.log('FCM token saved to user profile');
                    }
                    
                    // Listen for foreground messages
                    messaging.onMessage((payload) => {
                        console.log('Foreground message received:', payload);
                        
                        // Show notification
                        createNotification(
                            payload.notification?.title || 'New Notification',
                            payload.notification?.body || 'You have a new notification',
                            'info'
                        );
                        
                        // Play sound if needed
                        playNotificationSound();
                    });
                    
                } else {
                    console.log('Notification permission denied');
                }
            } catch (error) {
                console.error('Error setting up Firebase Messaging:', error);
            }
        }

        function playNotificationSound() {
            // Create and play notification sound
            const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3');
            audio.volume = 0.3;
            audio.play().catch(e => console.log('Audio play failed:', e));
        }

        // ==================== FIX 5: PLACE ORDER NULL ERROR ====================
        // Updated placeOrder function with proper null checks
        async function placeOrder() {
            if (!isOnline) {
                showToast('Cannot place order while offline', 'error');
                return;
            }

            try {
                // Get selected payment method
                const codRadio = document.getElementById('paymentMethodCod');
                const upiRadio = document.getElementById('paymentMethodUpi');
                
                if (codRadio && codRadio.checked) {
                    selectedPaymentMethod = 'cod';
                } else if (upiRadio && upiRadio.checked) {
                    selectedPaymentMethod = 'qr';
                } else {
                    // Default to COD if nothing selected
                    selectedPaymentMethod = 'cod';
                    if (codRadio) codRadio.checked = true;
                }
                
                if (!selectedPaymentMethod) {
                    showToast('Please select a payment method', 'error');
                    return;
                }
                
                // Get phone from selected address or input
                let phone = '';
                if (selectedAddress) {
                    const address = addresses.find(addr => addr.id === selectedAddress);
                    phone = address?.phone || '';
                }
                
                // If no phone in address, check checkout form
                if (!phone) {
                    phone = document.getElementById('checkoutPhone')?.value?.trim() || '';
                }
                
                // Phone is optional now, only validate if provided
                if (phone && !validatePhoneNumber(phone)) {
                    showToast('Please enter a valid phone number', 'error');
                    return;
                }
                
                if (cart.length === 0) {
                    showToast('Your cart is empty', 'error');
                    return;
                }
                
                const user = auth.currentUser;
                if (!user) {
                    showToast('Please login to place order', 'error');
                    return;
                }
                
                showLoading(true);
                
                const addressData = addresses.find(addr => addr.isDefault) || addresses[0];
                if (!addressData) {
                    showToast('Please add a delivery address first', 'error');
                    showLoading(false);
                    return;
                }
                
                // Use selected address or default
                const selectedAddressData = addresses.find(addr => addr.id === selectedAddress) || addressData;
                
                const completeAddress = {
                    id: selectedAddressData.id || generateId(),
                    fullName: selectedAddressData.name || user.displayName || 'Customer',
                    phone: phone || selectedAddressData.phone || '',
                    details: selectedAddressData.address || 'Address not specified',
                    city: selectedAddressData.city || 'City not specified',
                    pincode: selectedAddressData.pincode || '000000',
                    landmark: selectedAddressData.landmark || '',
                    type: selectedAddressData.type || 'home',
                    customerId: user.uid,
                    customerName: user.displayName || 'Customer',
                    customerEmail: user.email,
                    customerPhone: phone || selectedAddressData.phone || ''
                };
                
                const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                let discount = 0;
                
                if (appliedCoupon) {
                    if (appliedCoupon.type === 'percentage') {
                        discount = (subtotal * appliedCoupon.value) / 100;
                    } else {
                        discount = appliedCoupon.value;
                    }
                }
                
                const total = subtotal - discount;
                
                const orderItems = cart.map(item => ({
                    id: item.id,
                    name: item.name,
                    price: item.price,
                    quantity: item.quantity,
                    image: item.image,
                    shopId: item.shopId,
                    shopName: item.shopName
                }));
                
                const unifiedOrderId = 'ORD_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6).toUpperCase();
                
                const orderData = {
                    orderId: unifiedOrderId,
                    id: unifiedOrderId,
                    customerId: user.uid,
                    customerName: user.displayName || 'Customer',
                    customerEmail: user.email,
                    phone: phone || selectedAddressData.phone || '',
                    items: orderItems,
                    subtotal: subtotal,
                    discount: discount,
                    total: total,
                    address: completeAddress,
                    status: 'pending',
                    paymentMethod: selectedPaymentMethod,
                    paymentStatus: selectedPaymentMethod === 'qr' ? 'pending' : 'pending',
                    shopId: cart[0]?.shopId || 'default_shop',
                    shopName: cart[0]?.shopName || 'Default Shop',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    appliedCoupon: appliedCoupon ? appliedCoupon.code : null
                };
                
                const docRef = await db.collection('orders').add(orderData);
                console.log('✅ Order created:', docRef.id);
                
                // Clear cart
                cart = [];
                localStorage.setItem('dukaan_cart', JSON.stringify(cart));
                updateCartUI();
                appliedCoupon = null;
                document.getElementById('couponCode').value = '';
                document.getElementById('couponMessage').textContent = '';
                
                showLoading(false);
                showToast(`✅ Order placed successfully! Order ID: ${unifiedOrderId}`, 'success');
                closeBottomSheet();
                
                // Send push notification to shopkeeper
                sendOrderNotificationToShopkeeper(orderData);
                
                setTimeout(() => {
                    navigateToPage('orders');
                }, 2000);
                
            } catch (error) {
                console.error('❌ Error placing order:', error);
                showLoading(false);
                showToast('Error placing order: ' + error.message, 'error');
            }
        }

        async function sendOrderNotificationToShopkeeper(orderData) {
            try {
                // Get shopkeeper's FCM token
                const shopDoc = await db.collection('shops').doc(orderData.shopId).get();
                if (shopDoc.exists) {
                    const shopData = shopDoc.data();
                    const shopkeeperId = shopData.ownerId;
                    
                    if (shopkeeperId) {
                        const shopkeeperDoc = await db.collection('users').doc(shopkeeperId).get();
                        if (shopkeeperDoc.exists) {
                            const shopkeeperData = shopkeeperDoc.data();
                            const fcmToken = shopkeeperData.fcmToken;
                            
                            if (fcmToken) {
                                // Send notification via Firebase Cloud Messaging
                                // Note: This requires Cloud Functions or server-side implementation
                                console.log('Should send notification to shopkeeper with token:', fcmToken);
                                
                                // For now, we'll create a notification in Firestore
                                await db.collection('notifications').add({
                                    userId: shopkeeperId,
                                    title: 'New Order Received',
                                    message: `New order #${orderData.orderId.slice(-6)} from ${orderData.customerName}`,
                                    type: 'new_order',
                                    orderId: orderData.orderId,
                                    read: false,
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                                });
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Error sending notification to shopkeeper:', error);
            }
        }

        // ==================== UPDATED NAVIGATION FUNCTION ====================
        function navigateToPage(page) {
            currentPage = page;
            
            document.getElementById('homePage').style.display = 'none';
            document.getElementById('ordersPage').style.display = 'none';
            document.getElementById('wishlistPage').style.display = 'none';
            document.getElementById('productDetailPage').style.display = 'none';
            document.getElementById('profilePage').style.display = 'none';
            document.getElementById('notificationsPage').style.display = 'none';

            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-page') === page) {
                    item.classList.add('active');
                }
            });

            switch(page) {
                case 'home':
                    document.getElementById('homePage').style.display = 'block';
                    break;
                case 'orders':
                    document.getElementById('ordersPage').style.display = 'block';
                    renderOrders();
                    break;
                case 'wishlist':
                    document.getElementById('wishlistPage').style.display = 'block';
                    renderWishlistItems();
                    break;
                case 'account':
                    document.getElementById('profilePage').style.display = 'block';
                    loadUserProfile();
                    break;
                case 'notifications':
                    document.getElementById('notificationsPage').style.display = 'block';
                    loadNotificationsPage();
                    break;
                case 'cart':
                    openBottomSheet();
                    break;
                default:
                    document.getElementById('homePage').style.display = 'block';
            }
            
            // Update history state
            history.pushState({ page: page }, '', '');
        }

        // ==================== UPDATED BOTTOM SHEET FUNCTIONS ====================
        function openBottomSheet() {
            if (cart.length === 0) {
                showToast('Your cart is empty');
                return;
            }

            isBottomSheetOpen = true;
            document.getElementById('bsheet').classList.add('open');
            
            // Ensure shop config is loaded
            loadAndListenToShop();
            
            // Setup payment selection
            setupPaymentSelection();
            
            updateOrderSummary();
            
            if (!selectedAddress && addresses.length > 0) {
                selectedAddress = addresses.find(addr => addr.isDefault)?.id || addresses[0].id;
                fillCheckoutForm(addresses.find(addr => addr.id === selectedAddress));
            }
            renderAddresses();
            
            // Update coupon section when bottom sheet opens
            updateCouponSection();
        }

        function closeBottomSheet() {
            isBottomSheetOpen = false;
            document.getElementById('bsheet').classList.remove('open');
            document.getElementById('qrCodeSection').style.display = 'none';
            selectedPaymentMethod = null;
            document.querySelectorAll('.payment-option').forEach(option => option.classList.remove('selected'));
        }

        // ==================== REST OF THE CODE (KEEP EXISTING IMPLEMENTATION) ====================
        // Load and listen to shop (existing code)
        let currentShopListener = null;
        let currentShopId = null;

        function loadAndListenToShop() {
            if (currentShopListener) {
                currentShopListener();
                currentShopListener = null;
                console.log("🔄 Unsubscribed previous shop listener");
            }

            if (!cart || cart.length === 0) {
                console.log("🛒 Cart is empty, no shop to listen to");
                currentShopId = null;
                return;
            }

            const shopIdFromCart = cart[0].shopId;
            if (!shopIdFromCart) {
                console.error("❌ No shopId found in cart items");
                return;
            }

            if (currentShopId === shopIdFromCart) {
                console.log("✅ Already listening to shop:", shopIdFromCart);
                return;
            }

            currentShopId = shopIdFromCart;
            console.log("🎯 Setting up listener for shop:", shopIdFromCart);

            const shopConfigRef = db.collection('shop_config').doc(shopIdFromCart);
            
            currentShopListener = shopConfigRef.onSnapshot(
                (doc) => {
                    console.log("📡 Real-time shop config update received for:", shopIdFromCart);
                    
                    if (doc.exists) {
                        const shopData = doc.data();
                        console.log("📡 REAL-TIME SHOP DATA:", shopData);
                        
                        SHOP_CONFIG = shopData;
                        updatePaymentSectionUI(shopData);
                        loadShopData();
                    } else {
                        console.log("⚠️ No config found for shop:", shopIdFromCart);
                        SHOP_CONFIG = null;
                        loadShopDataForPayment(shopIdFromCart);
                    }
                },
                (error) => {
                    console.error("❌ Error listening to shop config:", error);
                    SHOP_CONFIG = null;
                }
            );

            loadShopData();
        }

        async function loadShopDataForPayment(shopId) {
            try {
                const shopDoc = await db.collection('shops').doc(shopId).get();
                if (shopDoc.exists) {
                    const shopData = shopDoc.data();
                    console.log("✅ Fallback shop data loaded:", shopData);
                    
                    SHOP_CONFIG = {
                        upiId: shopData.upiId,
                        qrCodeImage: shopData.qrCodeImage,
                        upiSettings: shopData.upiSettings,
                        paymentMethods: shopData.paymentMethods
                    };
                    
                    updatePaymentSectionUI(shopData);
                }
            } catch (error) {
                console.error("❌ Error loading fallback shop data:", error);
            }
        }

        function updatePaymentSectionUI(shopData) {
            console.log("🔥 updatePaymentSectionUI CALLED:", shopData);
            
            if (shopData) {
                SHOP_CONFIG = shopData;
                console.log("💾 SHOP_CONFIG saved:", SHOP_CONFIG);
            }
            
            if (!shopData) {
                console.log("❌ No shop data to update UI");
                return;
            }
            
            let upiId = "";
            if (shopData.upiId) {
                upiId = shopData.upiId;
            } else if (shopData.upiSettings && shopData.upiSettings.upiId) {
                upiId = shopData.upiSettings.upiId;
            } else if (shopData.settings && shopData.settings.upiId) {
                upiId = shopData.settings.upiId;
            }
            
            let qrUrl = "";
            if (shopData.qrCodeImage && typeof shopData.qrCodeImage === 'string' && 
                shopData.qrCodeImage.includes('cloudinary.com')) {
                qrUrl = shopData.qrCodeImage;
            } else if (shopData.upiSettings && shopData.upiSettings.qrCodeImage && 
                     typeof shopData.upiSettings.qrCodeImage === 'string' &&
                     shopData.upiSettings.qrCodeImage.includes('cloudinary.com')) {
                qrUrl = shopData.upiSettings.qrCodeImage;
            } else if (shopData.settings && shopData.settings.qrCodeImage &&
                     typeof shopData.settings.qrCodeImage === 'string' &&
                     shopData.settings.qrCodeImage.includes('cloudinary.com')) {
                qrUrl = shopData.settings.qrCodeImage;
            } else if (upiId) {
                qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(upiId)}`;
            } else if (shopData.qrImage) {
                qrUrl = shopData.qrImage;
            } else if (shopData.qrCode) {
                qrUrl = shopData.qrCode;
            }
            
            const upiElement = document.getElementById('displayUpiId');
            const qrElement = document.getElementById('qrCodeImage');
            const qrSection = document.getElementById('qrCodeSection');
            
            if (upiElement) {
                if (upiId) {
                    upiElement.textContent = upiId;
                } else {
                    upiElement.textContent = "UPI ID not configured";
                    upiElement.style.color = "#999";
                }
            }
            
            if (qrElement) {
                if (qrUrl) {
                    const timestamp = Date.now();
                    const separator = qrUrl.includes('?') ? '&' : '?';
                    qrElement.src = qrUrl + separator + 't=' + timestamp;
                    qrElement.alt = "Scan to pay via UPI";
                    qrElement.style.display = 'block';
                } else {
                    qrElement.style.display = 'none';
                }
            }
            
            const upiOption = document.getElementById('upiPaymentOption');
            const codOption = document.getElementById('codPaymentOption');
            
            if (upiOption) {
                let upiEnabled = true;
                if (shopData.paymentMethods) {
                    upiEnabled = shopData.paymentMethods.upi !== false;
                } 
                else if (shopData.upiSettings && shopData.upiSettings.acceptedMethods) {
                    upiEnabled = shopData.upiSettings.acceptedMethods.upi !== false;
                }
                else if (shopData.settings && shopData.settings.paymentMethods) {
                    upiEnabled = shopData.settings.paymentMethods.upi !== false;
                }
                
                if (!upiId && !qrUrl) {
                    upiEnabled = false;
                }
                
                upiOption.style.display = upiEnabled ? 'flex' : 'none';
            }
            
            if (codOption) {
                let codEnabled = true;
                if (shopData.paymentMethods) {
                    codEnabled = shopData.paymentMethods.cash !== false;
                } 
                else if (shopData.upiSettings && shopData.upiSettings.acceptedMethods) {
                    codEnabled = shopData.upiSettings.acceptedMethods.cash !== false;
                }
                else if (shopData.settings && shopData.settings.paymentMethods) {
                    codEnabled = shopData.settings.paymentMethods.cash !== false;
                }
                
                codOption.style.display = codEnabled ? 'flex' : 'none';
            }
            
            if (qrSection) {
                const upiRadio = document.getElementById('paymentMethodUpi');
                if (upiRadio && upiRadio.checked && (upiId || qrUrl)) {
                    qrSection.style.display = 'block';
                }
            }
            
            console.log("✅ updatePaymentSectionUI completed");
        }

        function setupPaymentSelection() {
            console.log("🔧 Setting up payment selection listeners");
            
            const upiRadio = document.getElementById('paymentMethodUpi');
            const codRadio = document.getElementById('paymentMethodCod');
            const qrSection = document.getElementById('qrCodeSection');
            
            if (!upiRadio || !codRadio || !qrSection) {
                console.log("❌ Payment elements not found, retrying in 500ms");
                setTimeout(setupPaymentSelection, 500);
                return;
            }
            
            upiRadio.addEventListener('change', function() {
                if (this.checked) {
                    console.log("🎯 UPI payment selected");
                    qrSection.style.display = 'block';
                    setTimeout(() => {
                        qrSection.style.opacity = '1';
                        qrSection.style.transform = 'translateY(0)';
                    }, 10);
                    
                    if (SHOP_CONFIG) {
                        updatePaymentSectionUI(SHOP_CONFIG);
                    } else {
                        if (cart.length > 0) {
                            loadAndListenToShop();
                        }
                    }
                    
                    selectedPaymentMethod = 'qr';
                }
            });
            
            codRadio.addEventListener('change', function() {
                if (this.checked) {
                    console.log("🎯 COD payment selected");
                    qrSection.style.opacity = '0';
                    qrSection.style.transform = 'translateY(10px)';
                    setTimeout(() => {
                        qrSection.style.display = 'none';
                    }, 300);
                    
                    selectedPaymentMethod = 'cod';
                }
            });
            
            codRadio.checked = true;
            selectedPaymentMethod = 'cod';
            
            qrSection.style.transition = 'all 0.3s ease';
            qrSection.style.opacity = '0';
            qrSection.style.transform = 'translateY(10px)';
            qrSection.style.display = 'none';
            
            console.log("✅ Payment selection setup complete");
        }

        async function loadShopData() {
            try {
                let shopId = 'default_shop';
                if (cart.length > 0) {
                    shopId = cart[0].shopId;
                } else if (PRODUCTS.length > 0) {
                    shopId = PRODUCTS[0].shopId;
                }
                
                const shopDoc = await db.collection('shops').doc(shopId).get();
                if (shopDoc.exists) {
                    SHOP_DATA = shopDoc.data();
                    console.log('✅ Shop data loaded:', SHOP_DATA);
                    
                    if (SHOP_DATA) {
                        SHOP_CONFIG = SHOP_DATA;
                        console.log('💾 SHOP_CONFIG updated from SHOP_DATA');
                    }
                    
                    updateCouponSection();
                }
            } catch (error) {
                console.error('Error loading shop data:', error);
                SHOP_DATA = null;
            }
        }

        async function loadShopCoupons() {
            try {
                const couponsSnapshot = await db.collection('coupons').get();
                SHOP_COUPONS = [];
                couponsSnapshot.forEach(doc => {
                    SHOP_COUPONS.push({ id: doc.id, ...doc.data() });
                });
                console.log('Shop coupons loaded:', SHOP_COUPONS.length);
            } catch (error) {
                console.error('Error loading coupons:', error);
                SHOP_COUPONS = [];
            }
        }

        const AVAILABLE_COUPONS = [
            { code: "WELCOME10", type: "percentage", value: 10, minOrder: 500, description: "Get 10% OFF on orders above ₹500" },
            { code: "FLAT50", type: "fixed", value: 50, minOrder: 300, description: "Get ₹50 OFF on orders above ₹300" }
        ];

        const notificationPreferences = JSON.parse(localStorage.getItem('dukaan_notification_prefs')) || {
            orderUpdates: true,
            priceAlerts: true,
            promotions: true,
            pushEnabled: false
        };

        // Load products from Firebase
        async function loadProductsFromFirebase() {
            try {
                console.log('📦 Loading products from Firebase...');
                const productsSnapshot = await db.collection('products').get();
                
                PRODUCTS = [];
                ALL_CATEGORIES.clear();
                
                productsSnapshot.forEach(doc => {
                    const firebaseProduct = doc.data();
                    
                    if (firebaseProduct.status !== 'active' || firebaseProduct.stock <= 0) {
                        return;
                    }
                    
                    const mappedProduct = {
                        id: doc.id,
                        name: firebaseProduct.name || 'Unnamed Product',
                        price: firebaseProduct.price || 0,
                        mrp: firebaseProduct.mrp || firebaseProduct.price || 0,
                        category: firebaseProduct.category || 'Uncategorized',
                        shopId: firebaseProduct.shopId || 'unknown_shop',
                        shopName: firebaseProduct.shopName || 'Unknown Shop',
                        image: firebaseProduct.image || 'https://images.unsplash.com/photo-1563636619-e9143da7973b?w=400&h=300&fit=crop',
                        stock: firebaseProduct.stock || 0,
                        description: firebaseProduct.description || 'No description available',
                        deliveryTime: firebaseProduct.deliveryTime || '10-15 min',
                        specifications: firebaseProduct.specifications || {},
                        returnPolicy: firebaseProduct.returnPolicy || 'No returns. Contact shopkeeper for any issues.',
                        brand: firebaseProduct.brand || 'Generic',
                        features: firebaseProduct.features || []
                    };
                    
                    PRODUCTS.push(mappedProduct);
                    
                    if (firebaseProduct.category) {
                        ALL_CATEGORIES.add(firebaseProduct.category);
                    }
                });
                
                console.log('✅ Products loaded:', PRODUCTS.length);
                console.log('📋 Categories:', Array.from(ALL_CATEGORIES));
                
                updateDynamicShops();
                updateShopAndCategoryFilters();
                
                if (typeof renderProducts === 'function') {
                    renderProducts(PRODUCTS);
                }
                
            } catch (error) {
                console.error('Error loading products:', error);
                PRODUCTS = getDemoProducts();
                updateDynamicShops();
                updateShopAndCategoryFilters();
                if (typeof renderProducts === 'function') {
                    renderProducts(PRODUCTS);
                }
            }
        }

        function getDemoProducts() {
            return [
                { 
                    id: 'demo1', 
                    name: 'Fresh Cow Milk', 
                    price: 60, 
                    mrp: 70, 
                    category: 'dairy', 
                    shopId: 'freshmart', 
                    shopName: 'FreshMart', 
                    image: 'https://images.unsplash.com/photo-1563636619-e9143da7973b?w=400&h=300&fit=crop', 
                    description: 'Fresh pasteurized cow milk rich in calcium and protein.', 
                    stock: 50,
                    deliveryTime: '10-15 min'
                },
                { 
                    id: 'demo2', 
                    name: 'Face Cream', 
                    price: 199, 
                    mrp: 249, 
                    category: 'cosmetics', 
                    shopId: 'cosmeticstore', 
                    shopName: 'CosmeticStore', 
                    image: 'https://images.unsplash.com/photo-1596462502278-27bfdc403348?w=400&h=300&fit=crop', 
                    description: 'Moisturizing face cream with SPF protection.', 
                    stock: 30,
                    deliveryTime: '15-20 min'
                }
            ];
        }

        function updateDynamicShops() {
            SHOPS = {};
            
            PRODUCTS.forEach(product => {
                const shopId = product.shopId;
                const shopName = product.shopName;
                
                if (shopId && shopName && !SHOPS[shopId]) {
                    SHOPS[shopId] = {
                        id: shopId,
                        name: shopName,
                        category: product.category || 'general',
                        rating: 4.5,
                        deliveryTime: product.deliveryTime || '10-15 min'
                    };
                }
            });
            
            console.log('🛍️ Dynamic shops:', Object.keys(SHOPS).length, 'shops');
        }

        function updateShopAndCategoryFilters() {
            const shopFilter = document.getElementById('shopFilter');
            const categoryFilter = document.getElementById('categoryFilter');
            
            if (shopFilter) {
                shopFilter.innerHTML = '<option value="">All Shops</option>';
                Object.keys(SHOPS).forEach(shopId => {
                    const shop = SHOPS[shopId];
                    shopFilter.innerHTML += `<option value="${shopId}">${shop.name}</option>`;
                });
            }
            
            if (categoryFilter) {
                categoryFilter.innerHTML = '<option value="">All Categories</option>';
                const categories = Array.from(ALL_CATEGORIES).sort();
                categories.forEach(category => {
                    if (category && category.trim() !== '') {
                        categoryFilter.innerHTML += `<option value="${category}">${category}</option>`;
                    }
                });
            }
        }

        // Setup Firebase Auth
        function setupFirebaseAuth() {
            auth.onAuthStateChanged((user) => {
                console.log('Auth state changed:', user);
                if (user) {
                    currentUser = {
                        uid: user.uid,
                        email: user.email,
                        name: user.displayName || user.email.split('@')[0]
                    };
                    showAppScreen();
                    loadUserData();
                    
                    setTimeout(() => {
                        loadOrderHistory();
                        startRealTimeOrderListener();
                    }, 1000);
                    
                    updateCouponAuth();
                    showToast('Welcome back to Raashanmart!');
                    
                    document.getElementById('profileUserEmail').textContent = user.email;
                    document.getElementById('profileUserName').textContent = user.displayName || user.email.split('@')[0];
                    document.getElementById('avatarText').textContent = (user.displayName || user.email.split('@')[0]).charAt(0).toUpperCase();
                    
                    // Setup Firebase Messaging for push notifications
                    setupFirebaseMessaging();
                } else {
                    currentUser = null;
                    showAuthScreen();
                }
            });
        }

        // Load user data
        async function loadUserData() {
            if (!currentUser || !isOnline) return;
            
            try {
                const addressesSnapshot = await db.collection('users').doc(currentUser.uid).collection('addresses').get();
                addresses = [];
                addressesSnapshot.forEach(doc => {
                    addresses.push({ id: doc.id, ...doc.data() });
                });
                localStorage.setItem('userAddresses', JSON.stringify(addresses));
                renderAddresses();

                const wishlistSnapshot = await db.collection('users').doc(currentUser.uid).collection('wishlist').get();
                wishlist = [];
                wishlistSnapshot.forEach(doc => {
                    wishlist.push(doc.id);
                });
                localStorage.setItem('dukaan_wishlist', JSON.stringify(wishlist));
                updateWishlistUI();

            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // Load order history
        async function loadOrderHistory() {
            if (!currentUser || !isOnline) return;

            try {
                console.log("🔄 Loading order history");

                const snapshot = await db
                    .collection('orders')
                    .where('customerId', '==', currentUser.uid)
                    .get();

                orders = [];

                snapshot.forEach(doc => {
                    const firebaseOrder = doc.data();
                    const orderIdToUse = firebaseOrder.orderId || doc.id;

                    let createdDate;
                    if (firebaseOrder.createdAt && firebaseOrder.createdAt.toDate) {
                        createdDate = firebaseOrder.createdAt.toDate();
                    } else {
                        createdDate = new Date(0);
                    }

                    const mappedOrder = {
                        id: orderIdToUse,
                        orderId: orderIdToUse,
                        date: createdDate.toISOString(),
                        createdAt: createdDate.getTime(),
                        items: firebaseOrder.items || [],
                        address: firebaseOrder.address || {},
                        phone: firebaseOrder.phone || '',
                        paymentMethod: firebaseOrder.paymentMethod || 'cod',
                        status: firebaseOrder.status || 'confirmed',
                        subtotal: firebaseOrder.subtotal || firebaseOrder.total || 0,
                        discount: firebaseOrder.discount || 0,
                        total: firebaseOrder.total || 0,
                        tracking: firebaseOrder.tracking || {
                            confirmed: createdDate.toISOString()
                        },
                        refundStatus: firebaseOrder.refundStatus || null,
                        refundAmount: firebaseOrder.refundAmount || 0
                    };

                    orders.push(mappedOrder);
                });

                orders.sort((a, b) => b.createdAt - a.createdAt);

                localStorage.setItem('dukaan_orders', JSON.stringify(orders));
                renderOrders();

            } catch (error) {
                console.error('❌ Error loading order history:', error);

                const savedOrders = localStorage.getItem('dukaan_orders');
                if (savedOrders) {
                    orders = JSON.parse(savedOrders);
                    renderOrders();
                }
            }
        }

        function startRealTimeOrderListener() {
            if (!currentUser) return;

            console.log("🔔 Starting real-time order listener");

            db.collection('orders')
                .where('customerId', '==', currentUser.uid)
                .onSnapshot(snapshot => {

                    snapshot.docChanges().forEach(change => {
                        const data = change.doc.data();
                        const orderIdToUse = data.orderId || change.doc.id;

                        let createdDate;
                        if (data.createdAt && data.createdAt.toDate) {
                            createdDate = data.createdAt.toDate();
                        } else {
                            createdDate = new Date(0);
                        }

                        const updatedOrder = {
                            id: orderIdToUse,
                            orderId: orderIdToUse,
                            date: createdDate.toISOString(),
                            createdAt: createdDate.getTime(),
                            ...data
                        };

                        if (change.type === 'added' || change.type === 'modified') {
                            handleOrderUpdate(updatedOrder);
                        }
                    });

                    orders.sort((a, b) => b.createdAt - a.createdAt);
                    renderOrders();
                });
        }

        // Handle order update
        function handleOrderUpdate(updatedOrder) {
            const orderIndex = orders.findIndex(order => order.id === updatedOrder.id);
            const oldStatus = orderIndex !== -1 ? orders[orderIndex].status : null;
            
            if (orderIndex !== -1) {
                orders[orderIndex] = {
                    ...orders[orderIndex],
                    ...updatedOrder
                };
            } else {
                orders.push(updatedOrder);
            }
            
            localStorage.setItem('dukaan_orders', JSON.stringify(orders));
            renderOrders();
            
            if (oldStatus && oldStatus !== updatedOrder.status) {
                showOrderUpdateNotification(updatedOrder.id, oldStatus, updatedOrder.status);
            }
        }

        function showOrderUpdateNotification(orderId, oldStatus, newStatus) {
            if (!notificationPreferences.orderUpdates) return;

            const statusMessages = {
                'preparing': 'is being prepared',
                'packed': 'has been packed',
                'dispatched': 'has been dispatched',
                'ready_for_pickup': 'is ready for pickup',
                'out_for_delivery': 'is out for delivery',
                'delivered': 'has been delivered'
            };
            
            const message = statusMessages[newStatus];
            if (message) {
                const notification = document.getElementById('orderUpdateNotification');
                notification.innerHTML = `<i class="fas fa-bell"></i> Order #${orderId.slice(-6)} ${message}!`;
                notification.style.display = 'block';
                
                createNotification(
                    `Order Update: #${orderId.slice(-6)}`,
                    `Your order status changed from ${getStatusText(oldStatus)} to ${getStatusText(newStatus)}.`,
                    'success'
                );

                setTimeout(() => {
                    notification.style.display = 'none';
                }, 5000);
            }
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': 'Pending',
                'confirmed': 'Confirmed',
                'preparing': 'Preparing',
                'packed': 'Packed',
                'dispatched': 'Dispatched',
                'ready_for_pickup': 'Ready for Pickup',
                'out_for_delivery': 'Out for Delivery',
                'delivered': 'Delivered',
                'cancelled': 'Cancelled'
            };
            return statusMap[status] || status;
        }

        function getRefundStatusText(status) {
            const statusMap = {
                'pending': 'Pending',
                'processing': 'Processing',
                'completed': 'Completed',
                'rejected': 'Rejected'
            };
            return statusMap[status] || status;
        }

        // Setup offline detection
        function setupOfflineDetection() {
            checkInternetConnection();
            window.addEventListener('online', handleOnlineStatus);
            window.addEventListener('offline', handleOfflineStatus);
        }
        
        function checkInternetConnection() {
            const wasOnline = isOnline;
            isOnline = navigator.onLine;
            
            if (wasOnline !== isOnline) {
                if (isOnline) {
                    handleOnlineStatus();
                } else {
                    handleOfflineStatus();
                }
            }
        }
        
        function handleOnlineStatus() {
            if (isOnline) return;
            isOnline = true;

            console.log('✅ Internet connection restored');
            document.getElementById('offlineNotification').style.display = 'none';
            document.getElementById('offlineOverlay').style.display = 'none';

            const onlineNotification = document.getElementById('onlineNotification');
            onlineNotification.style.display = 'block';
            onlineNotification.innerHTML = '<i class="fas fa-wifi"></i> You are back online';

            setTimeout(() => {
                onlineNotification.style.display = 'none';
            }, 3000);

            if (currentUser) {
                loadProductsFromFirebase();
                loadOrderHistory();
                startRealTimeOrderListener();
                loadShopData();
            }
        }
        
        function handleOfflineStatus() {
            isOnline = false;
            console.log('❌ Internet connection lost');
            const offlineNotification = document.getElementById('offlineNotification');
            offlineNotification.style.display = 'block';
            offlineNotification.innerHTML = '<i class="fas fa-wifi-slash"></i> You are offline';
            showToast('You are offline. Some features may not work.', 'warning');
        }
        
        function checkInternetAndReload() {
            if (navigator.onLine) {
                window.location.reload();
            } else {
                showToast('Still offline. Please check your connection.', 'error');
            }
        }

        // Login handler
        async function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (!userDoc.exists) {
                    await db.collection('users').doc(user.uid).set({
                        email: user.email,
                        name: user.displayName || user.email.split('@')[0],
                        role: 'customer',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else {
                    await db.collection('users').doc(user.uid).update({
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                showToast('Welcome back to Raashanmart!');
                
            } catch (error) {
                console.error('Login error:', error);
                showToast('Login failed: ' + error.message);
            }
        }

        // Signup handler
        async function handleSignup(event) {
            event.preventDefault();
            
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                await userCredential.user.updateProfile({ displayName: name });
                
                await db.collection('users').doc(userCredential.user.uid).set({
                    name: name,
                    email: email,
                    role: 'customer',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showToast('Account created successfully!');
                
            } catch (error) {
                console.error('Signup error:', error);
                if (error.code === 'auth/email-already-in-use') {
                    showToast('Email already registered');
                } else {
                    showToast('Signup failed: ' + error.message);
                }
            }
        }

        // Forgot password
        function showForgotPassword() {
            const email = prompt('Enter your email address to reset password:');
            if (email && email.includes('@')) {
                auth.sendPasswordResetEmail(email)
                    .then(() => {
                        alert('Password reset email sent! Check your inbox.');
                    })
                    .catch(error => {
                        alert('Error: ' + error.message);
                    });
            } else if (email) {
                alert('Please enter a valid email address.');
            }
        }

        // Show auth/app screens
        function showAuthScreen() {
            document.getElementById('authScreen').style.display = 'block';
            document.getElementById('appScreen').style.display = 'none';
            currentUser = null;
        }
        
        function showAppScreen() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('appScreen').style.display = 'block';
            updateCouponAuth();
            renderProducts(PRODUCTS);
        }

        // Apply filters
        function applyFilters() {
            const shopValue = document.getElementById('shopFilter').value;
            const categoryValue = document.getElementById('categoryFilter').value;
            const sortValue = document.getElementById('sortSelect').value;
            
            let filteredProducts = PRODUCTS;
            
            if (shopValue) {
                filteredProducts = filteredProducts.filter(product => product.shopId === shopValue);
            }
            
            if (categoryValue) {
                filteredProducts = filteredProducts.filter(product => product.category === categoryValue);
            }
            
            applySortingToProducts(filteredProducts, sortValue);
        }

        // Apply sorting
        function applySortingToProducts(products, sortType) {
            let sortedProducts = [...products];
            
            switch(sortType) {
                case 'price_high_low':
                    sortedProducts.sort((a, b) => b.price - a.price);
                    break;
                case 'price_low_high':
                    sortedProducts.sort((a, b) => a.price - b.price);
                    break;
                case 'newest':
                    sortedProducts.sort((a, b) => b.id.localeCompare(a.id));
                    break;
            }
            
            renderProducts(sortedProducts);
        }

        function addToCartFromDetail() {
            if (!currentProductDetail) return;
            
            const quantity = parseInt(document.getElementById('quantityValue').textContent);
            const product = PRODUCTS.find(p => p.id === currentProductDetail.id);
            
            if (!product) return;
            
            // Check if cart already has items from different shop
            if (cart.length > 0) {
                const firstShopId = cart[0].shopId;
                if (firstShopId !== product.shopId) {
                    showToast(`Cannot add items from different shops. Please complete your order from ${cart[0].shopName} first.`, 'warning');
                    return;
                }
            }
            
            const existingItem = cart.find(item => item.id === product.id);
            
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    image: product.image,
                    quantity: quantity,
                    shopId: product.shopId,
                    shopName: product.shopName
                });
            }
            
            localStorage.setItem('dukaan_cart', JSON.stringify(cart));
            updateCartUI();
            showToast('Product added to cart!');
            
            // Load shop data for coupon validation
            loadShopData();
        }

        function toggleWishlistFromDetail() {
            if (!currentProductDetail) return;
            toggleWishlist(currentProductDetail.id);
            
            const wishlistBtn = document.getElementById('wishlistDetailBtn');
            const isInWishlist = wishlist.includes(currentProductDetail.id);
            wishlistBtn?.classList.toggle('active', isInWishlist);
        }

        // Address functions
        function renderAddresses() {
            const addressesContainer = document.getElementById('addresses');
            if (!addressesContainer) return;
            
            addressesContainer.innerHTML = '';
            
            if (addresses.length === 0) {
                addressesContainer.innerHTML = '<p class="text-muted">No addresses saved. Add your first address below.</p>';
                return;
            }
            
            const uniqueAddresses = new Set();
            const filteredAddresses = [];
            
            addresses.forEach(address => {
                const addressKey = `${address.name || ''}-${address.address || ''}-${address.city || ''}-${address.pincode || ''}`;
                if (!uniqueAddresses.has(addressKey)) {
                    uniqueAddresses.add(addressKey);
                    filteredAddresses.push(address);
                }
            });
            
            filteredAddresses.forEach(address => {
                const isSelected = selectedAddress === address.id;
                const addressCard = document.createElement('div');
                addressCard.className = `address-card ${isSelected ? 'selected' : ''}`;
                addressCard.innerHTML = `
                    <div class="address-title">
                        ${address.type === 'home' ? '🏠 Home' : address.type === 'work' ? '💼 Work' : '📍 Other'}
                        ${address.isDefault ? '<span class="badge bg-success ms-2">Default</span>' : ''}
                    </div>
                    <div class="address-details">${address.name || 'Customer'} • ${address.address || ''}</div>
                    <div class="address-phone">${address.phone || 'No phone'} • ${address.city || ''} - ${address.pincode || ''}</div>
                `;
                addressCard.onclick = () => {
                    selectedAddress = address.id;
                    renderAddresses();
                    fillCheckoutForm(address);
                };
                addressesContainer.appendChild(addressCard);
            });
        }

        function fillCheckoutForm(address) {
            document.getElementById('checkoutName').value = address.name || '';
            document.getElementById('checkoutPhone').value = address.phone || '';
            document.getElementById('checkoutCity').value = address.city || '';
            document.getElementById('checkoutPincode').value = address.pincode || '';
            document.getElementById('checkoutAddress').value = address.address || '';
        }

        function savedAddresses() {
            closeSavedAddressesModal();
            
            const savedAddresses = JSON.parse(localStorage.getItem('userAddresses') || '[]');
            let addressListHTML = '';
            
            if (savedAddresses.length === 0) {
                addressListHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-map-marker-alt" style="font-size: 48px; color: var(--text-light); margin-bottom: 15px;"></i>
                        <h4 style="color: var(--text-light);">No Saved Addresses</h4>
                        <p style="color: var(--text-light);">You haven't saved any addresses yet</p>
                    </div>
                `;
            } else {
                addressListHTML = savedAddresses.map((address) => `
                    <div class="address-card" id="address-${address.id}">
                        <div class="address-title">
                            ${address.type === 'home' ? '🏠 Home' : address.type === 'work' ? '💼 Work' : '📍 Other'}
                            ${address.isDefault ? '<span class="badge bg-success ms-2">Default</span>' : ''}
                        </div>
                        <div class="address-details">${address.name || 'Customer'} • ${address.address || ''}</div>
                        <div class="address-phone">${address.phone || 'No phone'} • ${address.city || ''} - ${address.pincode || ''}</div>
                        <div class="address-actions mt-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="editSavedAddress('${address.id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-outline-danger ms-2" onclick="deleteSavedAddress('${address.id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                            ${!address.isDefault ? `
                                <button class="btn btn-sm btn-outline-success ms-2" onclick="setDefaultAddress('${address.id}')">
                                    <i class="fas fa-check"></i> Set Default
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            }

            const modalHTML = `
            <div class="modal-overlay active" id="savedAddressesModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Saved Addresses</h3>
                        <button class="modal-close" onclick="closeSavedAddressesModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="addresses-list">
                            ${addressListHTML}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-outline" onclick="closeSavedAddressesModal()">Close</button>
                        <button type="button" class="btn-primary" onclick="addNewAddress()">
                            <i class="fas fa-plus"></i> Add New Address
                        </button>
                    </div>
                </div>
            </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeSavedAddressesModal() {
            const modal = document.getElementById('savedAddressesModal');
            if (modal) {
                modal.remove();
            }
        }

        function addNewAddress() {
            closeSavedAddressesModal();
            closeAddAddressModal();
            
            const modalHTML = `
            <div class="modal-overlay active" id="addAddressModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Add New Address</h3>
                        <button class="modal-close" onclick="closeAddAddressModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Full Name *</label>
                            <input type="text" class="form-control" id="addressName" placeholder="Enter full name" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone Number (Optional)</label>
                            <input type="tel" class="form-control" id="addressPhone" placeholder="Enter phone number" oninput="validatePhoneModal(this)">
                            <small id="phoneValidationModal" class="validation-message"></small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Pincode *</label>
                            <input type="text" class="form-control" id="addressPincode" placeholder="Enter pincode" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Address *</label>
                            <textarea class="form-control" id="addressLine1" placeholder="House no., Building, Street" rows="2" required></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Landmark (Optional)</label>
                            <input type="text" class="form-control" id="addressLandmark" placeholder="Nearby landmark">
                        </div>
                        <div class="form-group">
                            <label class="form-label">City *</label>
                            <input type="text" class="form-control" id="addressCity" placeholder="Enter city" required>
                        </div>
                        <div class="form-group form-check">
                            <input type="checkbox" class="form-check-input" id="defaultAddress">
                            <label class="form-check-label" for="defaultAddress">Set as default address</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-outline" onclick="closeAddAddressModal()">Cancel</button>
                        <button type="button" class="btn-primary" onclick="saveNewAddressModal()">Save Address</button>
                    </div>
                </div>
            </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeAddAddressModal() {
            const modal = document.getElementById('addAddressModal');
            if (modal) modal.remove();
        }

        function saveNewAddressModal() {
            const name = document.getElementById('addressName').value.trim();
            const phone = document.getElementById('addressPhone').value.trim();
            const pincode = document.getElementById('addressPincode').value.trim();
            const address = document.getElementById('addressLine1').value.trim();
            const city = document.getElementById('addressCity').value.trim();
            const landmark = document.getElementById('addressLandmark').value.trim();
            const isDefault = document.getElementById('defaultAddress').checked;

            if (!name || !pincode || !address || !city) {
                showToast("Please fill all required fields", 'error');
                return;
            }
            if (phone && !validatePhoneNumber(phone)) {
                showToast("Please enter a valid phone number", 'error');
                return;
            }

            try {
                let addresses = JSON.parse(localStorage.getItem('userAddresses') || '[]');
                
                const newAddress = {
                    id: 'addr_' + Date.now() + Math.random().toString(36).substr(2, 4),
                    name: name,
                    phone: phone || '',
                    pincode: pincode,
                    address: address,
                    city: city,
                    landmark: landmark || '',
                    type: 'home',
                    isDefault: isDefault,
                    createdAt: new Date().toISOString()
                };

                if (isDefault) {
                    addresses.forEach(addr => addr.isDefault = false);
                    newAddress.isDefault = true;
                }
                if (addresses.length === 0) {
                    newAddress.isDefault = true;
                }

                addresses.push(newAddress);
                localStorage.setItem('userAddresses', JSON.stringify(addresses));
                window.addresses = addresses;
                
                if (currentUser && isOnline) {
                    db.collection('users').doc(currentUser.uid).collection('addresses').add(newAddress).catch(error => {
                        console.error('Error saving address to Firebase:', error);
                    });
                }

                showToast('Address saved successfully!', 'success');
                closeAddAddressModal();
                
                setTimeout(() => {
                    if (document.getElementById('savedAddressesModal')) {
                        savedAddresses();
                    }
                    renderAddresses();
                }, 50);

            } catch (error) {
                console.error("Error saving address:", error);
                showToast("Error saving address: " + error.message, 'error');
            }
        }

        function editSavedAddress(addressId) {
            const addresses = JSON.parse(localStorage.getItem('userAddresses') || '[]');
            const address = addresses.find(addr => addr.id === addressId);
            
            if (!address) {
                showToast('Address not found', 'error');
                return;
            }

            const modalHTML = `
            <div class="modal-overlay active" id="editAddressModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Edit Address</h3>
                        <button class="modal-close" onclick="closeEditAddressModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Full Name *</label>
                            <input type="text" class="form-control" id="editAddressName" value="${address.name || ''}" placeholder="Enter full name" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone Number (Optional)</label>
                            <input type="tel" class="form-control" id="editAddressPhone" value="${address.phone || ''}" placeholder="Enter phone number" oninput="validatePhoneModal(this)">
                            <small id="phoneValidationModal" class="validation-message"></small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Pincode *</label>
                            <input type="text" class="form-control" id="editAddressPincode" value="${address.pincode || ''}" placeholder="Enter pincode" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Address *</label>
                            <textarea class="form-control" id="editAddressLine1" placeholder="House no., Building, Street" rows="2" required>${address.address || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Landmark (Optional)</label>
                            <input type="text" class="form-control" id="editAddressLandmark" value="${address.landmark || ''}" placeholder="Nearby landmark">
                        </div>
                        <div class="form-group">
                            <label class="form-label">City *</label>
                            <input type="text" class="form-control" id="editAddressCity" value="${address.city || ''}" placeholder="Enter city" required>
                        </div>
                        <div class="form-group form-check">
                            <input type="checkbox" class="form-check-input" id="editDefaultAddress" ${address.isDefault ? 'checked' : ''}>
                            <label class="form-check-label" for="editDefaultAddress">Set as default address</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-outline" onclick="closeEditAddressModal()">Cancel</button>
                        <button type="button" class="btn-primary" onclick="updateAddress('${addressId}')">Update Address</button>
                    </div>
                </div>
            </div>
            `;
            
            closeSavedAddressesModal();
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeEditAddressModal() {
            const modal = document.getElementById('editAddressModal');
            if (modal) modal.remove();
            savedAddresses();
        }

        async function updateAddress(addressId) {
            const name = document.getElementById('editAddressName').value.trim();
            const phone = document.getElementById('editAddressPhone').value.trim();
            const pincode = document.getElementById('editAddressPincode').value.trim();
            const address = document.getElementById('editAddressLine1').value.trim();
            const city = document.getElementById('editAddressCity').value.trim();
            const landmark = document.getElementById('editAddressLandmark').value.trim();
            const isDefault = document.getElementById('editDefaultAddress').checked;

            if (!name || !pincode || !address || !city) { 
                showToast("Please fill all required fields", 'error'); 
                return; 
            }
            if (phone && !validatePhoneNumber(phone)) { 
                showToast("Please enter a valid phone number", 'error'); 
                return; 
            }

            try {
                let addresses = JSON.parse(localStorage.getItem('userAddresses') || '[]');
                const addressIndex = addresses.findIndex(addr => addr.id === addressId);
                
                if (addressIndex === -1) {
                    showToast("Address not found", 'error');
                    return;
                }

                if (isDefault) {
                    addresses.forEach(addr => addr.isDefault = false);
                }

                addresses[addressIndex] = {
                    ...addresses[addressIndex],
                    name,
                    phone: phone || '',
                    pincode,
                    address,
                    city,
                    landmark: landmark || '',
                    isDefault,
                    updatedAt: new Date().toISOString()
                };

                localStorage.setItem('userAddresses', JSON.stringify(addresses));
                window.addresses = addresses;
                
                if (currentUser && isOnline) {
                    const firebaseDocId = addresses[addressIndex].firebaseDocId;
                    if (firebaseDocId) {
                        await db.collection('users').doc(currentUser.uid).collection('addresses').doc(firebaseDocId).update(addresses[addressIndex]);
                    }
                }
                
                showToast('Address updated successfully!', 'success');
                closeEditAddressModal();
                renderAddresses();
                
            } catch (error) {
                console.error("Error updating address:", error);
                showToast("Error updating address: " + error.message, 'error');
            }
        }

        async function deleteSavedAddress(addressId) {
            if (!confirm('Are you sure you want to delete this address?')) {
                return;
            }

            try {
                let addresses = JSON.parse(localStorage.getItem('userAddresses') || '[]');
                const addressToDelete = addresses.find(addr => addr.id === addressId);
                
                if (addressToDelete && addressToDelete.isDefault) {
                    showToast("Cannot delete default address. Set another address as default first.", 'error');
                    return;
                }

                addresses = addresses.filter(addr => addr.id !== addressId);
                localStorage.setItem('userAddresses', JSON.stringify(addresses));
                window.addresses = addresses;

                if (currentUser && isOnline) {
                    const firebaseDocId = addressToDelete.firebaseDocId;
                    if (firebaseDocId) {
                        await db.collection('users').doc(currentUser.uid).collection('addresses').doc(firebaseDocId).delete();
                    }
                }

                showToast('Address deleted successfully!', 'success');
                closeSavedAddressesModal();
                setTimeout(() => savedAddresses(), 100);
                renderAddresses();
                
            } catch (error) {
                console.error("Error deleting address:", error);
                showToast("Error deleting address: " + error.message, 'error');
            }
        }

        function setDefaultAddress(addressId) {
            try {
                const addresses = JSON.parse(localStorage.getItem('userAddresses') || '[]');
                addresses.forEach(addr => {
                    addr.isDefault = (addr.id === addressId);
                });

                localStorage.setItem('userAddresses', JSON.stringify(addresses));
                window.addresses = addresses;
                
                showToast('Default address updated!', 'success');
                closeSavedAddressesModal();
                setTimeout(() => savedAddresses(), 100);
                renderAddresses();
                
            } catch (error) {
                console.error("Error setting default address:", error);
                showToast("Error setting default address: " + error.message, 'error');
            }
        }

        // Phone validation
        function validatePhoneNumber(phone) {
            return /^[6-9]\d{9}$/.test(phone);
        }

        function validatePhoneModal(inputElement) {
            const phone = inputElement.value.trim();
            const isValid = validatePhoneNumber(phone);
            const validationElement = document.getElementById('phoneValidationModal');
            
            inputElement.classList.remove('phone-valid', 'phone-invalid');
            validationElement.textContent = '';
            
            if (phone.length === 0) return;

            if (isValid) {
                inputElement.classList.add('phone-valid');
                validationElement.textContent = '✓ Valid phone number';
                validationElement.className = 'validation-message validation-success';
            } else {
                inputElement.classList.add('phone-invalid');
                validationElement.textContent = 'Please enter a valid 10-digit phone number';
                validationElement.className = 'validation-message validation-error';
            }
        }

        // Order functions
        function renderOrders() {
            const ordersList = document.getElementById('ordersList');
            const noOrders = document.getElementById('noOrders');
            
            if (!ordersList) return;

            ordersList.innerHTML = '';
            
            if (orders.length === 0) {
                noOrders.style.display = 'block';
                return;
            }
            
            noOrders.style.display = 'none';
            
            const sortedOrders = [...orders].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedOrders.forEach(order => {
                const orderCard = document.createElement('div');
                orderCard.className = 'order-card';
                orderCard.setAttribute('data-order-id', order.id);
                
                const statusClass = `status-${order.status.replace(/_/g, '-')}`;
                const statusText = getStatusText(order.status);
                const displayOrderId = order.orderId || order.id;
                
                const orderDate = new Date(order.date);
                const now = new Date();
                const isNewOrder = (now - orderDate) < 24 * 60 * 60 * 1000;
                
                let refundSection = '';
                if (order.refundStatus) {
                    const refundStatusText = getRefundStatusText(order.refundStatus);
                    const refundStatusClass = `refund-${order.refundStatus}`;
                    refundSection = `
                        <div class="mt-3 p-2" style="background: var(--neutral); border-radius: 8px;">
                            <strong>Refund Status:</strong>
                            <span class="refund-status ${refundStatusClass}">${refundStatusText}</span>
                            ${order.refundAmount > 0 ? `<div class="mt-1">Amount: ₹${order.refundAmount}</div>` : ''}
                        </div>
                    `;
                }
                
                orderCard.innerHTML = `
                    <div class="order-header">
                        <div class="order-id">
                            Order #${displayOrderId.slice(-6)}
                            ${isNewOrder ? '<span class="new-order-badge">NEW</span>' : ''}
                        </div>
                        <div class="order-status ${statusClass}">${statusText}</div>
                    </div>
                    <div class="order-items">
                        ${order.items.map(item => `
                            <div class="order-item">
                                <span>${item.name} × ${item.quantity}</span>
                                <span>₹${item.price * item.quantity}</span>
                            </div>
                        `).join('')}
                    </div>
                    ${refundSection}
                    <div class="order-footer">
                        <div class="order-total">₹${order.total}</div>
                        <div class="order-actions">
                            <button class="btn-reorder" onclick="reorder('${order.id}')">
                                <i class="fas fa-redo"></i> Reorder
                            </button>
                            <button class="btn-outline" onclick="shareOrder('${order.id}')">
                                <i class="fas fa-share"></i> Share
                            </button>
                            ${['pending', 'confirmed', 'preparing'].includes(order.status) ? `
                                <button class="btn-outline btn-danger" onclick="cancelOrder('${order.id}')" style="background: var(--danger); color: white;">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
                ordersList.appendChild(orderCard);
            });
        }

        function reorder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            order.items.forEach(item => {
                const existingItem = cart.find(cartItem => cartItem.id === item.id);
                if (existingItem) {
                    existingItem.quantity += item.quantity;
                } else {
                    cart.push({...item});
                }
            });
            
            localStorage.setItem('dukaan_cart', JSON.stringify(cart));
            updateCartUI();
            showToast('Items added to cart!');
            openBottomSheet();
        }

        function cancelOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            if (!['pending', 'confirmed', 'preparing'].includes(order.status)) {
                showToast('Order cannot be cancelled after processing started.', 'error');
                return;
            }

            showConfirmationModal(
                'Cancel Order',
                `Are you sure you want to cancel Order #${orderId.slice(-6)}? This action cannot be undone.`,
                async () => {
                    const orderIndex = orders.findIndex(o => o.id === orderId);
                    if (orderIndex !== -1) {
                        orders[orderIndex].status = 'cancelled';
                        localStorage.setItem('dukaan_orders', JSON.stringify(orders));
                        renderOrders();
                        
                        if (isOnline) {
                            try {
                                const docToUpdate = await db.collection('orders').where('orderId', '==', orderId).get();
                                if (!docToUpdate.empty) {
                                    const firestoreDocId = docToUpdate.docs[0].id;
                                    await db.collection('orders').doc(firestoreDocId).update({
                                        status: 'cancelled',
                                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                    });
                                }
                            } catch(error) {
                                console.error("Firebase update failed on cancel:", error);
                            }
                        }

                        showToast('Order cancelled successfully', 'success');
                    }
                }
            );
        }

        function shareOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            const orderDetails = `
Order #${orderId.slice(-6)}
Status: ${getStatusText(order.status)}
Total: ₹${order.total}
Items: ${order.items.map(item => `${item.name} (Qty: ${item.quantity})`).join(', ')}
Placed on: ${new Date(order.date).toLocaleDateString()}
            `.trim();
            
            if (navigator.share) {
                navigator.share({
                    title: `My Dukaan Order #${orderId.slice(-6)}`,
                    text: orderDetails,
                    url: window.location.href
                }).then(() => {
                    showToast('Order shared successfully!');
                }).catch(error => {
                    console.log('Error sharing:', error);
                    fallbackShare(orderDetails);
                });
            } else {
                fallbackShare(orderDetails);
            }
        }

        function fallbackShare(orderDetails) {
            navigator.clipboard.writeText(orderDetails).then(() => {
                showToast('Order details copied to clipboard!');
            }).catch(() => {
                alert('Order Details:\n\n' + orderDetails);
            });
        }

        // Update cart quantity (for bottom sheet)
        function updateCartQuantity(index, change) {
            if (cart[index]) {
                const newQuantity = cart[index].quantity + change;

                if (newQuantity <= 0) {
                    cart.splice(index, 1);
                    showToast('Item removed from cart');
                } else if (newQuantity > 10) {
                    cart[index].quantity = 10;
                    showToast('Maximum 10 items allowed');
                    return;
                } else {
                    cart[index].quantity = newQuantity;
                }
                
                localStorage.setItem('dukaan_cart', JSON.stringify(cart));
                updateCartUI();
                
                // Re-validate coupon after quantity change
                if (appliedCoupon) {
                    validateCouponOnCartUpdate();
                }
            }
        }

        // Validate coupon on cart update
        function validateCouponOnCartUpdate() {
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            if (appliedCoupon && subtotal < appliedCoupon.minOrder) {
                appliedCoupon = null;
                document.getElementById('couponCode').value = '';
                document.getElementById('couponMessage').textContent = 'Cart value is below coupon minimum. Coupon removed.';
                document.getElementById('couponMessage').className = 'coupon-error';
                updateOrderSummary();
                showToast('Coupon removed due to low cart value', 'warning');
            }
        }

        function showLoading(show) {
            const placeOrderBtn = document.getElementById('placeOrderBtn');
            if (!placeOrderBtn) return;
            
            if (show) {
                placeOrderBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                placeOrderBtn.disabled = true;
            } else {
                placeOrderBtn.innerHTML = '<i class="fas fa-lock"></i> Place Order Securely';
                placeOrderBtn.disabled = cart.length === 0;
            }
        }

        // Profile functions
        function editPersonalDetails() {
            const user = firebase.auth().currentUser;
            const currentName = user.displayName || "";
            const currentEmail = user.email || "";
            
            if (currentUser && isOnline) {
                db.collection('users').doc(currentUser.uid).get().then(doc => {
                    let currentPhone = '';
                    if (doc.exists) {
                        currentPhone = doc.data().phone || '';
                    }
                    showEditProfileModal(currentName, currentEmail, currentPhone);
                }).catch(error => {
                    console.error('Error fetching user phone:', error);
                    showEditProfileModal(currentName, currentEmail, '');
                });
            } else {
                showEditProfileModal(currentName, currentEmail, '');
            }
        }
        
        function showEditProfileModal(currentName, currentEmail, currentPhone) {
            const modalHTML = `
            <div class="modal-overlay active" id="editProfileModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Edit Profile</h3>
                        <button class="modal-close" onclick="closeEditProfileModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="editUserName" value="${currentName}" placeholder="Enter your full name">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email Address</label>
                            <input type="email" class="form-control" id="editUserEmail" value="${currentEmail}" readonly style="background: #f8f9fa;">
                            <small class="text-muted">Email cannot be changed</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone Number (Optional)</label>
                            <input type="tel" class="form-control" id="editUserPhone" value="${currentPhone}" placeholder="Enter phone number" oninput="validatePhoneModal(this)">
                             <small id="phoneValidationModal" class="validation-message"></small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-outline" onclick="closeEditProfileModal()">Cancel</button>
                        <button type="button" class="btn-primary" onclick="processProfileUpdate()">Save Changes</button>
                    </div>
                </div>
            </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeEditProfileModal() {
            const modal = document.getElementById('editProfileModal');
            if (modal) modal.remove();
        }

        async function processProfileUpdate() {
            const newName = document.getElementById('editUserName').value.trim();
            const newPhone = document.getElementById('editUserPhone').value.trim();
            
            if (!newName) {
                showToast("Name cannot be empty", 'error');
                return;
            }
            if (newPhone && !validatePhoneNumber(newPhone)) {
                showToast("Please enter a valid phone number", 'error');
                return;
            }
            
            const user = firebase.auth().currentUser;
            
            try {
                if (newName !== user.displayName) {
                    await user.updateProfile({ displayName: newName });
                    currentUser.name = newName;
                }
                
                if (currentUser && isOnline) {
                    const updateData = {
                        name: newName,
                        phone: newPhone
                    };
                    await db.collection('users').doc(currentUser.uid).update(updateData);
                    currentUser.phone = newPhone;
                }

                showToast("Profile updated successfully!", 'success');
                document.getElementById('profileUserName').textContent = newName;
                document.getElementById('avatarText').textContent = newName.charAt(0).toUpperCase();

                closeEditProfileModal();
                
            } catch (error) {
                console.error("Profile update error:", error);
                showToast("Error updating profile: " + error.message, 'error');
            }
        }

        // Change Password Function
        function changePassword() {
            const modalHTML = `
            <div class="modal-overlay active" id="changePasswordModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Change Password</h3>
                        <button class="modal-close" onclick="closeChangePasswordModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Current Password</label>
                            <input type="password" class="form-control" id="currentPassword" placeholder="Enter current password" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">New Password</label>
                            <input type="password" class="form-control" id="newPassword" placeholder="Enter new password" required>
                            <small class="text-muted">Password must be at least 6 characters long</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Confirm New Password</label>
                            <input type="password" class="form-control" id="confirmPassword" placeholder="Confirm new password" required>
                        </div>
                        <div id="passwordError" class="alert alert-danger" style="display: none;"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-outline" onclick="closeChangePasswordModal()">Cancel</button>
                        <button type="button" class="btn-primary" onclick="updatePassword()">Change Password</button>
                    </div>
                </div>
            </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeChangePasswordModal() {
            const modal = document.getElementById('changePasswordModal');
            if (modal) modal.remove();
        }

        async function updatePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorElement = document.getElementById('passwordError');
            
            errorElement.style.display = 'none';
            errorElement.textContent = '';
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                errorElement.textContent = 'Please fill all fields';
                errorElement.style.display = 'block';
                return;
            }
            
            if (newPassword.length < 6) {
                errorElement.textContent = 'New password must be at least 6 characters long';
                errorElement.style.display = 'block';
                return;
            }
            
            if (newPassword !== confirmPassword) {
                errorElement.textContent = 'New passwords do not match';
                errorElement.style.display = 'block';
                return;
            }
            
            if (newPassword === currentPassword) {
                errorElement.textContent = 'New password must be different from current password';
                errorElement.style.display = 'block';
                return;
            }
            
            const user = firebase.auth().currentUser;
            
            try {
                const credential = firebase.auth.EmailAuthProvider.credential(user.email, currentPassword);
                await user.reauthenticateWithCredential(credential);
                
                await user.updatePassword(newPassword);
                
                showToast('Password changed successfully!', 'success');
                closeChangePasswordModal();
                
            } catch (error) {
                console.error('Password change error:', error);
                
                let errorMessage = 'Error changing password: ';
                switch(error.code) {
                    case 'auth/wrong-password':
                        errorMessage = 'Current password is incorrect';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'New password is too weak';
                        break;
                    case 'auth/requires-recent-login':
                        errorMessage = 'Please login again and try';
                        break;
                    default:
                        errorMessage = error.message;
                }
                
                errorElement.textContent = errorMessage;
                errorElement.style.display = 'block';
            }
        }

        // Wishlist functions
        function toggleWishlist(productId) {
            const index = wishlist.indexOf(productId);
            
            if (index > -1) {
                wishlist.splice(index, 1);
                showToast('Removed from wishlist');
            } else {
                wishlist.push(productId);
                showToast('Added to wishlist');
            }
            
            localStorage.setItem('dukaan_wishlist', JSON.stringify(wishlist));
            updateWishlistUI();
            renderProducts(PRODUCTS);
            renderWishlistItems();
        }

        function updateWishlistUI() {
            const wishlistCount = document.getElementById('wishlistCount');
            if (wishlistCount) {
                wishlistCount.textContent = wishlist.length;
                wishlistCount.style.display = wishlist.length > 0 ? 'block' : 'none';
            }
        }

        // Render wishlist items
        function renderWishlistItems() {
            const wishlistItems = document.getElementById('wishlistItems');
            const noWishlist = document.getElementById('noWishlist');
            
            if (!wishlistItems) return;

            wishlistItems.innerHTML = '';
            
            if (wishlist.length === 0) {
                if (noWishlist) noWishlist.style.display = 'block';
                return;
            }
            
            if (noWishlist) noWishlist.style.display = 'none';
            
            wishlist.forEach(productId => {
                const product = PRODUCTS.find(p => p.id === productId);
                if (!product) return;
                
                const shopName = product.shopName || 'Unknown Shop';
                const discount = product.mrp ? Math.round(((product.mrp - product.price) / product.mrp) * 100) : 0;
                const cartItem = cart.find(item => item.id === product.id);
                const quantity = cartItem ? cartItem.quantity : 0;
                
                let actionButton = '';
                if (quantity > 0) {
                    actionButton = `
                        <div class="btn-quantity-card" data-product-id="${product.id}">
                            <button class="quantity-btn-card" onclick="decreaseCartQuantity('${product.id}')">-</button>
                            <span class="quantity-value-card">${quantity}</span>
                            <button class="quantity-btn-card" onclick="increaseCartQuantity('${product.id}')">+</button>
                        </div>
                    `;
                } else {
                    actionButton = `
                        <button class="btn-add-cart" onclick="addToCart('${product.id}')">
                            <i class="fas fa-shopping-cart"></i> Add to Cart
                        </button>
                    `;
                }
                
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.setAttribute('data-product-id', product.id);
                productCard.innerHTML = `
                    <div class="shop-badge">${shopName}</div>
                    <button class="wishlist-btn active" onclick="toggleWishlist('${product.id}')">
                        <i class="fas fa-heart"></i>
                    </button>
                    <img src="${product.image}" alt="${product.name}" class="product-image" onclick="showProductDetail('${product.id}')">
                    <h3 class="product-title" onclick="showProductDetail('${product.id}')">${product.name}</h3>
                    <p class="product-category">${product.category} • ${product.deliveryTime || '10-15 min'}</p>
                    <div class="product-price">
                        <span class="current-price">₹${product.price}</span>
                        ${product.mrp ? `<span class="original-price">₹${product.mrp}</span>` : ''}
                        ${discount > 0 ? `<span class="discount">${discount}% OFF</span>` : ''}
                    </div>
                    <div class="card-actions">
                        ${actionButton}
                    </div>
                `;
                wishlistItems.appendChild(productCard);
            });
        }

        // Product detail functions
        function showProductDetail(productId) {
            const product = PRODUCTS.find(p => p.id === productId);
            if (!product) return;
            
            currentProductDetail = product;
            const shop = SHOPS[product.shopId] || { name: product.shopName || 'Unknown Shop', deliveryTime: product.deliveryTime || '10-15 min' };
            const discount = product.mrp ? Math.round(((product.mrp - product.price) / product.mrp) * 100) : 0;
            const isInWishlist = wishlist.includes(product.id);
            
            document.getElementById('productDetailImage').src = product.image;
            document.getElementById('productDetailTitle').textContent = product.name;
            document.getElementById('productDetailCategory').textContent = `${product.category} • ${shop.name} • ${shop.deliveryTime}`;
            document.getElementById('productDetailCurrent').textContent = `₹${product.price}`;
            document.getElementById('productDetailOriginal').textContent = product.mrp ? `₹${product.mrp}` : '';
            document.getElementById('productDetailDiscount').textContent = discount > 0 ? `${discount}% OFF` : '';
            document.getElementById('productDetailDescription').textContent = product.description;
            
            const wishlistBtn = document.getElementById('wishlistDetailBtn');
            if (wishlistBtn) {
                wishlistBtn.classList.toggle('active', isInWishlist);
            }
            
            document.getElementById('quantityValue').textContent = '1';
            
            document.getElementById('homePage').style.display = 'none';
            document.getElementById('productDetailPage').style.display = 'block';
            
            // Update current page for back button handling
            currentPage = 'productDetail';
        }

        function closeProductDetail() {
            document.getElementById('productDetailPage').style.display = 'none';
            document.getElementById('homePage').style.display = 'block';
            currentPage = 'home';
        }

        function changeQuantity(change) {
            const quantityElement = document.getElementById('quantityValue');
            if (!quantityElement) return;

            let quantity = parseInt(quantityElement.textContent);
            quantity += change;
            
            if (quantity < 1) quantity = 1;
            if (quantity > 10) quantity = 10;
            
            quantityElement.textContent = quantity;
        }

        // Coupon functions
        function updateCouponSection() {
            const couponSection = document.querySelector('.coupon-section');
            const applyCouponBtn = document.getElementById('applyCouponBtn');
            
            if (!SHOP_DATA) {
                if (applyCouponBtn) {
                    applyCouponBtn.disabled = true;
                }
                return;
            }
            
            const couponsEnabled = SHOP_DATA.couponEnabled || false;
            
            if (!couponsEnabled) {
                if (couponSection) {
                    couponSection.innerHTML = `
                        <div class="text-center text-muted p-3">
                            <i class="fas fa-tag" style="font-size: 24px; margin-bottom: 10px;"></i>
                            <p>Coupons are currently disabled by the shopkeeper</p>
                        </div>
                    `;
                }
                if (applyCouponBtn) {
                    applyCouponBtn.disabled = true;
                }
                return;
            }
            
            const hasCoupons = SHOP_DATA.couponCode || SHOP_DATA.couponSettings;
            
            if (hasCoupons) {
                if (applyCouponBtn) {
                    applyCouponBtn.disabled = !currentUser;
                }
            } else {
                if (couponSection) {
                    couponSection.innerHTML = `
                        <div class="text-center text-muted p-3">
                            <i class="fas fa-tag" style="font-size: 24px; margin-bottom: 10px;"></i>
                            <p>No coupons available at the moment</p>
                        </div>
                    `;
                }
                if (applyCouponBtn) {
                    applyCouponBtn.disabled = true;
                }
            }
        }

        function applyCoupon() {
            if (!SHOP_DATA || !SHOP_DATA.couponEnabled) {
                showToast('Coupons are currently disabled by the shopkeeper', 'warning');
                return;
            }
            
            if (!currentUser) {
                showToast('Please login to apply coupons');
                return;
            }
            
            const couponCode = document.getElementById('couponCode').value.trim().toUpperCase();
            const couponMessage = document.getElementById('couponMessage');
            
            if (!couponCode) {
                appliedCoupon = null;
                couponMessage.textContent = '';
                updateOrderSummary();
                showToast('Coupon removed');
                return;
            }
            
            let coupon = null;
            const shopCouponCode = SHOP_DATA.couponCode;
            const shopCouponSettings = SHOP_DATA.couponSettings;
            
            if (shopCouponCode && shopCouponCode.toUpperCase() === couponCode) {
                if (shopCouponSettings) {
                    coupon = {
                        code: shopCouponCode,
                        type: shopCouponSettings.discountType || 'percentage',
                        value: shopCouponSettings.value || 0,
                        minOrder: shopCouponSettings.minOrder || 0,
                        maxDiscount: shopCouponSettings.maxDiscount || 0,
                        description: shopCouponSettings.description || 'Shop coupon applied',
                        active: shopCouponSettings.active !== false
                    };
                }
            }
            
            if (!coupon) {
                coupon = AVAILABLE_COUPONS.find(c => c.code === couponCode);
            }
            
            if (!coupon) {
                couponMessage.textContent = 'Invalid coupon code';
                couponMessage.className = 'coupon-error';
                appliedCoupon = null;
                updateOrderSummary();
                return;
            }
            
            if (coupon.active === false) {
                couponMessage.textContent = 'Coupon is no longer active';
                couponMessage.className = 'coupon-error';
                appliedCoupon = null;
                updateOrderSummary();
                return;
            }
            
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            if (subtotal < coupon.minOrder) {
                couponMessage.textContent = `Minimum order amount of ₹${coupon.minOrder} required`;
                couponMessage.className = 'coupon-error';
                appliedCoupon = null;
                updateOrderSummary();
                return;
            }
            
            appliedCoupon = coupon;
            couponMessage.textContent = `🎉 ${coupon.description || 'Coupon applied!'}`;
            couponMessage.className = 'coupon-success';
            updateOrderSummary();
            showToast('Coupon applied successfully!');
        }

        function updateCouponAuth() {
            const couponCodeInput = document.getElementById('couponCode');
            const applyCouponBtn = document.getElementById('applyCouponBtn');
            const couponLoginRequired = document.getElementById('couponLoginRequired');
            
            if (currentUser) {
                if (couponCodeInput) couponCodeInput.disabled = false;
                if (applyCouponBtn) applyCouponBtn.disabled = false;
                if (couponLoginRequired) couponLoginRequired.style.display = 'none';
            } else {
                if (couponCodeInput) couponCodeInput.disabled = true;
                if (applyCouponBtn) applyCouponBtn.disabled = true;
                if (couponLoginRequired) couponLoginRequired.style.display = 'block';
            }
        }

        // QR payment
        function confirmQRPayment() {
            const utr = document.getElementById('utrNumber').value.trim();
            if (!/^\d{12}$/.test(utr)) {
                showToast('Please enter a valid UTR number');
                return;
            }
            
            showConfirmationModal(
                'Confirm QR Payment',
                `You are about to confirm your QR payment with UTR: ${utr}. Total amount: ${document.getElementById('qrAmount').textContent}. Please ensure you have completed the payment via QR scan.`,
                () => {
                    selectedPaymentMethod = 'qr';
                    showToast('QR payment confirmed! Please click "Place Order Securely" to complete your order.');
                }
            );
        }

        function validateUTR() {
            const utr = document.getElementById('utrNumber').value.trim();
            const isValid = /^\d{12}$/.test(utr);
            const utrValidation = document.getElementById('utrValidation');
            
            if (utr.length === 0) {
                utrValidation.textContent = '';
                return;
            }
            
            if (isValid) {
                utrValidation.textContent = '✓ Valid UTR number';
                utrValidation.className = 'validation-message validation-success';
            } else {
                utrValidation.textContent = 'Please enter a valid 12-digit UTR number';
                utrValidation.className = 'validation-message validation-error';
            }
        }

        // Confirmation modal
        function showConfirmationModal(title, message, onConfirm) {
            document.getElementById('confirmationTitle').textContent = title;
            document.getElementById('confirmationMessage').textContent = message;
            
            const confirmButton = document.getElementById('confirmAction');
            const modalElement = document.getElementById('confirmationModal');
            const modal = new bootstrap.Modal(modalElement);
            
            const handleConfirm = () => {
                onConfirm();
                modal.hide();
                confirmButton.removeEventListener('click', handleConfirm);
            };
            
            confirmButton.addEventListener('click', handleConfirm);
            modalElement.addEventListener('hidden.bs.modal', () => {
                confirmButton.removeEventListener('click', handleConfirm);
            });
            
            modal.show();
        }

        // Policy functions
        function openPrivacyPolicy() {
            showPolicyModal('Privacy Policy');
        }

        function openTermsConditions() {
            showPolicyModal('Terms & Conditions');
        }

        function openRefundPolicy() {
            showPolicyModal('Refund Policy');
        }

        function showPolicyModal(title) {
            const modalHTML = `
                <div class="modal-overlay active" id="policyModal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">${title}</h3>
                            <button class="modal-close" onclick="closePolicyModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            ${getPolicyContent(title)}
                        </div>
                        <div class="modal-footer">
                            <button class="btn-outline" onclick="closePolicyModal()">
                                <i class="fas fa-times"></i> Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function getPolicyContent(title) {
            if (title === 'Privacy Policy') {
                return `
                    <div style="padding: 1rem; line-height: 1.6;">
                        <h4 style="color: var(--primary); margin-bottom: 1rem;">Privacy Policy</h4>
                        <p>We respect your privacy and are committed to protecting your personal data.</p>
                        <h5>What We Collect:</h5>
                        <ul>
                            <li>Name and contact information</li>
                            <li>Delivery addresses</li>
                            <li>Order history</li>
                            <li>Payment information (secured)</li>
                        </ul>
                        <h5>How We Use Your Data:</h5>
                        <ul>
                            <li>To process your orders</li>
                            <li>To improve our services</li>
                            <li>To send order updates</li>
                            <li>For customer support</li>
                        </ul>
                        <p>We never share your personal data with third parties without your consent.</p>
                    </div>
                `;
            } else if (title === 'Terms & Conditions') {
                return `
                    <div style="padding: 1rem; line-height: 1.6;">
                        <h4 style="color: var(--primary); margin-bottom: 1rem;">Terms & Conditions</h4>
                        <p>By using Raashanmart, you agree to these terms:</p>
                        <h5>User Responsibilities:</h5>
                        <ul>
                            <li>Provide accurate information</li>
                            <li>Keep your account secure</li>
                            <li>Use services legally</li>
                            <li>Respect shopkeeper policies</li>
                        </ul>
                        <h5>Order Policies:</h5>
                        <ul>
                            <li>Prices may change</li>
                            <li>Availability is subject to stock</li>
                            <li>Delivery times are estimates</li>
                            <li>Shopkeepers may cancel orders</li>
                            </ul>
                        <p>Contact : manager.dukaan@gmail.com</p>
                        </ul>
                    </div>
                `;
            } else if (title === 'Refund Policy') {
                return `
                    <div style="padding: 1rem; line-height: 1.6;">
                        <h4 style="color: var(--primary); margin-bottom: 1rem;">Refund Policy</h4>
                        <h5>Refund Eligibility:</h5>
                        <ul>
                            <li>Damaged or incorrect items</li>
                            <li>Orders not delivered</li>
                            <li>Cancelled orders</li>
                            <li>Shopkeeper discretion</li>
                        </ul>
                        <h5>Refund Process:</h5>
                        <ul>
                            <li>Contact shopkeeper within 24 hours</li>
                            <li>Provide order details</li>
                            <li>Share photos if applicable</li>
                            <li>Wait for verification</li>
                        </ul>
                        <p>Partial refunds may be issued for damaged items.</p>
                        </ul>
                        <p>Contact : manager.dukaan@gmail.com</p>
                    </div>
                `;
            }
            return '<p>Policy content not available.</p>';
        }

        function closePolicyModal() {
            const modal = document.getElementById('policyModal');
            if (modal) modal.remove();
        }

        // Logout
        function logout() {
            console.log("Logout function called");
            
            if (firebase.auth().currentUser) {
                firebase.auth().signOut().then(() => {
                    showToast("Logged out successfully!", 'success');
                    
                    document.getElementById('appScreen').style.display = 'none';
                    document.getElementById('authScreen').style.display = 'block';
                    document.getElementById('loginForm').reset();
                    document.getElementById('signupForm').reset();
                    document.getElementById('loginForm').style.display = 'block';
                    document.getElementById('signupForm').style.display = 'none';
                    document.getElementById('loginFooter').style.display = 'block';
                    document.getElementById('signupFooter').style.display = 'none';
                    
                }).catch((error) => {
                    console.error("Logout error:", error);
                    showToast("Error logging out: " + error.message, 'error');
                });
            } else {
                document.getElementById('appScreen').style.display = 'none';
                document.getElementById('authScreen').style.display = 'block';
                showToast("Logged out successfully!");
            }
        }

        // Push notifications
        function setupPushNotifications() {
            if ('Notification' in window) {
                if (Notification.permission === 'granted') {
                    console.log('Push notifications already granted');
                } else if (Notification.permission !== 'denied') {
                    console.log('Push notifications available');
                }
            }
        }

        function togglePushNotifications() {
            if (!('Notification' in window)) {
                showToast('Browser does not support notifications');
                document.getElementById('pushNotificationsToggle').checked = false;
                return;
            }
            
            if (Notification.permission === 'granted') {
                notificationPreferences.pushEnabled = !notificationPreferences.pushEnabled;
                document.getElementById('pushNotificationsToggle').checked = notificationPreferences.pushEnabled;
                showToast(`Push notifications ${notificationPreferences.pushEnabled ? 'enabled' : 'disabled'}`);
            } else if (Notification.permission === 'denied') {
                showToast('Push notifications blocked by browser. Please change settings manually.', 'error');
                document.getElementById('pushNotificationsToggle').checked = false;
                notificationPreferences.pushEnabled = false;
            } else {
                Notification.requestPermission().then(permission => {
                    notificationPreferences.pushEnabled = permission === 'granted';
                    document.getElementById('pushNotificationsToggle').checked = permission === 'granted';
                    
                    if (permission === 'granted') {
                        showToast('Push notifications enabled!');
                    } else {
                        showToast('Push notification permission denied.', 'warning');
                    }
                });
            }
            
            localStorage.setItem('dukaan_notification_prefs', JSON.stringify(notificationPreferences));
        }

        // Notification functions
        function createNotification(title, message, type = 'info') {
            const notification = {
                id: generateId(),
                title,
                message, 
                type,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            notifications.unshift(notification);
            localStorage.setItem('dukaan_notifications', JSON.stringify(notifications));
            
            if (notificationPreferences.pushEnabled && 'Notification' in window && Notification.permission === 'granted') {
                new Notification(title, { body: message, icon: 'https://cdn-icons-png.flaticon.com/512/3082/3082383.png' });
            }
        }

        function loadNotificationsPage() {
            renderNotificationsList();
            updateNotificationPreferencesUI();
        }

        function renderNotificationsList() {
            const list = document.getElementById('notificationsList');
            const empty = document.getElementById('noNotifications');
            
            if (!list || !empty) return;

            if (notifications.length === 0) {
                list.innerHTML = '';
                empty.style.display = 'block';
                return;
            }
            
            empty.style.display = 'none';
            list.innerHTML = notifications.map(notif => `
                <div class="notification-item ${notif.read ? '' : 'notification-unread'}" 
                     onclick="markNotificationRead('${notif.id}')">
                    <div style="flex: 1;">
                        <strong>${notif.title}</strong>
                        <p style="margin: 5px 0; color: var(--text-light);">${notif.message}</p>
                        <small>${new Date(notif.timestamp).toLocaleString()}</small>
                    </div>
                </div>
            `).join('');
        }

        function markNotificationRead(notificationId) {
            const notificationIndex = notifications.findIndex(n => n.id === notificationId);
            if (notificationIndex !== -1) {
                notifications[notificationIndex].read = true;
                localStorage.setItem('dukaan_notifications', JSON.stringify(notifications));
                renderNotificationsList();
            }
        }

        function updateNotificationPreference(key, value) {
            notificationPreferences[key] = value;
            localStorage.setItem('dukaan_notification_prefs', JSON.stringify(notificationPreferences));
            showToast('Notification preference updated');
        }

        function updateNotificationPreferencesUI() {
            const orderUpdatesToggle = document.getElementById('orderUpdatesToggle');
            const priceAlertsToggle = document.getElementById('priceAlertsToggle');
            const promotionsToggle = document.getElementById('promotionsToggle');
            const pushNotificationsToggle = document.getElementById('pushNotificationsToggle');
            
            if (orderUpdatesToggle) orderUpdatesToggle.checked = notificationPreferences.orderUpdates;
            if (priceAlertsToggle) priceAlertsToggle.checked = notificationPreferences.priceAlerts;
            if (promotionsToggle) promotionsToggle.checked = notificationPreferences.promotions;
            if (pushNotificationsToggle) pushNotificationsToggle.checked = notificationPreferences.pushEnabled;
        }

        function clearAllNotifications() {
            notifications = [];
            localStorage.setItem('dukaan_notifications', JSON.stringify(notifications));
            renderNotificationsList();
            showToast('All notifications cleared');
        }

        // Utility functions
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = 'position-fixed top-0 start-50 translate-middle-x mt-3';
            toast.style.zIndex = '9999';
            
            let bgColor = 'var(--accent)';
            if (type === 'error') bgColor = 'var(--danger)';
            if (type === 'success') bgColor = 'var(--success)';
            if (type === 'warning') bgColor = 'var(--warning)';
            
            toast.innerHTML = `
                <div class="toast show" role="alert" style="background: ${bgColor}; color: white; border: none;">
                    <div class="toast-body d-flex justify-content-between align-items-center">
                        <span>${message}</span>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Initialize app
        function initApp() {
            // Setup event listeners
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('signupForm').addEventListener('submit', handleSignup);
            document.getElementById('showSignup').addEventListener('click', () => {
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('signupForm').style.display = 'block';
                document.getElementById('loginFooter').style.display = 'none';
                document.getElementById('signupFooter').style.display = 'block';
            });
            document.getElementById('showLogin').addEventListener('click', () => {
                document.getElementById('loginForm').style.display = 'block';
                document.getElementById('signupForm').style.display = 'none';
                document.getElementById('loginFooter').style.display = 'block';
                document.getElementById('signupFooter').style.display = 'none';
            });

            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = item.getAttribute('data-page');
                    navigateToPage(page);
                });
            });

            // Bottom sheet
            document.getElementById('closeB').addEventListener('click', closeBottomSheet);
            document.getElementById('bottomNavCart').addEventListener('click', (e) => {
                e.preventDefault();
                openBottomSheet();
            });

            // Payment methods
            document.querySelectorAll('.payment-option').forEach(option => {
                option.addEventListener('click', () => {
                    selectPaymentMethod(option.getAttribute('data-method'));
                });
            });

            // Coupon
            document.getElementById('applyCouponBtn').addEventListener('click', applyCoupon);

            // QR payment
            document.getElementById('confirmQrPayment').addEventListener('click', confirmQRPayment);

            // Filters
            document.getElementById('shopFilter').addEventListener('change', applyFilters);
            document.getElementById('categoryFilter').addEventListener('change', applyFilters);
            document.getElementById('sortSelect').addEventListener('change', applyFilters);

            // Search
            document.getElementById('search').addEventListener('input', handleSearch);

            // Notification toggles
            const orderUpdatesToggle = document.getElementById('orderUpdatesToggle');
            const priceAlertsToggle = document.getElementById('priceAlertsToggle');
            const promotionsToggle = document.getElementById('promotionsToggle');
            const pushNotificationsToggle = document.getElementById('pushNotificationsToggle');
            
            if (orderUpdatesToggle) {
                orderUpdatesToggle.addEventListener('change', function() {
                    updateNotificationPreference('orderUpdates', this.checked);
                });
            }
            if (priceAlertsToggle) {
                priceAlertsToggle.addEventListener('change', function() {
                    updateNotificationPreference('priceAlerts', this.checked);
                });
            }
            if (promotionsToggle) {
                promotionsToggle.addEventListener('change', function() {
                    updateNotificationPreference('promotions', this.checked);
                });
            }
            if (pushNotificationsToggle) {
                pushNotificationsToggle.addEventListener('change', togglePushNotifications);
            }

            // Clear notifications
            const clearNotificationsBtn = document.getElementById('clearNotificationsBtn');
            if (clearNotificationsBtn) {
                clearNotificationsBtn.addEventListener('click', clearAllNotifications);
            }

            // Setup Firebase
            setupFirebaseAuth();
            setupOfflineDetection();
            setupPushNotifications();
            
            // Setup mobile back button handling
            setupMobileBackButton();
            
            // Load products
            loadProductsFromFirebase();
            
            // Initial UI updates
            updateCartUI();
            updateWishlistUI();
            renderOrders();
            renderAddresses();
        }

        // Handle search
        function handleSearch() {
            const query = document.getElementById('search').value.trim().toLowerCase();
            if (query.length === 0) {
                document.getElementById('searchResults').style.display = 'none';
                renderProducts(PRODUCTS);
                return;
            }
            
            const filteredProducts = PRODUCTS.filter(product => 
                product.name.toLowerCase().includes(query) ||
                product.category.toLowerCase().includes(query)
            );
            
            showSearchResults(filteredProducts);
            renderProducts(filteredProducts);
        }

        function showSearchResults(products) {
            const searchResults = document.getElementById('searchResults');
            searchResults.innerHTML = '';
            
            if (products.length === 0) {
                searchResults.style.display = 'none';
                return;
            }
            
            const limitedResults = products.slice(0, 5);
            
            limitedResults.forEach(product => {
                const searchItem = document.createElement('div');
                searchItem.className = 'search-result-item';
                searchItem.innerHTML = `
                    <img src="${product.image}" alt="${product.name}" class="search-result-image">
                    <div class="search-result-info">
                        <div class="search-result-name">${product.name}</div>
                        <div class="search-result-category">${product.category} • ${product.shopName}</div>
                    </div>
                    <div class="search-result-price">₹${product.price}</div>
                `;
                searchItem.addEventListener('click', () => {
                    document.getElementById('search').value = product.name;
                    showProductDetail(product.id);
                    searchResults.style.display = 'none';
                });
                searchResults.appendChild(searchItem);
            });
            
            searchResults.style.display = 'block';
        }

        // Start app when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });
    </script>
</body>
</html>
