<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raashanmart - Online Shopping</title>
    <!-- ✅ RAASHANMART FAVICON ADD HERE -->
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/3082/3082383.png" type="image/x-icon">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        /* All CSS remains exactly the same as original */
        :root {
            --primary: #0F2C59; --primary-dark: #0A1F3D; --secondary: #FFFFFF; --accent: #3A8EF6; 
            --accent-hover: #2D7AE6; --success: #10B981; --warning: #F59E0B; --danger: #EF4444;
            --neutral: #F8FAFC; --text-dark: #1E293B; --text-light: #64748B; --border: #E2E8F0;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08); --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.12);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--neutral); color: var(--text-dark); line-height: 1.6; padding-bottom: 80px; }
        .app-header { background: var(--primary); color: white; padding: 12px 0; position: sticky; top: 0; z-index: 1000; }
        .header-container { max-width: 1200px; margin: 0 auto; padding: 0 16px; display: flex; align-items: center; justify-content: space-between; gap: 20px; }
        .brand { display: flex; align-items: center; gap: 12px; font-weight: 800; font-size: 1.4rem; text-decoration: none; color: white; }
        .brand-logo { width: 40px; height: 40px; background: var(--accent); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; }
        .search-container { flex: 1; position: relative; margin: 0 20px; max-width: 600px; }
        .search-bar { width: 100%; padding: 12px 45px 12px 16px; border-radius: 10px; border: none; font-size: 15px; background: white; box-shadow: var(--shadow); transition: all 0.3s ease; }
        .search-bar:focus { outline: none; box-shadow: 0 4px 20px rgba(58, 142, 246, 0.25); }
        .search-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--text-light); }
        .search-results { position: absolute; top: 100%; left: 0; right: 0; background: white; border-radius: 0 0 10px 10px; box-shadow: var(--shadow-lg); max-height: 300px; overflow-y: auto; z-index: 1001; display: none; }
        .search-result-item { padding: 12px 16px; border-bottom: 1px solid var(--border); cursor: pointer; display: flex; align-items: center; gap: 12px; }
        .search-result-item:hover { background: var(--neutral); }
        .search-result-image { width: 40px; height: 40px; border-radius: 8px; object-fit: cover; }
        .search-result-info { flex: 1; }
        .search-result-name { font-weight: 600; font-size: 14px; margin-bottom: 2px; }
        .search-result-category { font-size: 12px; color: var(--text-light); }
        .search-result-price { font-weight: 700; color: var(--accent); font-size: 14px; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding: 12px 0; z-index: 1000; box-shadow: 0 -2px 20px rgba(0, 0, 0, 0.1); }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; text-decoration: none; color: var(--text-light); transition: all 0.2s; flex: 1; position: relative; }
        .nav-item.active { color: var(--accent); }
        .nav-icon { font-size: 20px; }
        .nav-label { font-size: 12px; font-weight: 500; }
        .nav-badge {
            position: absolute;
            top: -5px;
            right: 50px;
            background: var(--accent);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 700;
            min-width: 18px;
            text-align: center;
        }
        .container-main { max-width: 1200px; margin: 24px auto; padding: 0 16px; }
        .hero-banner { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 40px 20px; border-radius: 20px; margin-bottom: 30px; position: relative; overflow: hidden; }
        .hero-content { position: relative; z-index: 2; max-width: 600px; }
        .hero-badge { display: inline-flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600; margin-bottom: 20px; }
        .hero-title { font-size: 2.5rem; font-weight: 800; margin-bottom: 15px; line-height: 1.2; }
        .hero-subtitle { font-size: 1.1rem; margin-bottom: 25px; opacity: 0.9; }
        .btn-primary { background: var(--accent); color: white; border: none; padding: 12px 30px; border-radius: 10px; font-weight: 600; font-size: 16px; cursor: pointer; transition: all 0.3s ease; }
        .btn-primary:hover { background: var(--accent-hover); transform: translateY(-2px); }
        .btn-outline { background: transparent; color: var(--accent); border: 2px solid var(--accent); padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .btn-outline:hover { background: var(--accent); color: white; }
        .hero-pattern { position: absolute; top: 0; right: 0; bottom: 0; width: 50%; background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" fill="rgba(255,255,255,0.05)"><circle cx="20" cy="20" r="5"/><circle cx="50" cy="50" r="8"/><circle cx="80" cy="80" r="5"/></svg>'); }
        .orders-page { display: none; }
        .wishlist-page { display: none; }
        .product-detail-page { display: none; }
        .order-card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: var(--shadow); border: 1px solid var(--border); }
        .wishlist-card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: var(--shadow); border: 1px solid var(--border); display: flex; gap: 15px; align-items: center; }
        .wishlist-image { width: 80px; height: 80px; border-radius: 8px; object-fit: cover; }
        .wishlist-info { flex: 1; }
        .wishlist-actions { display: flex; gap: 10px; }
        .order-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--border); }
        .order-id { font-weight: 700; color: var(--text-dark); }
        .order-status { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .status-delivered { background: var(--success); color: white; }
        .status-pending { background: var(--warning); color: white; }
        .status-cancelled { background: var(--danger); color: white; }
        .status-preparing { background: var(--accent); color: white; }
        .status-dispatched { background: #8B5CF6; color: white; }
        /* ✅ NEW STATUS COLORS ADDED */
        .status-packed { background: #7C3AED; color: white; }
        .status-ready-for-pickup { background: #10B981; color: white; }
        .status-out-for-delivery { background: #3A8EF6; color: white; }
        .order-items { margin-bottom: 12px; }
        .order-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; }
        .order-footer { display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 1px solid var(--border); }
        .order-total { font-weight: 700; font-size: 16px; color: var(--text-dark); }
        .btn-reorder { background: var(--accent); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; }
        .product-card { background: white; border-radius: 16px; padding: 16px; box-shadow: var(--shadow); transition: all 0.3s ease; border: 1px solid var(--border); display: flex; flex-direction: column; height: 100%; position: relative; overflow: hidden; }
        .product-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); }
        .product-badge { position: absolute; top: 12px; left: 12px; background: var(--success); color: white; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .wishlist-btn { position: absolute; top: 12px; right: 12px; background: rgba(255,255,255,0.9); border: none; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; color: var(--text-light); }
        .wishlist-btn:hover { background: white; transform: scale(1.1); }
        .wishlist-btn.active { background: var(--danger); color: white; }
        .product-image { height: 160px; border-radius: 12px; object-fit: cover; width: 100%; background: var(--neutral); margin-bottom: 12px; cursor: pointer; }
        .product-title { font-weight: 700; font-size: 16px; margin-bottom: 6px; color: var(--text-dark); cursor: pointer; }
        .product-category { font-size: 13px; color: var(--text-light); margin-bottom: 10px; }
        .product-price { display: flex; align-items: center; gap: 8px; margin-top: auto; }
        .current-price { font-weight: 800; font-size: 18px; color: var(--accent); }
        .original-price { color: var(--text-light); text-decoration: line-through; font-size: 14px; }
        .discount { color: var(--success); font-size: 13px; font-weight: 600; }
        .card-actions { display: flex; justify-content: center; margin-top: 15px; }
        .btn-add-cart { background: var(--accent); color: white; border: none; padding: 10px 16px; border-radius: 10px; font-weight: 600; width: 100%; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; white-space: nowrap; font-size: 14px; }
        .btn-add-cart:hover { background: var(--accent-hover); transform: scale(1.02); }
        .shop-badge { position: absolute; top: 12px; right: 55px; background: var(--primary); color: white; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 600; }
        .bottom-sheet { position: fixed; left: 0; right: 0; bottom: 0; background: white; border-top-left-radius: 20px; border-top-right-radius: 20px; box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.15); transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.22, 1, 0.36, 1); z-index: 1001; max-height: 85vh; overflow: auto; }
        .bottom-sheet.open { transform: translateY(0); }
        .sheet-handle { width: 60px; height: 5px; background: #E2E8F0; border-radius: 99px; margin: 12px auto; display: block; }
        .sheet-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .sheet-title { font-weight: 700; font-size: 1.3rem; color: var(--text-dark); }
        .sheet-close { background: none; border: none; font-size: 24px; color: var(--text-light); cursor: pointer; }
        .sheet-body { padding: 20px; }
        .coupon-section { margin: 20px 0; padding: 15px; background: var(--neutral); border-radius: 12px; border: 1px solid var(--border); }
        .coupon-input-group { display: flex; gap: 10px; margin-bottom: 10px; }
        .coupon-input { flex: 1; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; }
        .btn-apply-coupon { background: var(--accent); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .btn-apply-coupon:disabled { background: var(--text-light); cursor: not-allowed; }
        .coupon-login-required { color: var(--warning); font-size: 14px; margin-top: 8px; text-align: center; }
        .coupon-success { color: var(--success); font-size: 14px; font-weight: 600; margin-top: 8px; }
        .coupon-error { color: var(--danger); font-size: 14px; margin-top: 8px; }
        .phone-valid { border-color: var(--success) !important; }
        .phone-invalid { border-color: var(--danger) !important; }
        .validation-message { font-size: 12px; margin-top: 4px; }
        .validation-success { color: var(--success); }
        .validation-error { color: var(--danger); }
        .order-item-summary { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border); }
        .discount-row { display: flex; justify-content: space-between; padding: 8px 0; color: var(--success); font-weight: 600; }
        .order-total-summary { display: flex; justify-content: space-between; padding: 15px 0; margin-top: 10px; border-top: 2px solid var(--border); font-weight: 800; font-size: 18px; }
        .payment-methods { margin: 20px 0; }
        .payment-option { display: flex; align-items: center; gap: 12px; padding: 15px; border: 2px solid var(--border); border-radius: 10px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s ease; }
        .payment-option.selected { border-color: var(--accent); background: rgba(58, 142, 246, 0.05); }
        .payment-icon { width: 40px; height: 40px; background: var(--neutral); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .payment-info { flex: 1; }
        .payment-title { font-weight: 600; margin-bottom: 4px; }
        .payment-desc { font-size: 12px; color: var(--text-light); }
        .qr-modal { text-align: center; padding: 20px; position: relative; }
        .qr-code { width: 100%; max-width: 280px; margin: 20px auto; padding: 20px; background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 2px solid #f1f3f4; }
        .qr-code-content { display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .qr-image-container { width: 200px; height: 200px; border-radius: 12px; overflow: hidden; border: 2px solid #34A853; background: white; }
        .qr-image-container img { width: 100%; height: 100%; object-fit: contain; }
        .upi-details { background: #f8f9fa; padding: 12px; border-radius: 10px; width: 100%; text-align: center; }
        .utr-input { margin: 15px 0; }
        .utr-input .form-control { margin-top: 8px; }
        .empty-state { text-align: center; padding: 40px 20px; }
        .empty-icon { font-size: 60px; color: var(--border); margin-bottom: 15px; }
        .empty-text { color: var(--text-light); font-size: 16px; }
        .auth-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); padding: 20px; }
        .auth-card { background: white; border-radius: 20px; padding: 40px; box-shadow: var(--shadow-lg); width: 100%; max-width: 450px; }
        .auth-header { text-align: center; margin-bottom: 30px; }
        .auth-logo { width: 60px; height: 60px; background: var(--accent); border-radius: 15px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.5rem; color: white; margin: 0 auto 15px; }
        .auth-title { font-size: 1.8rem; font-weight: 700; color: var(--text-dark); margin-bottom: 8px; }
        .auth-subtitle { color: var(--text-light); font-size: 1rem; }
        .form-group { margin-bottom: 20px; }
        .form-label { font-weight: 600; margin-bottom: 8px; color: var(--text-dark); display: block; }
        .form-control { width: 100%; padding: 12px 16px; border: 1px solid var(--border); border-radius: 10px; font-size: 15px; transition: all 0.2s; }
        .form-control:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(58, 142, 246, 0.1); }
        .auth-footer { text-align: center; margin-top: 25px; color: var(--text-light); }
        .auth-link { color: var(--accent); text-decoration: none; font-weight: 600; }
        .auth-link:hover { text-decoration: underline; }
        .address-grid { display: grid; gap: 12px; margin-bottom: 15px; }
        .address-card { padding: 15px; border: 2px solid var(--border); border-radius: 10px; cursor: pointer; transition: all 0.3s ease; }
        .address-card.selected { border-color: var(--accent); background: rgba(58, 142, 246, 0.05); }
        .address-title { font-weight: 600; margin-bottom: 5px; }
        .address-details { color: var(--text-light); font-size: 14px; margin-bottom: 5px; }
        .address-phone { font-size: 12px; color: var(--text-light); }
        .address-form { background: var(--neutral); padding: 20px; border-radius: 12px; margin-top: 15px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        /* ✅ UPDATED ORDER TIMELINE WITH MORE STEPS */
        .order-timeline {
            display: flex;
            justify-content: space-between;
            position: relative;
            margin: 20px 0;
            padding: 0 10px;
        }
        .order-timeline::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 5%;
            right: 5%;
            height: 3px;
            background: var(--border);
            z-index: 1;
        }
        .timeline-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
            flex: 1;
        }
        .step-icon {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }
        .step-icon.active {
            background: var(--accent);
            color: white;
        }
        .step-icon.completed {
            background: var(--success);
            color: white;
        }
        .step-label {
            font-size: 11px;
            text-align: center;
            color: var(--text-light);
            font-weight: 500;
            line-height: 1.2;
        }
        .step-label.active {
            color: var(--accent);
            font-weight: 600;
        }
        .step-label.completed {
            color: var(--success);
            font-weight: 600;
        }
        .step-time {
            font-size: 9px;
            color: var(--text-light);
            margin-top: 2px;
            text-align: center;
            line-height: 1.2;
        }
        /* Product Detail Page Styles - UPDATED */
        .product-detail-container {
            background: white;
            border-radius: 20px;
            padding: 0;
            overflow: hidden;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }
        .product-detail-image {
            width: 100%;
            height: 400px;
            object-fit: cover;
        }
        .product-detail-content {
            padding: 30px;
        }
        .product-detail-header {
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 20px;
        }
        .product-detail-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        .product-detail-category {
            color: var(--text-light);
            font-size: 1rem;
            margin-bottom: 15px;
        }
        .product-detail-price {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        .product-detail-current {
            font-size: 2rem;
            font-weight: 800;
            color: var(--accent);
        }
        .product-detail-original {
            font-size: 1.5rem;
            color: var(--text-light);
            text-decoration: line-through;
        }
        .product-detail-discount {
            background: var(--success);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
        }
        .product-detail-actions {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            align-items: center;
        }
        .btn-quantity {
            display: flex;
            align-items: center;
            gap: 15px;
            background: var(--neutral);
            padding: 10px 15px;
            border-radius: 10px;
        }
        .quantity-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--accent);
        }
        .quantity-value {
            font-weight: 600;
            min-width: 30px;
            text-align: center;
        }
        /* ✅ NEW: Product Specifications Section */
        .specifications-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            box-shadow: var(--shadow);
        }
        .specs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .spec-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px dashed var(--border);
        }
        .spec-label {
            color: var(--text-light);
            font-weight: 500;
        }
        .spec-value {
            font-weight: 600;
            color: var(--text-dark);
        }
        .return-policy-section {
            background: var(--neutral);
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            border-left: 4px solid var(--accent);
        }
        .return-policy-list {
            list-style: none;
            padding: 0;
            margin: 15px 0 0 0;
        }
        .return-policy-list li {
            padding: 8px 0;
            color: var(--text-light);
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        .return-policy-list li i {
            color: var(--success);
            margin-top: 3px;
        }
        /* Reviews Section Styles */
        .reviews-section {
            margin-top: 40px;
            padding: 30px;
            background: white;
            border-radius: 20px;
            box-shadow: var(--shadow);
        }
        .rating-summary {
            display: flex;
            align-items: center;
            gap: 40px;
            margin-bottom: 30px;
            padding-bottom: 30px;
            border-bottom: 2px solid var(--border);
        }
        .average-rating {
            text-align: center;
        }
        .rating-stars {
            display: flex;
            gap: 2px;
            margin-bottom: 10px;
            justify-content: center;
        }
        .rating-star {
            color: #ddd;
            font-size: 24px;
        }
        .rating-star.filled {
            color: #FFB800;
        }
        .rating-value {
            font-size: 3rem;
            font-weight: 700;
            color: var(--text-dark);
            line-height: 1;
        }
        .rating-count {
            color: var(--text-light);
            font-size: 16px;
        }
        .rating-distribution {
            flex: 1;
        }
        .rating-bar {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 12px;
        }
        .bar-label {
            width: 80px;
            font-size: 14px;
            color: var(--text-light);
        }
        .bar-container {
            flex: 1;
            height: 10px;
            background: #f0f0f0;
            border-radius: 5px;
            overflow: hidden;
        }
        .bar-fill {
            height: 100%;
            background: #FFB800;
            border-radius: 5px;
            transition: width 0.3s ease;
        }
        .bar-count {
            width: 40px;
            text-align: right;
            font-size: 14px;
            color: var(--text-light);
        }
        .reviews-list {
            margin-bottom: 30px;
        }
        .review-card {
            padding: 20px;
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 20px;
            background: var(--neutral);
        }
        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        .review-user {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 18px;
        }
        .user-info h5 {
            margin: 0;
            font-size: 16px;
            margin-bottom: 5px;
        }
        .verified-badge {
            background: var(--success);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        .review-rating {
            display: flex;
            gap: 2px;
        }
        .review-star {
            color: #FFB800;
            font-size: 16px;
        }
        .review-date {
            color: var(--text-light);
            font-size: 14px;
        }
        .review-content {
            color: var(--text-dark);
            line-height: 1.6;
            font-size: 15px;
        }
        .review-form-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            border: 2px solid var(--border);
        }
        .review-form-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-dark);
        }
        .star-rating-input {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }
        .star-input {
            background: none;
            border: none;
            font-size: 28px;
            color: #ddd;
            cursor: pointer;
            transition: all 0.2s;
            padding: 5px;
        }
        .star-input:hover,
        .star-input.active {
            color: #FFB800;
            transform: scale(1.1);
        }
        .review-textarea {
            width: 100%;
            padding: 15px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 15px;
            resize: vertical;
            min-height: 120px;
            margin-bottom: 15px;
            transition: all 0.2s;
        }
        .review-textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(58, 142, 246, 0.1);
        }
        .review-requirements {
            background: var(--neutral);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .requirements-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-dark);
        }
        .requirements-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .requirements-list li {
            padding: 5px 0;
            color: var(--text-light);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .requirements-list li i {
            color: var(--success);
            font-size: 12px;
        }
        .no-reviews {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-light);
        }
        .no-reviews-icon {
            font-size: 60px;
            margin-bottom: 15px;
            color: var(--border);
        }
        /* User Profile Styles */
        .profile-page { display: none; }
        .profile-header { 
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 30px 20px;
            text-align: center;
            border-radius: 20px;
            margin-bottom: 30px;
            position: relative;
        }
        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 2.5rem;
            font-weight: bold;
            color: white;
            border: 4px solid white;
            position: relative;
            overflow: hidden;
        }
        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .avatar-upload {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: var(--accent);
            border: 2px solid white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            font-size: 14px;
        }
        .profile-name {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        .profile-email {
            opacity: 0.9;
            font-size: 1rem;
        }
        .profile-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }
        .section-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .profile-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .profile-menu-item {
            padding: 15px 0;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .profile-menu-item:last-child {
            border-bottom: none;
        }
        .profile-menu-item:hover {
            background: var(--neutral);
            margin: 0 -20px;
            padding: 15px 20px;
        }
        .menu-item-content {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }
        .menu-item-icon {
            width: 40px;
            height: 40px;
            background: var(--neutral);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent);
            font-size: 1.2rem;
        }
        .menu-item-text {
            flex: 1;
        }
        .menu-item-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-dark);
        }
        .menu-item-desc {
            font-size: 0.9rem;
            color: var(--text-light);
        }
        .menu-item-arrow {
            color: var(--text-light);
        }
        .security-badge {
            background: var(--success);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .login-session {
            padding: 15px;
            border: 1px solid var(--border);
            border-radius: 10px;
            margin-bottom: 10px;
            background: var(--neutral);
        }
        .session-active {
            border-left: 4px solid var(--success);
        }
        .session-inactive {
            border-left: 4px solid var(--text-light);
        }
        .preference-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border);
        }
        .preference-item:last-child {
            border-bottom: none;
        }
        .preference-info {
            flex: 1;
        }
        .preference-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        .preference-desc {
            font-size: 0.9rem;
            color: var(--text-light);
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--accent);
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        /* Enhanced Search Styles */
        .search-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9998;
            display: none;
        }
        .search-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: white;
            z-index: 9999;
            border-radius: 0 0 20px 20px;
            box-shadow: var(--shadow-lg);
            display: none;
        }
        .search-modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .search-modal-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            outline: none;
        }
        .search-modal-input:focus {
            border-color: var(--accent);
        }
        .search-modal-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: var(--text-light);
            cursor: pointer;
        }
        .search-modal-body {
            max-height: 60vh;
            overflow-y: auto;
            padding: 20px;
        }
        .search-section {
            margin-bottom: 25px;
        }
        .search-section-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .clear-recent {
            background: none;
            border: none;
            color: var(--accent);
            font-size: 0.9rem;
            cursor: pointer;
        }
        .recent-searches {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .recent-search-item {
            background: var(--neutral);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid var(--border);
        }
        .recent-search-item:hover {
            background: var(--accent);
            color: white;
        }
        .popular-searches {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .popular-search-item {
            background: white;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .popular-search-item:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }
        .search-suggestions {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .search-suggestion-item {
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .search-suggestion-item:last-child {
            border-bottom: none;
        }
        .search-suggestion-item:hover {
            background: var(--neutral);
            margin: 0 -20px;
            padding: 12px 20px;
        }
        .suggestion-icon {
            color: var(--text-light);
            font-size: 1rem;
        }
        .advanced-filters {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-top: 15px;
            box-shadow: var(--shadow);
        }
        .filter-group {
            margin-bottom: 20px;
        }
        .filter-title {
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-dark);
        }
        .price-range {
            padding: 0 10px;
        }
        .price-inputs {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .price-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
        }
        .rating-filters {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .rating-filter-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            cursor: pointer;
        }
        .rating-stars-small {
            display: flex;
            gap: 2px;
        }
        .rating-star-small {
            color: #FFB800;
            font-size: 14px;
        }
        .shop-filters {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .shop-filter-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .shop-filter-item:hover {
            border-color: var(--accent);
        }
        .shop-filter-item.selected {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        .filter-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        /* Sorting Styles */
        .sorting-options {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        .sort-label {
            font-weight: 600;
            color: var(--text-dark);
            white-space: nowrap;
        }
        .sort-select {
            padding: 10px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            background: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 160px;
        }
        .sort-select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(58, 142, 246, 0.1);
        }
        .sort-select:hover {
            border-color: var(--accent);
        }
        .sort-badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .sort-badge {
            padding: 8px 16px;
            background: var(--neutral);
            border: 2px solid var(--border);
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        .sort-badge:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }
        .sort-badge.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        /* ORDER ENHANCEMENTS CSS */
        .order-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .order-actions button {
            font-size: 12px;
            padding: 6px 12px;
        }
        .delivery-agent-info {
            border-left: 4px solid var(--accent);
        }
        .eta-section {
            border-left: 4px solid var(--success);
        }
        .order-tracking-details p {
            margin-bottom: 8px;
        }
        /* Notifications Page */
        .notifications-page { display: none; }
        .notification-item { 
            padding: 15px; 
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 12px;
        }
        .notification-unread { background: rgba(58, 142, 246, 0.05); }
        .quantity-cart-container {
            display: flex;
            gap: 15px;
            align-items: center;
            width: 100%;
        }
        .btn-add-cart-detail {
            flex: 1;
            min-width: 200px;
        }
        .product-detail-actions {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        /* HIDE ALL BADGES IN HAMBURGER MENU */
        #hamburgerMenu .nav-badge {
            display: none !important;
        }
        .quantity-cart-container {
            display: flex;
            gap: 15px;
            align-items: center;
            flex: 1;
        }
        .btn-quantity {
            display: flex;
            align-items: center;
            gap: 15px;
            background: var(--neutral);
            padding: 10px 15px;
            border-radius: 10px;
            border: 1px solid var(--border);
        }
        .product-detail-actions {
            display: flex;
            gap: 15px;
            align-items: center;
            width: 100%;
        }
        .btn-add-cart-detail {
            flex: 1;
            min-width: 160px;
        }
        /* FINAL FIX - QUANTITY & CART LAYOUT */
        .quantity-cart-container {
            display: flex;
            align-items: center;
            gap: 15px;
            width: 100%;
        }
        .btn-quantity {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--neutral);
            padding: 10px 15px;
            border-radius: 10px;
            border: 1px solid var(--border);
        }
        .btn-add-cart-detail {
            flex: 1;
        }
        .product-detail-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        /* HIDE ALL BADGES IN HAMBURGER MENU */
        #hamburgerMenu .nav-badge {
            display: none !important;
        }
        /* Bottom nav badge proper position fix */
        .bottom-nav .nav-item {
            position: relative;
        }
        .bottom-nav .nav-badge {
            position: absolute;
            top: -6px;
            left: 50%;
            right: auto;
            transform: translateX(4px);
            background: var(--accent);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 700;
            min-width: 18px;
            text-align: center;
        }
        /* FINAL QUANTITY FIX */
        .product-detail-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .quantity-cart-container {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }
        #hamburgerWishlistCount {
            display: none !important;
        }
        /* DEBUG - COLOR CODE BADGES */
        #bottomCartCount { background: red !important; }
        #hamburgerWishlistCount { background: blue !important; }
        /* HIDE WISHLIST BADGE IN HAMBURGER MENU */
        #hamburgerWishlistCount {
            display: none !important;
        }
        /* HIDE ALL BADGES IN HAMBURGER MENU */
        #hamburgerMenu .nav-badge {
            display: none !important;
        }
        /* FIX QUANTITY LAYOUT */
        .quantity-cart-container {
            display: flex !important;
            flex-direction: row !important;
            align-items: center !important;
            gap: 15px !important;
            width: 100% !important;
        }
        .btn-quantity {
            display: flex !important;
            flex-direction: row !important;
            align-items: center !important;
            gap: 10px !important;
            white-space: nowrap !important;
        }
        /* REMOVE BADGE FROM HAMBURGER MENU ITEMS */
        #hamburgerMenu .nav-badge,
        .nav-item[onclick*="openHamburgerMenu"] .nav-badge {
            display: none !important;
        }
        /* KEEP BADGES FOR OTHER NAV ITEMS */
        .nav-item[data-page] .nav-badge {
            display: block; /* This keeps badges for Home, Orders, Account, Cart */
        }
        .delivery-options {
            margin: 10px 0;
        }
        .delivery-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            border: 2px solid var(--border);
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .delivery-option.selected {
            border-color: var(--accent);
            background: rgba(58, 142, 246, 0.05);
        }
        .delivery-option:hover {
            border-color: var(--accent);
        }
        /* SOCIAL SHARE STYLES */
        .btn-outline:hover {
            background: var(--accent);
            color: white;
        }
        .share-options-modal {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: var(--shadow-lg);
            max-width: 300px;
            margin: 20px auto;
        }
        .share-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .btn-share {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-share.whatsapp {
            background: #25D366;
            color: white;
        }
        .btn-share.copy {
            background: var(--accent);
            color: white;
        }
        /* Modal Overlay - Fixed Position */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.12);
            position: relative;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-dark);
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-light);
            cursor: pointer;
        }
        .modal-body {
            margin-bottom: 20px;
        }
        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }
        /* ✅ FIX: ORDER STATUS BADGES */
.orders-count-badge {
    position: absolute;
    top: -8px;
    right: 10px;
    background: var(--danger);
    color: white;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 700;
    min-width: 18px;
    text-align: center;
}

/* Order status specific colors */
.status-preparing { background: #F59E0B; color: white; }
.status-dispatched { background: #8B5CF6; color: white; }
.status-packed { background: #7C3AED; color: white; }
.status-ready-for-pickup { background: #10B981; color: white; }
.status-out-for-delivery { background: #3A8EF6; color: white; }

/* Real-time update notification */
.order-update-notification {
    position: fixed;
    top: 70px;
    right: 20px;
    background: var(--success);
    color: white;
    padding: 12px 20px;
    border-radius: 10px;
    box-shadow: var(--shadow-lg);
    z-index: 9999;
    display: none;
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

/* ✅ REFUND STYLES */
.refund-notification {
    position: fixed;
    top: 80px;
    right: 20px;
    background: linear-gradient(135deg, #10B981, #059669);
    color: white;
    padding: 15px 20px;
    border-radius: 10px;
    box-shadow: var(--shadow-lg);
    z-index: 9999;
    max-width: 300px;
    animation: slideIn 0.3s ease;
}

.refund-message {
    background: linear-gradient(135deg, #FEF3C7, #FDE68A);
    padding: 10px 15px;
    border-radius: 8px;
    margin: 10px 0;
    border-left: 4px solid #F59E0B;
}

.refund-status-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    margin-left: 10px;
}

.refund-pending {
    background: #FEF3C7;
    color: #92400E;
}

.refund-processing {
    background: #DBEAFE;
    color: #1E40AF;
}

.refund-completed {
    background: #D1FAE5;
    color: #065F46;
}

/* ✅ OFFLINE NOTIFICATION STYLES */
.offline-notification {
    position: fixed;
    top: 60px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--danger);
    color: white;
    padding: 12px 24px;
    border-radius: 10px;
    box-shadow: var(--shadow-lg);
    z-index: 9999;
    display: none;
    animation: slideDown 0.3s ease;
    text-align: center;
    max-width: 90%;
}

.online-notification {
    position: fixed;
    top: 60px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--success);
    color: white;
    padding: 12px 24px;
    border-radius: 10px;
    box-shadow: var(--shadow-lg);
    z-index: 9999;
    display: none;
    animation: slideDown 0.3s ease;
    text-align: center;
    max-width: 90%;
}

@keyframes slideDown {
    from { transform: translate(-50%, -100%); opacity: 0; }
    to { transform: translate(-50%, 0); opacity: 1; }
}

/* ✅ OFFLINE MODE STYLES */
.offline-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 10000;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.offline-content {
    background: white;
    border-radius: 20px;
    padding: 30px;
    max-width: 400px;
    width: 100%;
    text-align: center;
    box-shadow: var(--shadow-lg);
}

.offline-icon {
    font-size: 60px;
    color: var(--danger);
    margin-bottom: 20px;
}

.offline-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-dark);
    margin-bottom: 10px;
}

.offline-message {
    color: var(--text-light);
    margin-bottom: 20px;
    line-height: 1.6;
}

.reload-button {
    background: var(--accent);
    color: white;
    border: none;
    padding: 12px 30px;
    border-radius: 10px;
    font-weight: 600;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 10px;
}

.reload-button:hover {
    background: var(--accent-hover);
    transform: translateY(-2px);
}
        /* 🎯 MOBILE LAYOUT FIXES */
        @media (max-width: 768px) {
            /* Better product grid - 2 products with proper spacing */
            .product-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 12px !important;
                padding: 0 8px !important;
            }
            
            /* Better product card proportions */
            .product-card {
                padding: 12px !important;
                border-radius: 12px !important;
                min-height: 280px !important;
                display: flex !important;
                flex-direction: column !important;
            }
            
            /* Optimized product image */
            .product-image {
                height: 120px !important;
                border-radius: 8px !important;
                margin-bottom: 8px !important;
            }
            
            /* Better text sizing */
            .product-title {
                font-size: 14px !important;
                line-height: 1.3 !important;
                margin-bottom: 4px !important;
                display: -webkit-box !important;
                -webkit-line-clamp: 2 !important;
                -webkit-box-orient: vertical !important;
                overflow: hidden !important;
            }
            
            .product-category {
                font-size: 11px !important;
                margin-bottom: 8px !important;
            }
            
            /* Better price layout */
            .product-price {
                margin-top: auto !important;
                padding-top: 8px !important;
            }
            
            .current-price {
                font-size: 16px !important;
            }
            
            .original-price {
                font-size: 12px !important;
            }
            
            .discount {
                font-size: 11px !important;
            }
            
            /* Better button sizing */
            .btn-add-cart {
                padding: 8px 12px !important;
                font-size: 12px !important;
                border-radius: 8px !important;
            }
            
            /* Badge optimization */
            .product-badge {
                font-size: 10px !important;
                padding: 3px 8px !important;
                top: 8px !important;
                left: 8px !important;
            }
            
            .shop-badge {
                font-size: 9px !important;
                padding: 2px 6px !important;
                top: 8px !important;
                right: 8px !important;
            }
            
            .wishlist-btn {
                position: absolute !important;
                bottom: 60px !important;
                right: 12px !important;
                top: auto !important;
                width: 32px !important;
                height: 32px !important;
                background: rgba(255,255,255,0.9) !important;
                border: none !important;
                border-radius: 50% !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                cursor: pointer !important;
                transition: all 0.3s ease !important;
                color: var(--text-light) !important;
                z-index: 3 !important;
            }
            
            .wishlist-btn:hover {
                background: white !important;
                transform: scale(1.1) !important;
            }
            
            .wishlist-btn.active {
                background: var(--danger) !important;
                color: white !important;
            }
            
            /* Mobile adjustment */
            @media (max-width: 768px) {
                .wishlist-btn {
                    bottom: 50px !important;
                    right: 8px !important;
                    width: 28px !important;
                    height: 28px !important;
                }
            }
            
            /* Header optimization */
            .header-container { 
                flex-direction: column; 
                gap: 12px; 
                position: relative;
            }
            
            .search-container { 
                margin: 0 auto; 
                width: 100%; 
                max-width: 500px;
            }
            
            /* Container optimization */
            .container-main {
                margin: 16px auto !important;
                padding: 0 8px !important;
            }
            
            /* Container optimization */
            .container-main {
                margin: 16px auto !important;
                padding: 0 8px !important;
            }
            
            /* Hero section optimization */
            .hero-banner {
                padding: 20px 16px !important;
                margin-bottom: 20px !important;
                border-radius: 16px !important;
            }
            
            .hero-content { 
                max-width: 100%; 
            }
            
            .hero-title { 
                font-size: 1.5rem !important;
                margin-bottom: 10px !important;
            }
            
            .hero-subtitle {
                font-size: 0.9rem !important;
                margin-bottom: 15px !important;
            }
            
            /* Filter section optimization */
            .filter-section > div {
                flex-direction: column !important;
                gap: 12px !important;
            }
            
            .filter-section .d-flex {
                width: 100% !important;
                justify-content: space-between !important;
                margin-bottom: 15px !important;
            }
            
            .category-filter {
                flex: 1 !important;
                margin: 0 4px !important;
            }
            
            .sorting-options {
                width: 100% !important;
                justify-content: space-between !important;
            }
            
            .sort-select {
                min-width: 140px !important;
            }
            
            /* Auth optimization */
            .auth-card { 
                padding: 30px 25px; 
            }
            
            .form-row { 
                grid-template-columns: 1fr; 
            }
            
            /* Wishlist optimization */
            .wishlist-card { 
                flex-direction: column; 
                text-align: center; 
            }
            
            .wishlist-actions { 
                justify-content: center; 
            }
            
            /* Reviews optimization */
            .rating-summary { 
                flex-direction: column; 
                gap: 20px; 
                text-align: center; 
            }
            
            /* Product detail optimization */
            .product-detail-actions { 
                flex-direction: column; 
            }
            
            .product-detail-image { 
                height: 300px; 
            }
            
            /* Order actions */
            .order-actions {
                justify-content: center;
            }
            
            .order-actions button {
                flex: 1;
                min-width: 80px;
            }
            
            /* Enhanced Search Mobile Styles */
            .search-modal-body {
                max-height: 70vh;
            }
            
            .popular-searches {
                grid-template-columns: 1fr;
            }
            
            .shop-filters {
                grid-template-columns: 1fr;
            }
            
            .recent-searches {
                flex-direction: column;
            }
            
            .recent-search-item {
                text-align: center;
            }
            
            /* ✅ MOBILE ORDER TRACKING FIX */
            .order-timeline {
                padding: 0 5px !important;
            }
            
            .step-label {
                font-size: 9px !important;
            }
            
            .step-time {
                font-size: 8px !important;
            }
            
            .step-icon {
                width: 30px !important;
                height: 30px !important;
                font-size: 12px !important;
            }
            
            /* Mobile product detail adjustments */
            .specifications-section,
            .return-policy-section {
                padding: 15px !important;
            }
            
            .specs-grid {
                grid-template-columns: 1fr !important;
            }
        }
        /* Header Layout Fix */
        .app-header .header-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            position: relative;
        }
        .app-header .search-container {
            flex: 1;
            max-width: 500px;
            margin: 0 auto;
            position: relative;
        }
        .app-header .header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: auto;
        }
        /* Center search bar on desktop */
        @media (min-width: 769px) {
            .app-header .header-container {
                position: relative;
            }
            
            .app-header .search-container {
                position: absolute;
                left: 50%;
                transform: translateX(-50%);
                width: 400px;
            }
            
            .app-header .header-actions {
                margin-left: auto;
            }
        }
        /* Mobile responsive */
        @media (max-width: 768px) {
            .app-header .header-container {
                flex-direction: column;
                gap: 12px;
            }
            
            .app-header .search-container {
                order: 2;
                width: 100%;
                max-width: none;
            }
            
            .app-header .header-actions {
                order: 3;
                width: 100%;
                justify-content: flex-end;
            }
        }
        /* Logout option styling */
        .preference-item[style*="color: var(--danger)"] {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .preference-item[style*="color: var(--danger)"]:hover {
            background: #FEE2E2;
            border-radius: 8px;
            padding: 12px;
            margin: -12px -12px -12px -12px;
        }
        /* 🎯 EXTRA SMALL DEVICES */
        @media (max-width: 480px) {
            .product-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 8px !important;
                padding: 0 4px !important;
            }
            
            .product-card {
                padding: 10px !important;
                min-height: 260px !important;
            }
            
            .product-image {
                height: 110px !important;
            }
            
            .product-title {
                font-size: 13px !important;
            }
            
            .current-price {
                font-size: 15px !important;
            }
            
            .container-main { 
                padding: 0 12px; 
            }
            
            .hero-banner { 
                padding: 20px; 
            }
            
            .product-detail-content { 
                padding: 20px; 
            }
            
            .reviews-section { 
                padding: 20px; 
            }
            
            /* ✅ EXTRA SMALL ORDER TRACKING */
            .order-timeline {
                padding: 0 2px !important;
            }
            
            .step-label {
                font-size: 8px !important;
            }
            
            .step-time {
                font-size: 7px !important;
            }
            
            .step-icon {
                width: 25px !important;
                height: 25px !important;
                font-size: 10px !important;
            }
        }
        /* 🎯 TABLET OPTIMIZATION */
        @media (min-width: 769px) and (max-width: 1024px) {
            .product-grid {
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 16px !important;
            }
        }
        /* Desktop remains unchanged */
        @media (min-width: 769px) {
            .product-grid {
                grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
                gap: 20px;
            }
        }
        
        /* ✅ FIX: ORDER STATUS BADGES */
        .orders-count-badge {
            position: absolute;
            top: -8px;
            right: 10px;
            background: var(--danger);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 700;
            min-width: 18px;
            text-align: center;
        }
        
        /* Order status specific colors */
        .status-preparing { background: #F59E0B; color: white; }
        .status-dispatched { background: #8B5CF6; color: white; }
        .status-packed { background: #7C3AED; color: white; }
        .status-ready-for-pickup { background: #10B981; color: white; }
        .status-out-for-delivery { background: #3A8EF6; color: white; }
        
        /* Real-time update notification */
        .order-update-notification {
            position: fixed;
            top: 70px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            box-shadow: var(--shadow-lg);
            z-index: 9999;
            display: none;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* ✅ NEW: Search bar active state */
        .search-container.active .search-bar {
            box-shadow: 0 4px 20px rgba(58, 142, 246, 0.4);
        }
        
        /* ✅ NEW: Product Description Section */
        .product-description {
            margin: 25px 0;
            padding: 20px;
            background: var(--neutral);
            border-radius: 15px;
        }
        
        .product-description h4 {
            margin-bottom: 15px;
            color: var(--text-dark);
            font-size: 1.2rem;
        }
        
        .product-description p {
            line-height: 1.6;
            color: var(--text-light);
        }
    </style>
</head>
<body>
    <!-- ✅ OFFLINE DETECTION OVERLAY -->
    <div id="offlineOverlay" class="offline-overlay">
        <div class="offline-content">
            <div class="offline-icon">
                <i class="fas fa-wifi-slash"></i>
            </div>
            <h3 class="offline-title">No Internet Connection</h3>
            <p class="offline-message">
                You're currently offline. Please check your internet connection and try again.
                <br><br>
                <small>Some features may not work properly while offline.</small>
            </p>
            <button class="reload-button" onclick="checkInternetAndReload()">
                <i class="fas fa-sync-alt"></i> Retry Connection
            </button>
        </div>
    </div>

    <!-- ✅ OFFLINE NOTIFICATION -->
    <div id="offlineNotification" class="offline-notification">
        <i class="fas fa-wifi-slash"></i> You are offline
    </div>

    <!-- ✅ ONLINE NOTIFICATION -->
    <div id="onlineNotification" class="online-notification">
        <i class="fas fa-wifi"></i> You are back online
    </div>

    <!-- Login/Signup Screen -->
    <div id="authScreen">
        <div class="auth-container">
            <div class="auth-card">
                <div class="auth-header">
                    <div class="auth-logo">R</div>
                    <h1 class="auth-title">Welcome to Raashanmart</h1>
                    <p class="auth-subtitle">Sign in to your account</p>
                </div>
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="loginEmail" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" id="loginPassword" placeholder="Enter your password" required>
                    </div>
                    <button type="submit" class="btn-primary w-100" style="padding: 12px;">Sign In</button>
                    <div class="forgot-password">
                 <a href="#" onclick="showForgotPassword()">Forgot Password?</a>
                    </div>
                </form>
                <form id="signupForm" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="signupName" placeholder="Enter your full name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="signupEmail" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" id="signupPassword" placeholder="Create a password" required>
                    </div>
                    <button type="submit" class="btn-primary w-100" style="padding: 12px;">Create Account</button>
                </form>
                <div class="auth-footer">
                    <p id="loginFooter">Don't have an account? <a href="#" class="auth-link" id="showSignup">Sign up</a></p>
                    <p id="signupFooter" style="display: none;">Already have an account? <a href="#" class="auth-link" id="showLogin">Sign in</a></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App Screen -->
    <div id="appScreen" style="display: none;">
        <header class="app-header">
            <div class="header-container">
                <a href="#" class="brand">
                    <div class="brand-logo">R</div>
                    <span>Raashanmart</span>
                </a>
                <div class="search-container">
                    <input type="text" id="search" class="search-bar" placeholder="Search for products, categories...">
                    <div class="search-icon"><i class="fas fa-search"></i></div>
                    <div class="search-results" id="searchResults"></div>
                </div>
                <div class="header-actions">
                </div>
            </div>
        </header>
        
        <!-- Real-time order update notification -->
        <div id="orderUpdateNotification" class="order-update-notification">
            <i class="fas fa-bell"></i> Order status updated!
        </div>
        
        <div class="container-main">
            <div id="homePage">
                <div class="hero-banner">
                    <div class="hero-content">
                        <div class="hero-badge">
                            <i class="fas fa-bolt"></i>
                            <span>Fast Delivery • Best Prices</span>
                        </div>
                        <h1 class="hero-title">Groceries Delivered to Your Doorstep</h1>
                        <p class="hero-subtitle">Fresh products, competitive prices, and quick delivery</p>
                        <button class="btn-primary">Shop Now</button>
                    </div>
                    <div class="hero-pattern"></div>
                </div>
                
                <!-- Enhanced Search Modal -->
                <div id="searchOverlay" class="search-overlay"></div>
                <div id="searchModal" class="search-modal">
                    <div class="search-modal-header">
                        <div style="position: relative; flex: 1;">
                            <input type="text" id="enhancedSearchInput" class="search-modal-input" placeholder="Search for products, shops, categories...">
                            <div id="searchSuggestions" class="search-results" style="display: none;"></div>
                        </div>
                        <button class="search-modal-close" onclick="closeEnhancedSearch()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="search-modal-body">
                        <!-- Recent Searches -->
                        <div class="search-section" id="recentSearchesSection">
                            <div class="search-section-title">
                                <span>Recent Searches</span>
                                <button class="clear-recent" onclick="clearRecentSearches()">Clear all</button>
                            </div>
                            <div class="recent-searches" id="recentSearchesList">
                                <!-- Recent searches will be populated here -->
                            </div>
                        </div>

                        <!-- Popular Searches -->
                        <div class="search-section">
                            <div class="search-section-title">
                                <span>Popular Searches</span>
                            </div>
                            <div class="popular-searches" id="popularSearchesList">
                                <!-- Popular searches will be populated here -->
                            </div>
                        </div>

                        <!-- Search Suggestions -->
                        <div class="search-section" id="searchSuggestionsSection" style="display: none;">
                            <div class="search-section-title">
                                <span>Suggestions</span>
                            </div>
                            <ul class="search-suggestions" id="searchSuggestionsList">
                                <!-- Search suggestions will be populated here -->
                            </ul>
                        </div>

                        <!-- Advanced Filters -->
                        <div class="advanced-filters" id="advancedFilters">
                            <div class="filter-group">
                                <div class="filter-title">Price Range</div>
                                <div class="price-range">
                                    <input type="range" id="priceRange" min="0" max="5000" value="5000" class="form-range">
                                    <div class="price-inputs">
                                        <input type="number" id="minPrice" class="price-input" placeholder="Min" value="0">
                                        <input type="number" id="maxPrice" class="price-input" placeholder="Max" value="5000">
                                    </div>
                                </div>
                            </div>

                            <div class="filter-group">
                                <div class="filter-title">Customer Rating</div>
                                <div class="rating-filters">
                                    <label class="rating-filter-item">
                                        <input type="checkbox" class="rating-filter" value="4">
                                        <div class="rating-stars-small">
                                            <i class="fas fa-star rating-star-small"></i>
                                            <i class="fas fa-star rating-star-small"></i>
                                            <i class="fas fa-star rating-star-small"></i>
                                            <i class="fas fa-star rating-star-small"></i>
                                            <i class="fas fa-star rating-star-small"></i>
                                        </div>
                                        <span>4+ Stars</span>
                                    </label>
                                    <label class="rating-filter-item">
                                        <input type="checkbox" class="rating-filter" value="3">
                                        <div class="rating-stars-small">
                                            <i class="fas fa-star rating-star-small"></i>
                                            <i class="fas fa-star rating-star-small"></i>
                                            <i class="fas fa-star rating-star-small"></i>
                                            <i class="fas fa-star rating-star-small"></i>
                                            <i class="far fa-star rating-star-small"></i>
                                        </div>
                                        <span>3+ Stars</span>
                                    </label>
                                </div>
                            </div>

                            <div class="filter-group">
                                <div class="filter-title">Shops</div>
                                <div class="shop-filters" id="shopFiltersList">
                                    <!-- Shop filters will be populated here -->
                                </div>
                            </div>

                            <div class="filter-actions">
                                <button class="btn-outline" onclick="resetFilters()" style="flex: 1;">
                                    <i class="fas fa-refresh"></i> Reset
                                </button>
                                <button class="btn-primary" onclick="applyAdvancedFilters()" style="flex: 1;">
                                    <i class="fas fa-check"></i> Apply
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raashanmart - Online Shopping</title>
    <!-- ✅ RAASHANMART FAVICON ADD HERE -->
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/3082/3082383.png" type="image/x-icon">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        /* All CSS remains exactly the same as original */
        :root {
            --primary: #0F2C59; --primary-dark: #0A1F3D; --secondary: #FFFFFF; --accent: #3A8EF6; 
            --accent-hover: #2D7AE6; --success: #10B981; --warning: #F59E0B; --danger: #EF4444;
            --neutral: #F8FAFC; --text-dark: #1E293B; --text-light: #64748B; --border: #E2E8F0;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08); --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.12);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--neutral); color: var(--text-dark); line-height: 1.6; padding-bottom: 80px; }
        .app-header { background: var(--primary); color: white; padding: 12px 0; position: sticky; top: 0; z-index: 1000; }
        .header-container { max-width: 1200px; margin: 0 auto; padding: 0 16px; display: flex; align-items: center; justify-content: space-between; gap: 20px; }
        .brand { display: flex; align-items: center; gap: 12px; font-weight: 800; font-size: 1.4rem; text-decoration: none; color: white; }
        .brand-logo { width: 40px; height: 40px; background: var(--accent); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; }
        .search-container { flex: 1; position: relative; margin: 0 20px; max-width: 600px; }
        .search-bar { width: 100%; padding: 12px 45px 12px 16px; border-radius: 10px; border: none; font-size: 15px; background: white; box-shadow: var(--shadow); transition: all 0.3s ease; }
        .search-bar:focus { outline: none; box-shadow: 0 4px 20px rgba(58, 142, 246, 0.25); }
        .search-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--text-light); }
        .search-results { position: absolute; top: 100%; left: 0; right: 0; background: white; border-radius: 0 0 10px 10px; box-shadow: var(--shadow-lg); max-height: 300px; overflow-y: auto; z-index: 1001; display: none; }
        .search-result-item { padding: 12px 16px; border-bottom: 1px solid var(--border); cursor: pointer; display: flex; align-items: center; gap: 12px; }
        .search-result-item:hover { background: var(--neutral); }
        .search-result-image { width: 40px; height: 40px; border-radius: 8px; object-fit: cover; }
        .search-result-info { flex: 1; }
        .search-result-name { font-weight: 600; font-size: 14px; margin-bottom: 2px; }
        .search-result-category { font-size: 12px; color: var(--text-light); }
        .search-result-price { font-weight: 700; color: var(--accent); font-size: 14px; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding: 12px 0; z-index: 1000; box-shadow: 0 -2px 20px rgba(0, 0, 0, 0.1); }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; text-decoration: none; color: var(--text-light); transition: all 0.2s; flex: 1; position: relative; }
        .nav-item.active { color: var(--accent); }
        .nav-icon { font-size: 20px; }
        .nav-label { font-size: 12px; font-weight: 500; }
        .nav-badge {
            position: absolute;
            top: -5px;
            right: 50px;
            background: var(--accent);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 700;
            min-width: 18px;
            text-align: center;
        }
        .container-main { max-width: 1200px; margin: 24px auto; padding: 0 16px; }
        .hero-banner { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 40px 20px; border-radius: 20px; margin-bottom: 30px; position: relative; overflow: hidden; }
        .hero-content { position: relative; z-index: 2; max-width: 600px; }
        .hero-badge { display: inline-flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600; margin-bottom: 20px; }
        .hero-title { font-size: 2.5rem; font-weight: 800; margin-bottom: 15px; line-height: 1.2; }
        .hero-subtitle { font-size: 1.1rem; margin-bottom: 25px; opacity: 0.9; }
        .btn-primary { background: var(--accent); color: white; border: none; padding: 12px 30px; border-radius: 10px; font-weight: 600; font-size: 16px; cursor: pointer; transition: all 0.3s ease; }
        .btn-primary:hover { background: var(--accent-hover); transform: translateY(-2px); }
        .btn-outline { background: transparent; color: var(--accent); border: 2px solid var(--accent); padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .btn-outline:hover { background: var(--accent); color: white; }
        .hero-pattern { position: absolute; top: 0; right: 0; bottom: 0; width: 50%; background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" fill="rgba(255,255,255,0.05)"><circle cx="20" cy="20" r="5"/><circle cx="50" cy="50" r="8"/><circle cx="80" cy="80" r="5"/></svg>'); }
        .orders-page { display: none; }
        .wishlist-page { display: none; }
        .product-detail-page { display: none; }
        .order-card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: var(--shadow); border: 1px solid var(--border); }
        .wishlist-card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: var(--shadow); border: 1px solid var(--border); display: flex; gap: 15px; align-items: center; }
        .wishlist-image { width: 80px; height: 80px; border-radius: 8px; object-fit: cover; }
        .wishlist-info { flex: 1; }
        .wishlist-actions { display: flex; gap: 10px; }
        .order-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--border); }
        .order-id { font-weight: 700; color: var(--text-dark); }
        .order-status { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .status-delivered { background: var(--success); color: white; }
        .status-pending { background: var(--warning); color: white; }
        .status-cancelled { background: var(--danger); color: white; }
        .status-preparing { background: var(--accent); color: white; }
        .status-dispatched { background: #8B5CF6; color: white; }
        /* ✅ NEW STATUS COLORS ADDED */
        .status-packed { background: #7C3AED; color: white; }
        .status-ready-for-pickup { background: #10B981; color: white; }
        .status-out-for-delivery { background: #3A8EF6; color: white; }
        .order-items { margin-bottom: 12px; }
        .order-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; }
        .order-footer { display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 1px solid var(--border); }
        .order-total { font-weight: 700; font-size: 16px; color: var(--text-dark); }
        .btn-reorder { background: var(--accent); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; }
        .product-card { background: white; border-radius: 16px; padding: 16px; box-shadow: var(--shadow); transition: all 0.3s ease; border: 1px solid var(--border); display: flex; flex-direction: column; height: 100%; position: relative; overflow: hidden; }
        .product-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); }
        .product-badge { position: absolute; top: 12px; left: 12px; background: var(--success); color: white; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .wishlist-btn { position: absolute; top: 12px; right: 12px; background: rgba(255,255,255,0.9); border: none; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; color: var(--text-light); }
        .wishlist-btn:hover { background: white; transform: scale(1.1); }
        .wishlist-btn.active { background: var(--danger); color: white; }
        .product-image { height: 160px; border-radius: 12px; object-fit: cover; width: 100%; background: var(--neutral); margin-bottom: 12px; cursor: pointer; }
        .product-title { font-weight: 700; font-size: 16px; margin-bottom: 6px; color: var(--text-dark); cursor: pointer; }
        .product-category { font-size: 13px; color: var(--text-light); margin-bottom: 10px; }
        .product-price { display: flex; align-items: center; gap: 8px; margin-top: auto; }
        .current-price { font-weight: 800; font-size: 18px; color: var(--accent); }
        .original-price { color: var(--text-light); text-decoration: line-through; font-size: 14px; }
        .discount { color: var(--success); font-size: 13px; font-weight: 600; }
        .card-actions { display: flex; justify-content: center; margin-top: 15px; }
        .btn-add-cart { background: var(--accent); color: white; border: none; padding: 10px 16px; border-radius: 10px; font-weight: 600; width: 100%; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; white-space: nowrap; font-size: 14px; }
        .btn-add-cart:hover { background: var(--accent-hover); transform: scale(1.02); }
        .shop-badge { position: absolute; top: 12px; right: 55px; background: var(--primary); color: white; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 600; }
        .bottom-sheet { position: fixed; left: 0; right: 0; bottom: 0; background: white; border-top-left-radius: 20px; border-top-right-radius: 20px; box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.15); transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.22, 1, 0.36, 1); z-index: 1001; max-height: 85vh; overflow: auto; }
        .bottom-sheet.open { transform: translateY(0); }
        .sheet-handle { width: 60px; height: 5px; background: #E2E8F0; border-radius: 99px; margin: 12px auto; display: block; }
        .sheet-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .sheet-title { font-weight: 700; font-size: 1.3rem; color: var(--text-dark); }
        .sheet-close { background: none; border: none; font-size: 24px; color: var(--text-light); cursor: pointer; }
        .sheet-body { padding: 20px; }
        .coupon-section { margin: 20px 0; padding: 15px; background: var(--neutral); border-radius: 12px; border: 1px solid var(--border); }
        .coupon-input-group { display: flex; gap: 10px; margin-bottom: 10px; }
        .coupon-input { flex: 1; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; }
        .btn-apply-coupon { background: var(--accent); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .btn-apply-coupon:disabled { background: var(--text-light); cursor: not-allowed; }
        .coupon-login-required { color: var(--warning); font-size: 14px; margin-top: 8px; text-align: center; }
        .coupon-success { color: var(--success); font-size: 14px; font-weight: 600; margin-top: 8px; }
        .coupon-error { color: var(--danger); font-size: 14px; margin-top: 8px; }
        .phone-valid { border-color: var(--success) !important; }
        .phone-invalid { border-color: var(--danger) !important; }
        .validation-message { font-size: 12px; margin-top: 4px; }
        .validation-success { color: var(--success); }
        .validation-error { color: var(--danger); }
        .order-item-summary { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border); }
        .discount-row { display: flex; justify-content: space-between; padding: 8px 0; color: var(--success); font-weight: 600; }
        .order-total-summary { display: flex; justify-content: space-between; padding: 15px 0; margin-top: 10px; border-top: 2px solid var(--border); font-weight: 800; font-size: 18px; }
        .payment-methods { margin: 20px 0; }
        .payment-option { display: flex; align-items: center; gap: 12px; padding: 15px; border: 2px solid var(--border); border-radius: 10px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s ease; }
        .payment-option.selected { border-color: var(--accent); background: rgba(58, 142, 246, 0.05); }
        .payment-icon { width: 40px; height: 40px; background: var(--neutral); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .payment-info { flex: 1; }
        .payment-title { font-weight: 600; margin-bottom: 4px; }
        .payment-desc { font-size: 12px; color: var(--text-light); }
        .qr-modal { text-align: center; padding: 20px; position: relative; }
        .qr-code { width: 100%; max-width: 280px; margin: 20px auto; padding: 20px; background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 2px solid #f1f3f4; }
        .qr-code-content { display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .qr-image-container { width: 200px; height: 200px; border-radius: 12px; overflow: hidden; border: 2px solid #34A853; background: white; }
        .qr-image-container img { width: 100%; height: 100%; object-fit: contain; }
        .upi-details { background: #f8f9fa; padding: 12px; border-radius: 10px; width: 100%; text-align: center; }
        .utr-input { margin: 15px 0; }
        .utr-input .form-control { margin-top: 8px; }
        .empty-state { text-align: center; padding: 40px 20px; }
        .empty-icon { font-size: 60px; color: var(--border); margin-bottom: 15px; }
        .empty-text { color: var(--text-light); font-size: 16px; }
        .auth-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); padding: 20px; }
        .auth-card { background: white; border-radius: 20px; padding: 40px; box-shadow: var(--shadow-lg); width: 100%; max-width: 450px; }
        .auth-header { text-align: center; margin-bottom: 30px; }
        .auth-logo { width: 60px; height: 60px; background: var(--accent); border-radius: 15px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.5rem; color: white; margin: 0 auto 15px; }
        .auth-title { font-size: 1.8rem; font-weight: 700; color: var(--text-dark); margin-bottom: 8px; }
        .auth-subtitle { color: var(--text-light); font-size: 1rem; }
        .form-group { margin-bottom: 20px; }
        .form-label { font-weight: 600; margin-bottom: 8px; color: var(--text-dark); display: block; }
        .form-control { width: 100%; padding: 12px 16px; border: 1px solid var(--border); border-radius: 10px; font-size: 15px; transition: all 0.2s; }
        .form-control:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(58, 142, 246, 0.1); }
        .auth-footer { text-align: center; margin-top: 25px; color: var(--text-light); }
        .auth-link { color: var(--accent); text-decoration: none; font-weight: 600; }
        .auth-link:hover { text-decoration: underline; }
        .address-grid { display: grid; gap: 12px; margin-bottom: 15px; }
        .address-card { padding: 15px; border: 2px solid var(--border); border-radius: 10px; cursor: pointer; transition: all 0.3s ease; }
        .address-card.selected { border-color: var(--accent); background: rgba(58, 142, 246, 0.05); }
        .address-title { font-weight: 600; margin-bottom: 5px; }
        .address-details { color: var(--text-light); font-size: 14px; margin-bottom: 5px; }
        .address-phone { font-size: 12px; color: var(--text-light); }
        .address-form { background: var(--neutral); padding: 20px; border-radius: 12px; margin-top: 15px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        /* ✅ UPDATED ORDER TIMELINE WITH MORE STEPS */
        .order-timeline {
            display: flex;
            justify-content: space-between;
            position: relative;
            margin: 20px 0;
            padding: 0 10px;
        }
        .order-timeline::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 5%;
            right: 5%;
            height: 3px;
            background: var(--border);
            z-index: 1;
        }
        .timeline-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
            flex: 1;
        }
        .step-icon {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }
        .step-icon.active {
            background: var(--accent);
            color: white;
        }
        .step-icon.completed {
            background: var(--success);
            color: white;
        }
        .step-label {
            font-size: 11px;
            text-align: center;
            color: var(--text-light);
            font-weight: 500;
            line-height: 1.2;
        }
        .step-label.active {
            color: var(--accent);
            font-weight: 600;
        }
        .step-label.completed {
            color: var(--success);
            font-weight: 600;
        }
        .step-time {
            font-size: 9px;
            color: var(--text-light);
            margin-top: 2px;
            text-align: center;
            line-height: 1.2;
        }
        /* Product Detail Page Styles - UPDATED */
        .product-detail-container {
            background: white;
            border-radius: 20px;
            padding: 0;
            overflow: hidden;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }
        .product-detail-image {
            width: 100%;
            height: 400px;
            object-fit: cover;
        }
        .product-detail-content {
            padding: 30px;
        }
        .product-detail-header {
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 20px;
        }
        .product-detail-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        .product-detail-category {
            color: var(--text-light);
            font-size: 1rem;
            margin-bottom: 15px;
        }
        .product-detail-price {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        .product-detail-current {
            font-size: 2rem;
            font-weight: 800;
            color: var(--accent);
        }
        .product-detail-original {
            font-size: 1.5rem;
            color: var(--text-light);
            text-decoration: line-through;
        }
        .product-detail-discount {
            background: var(--success);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
        }
        .product-detail-actions {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            align-items: center;
        }
        .btn-quantity {
            display: flex;
            align-items: center;
            gap: 15px;
            background: var(--neutral);
            padding: 10px 15px;
            border-radius: 10px;
        }
        .quantity-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--accent);
        }
        .quantity-value {
            font-weight: 600;
            min-width: 30px;
            text-align: center;
        }
        /* ✅ NEW: Product Specifications Section */
        .specifications-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            box-shadow: var(--shadow);
        }
        .specs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .spec-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px dashed var(--border);
        }
        .spec-label {
            color: var(--text-light);
            font-weight: 500;
        }
        .spec-value {
            font-weight: 600;
            color: var(--text-dark);
        }
        .return-policy-section {
            background: var(--neutral);
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            border-left: 4px solid var(--accent);
        }
        .return-policy-list {
            list-style: none;
            padding: 0;
            margin: 15px 0 0 0;
        }
        .return-policy-list li {
            padding: 8px 0;
            color: var(--text-light);
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        .return-policy-list li i {
            color: var(--success);
            margin-top: 3px;
        }
        /* Reviews Section Styles */
        .reviews-section {
            margin-top: 40px;
            padding: 30px;
            background: white;
            border-radius: 20px;
            box-shadow: var(--shadow);
        }
        .rating-summary {
            display: flex;
            align-items: center;
            gap: 40px;
            margin-bottom: 30px;
            padding-bottom: 30px;
            border-bottom: 2px solid var(--border);
        }
        .average-rating {
            text-align: center;
        }
        .rating-stars {
            display: flex;
            gap: 2px;
            margin-bottom: 10px;
            justify-content: center;
        }
        .rating-star {
            color: #ddd;
            font-size: 24px;
        }
        .rating-star.filled {
            color: #FFB800;
        }
        .rating-value {
            font-size: 3rem;
            font-weight: 700;
            color: var(--text-dark);
            line-height: 1;
        }
        .rating-count {
            color: var(--text-light);
            font-size: 16px;
        }
        .rating-distribution {
            flex: 1;
        }
        .rating-bar {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 12px;
        }
        .bar-label {
            width: 80px;
            font-size: 14px;
            color: var(--text-light);
        }
        .bar-container {
            flex: 1;
            height: 10px;
            background: #f0f0f0;
            border-radius: 5px;
            overflow: hidden;
        }
        .bar-fill {
            height: 100%;
            background: #FFB800;
            border-radius: 5px;
            transition: width 0.3s ease;
        }
        .bar-count {
            width: 40px;
            text-align: right;
            font-size: 14px;
            color: var(--text-light);
        }
        .reviews-list {
            margin-bottom: 30px;
        }
        .review-card {
            padding: 20px;
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 20px;
            background: var(--neutral);
        }
        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        .review-user {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 18px;
        }
        .user-info h5 {
            margin: 0;
            font-size: 16px;
            margin-bottom: 5px;
        }
        .verified-badge {
            background: var(--success);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        .review-rating {
            display: flex;
            gap: 2px;
        }
        .review-star {
            color: #FFB800;
            font-size: 16px;
        }
        .review-date {
            color: var(--text-light);
            font-size: 14px;
        }
        .review-content {
            color: var(--text-dark);
            line-height: 1.6;
            font-size: 15px;
        }
        .review-form-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            border: 2px solid var(--border);
        }
        .review-form-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-dark);
        }
        .star-rating-input {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }
        .star-input {
            background: none;
            border: none;
            font-size: 28px;
            color: #ddd;
            cursor: pointer;
            transition: all 0.2s;
            padding: 5px;
        }
        .star-input:hover,
        .star-input.active {
            color: #FFB800;
            transform: scale(1.1);
        }
        .review-textarea {
            width: 100%;
            padding: 15px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 15px;
            resize: vertical;
            min-height: 120px;
            margin-bottom: 15px;
            transition: all 0.2s;
        }
        .review-textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(58, 142, 246, 0.1);
        }
        .review-requirements {
            background: var(--neutral);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .requirements-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-dark);
        }
        .requirements-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .requirements-list li {
            padding: 5px 0;
            color: var(--text-light);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .requirements-list li i {
            color: var(--success);
            font-size: 12px;
        }
        .no-reviews {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-light);
        }
        .no-reviews-icon {
            font-size: 60px;
            margin-bottom: 15px;
            color: var(--border);
        }
        /* User Profile Styles */
        .profile-page { display: none; }
        .profile-header { 
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 30px 20px;
            text-align: center;
            border-radius: 20px;
            margin-bottom: 30px;
            position: relative;
        }
        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 2.5rem;
            font-weight: bold;
            color: white;
            border: 4px solid white;
            position: relative;
            overflow: hidden;
        }
        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .avatar-upload {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: var(--accent);
            border: 2px solid white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            font-size: 14px;
        }
        .profile-name {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        .profile-email {
            opacity: 0.9;
            font-size: 1rem;
        }
        .profile-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }
        .section-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .profile-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .profile-menu-item {
            padding: 15px 0;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .profile-menu-item:last-child {
            border-bottom: none;
        }
        .profile-menu-item:hover {
            background: var(--neutral);
            margin: 0 -20px;
            padding: 15px 20px;
        }
        .menu-item-content {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }
        .menu-item-icon {
            width: 40px;
            height: 40px;
            background: var(--neutral);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent);
            font-size: 1.2rem;
        }
        .menu-item-text {
            flex: 1;
        }
        .menu-item-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-dark);
        }
        .menu-item-desc {
            font-size: 0.9rem;
            color: var(--text-light);
        }
        .menu-item-arrow {
            color: var(--text-light);
        }
        .security-badge {
            background: var(--success);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .login-session {
            padding: 15px;
            border: 1px solid var(--border);
            border-radius: 10px;
            margin-bottom: 10px;
            background: var(--neutral);
        }
        .session-active {
            border-left: 4px solid var(--success);
        }
        .session-inactive {
            border-left: 4px solid var(--text-light);
        }
        .preference-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border);
        }
        .preference-item:last-child {
            border-bottom: none;
        }
        .preference-info {
            flex: 1;
        }
        .preference-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        .preference-desc {
            font-size: 0.9rem;
            color: var(--text-light);
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--accent);
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        /* Enhanced Search Styles */
        .search-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9998;
            display: none;
        }
        .search-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: white;
            z-index: 9999;
            border-radius: 0 0 20px 20px;
            box-shadow: var(--shadow-lg);
            display: none;
        }
        .search-modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .search-modal-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            outline: none;
        }
        .search-modal-input:focus {
            border-color: var(--accent);
        }
        .search-modal-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: var(--text-light);
            cursor: pointer;
        }
        .search-modal-body {
            max-height: 60vh;
            overflow-y: auto;
            padding: 20px;
        }
        .search-section {
            margin-bottom: 25px;
        }
        .search-section-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .clear-recent {
            background: none;
            border: none;
            color: var(--accent);
            font-size: 0.9rem;
            cursor: pointer;
        }
        .recent-searches {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .recent-search-item {
            background: var(--neutral);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid var(--border);
        }
        .recent-search-item:hover {
            background: var(--accent);
            color: white;
        }
        .popular-searches {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .popular-search-item {
            background: white;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .popular-search-item:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }
        .search-suggestions {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .search-suggestion-item {
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .search-suggestion-item:last-child {
            border-bottom: none;
        }
        .search-suggestion-item:hover {
            background: var(--neutral);
            margin: 0 -20px;
            padding: 12px 20px;
        }
        .suggestion-icon {
            color: var(--text-light);
            font-size: 1rem;
        }
        .advanced-filters {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-top: 15px;
            box-shadow: var(--shadow);
        }
        .filter-group {
            margin-bottom: 20px;
        }
        .filter-title {
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-dark);
        }
        .price-range {
            padding: 0 10px;
        }
        .price-inputs {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .price-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
        }
        .rating-filters {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .rating-filter-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            cursor: pointer;
        }
        .rating-stars-small {
            display: flex;
            gap: 2px;
        }
        .rating-star-small {
            color: #FFB800;
            font-size: 14px;
        }
        .shop-filters {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .shop-filter-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .shop-filter-item:hover {
            border-color: var(--accent);
        }
        .shop-filter-item.selected {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        .filter-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        /* Sorting Styles */
        .sorting-options {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        .sort-label {
            font-weight: 600;
            color: var(--text-dark);
            white-space: nowrap;
        }
        .sort-select {
            padding: 10px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            background: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 160px;
        }
        .sort-select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(58, 142, 246, 0.1);
        }
        .sort-select:hover {
            border-color: var(--accent);
        }
        .sort-badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .sort-badge {
            padding: 8px 16px;
            background: var(--neutral);
            border: 2px solid var(--border);
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        .sort-badge:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }
        .sort-badge.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        /* ORDER ENHANCEMENTS CSS */
        .order-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .order-actions button {
            font-size: 12px;
            padding: 6px 12px;
        }
        .delivery-agent-info {
            border-left: 4px solid var(--accent);
        }
        .eta-section {
            border-left: 4px solid var(--success);
        }
        .order-tracking-details p {
            margin-bottom: 8px;
        }
        /* Notifications Page */
        .notifications-page { display: none; }
        .notification-item { 
            padding: 15px; 
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 12px;
        }
        .notification-unread { background: rgba(58, 142, 246, 0.05); }
        .quantity-cart-container {
            display: flex;
            gap: 15px;
            align-items: center;
            width: 100%;
        }
        .btn-add-cart-detail {
            flex: 1;
            min-width: 200px;
        }
        .product-detail-actions {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        /* HIDE ALL BADGES IN HAMBURGER MENU */
        #hamburgerMenu .nav-badge {
            display: none !important;
        }
        .quantity-cart-container {
            display: flex;
            gap: 15px;
            align-items: center;
            flex: 1;
        }
        .btn-quantity {
            display: flex;
            align-items: center;
            gap: 15px;
            background: var(--neutral);
            padding: 10px 15px;
            border-radius: 10px;
            border: 1px solid var(--border);
        }
        .product-detail-actions {
            display: flex;
            gap: 15px;
            align-items: center;
            width: 100%;
        }
        .btn-add-cart-detail {
            flex: 1;
            min-width: 160px;
        }
        /* FINAL FIX - QUANTITY & CART LAYOUT */
        .quantity-cart-container {
            display: flex;
            align-items: center;
            gap: 15px;
            width: 100%;
        }
        .btn-quantity {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--neutral);
            padding: 10px 15px;
            border-radius: 10px;
            border: 1px solid var(--border);
        }
        .btn-add-cart-detail {
            flex: 1;
        }
        .product-detail-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        /* HIDE ALL BADGES IN HAMBURGER MENU */
        #hamburgerMenu .nav-badge {
            display: none !important;
        }
        /* Bottom nav badge proper position fix */
        .bottom-nav .nav-item {
            position: relative;
        }
        .bottom-nav .nav-badge {
            position: absolute;
            top: -6px;
            left: 50%;
            right: auto;
            transform: translateX(4px);
            background: var(--accent);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 700;
            min-width: 18px;
            text-align: center;
        }
        /* FINAL QUANTITY FIX */
        .product-detail-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .quantity-cart-container {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }
        #hamburgerWishlistCount {
            display: none !important;
        }
        /* DEBUG - COLOR CODE BADGES */
        #bottomCartCount { background: red !important; }
        #hamburgerWishlistCount { background: blue !important; }
        /* HIDE WISHLIST BADGE IN HAMBURGER MENU */
        #hamburgerWishlistCount {
            display: none !important;
        }
        /* HIDE ALL BADGES IN HAMBURGER MENU */
        #hamburgerMenu .nav-badge {
            display: none !important;
        }
        /* FIX QUANTITY LAYOUT */
        .quantity-cart-container {
            display: flex !important;
            flex-direction: row !important;
            align-items: center !important;
            gap: 15px !important;
            width: 100% !important;
        }
        .btn-quantity {
            display: flex !important;
            flex-direction: row !important;
            align-items: center !important;
            gap: 10px !important;
            white-space: nowrap !important;
        }
        /* REMOVE BADGE FROM HAMBURGER MENU ITEMS */
        #hamburgerMenu .nav-badge,
        .nav-item[onclick*="openHamburgerMenu"] .nav-badge {
            display: none !important;
        }
        /* KEEP BADGES FOR OTHER NAV ITEMS */
        .nav-item[data-page] .nav-badge {
            display: block; /* This keeps badges for Home, Orders, Account, Cart */
        }
        .delivery-options {
            margin: 10px 0;
        }
        .delivery-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            border: 2px solid var(--border);
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .delivery-option.selected {
            border-color: var(--accent);
            background: rgba(58, 142, 246, 0.05);
        }
        .delivery-option:hover {
            border-color: var(--accent);
        }
        /* SOCIAL SHARE STYLES */
        .btn-outline:hover {
            background: var(--accent);
            color: white;
        }
        .share-options-modal {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: var(--shadow-lg);
            max-width: 300px;
            margin: 20px auto;
        }
        .share-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .btn-share {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-share.whatsapp {
            background: #25D366;
            color: white;
        }
        .btn-share.copy {
            background: var(--accent);
            color: white;
        }
        /* Modal Overlay - Fixed Position */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.12);
            position: relative;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-dark);
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-light);
            cursor: pointer;
        }
        .modal-body {
            margin-bottom: 20px;
        }
        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }
        /* ✅ FIX: ORDER STATUS BADGES */
.orders-count-badge {
    position: absolute;
    top: -8px;
    right: 10px;
    background: var(--danger);
    color: white;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 700;
    min-width: 18px;
    text-align: center;
}

/* Order status specific colors */
.status-preparing { background: #F59E0B; color: white; }
.status-dispatched { background: #8B5CF6; color: white; }
.status-packed { background: #7C3AED; color: white; }
.status-ready-for-pickup { background: #10B981; color: white; }
.status-out-for-delivery { background: #3A8EF6; color: white; }

/* Real-time update notification */
.order-update-notification {
    position: fixed;
    top: 70px;
    right: 20px;
    background: var(--success);
    color: white;
    padding: 12px 20px;
    border-radius: 10px;
    box-shadow: var(--shadow-lg);
    z-index: 9999;
    display: none;
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

/* ✅ REFUND STYLES */
.refund-notification {
    position: fixed;
    top: 80px;
    right: 20px;
    background: linear-gradient(135deg, #10B981, #059669);
    color: white;
    padding: 15px 20px;
    border-radius: 10px;
    box-shadow: var(--shadow-lg);
    z-index: 9999;
    max-width: 300px;
    animation: slideIn 0.3s ease;
}

.refund-message {
    background: linear-gradient(135deg, #FEF3C7, #FDE68A);
    padding: 10px 15px;
    border-radius: 8px;
    margin: 10px 0;
    border-left: 4px solid #F59E0B;
}

.refund-status-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    margin-left: 10px;
}

.refund-pending {
    background: #FEF3C7;
    color: #92400E;
}

.refund-processing {
    background: #DBEAFE;
    color: #1E40AF;
}

.refund-completed {
    background: #D1FAE5;
    color: #065F46;
}

/* ✅ OFFLINE NOTIFICATION STYLES */
.offline-notification {
    position: fixed;
    top: 60px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--danger);
    color: white;
    padding: 12px 24px;
    border-radius: 10px;
    box-shadow: var(--shadow-lg);
    z-index: 9999;
    display: none;
    animation: slideDown 0.3s ease;
    text-align: center;
    max-width: 90%;
}

.online-notification {
    position: fixed;
    top: 60px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--success);
    color: white;
    padding: 12px 24px;
    border-radius: 10px;
    box-shadow: var(--shadow-lg);
    z-index: 9999;
    display: none;
    animation: slideDown 0.3s ease;
    text-align: center;
    max-width: 90%;
}

@keyframes slideDown {
    from { transform: translate(-50%, -100%); opacity: 0; }
    to { transform: translate(-50%, 0); opacity: 1; }
}

/* ✅ OFFLINE MODE STYLES */
.offline-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 10000;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.offline-content {
    background: white;
    border-radius: 20px;
    padding: 30px;
    max-width: 400px;
    width: 100%;
    text-align: center;
    box-shadow: var(--shadow-lg);
}

.offline-icon {
    font-size: 60px;
    color: var(--danger);
    margin-bottom: 20px;
}

.offline-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-dark);
    margin-bottom: 10px;
}

.offline-message {
    color: var(--text-light);
    margin-bottom: 20px;
    line-height: 1.6;
}

.reload-button {
    background: var(--accent);
    color: white;
    border: none;
    padding: 12px 30px;
    border-radius: 10px;
    font-weight: 600;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 10px;
}

.reload-button:hover {
    background: var(--accent-hover);
    transform: translateY(-2px);
}
        /* 🎯 MOBILE LAYOUT FIXES */
        @media (max-width: 768px) {
            /* Better product grid - 2 products with proper spacing */
            .product-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 12px !important;
                padding: 0 8px !important;
            }
            
            /* Better product card proportions */
            .product-card {
                padding: 12px !important;
                border-radius: 12px !important;
                min-height: 280px !important;
                display: flex !important;
                flex-direction: column !important;
            }
            
            /* Optimized product image */
            .product-image {
                height: 120px !important;
                border-radius: 8px !important;
                margin-bottom: 8px !important;
            }
            
            /* Better text sizing */
            .product-title {
                font-size: 14px !important;
                line-height: 1.3 !important;
                margin-bottom: 4px !important;
                display: -webkit-box !important;
                -webkit-line-clamp: 2 !important;
                -webkit-box-orient: vertical !important;
                overflow: hidden !important;
            }
            
            .product-category {
                font-size: 11px !important;
                margin-bottom: 8px !important;
            }
            
            /* Better price layout */
            .product-price {
                margin-top: auto !important;
                padding-top: 8px !important;
            }
            
            .current-price {
                font-size: 16px !important;
            }
            
            .original-price {
                font-size: 12px !important;
            }
            
            .discount {
                font-size: 11px !important;
            }
            
            /* Better button sizing */
            .btn-add-cart {
                padding: 8px 12px !important;
                font-size: 12px !important;
                border-radius: 8px !important;
            }
            
            /* Badge optimization */
            .product-badge {
                font-size: 10px !important;
                padding: 3px 8px !important;
                top: 8px !important;
                left: 8px !important;
            }
            
            .shop-badge {
                font-size: 9px !important;
                padding: 2px 6px !important;
                top: 8px !important;
                right: 8px !important;
            }
            
            .wishlist-btn {
                position: absolute !important;
                bottom: 60px !important;
                right: 12px !important;
                top: auto !important;
                width: 32px !important;
                height: 32px !important;
                background: rgba(255,255,255,0.9) !important;
                border: none !important;
                border-radius: 50% !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                cursor: pointer !important;
                transition: all 0.3s ease !important;
                color: var(--text-light) !important;
                z-index: 3 !important;
            }
            
            .wishlist-btn:hover {
                background: white !important;
                transform: scale(1.1) !important;
            }
            
            .wishlist-btn.active {
                background: var(--danger) !important;
                color: white !important;
            }
            
            /* Mobile adjustment */
            @media (max-width: 768px) {
                .wishlist-btn {
                    bottom: 50px !important;
                    right: 8px !important;
                    width: 28px !important;
                    height: 28px !important;
                }
            }
            
            /* Header optimization */
            .header-container { 
                flex-direction: column; 
                gap: 12px; 
                position: relative;
            }
            
            .search-container { 
                margin: 0 auto; 
                width: 100%; 
                max-width: 500px;
            }
            
            /* Container optimization */
            .container-main {
                margin: 16px auto !important;
                padding: 0 8px !important;
            }
            
            /* Container optimization */
            .container-main {
                margin: 16px auto !important;
                padding: 0 8px !important;
            }
            
            /* Hero section optimization */
            .hero-banner {
                padding: 20px 16px !important;
                margin-bottom: 20px !important;
                border-radius: 16px !important;
            }
            
            .hero-content { 
                max-width: 100%; 
            }
            
            .hero-title { 
                font-size: 1.5rem !important;
                margin-bottom: 10px !important;
            }
            
            .hero-subtitle {
                font-size: 0.9rem !important;
                margin-bottom: 15px !important;
            }
            
            /* Filter section optimization */
            .filter-section > div {
                flex-direction: column !important;
                gap: 12px !important;
            }
            
            .filter-section .d-flex {
                width: 100% !important;
                justify-content: space-between !important;
                margin-bottom: 15px !important;
            }
            
            .category-filter {
                flex: 1 !important;
                margin: 0 4px !important;
            }
            
            .sorting-options {
                width: 100% !important;
                justify-content: space-between !important;
            }
            
            .sort-select {
                min-width: 140px !important;
            }
            
            /* Auth optimization */
            .auth-card { 
                padding: 30px 25px; 
            }
            
            .form-row { 
                grid-template-columns: 1fr; 
            }
            
            /* Wishlist optimization */
            .wishlist-card { 
                flex-direction: column; 
                text-align: center; 
            }
            
            .wishlist-actions { 
                justify-content: center; 
            }
            
            /* Reviews optimization */
            .rating-summary { 
                flex-direction: column; 
                gap: 20px; 
                text-align: center; 
            }
            
            /* Product detail optimization */
            .product-detail-actions { 
                flex-direction: column; 
            }
            
            .product-detail-image { 
                height: 300px; 
            }
            
            /* Order actions */
            .order-actions {
                justify-content: center;
            }
            
            .order-actions button {
                flex: 1;
                min-width: 80px;
            }
            
            /* Enhanced Search Mobile Styles */
            .search-modal-body {
                max-height: 70vh;
            }
            
            .popular-searches {
                grid-template-columns: 1fr;
            }
            
            .shop-filters {
                grid-template-columns: 1fr;
            }
            
            .recent-searches {
                flex-direction: column;
            }
            
            .recent-search-item {
                text-align: center;
            }
            
            /* ✅ MOBILE ORDER TRACKING FIX */
            .order-timeline {
                padding: 0 5px !important;
            }
            
            .step-label {
                font-size: 9px !important;
            }
            
            .step-time {
                font-size: 8px !important;
            }
            
            .step-icon {
                width: 30px !important;
                height: 30px !important;
                font-size: 12px !important;
            }
            
            /* Mobile product detail adjustments */
            .specifications-section,
            .return-policy-section {
                padding: 15px !important;
            }
            
            .specs-grid {
                grid-template-columns: 1fr !important;
            }
        }
        /* Header Layout Fix */
        .app-header .header-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            position: relative;
        }
        .app-header .search-container {
            flex: 1;
            max-width: 500px;
            margin: 0 auto;
            position: relative;
        }
        .app-header .header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: auto;
        }
        /* Center search bar on desktop */
        @media (min-width: 769px) {
            .app-header .header-container {
                position: relative;
            }
            
            .app-header .search-container {
                position: absolute;
                left: 50%;
                transform: translateX(-50%);
                width: 400px;
            }
            
            .app-header .header-actions {
                margin-left: auto;
            }
        }
        /* Mobile responsive */
        @media (max-width: 768px) {
            .app-header .header-container {
                flex-direction: column;
                gap: 12px;
            }
            
            .app-header .search-container {
                order: 2;
                width: 100%;
                max-width: none;
            }
            
            .app-header .header-actions {
                order: 3;
                width: 100%;
                justify-content: flex-end;
            }
        }
        /* Logout option styling */
        .preference-item[style*="color: var(--danger)"] {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .preference-item[style*="color: var(--danger)"]:hover {
            background: #FEE2E2;
            border-radius: 8px;
            padding: 12px;
            margin: -12px -12px -12px -12px;
        }
        /* 🎯 EXTRA SMALL DEVICES */
        @media (max-width: 480px) {
            .product-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 8px !important;
                padding: 0 4px !important;
            }
            
            .product-card {
                padding: 10px !important;
                min-height: 260px !important;
            }
            
            .product-image {
                height: 110px !important;
            }
            
            .product-title {
                font-size: 13px !important;
            }
            
            .current-price {
                font-size: 15px !important;
            }
            
            .container-main { 
                padding: 0 12px; 
            }
            
            .hero-banner { 
                padding: 20px; 
            }
            
            .product-detail-content { 
                padding: 20px; 
            }
            
            .reviews-section { 
                padding: 20px; 
            }
            
            /* ✅ EXTRA SMALL ORDER TRACKING */
            .order-timeline {
                padding: 0 2px !important;
            }
            
            .step-label {
                font-size: 8px !important;
            }
            
            .step-time {
                font-size: 7px !important;
            }
            
            .step-icon {
                width: 25px !important;
                height: 25px !important;
                font-size: 10px !important;
            }
        }
        /* 🎯 TABLET OPTIMIZATION */
        @media (min-width: 769px) and (max-width: 1024px) {
            .product-grid {
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 16px !important;
            }
        }
        /* Desktop remains unchanged */
        @media (min-width: 769px) {
            .product-grid {
                grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
                gap: 20px;
            }
        }
        
        /* ✅ FIX: ORDER STATUS BADGES */
        .orders-count-badge {
            position: absolute;
            top: -8px;
            right: 10px;
            background: var(--danger);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 700;
            min-width: 18px;
            text-align: center;
        }
        
        /* Order status specific colors */
        .status-preparing { background: #F59E0B; color: white; }
        .status-dispatched { background: #8B5CF6; color: white; }
        .status-packed { background: #7C3AED; color: white; }
        .status-ready-for-pickup { background: #10B981; color: white; }
        .status-out-for-delivery { background: #3A8EF6; color: white; }
        
        /* Real-time update notification */
        .order-update-notification {
            position: fixed;
            top: 70px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            box-shadow: var(--shadow-lg);
            z-index: 9999;
            display: none;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* ✅ NEW: Search bar active state */
        .search-container.active .search-bar {
            box-shadow: 0 4px 20px rgba(58, 142, 246, 0.4);
        }
        
        /* ✅ NEW: Product Description Section */
        .product-description {
            margin: 25px 0;
            padding: 20px;
            background: var(--neutral);
            border-radius: 15px;
        }
        
        .product-description h4 {
            margin-bottom: 15px;
            color: var(--text-dark);
            font-size: 1.2rem;
        }
        
        .product-description p {
            line-height: 1.6;
            color: var(--text-light);
        }
    </style>
</head>
<body>
    <!-- ✅ OFFLINE DETECTION OVERLAY -->
    <div id="offlineOverlay" class="offline-overlay">
        <div class="offline-content">
            <div class="offline-icon">
                <i class="fas fa-wifi-slash"></i>
            </div>
            <h3 class="offline-title">No Internet Connection</h3>
            <p class="offline-message">
                You're currently offline. Please check your internet connection and try again.
                <br><br>
                <small>Some features may not work properly while offline.</small>
            </p>
            <button class="reload-button" onclick="checkInternetAndReload()">
                <i class="fas fa-sync-alt"></i> Retry Connection
            </button>
        </div>
    </div>

    <!-- ✅ OFFLINE NOTIFICATION -->
    <div id="offlineNotification" class="offline-notification">
        <i class="fas fa-wifi-slash"></i> You are offline
    </div>

    <!-- ✅ ONLINE NOTIFICATION -->
    <div id="onlineNotification" class="online-notification">
        <i class="fas fa-wifi"></i> You are back online
    </div>

    <!-- Login/Signup Screen -->
    <div id="authScreen">
        <div class="auth-container">
            <div class="auth-card">
                <div class="auth-header">
                    <div class="auth-logo">R</div>
                    <h1 class="auth-title">Welcome to Raashanmart</h1>
                    <p class="auth-subtitle">Sign in to your account</p>
                </div>
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="loginEmail" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" id="loginPassword" placeholder="Enter your password" required>
                    </div>
                    <button type="submit" class="btn-primary w-100" style="padding: 12px;">Sign In</button>
                    <div class="forgot-password">
                 <a href="#" onclick="showForgotPassword()">Forgot Password?</a>
                    </div>
                </form>
                <form id="signupForm" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="signupName" placeholder="Enter your full name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="signupEmail" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" id="signupPassword" placeholder="Create a password" required>
                    </div>
                    <button type="submit" class="btn-primary w-100" style="padding: 12px;">Create Account</button>
                </form>
                <div class="auth-footer">
                    <p id="loginFooter">Don't have an account? <a href="#" class="auth-link" id="showSignup">Sign up</a></p>
                    <p id="signupFooter" style="display: none;">Already have an account? <a href="#" class="auth-link" id="showLogin">Sign in</a></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App Screen -->
    <div id="appScreen" style="display: none;">
        <header class="app-header">
            <div class="header-container">
                <a href="#" class="brand">
                    <div class="brand-logo">R</div>
                    <span>Raashanmart</span>
                </a>
                <div class="search-container">
                    <input type="text" id="search" class="search-bar" placeholder="Search for products, categories...">
                    <div class="search-icon"><i class="fas fa-search"></i></div>
                    <div class="search-results" id="searchResults"></div>
                </div>
                <div class="header-actions">
                </div>
            </div>
        </header>
        
        <!-- Real-time order update notification -->
        <div id="orderUpdateNotification" class="order-update-notification">
            <i class="fas fa-bell"></i> Order status updated!
        </div>
        
        <div class="container-main">
            <div id="homePage">
                <div class="hero-banner">
                    <div class="hero-content">
                        <div class="hero-badge">
                            <i class="fas fa-bolt"></i>
                            <span>Fast Delivery • Best Prices</span>
                        </div>
                        <h1 class="hero-title">Groceries Delivered to Your Doorstep</h1>
                        <p class="hero-subtitle">Fresh products, competitive prices, and quick delivery</p>
                        <button class="btn-primary">Shop Now</button>
                    </div>
                    <div class="hero-pattern"></div>
                </div>
                
                <!-- Enhanced Search Modal -->
                <div id="searchOverlay" class="search-overlay"></div>
                <div id="searchModal" class="search-modal">
                    <div class="search-modal-header">
                        <div style="position: relative; flex: 1;">
                            <input type="text" id="enhancedSearchInput" class="search-modal-input" placeholder="Search for products, shops, categories...">
                            <div id="searchSuggestions" class="search-results" style="display: none;"></div>
                        </div>
                        <button class="search-modal-close" onclick="closeEnhancedSearch()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="search-modal-body">
                        <!-- Recent Searches -->
                        <div class="search-section" id="recentSearchesSection">
                            <div class="search-section-title">
                                <span>Recent Searches</span>
                                <button class="clear-recent" onclick="clearRecentSearches()">Clear all</button>
                            </div>
                            <div class="recent-searches" id="recentSearchesList">
                                <!-- Recent searches will be populated here -->
                            </div>
                        </div>

                        <!-- Popular Searches -->
                        <div class="search-section">
                            <div class="search-section-title">
                                <span>Popular Searches</span>
                            </div>
                            <div class="popular-searches" id="popularSearchesList">
                                <!-- Popular searches will be populated here -->
                            </div>
                        </div>

                        <!-- Search Suggestions -->
                        <div class="search-section" id="searchSuggestionsSection" style="display: none;">
                            <div class="search-section-title">
                                <span>Suggestions</span>
                            </div>
                            <ul class="search-suggestions" id="searchSuggestionsList">
                                <!-- Search suggestions will be populated here -->
                            </ul>
                        </div>

                        <!-- Advanced Filters -->
                        <div class="advanced-filters" id="advancedFilters">
                            <div class="filter-group">
                                <div class="filter-title">Price Range</div>
                                <div class="price-range">
                                    <input type="range" id="priceRange" min="0" max="5000" value="5000" class="form-range">
                                    <div class="price-inputs">
                                        <input type="number" id="minPrice" class="price-input" placeholder="Min" value="0">
                                        <input type="number" id="maxPrice" class="price-input" placeholder="Max" value="5000">
                                    </div>
                                </div>
                            </div>

                            <div class="filter-group">
                                <div class="filter-title">Customer Rating</div>
                                <div class="rating-filters">
                                    <label class="rating-filter-item">
                                        <input type="checkbox" class="rating-filter" value="4">
                                        <div class="rating-stars-small">
                                            <i class="fas fa-star rating-star-small"></i>
                                            <i class="fas fa-star rating-star-small"></i>
                                            <i class="fas fa-star rating-star-small"></i>
                                            <i class="fas fa-star rating-star-small"></i>
                                            <i class="fas fa-star rating-star-small"></i>
                                        </div>
                                        <span>4+ Stars</span>
                                    </label>
                                    <label class="rating-filter-item">
                                        <input type="checkbox" class="rating-filter" value="3">
                                        <div class="rating-stars-small">
                                            <i class="fas fa-star rating-star-small"></i>
                                            <i class="fas fa-star rating-star-small"></i>
                                            <i class="fas fa-star rating-star-small"></i>
                                            <i class="fas fa-star rating-star-small"></i>
                                            <i class="far fa-star rating-star-small"></i>
                                        </div>
                                        <span>3+ Stars</span>
                                    </label>
                                </div>
                            </div>

                            <div class="filter-group">
                                <div class="filter-title">Shops</div>
                                <div class="shop-filters" id="shopFiltersList">
                                    <!-- Shop filters will be populated here -->
                                </div>
                            </div>

                            <div class="filter-actions">
                                <button class="btn-outline" onclick="resetFilters()" style="flex: 1;">
                                    <i class="fas fa-refresh"></i> Reset
                                </button>
                                <button class="btn-primary" onclick="applyAdvancedFilters()" style="flex: 1;">
                                    <i class="fas fa-check"></i> Apply
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                        <!-- ✅ UPDATED ORDER TRACKING MODAL WITH MORE STEPS -->
        <div class="bottom-sheet" id="orderTracking">
            <span class="sheet-handle"></span>
            <div class="sheet-header">
                <strong class="sheet-title">Track Your Order</strong>
                <button class="sheet-close" onclick="closeOrderTracking()">&times;</button>
            </div>
            <div class="sheet-body">
                <div class="order-timeline" id="orderTimeline">
                    <div class="timeline-step">
                        <div class="step-icon completed" id="stepConfirmed">
                            <i class="fas fa-check"></i>
                        </div>
                        <div class="step-label completed">Order Confirmed</div>
                        <div class="step-time" id="timeConfirmed">Today, 10:30 AM</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-icon active" id="stepPreparing">
                            <i class="fas fa-utensils"></i>
                        </div>
                        <div class="step-label active">Preparing</div>
                        <div class="step-time" id="timePreparing">In progress</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-icon" id="stepPacked">
                            <i class="fas fa-box"></i>
                        </div>
                        <div class="step-label">Packed</div>
                        <div class="step-time" id="timePacked">--</div>
                    </div>
                    <div class="timeline-step" id="stepDispatchedContainer">
                        <div class="step-icon" id="stepDispatched">
                            <i class="fas fa-shipping-fast"></i>
                        </div>
                        <div class="step-label">Dispatched</div>
                        <div class="step-time" id="timeDispatched">--</div>
                    </div>
                    <!-- DELIVERY OR PICKUP STEP (DYNAMIC) -->
                    <div class="timeline-step" id="finalStepContainer">
                        <div class="step-icon" id="stepFinal">
                            <i class="fas fa-home" id="finalIcon"></i>
                        </div>
                        <div class="step-label" id="finalLabel">Delivered</div>
                        <div class="step-time" id="timeFinal">--</div>
                    </div>
                </div>
                
                <div class="order-details-card">
                    <h5>Order Details</h5>
                    <div id="trackingOrderDetails"></div>
                </div>
                
                <!-- PICKUP LOCATION BUTTON (SHOW ONLY FOR PICKUP ORDERS) -->
                <button class="btn-outline w-100 mt-3" id="pickupLocationBtn" onclick="showPickupLocation()" style="display: none;">
                    <i class="fas fa-map-marker-alt"></i> View Pickup Location
                </button>
                
                <button class="btn-outline w-100 mt-3" id="cancelOrderBtn" onclick="cancelOrder()">
                    <i class="fas fa-times"></i> Cancel Order
                </button>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div class="modal fade" id="confirmationModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header" style="background: var(--primary); color: white;">
                        <h5 class="modal-title" id="confirmationTitle">Confirm Action</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="confirmationMessage">
                        <!-- Message will be inserted here -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-outline" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn-primary" id="confirmAction">Confirm</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ✅ FIX 1: एकीकृत ऑर्डर आईडी सिस्टम
    // ✅ FIX 2: रिफंड सिस्टम शॉपकीपर और कस्टमर दोनों के लिए
    
    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyD2-yz4xwYD5S_oXs6ryhNP8XIC94jzda4",
        authDomain: "dukaan-platform.firebaseapp.com",
        projectId: "dukaan-platform", 
        storageBucket: "dukaan-platform.firebasestorage.app",
        messagingSenderId: "75765851780",
        appId: "1:75765851780:web:dd9567db1d39c3b09c84d1"
    };

    // Initialize Firebase
    try {
        firebase.initializeApp(firebaseConfig);
        console.log('Firebase initialized successfully');
    } catch (error) {
        console.log('Firebase already initialized');
    }
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    // ✅ FIX 1: AUTO LOGOUT FIX - Use LOCAL persistence instead of SESSION
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

    // ✅ DYNAMIC SHOPS - WILL BE POPULATED FROM FIREBASE
    let SHOPS = {};

    let PRODUCTS = [];

    // ✅ FIX 5: DYNAMIC CATEGORIES FROM FIREBASE
    let ALL_CATEGORIES = new Set();

    // Firebase se real products load karne ka function - UPDATED
    async function loadProductsFromFirebase() {
        try {
            console.log('📦 Loading products from Firebase...');
            
            // ✅ SIMPLE QUERY - NO FILTERS
            const productsSnapshot = await db.collection('products').get();
            
            PRODUCTS = [];
            ALL_CATEGORIES.clear();
            
            productsSnapshot.forEach(doc => {
                const firebaseProduct = doc.data();
                
                // ✅ FILTER LOCALLY
                // Skip if status is not active
                if (firebaseProduct.status !== 'active') {
                    console.log('Skipping inactive:', firebaseProduct.name);
                    return;
                }
                
                // Skip if stock is 0 or less
                if (firebaseProduct.stock <= 0) {
                    console.log('Skipping out of stock:', firebaseProduct.name);
                    return;
                }
                
                // ✅ MAP FIELDS
                const mappedProduct = {
                    id: doc.id,
                    name: firebaseProduct.name,
                    price: firebaseProduct.price,
                    mrp: firebaseProduct.mrp,
                    category: firebaseProduct.category || 'Uncategorized',
                    // ✅ CRITICAL FIX: Ensure shopId and shopName are set
                    shopId: firebaseProduct.shopId || firebaseProduct.shop || 'unknown_shop', 
                    shopName: firebaseProduct.shopName || firebaseProduct.shop || 'Unknown Shop',
                    image: firebaseProduct.image,
                    stock: firebaseProduct.stock,
                    description: firebaseProduct.description || '',
                    isAvailable: firebaseProduct.isAvailable !== false,
                    status: firebaseProduct.status || 'active',
                    deliveryTime: firebaseProduct.deliveryTime || '10-15 min',
                    specifications: firebaseProduct.specifications || {},
                    returnPolicy: firebaseProduct.returnPolicy || 'No returns. Contact shopkeeper for any issues.',
                    brand: firebaseProduct.brand || 'Generic',
                    features: firebaseProduct.features || []
                };
                
                PRODUCTS.push(mappedProduct);
                
                // ✅ ADD CATEGORY TO DYNAMIC SET
                if (firebaseProduct.category) {
                    ALL_CATEGORIES.add(firebaseProduct.category);
                }
            });
            
            console.log('📦 Products loaded:', PRODUCTS.length);
            console.log('📋 Categories found:', Array.from(ALL_CATEGORIES));
            
            // ✅ UPDATE DYNAMIC SHOPS FROM PRODUCTS
            updateDynamicShops();
            
            // ✅ UPDATE FILTER DROPDOWNS WITH DYNAMIC DATA
            updateShopAndCategoryFilters();
            
            if (typeof renderProducts === 'function') {
                renderProducts(PRODUCTS);
            }
            
        } catch (error) {
            console.error('Error loading products:', error);
            PRODUCTS = getDemoProducts();
            updateDynamicShops();
            updateShopAndCategoryFilters();
            if (typeof renderProducts === 'function') {
                renderProducts(PRODUCTS);
            }
        }
    }

    // ✅ DYNAMIC SHOPS FROM PRODUCTS
    function updateDynamicShops() {
        SHOPS = {};
        
        PRODUCTS.forEach(product => {
            const shopId = product.shopId;
            const shopName = product.shopName;
            
            if (shopId && shopName && !SHOPS[shopId]) {
                SHOPS[shopId] = {
                    id: shopId,
                    name: shopName,
                    category: product.category || 'general',
                    rating: 4.5,
                    deliveryTime: product.deliveryTime || '10-15 min'
                };
            }
        });
        
        console.log('🛍️ Dynamic shops updated:', Object.keys(SHOPS).length, 'shops');
    }

    // ✅ UPDATED: UPDATE SHOP AND CATEGORY FILTERS WITH DYNAMIC DATA
    function updateShopAndCategoryFilters() {
        // Shop Filter
        const shopFilter = document.getElementById('shopFilter');
        const categoryFilter = document.getElementById('categoryFilter');
        
        if (shopFilter) {
            shopFilter.innerHTML = '<option value="">All Shops</option>';
            Object.keys(SHOPS).forEach(shopId => {
                const shop = SHOPS[shopId];
                shopFilter.innerHTML += `<option value="${shopId}">${shop.name}</option>`;
            });
            console.log('✅ Shop filter updated with', Object.keys(SHOPS).length, 'shops');
        }
        
        // Category Filter
        if (categoryFilter) {
            categoryFilter.innerHTML = '<option value="">All Categories</option>';
            
            // ✅ ADD DYNAMIC CATEGORIES FROM ALL_CATEGORIES SET
            const categories = Array.from(ALL_CATEGORIES).sort();
            categories.forEach(category => {
                if (category && category.trim() !== '') {
                    categoryFilter.innerHTML += `<option value="${category}">${category}</option>`;
                }
            });
            console.log('✅ Category filter updated:', categories.length, 'dynamic categories');
        }
    }

    // ✅ ENHANCED REFUND SYSTEM FUNCTIONS
    function setupPartialOrderRefundSystem() {
        if (!currentUser) return;
        
        console.log("💰 Setting up refund listener for user:", currentUser.uid);
        
        // Listen to refunds collection for this customer
        db.collection('refunds')
            .where('customerId', '==', currentUser.uid)
            .onSnapshot((snapshot) => {
                console.log("🔄 Refund update received:", snapshot.docChanges().length, "changes");
                
                snapshot.docChanges().forEach((change) => {
                    const refundData = { 
                        id: change.doc.id, 
                        ...change.doc.data() 
                    };
                    
                    console.log("💰 Refund update type:", change.type, "Refund ID:", refundData.id, "Status:", refundData.status);
                    
                    if (change.type === 'added' || change.type === 'modified') {
                        handleRefundUpdate(refundData);
                    }
                });
            }, (error) => {
                console.error("❌ Error in refund listener:", error);
            });
    }

    function handleRefundUpdate(refundData) {
        const { orderId, refundAmount, status, estimatedTime, completedAt } = refundData;
        
        // Find the order
        const orderIndex = orders.findIndex(order => order.id === orderId);
        
        if (orderIndex !== -1) {
            // Update order with refund information
            orders[orderIndex].refundStatus = status;
            orders[orderIndex].refundAmount = refundAmount;
            orders[orderIndex].refundEstimatedTime = estimatedTime;
            if (completedAt) {
                orders[orderIndex].refundCompletedAt = completedAt;
            }
            
            // Save to local storage
            localStorage.setItem('dukaan_orders', JSON.stringify(orders));
            
            // Update UI
            renderOrders();
            
            // Show notification if status is pending or completed
            if (status === 'pending') {
                showRefundNotification(refundData);
            } else if (status === 'completed') {
                showRefundCompletedNotification(refundData);
            }
        }
    }

    function showRefundNotification(refundData) {
        const { orderId, refundAmount, estimatedTime } = refundData;
        
        const notificationHTML = `
            <div class="refund-notification">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                    <i class="fas fa-money-bill-wave"></i>
                    <strong>Refund Initiated</strong>
                </div>
                <div style="margin-bottom: 5px;">
                    ₹${refundAmount} will be refunded for Order #${orderId.slice(-6)}
                </div>
                <div style="opacity: 0.9;">
                    <i class="fas fa-clock"></i> Expected within ${estimatedTime}
                </div>
            </div>
        `;
        
        const existing = document.querySelector('.refund-notification');
        if (existing) existing.remove();
        
        document.body.insertAdjacentHTML('beforeend', notificationHTML);
        
        setTimeout(() => {
            const notif = document.querySelector('.refund-notification');
            if (notif) notif.remove();
        }, 10000);
    }

    function showRefundCompletedNotification(refundData) {
        const { orderId, refundAmount } = refundData;
        
        showToast(`✅ Refund of ₹${refundAmount} completed for Order #${orderId.slice(-6)}`);
    }

    function addRefundMessageToOrder(order) {
        if (order.refundStatus) {
            let message = '';
            let badgeClass = '';
            let badgeText = '';
            
            switch(order.refundStatus) {
                case 'pending':
                    message = `
                        <div class="refund-message">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                <i class="fas fa-exchange-alt" style="color: #D97706;"></i>
                                <strong style="color: #92400E;">Partial Refund Initiated</strong>
                            </div>
                            <div style="color: #92400E;">
                                ₹${order.refundAmount || 0} will be refunded within ${order.refundEstimatedTime || '24-48 hours'}
                            </div>
                        </div>
                    `;
                    badgeClass = 'refund-pending';
                    badgeText = 'Refund Pending';
                    break;
                    
                case 'processing':
                    message = `
                        <div class="refund-message">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                <i class="fas fa-sync-alt" style="color: #1E40AF;"></i>
                                <strong style="color: #1E40AF;">Refund Processing</strong>
                            </div>
                            <div style="color: #1E40AF;">
                                ₹${order.refundAmount || 0} is being processed
                            </div>
                        </div>
                    `;
                    badgeClass = 'refund-processing';
                    badgeText = 'Processing';
                    break;
                    
                case 'completed':
                    const completedDate = order.refundCompletedAt ? 
                        new Date(order.refundCompletedAt).toLocaleDateString() : 'Recently';
                    message = `
                        <div class="refund-message">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                <i class="fas fa-check-circle" style="color: #059669;"></i>
                                <strong style="color: #065F46;">Refund Completed</strong>
                            </div>
                            <div style="color: #065F46;">
                                ₹${order.refundAmount || 0} refunded on ${completedDate}
                            </div>
                        </div>
                    `;
                    badgeClass = 'refund-completed';
                    badgeText = 'Refunded';
                    break;
            }
            
            // Add badge to order status
            if (badgeClass && badgeText) {
                const orderElement = document.querySelector(`[data-order-id="${order.id}"]`);
                if (orderElement) {
                    const statusDiv = orderElement.querySelector('.order-status');
                    if (statusDiv) {
                        // Clear existing refund badges to prevent duplicates on re-render
                        statusDiv.querySelectorAll('.refund-status-badge').forEach(badge => badge.remove());
                        
                        const badge = document.createElement('span');
                        badge.className = `refund-status-badge ${badgeClass}`;
                        badge.textContent = badgeText;
                        statusDiv.appendChild(badge);
                    }
                }
            }
            
            return message;
        }

        // Emergency fallback demo products
        function getDemoProducts() {
            return [
                { id: 'demo1', name: 'Fresh Cow Milk', price: 60, mrp: 70, category: 'dairy', shopId: 'freshmart', shopName: 'FreshMart', image: 'https://images.unsplash.com/photo-1563636619-e9143da7973b?w=400&h=300&fit=crop', badge: 'Fresh', size: '1 Litre', brand: 'Amul', description: 'Fresh pasteurized cow milk rich in calcium and protein.', features: ['Pasteurized', 'Rich in Calcium', 'No Preservatives'], specifications: { type: 'Cow Milk', fat: '3.5%', shelfLife: '7 days' }, returnPolicy: 'No returns. Contact shopkeeper for any issues.' },
                { id: 'demo2', name: 'Face Cream', price: 199, mrp: 249, category: 'cosmetics', shopId: 'cosmeticstore', shopName: 'CosmeticStore', image: 'https://images.unsplash.com/photo-1596462502278-27bfdc403348?w=400&h=300&fit=crop', badge: 'New', size: '50ml', brand: 'Lakme', description: 'Moisturizing face cream with SPF protection.', features: ['SPF 30', 'Moisturizing', 'Non-Greasy'], specifications: { skinType: 'All Skin Types', spf: 'SPF 30' }, returnPolicy: 'No returns. Contact shopkeeper for damaged products.' }
            ];
        }

        const AVAILABLE_COUPONS = [
            { code: "WELCOME10", type: "percentage", value: 10, minOrder: 500, description: "Get 10% OFF on orders above ₹500" },
            { code: "FLAT50", type: "fixed", value: 50, minOrder: 300, description: "Get ₹50 OFF on orders above ₹300" }
        ];

        // ✅ FIX 2: SHOPKEEPER COUPON SETTINGS
        let SHOP_COUPON_SETTINGS = {
            couponEnabled: true, // Default: coupons enabled
            activeCoupons: ['WELCOME10', 'FLAT50'] // Default active coupons
        };

        // Load shop coupon settings from Firebase
        async function loadShopCouponSettings() {
            if (!isOnline) return;
            try {
                const settingsDoc = await db.collection('settings').doc('couponSettings').get();
                if (settingsDoc.exists) {
                    SHOP_COUPON_SETTINGS = settingsDoc.data();
                    console.log('✅ Shop coupon settings loaded:', SHOP_COUPON_SETTINGS);
                }
            } catch (error) {
                console.error('Error loading coupon settings:', error);
            }
        }

        // REVIEWS SYSTEM
        const REVIEW_RULES = {
            minRating: 1,
            maxRating: 5,
            minReviewLength: 10,
            maxReviewLength: 500
        };

        // App State
        let currentUser = null;
        let cart = JSON.parse(localStorage.getItem('dukaan_cart')) || [];
        let wishlist = JSON.parse(localStorage.getItem('dukaan_wishlist')) || [];
        let orderTrackingInterval = null;
        let currentTrackingOrder = null;
        let productReviews = JSON.parse(localStorage.getItem('dukaan_product_reviews')) || [];
        // ✅ CRITICAL FIX for Issue #6: addresses should load from local storage/Firestore
        let addresses = JSON.parse(localStorage.getItem('userAddresses')) || []; 
        let appliedCoupon = null;
        let orders = JSON.parse(localStorage.getItem('dukaan_orders')) || [];
        let selectedPaymentMethod = null;
        let selectedAddress = addresses.length > 0 ? addresses.find(addr => addr.isDefault)?.id || addresses[0].id : null;
        let currentProductDetail = null;
        let selectedRating = 0;
        // Notification System State
        let notifications = JSON.parse(localStorage.getItem('dukaan_notifications')) || [];
        let notificationPreferences = JSON.parse(localStorage.getItem('dukaan_notification_prefs')) || {
            orderUpdates: true,
            priceAlerts: true,
            promotions: true,
            pushEnabled: false // ✅ FIX 5: SET TO FALSE BY DEFAULT
        };

        // Order Badges State
        let orderBadges = {
            pending: 0,
            preparing: 0,
            packed: 0,
            dispatched: 0,
            readyForPickup: 0,
            outForDelivery: 0
        };

        // ✅ INTERNET CONNECTION STATE
        let isOnline = navigator.onLine;
        let offlineCheckInterval = null;

        // DOM Elements
        const authScreen = document.getElementById('authScreen');
        const appScreen = document.getElementById('appScreen');
        const homePage = document.getElementById('homePage');
        const ordersPage = document.getElementById('ordersPage');
        const wishlistPage = document.getElementById('wishlistPage');
        const productDetailPage = document.getElementById('productDetailPage');
        const profilePage = document.getElementById('profilePage'); // Added for profile page
        const notificationsPage = document.getElementById('notificationsPage'); // Added for notifications page
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');
        const searchInput = document.getElementById('search');
        const searchResults = document.getElementById('searchResults');
        const shopFilter = document.getElementById('shopFilter');
        const categoryFilter = document.getElementById('categoryFilter');
        const productGrid = document.getElementById('grid');
        const emptyState = document.getElementById('empty');
        const bottomSheet = document.getElementById('bsheet'); // Assuming there's a div with ID 'bsheet'
        const closeSheetBtn = document.getElementById('closeB'); // Assuming there's a button with ID 'closeB'
        const orderList = document.getElementById('orderList');
        const orderTotal = document.getElementById('orderTotal');
        const placeOrderBtn = document.getElementById('placeOrderBtn');
        const addressesContainer = document.getElementById('addresses');
        const bottomNavCart = document.getElementById('bottomNavCart');
        const bottomCartCount = document.getElementById('bottomCartCount');
        const wishlistNav = document.getElementById('wishlistNav');
        const wishlistCount = document.getElementById('wishlistCount');
        const wishlistItems = document.getElementById('wishlistItems');
        const noWishlist = document.getElementById('noWishlist');
        const navItems = document.querySelectorAll('.nav-item');
        const ordersList = document.getElementById('ordersList');
        const noOrders = document.getElementById('noOrders');
        const couponCodeInput = document.getElementById('couponCode');
        const applyCouponBtn = document.getElementById('applyCouponBtn');
        const couponMessage = document.getElementById('couponMessage');
        const couponLoginRequired = document.getElementById('couponLoginRequired');
        const checkoutPhone = document.getElementById('checkoutPhone');
        const phoneValidation = document.getElementById('phoneValidation');
        const addrPhone = document.getElementById('addrPhone'); // Assuming this exists in the address form
        const addrPhoneValidation = document.getElementById('addrPhoneValidation'); // Assuming this exists
        const paymentOptions = document.querySelectorAll('.payment-option');
        const qrCodeSection = document.getElementById('qrCodeSection');
        const qrAmount = document.getElementById('qrAmount');
        const confirmQrPayment = document.getElementById('confirmQrPayment');
        const utrNumber = document.getElementById('utrNumber');
        const utrValidation = document.getElementById('utrValidation');
        const saveAddr = document.getElementById('saveAddr'); // Assuming this is the save button in the address form
        const orderTracking = document.getElementById('orderTracking');
        const ordersNavBadge = document.getElementById('ordersNavBadge');
        const ordersBadge = document.getElementById('ordersBadge');

        // ✅ FIX 1: UPDATED ADDRESS SAVING FOR SHOPKEEPER APP
        async function saveAddressForShopkeeper(addressData) {
            if (!currentUser || !isOnline) return addressData.id || generateId();
            
            try {
                const addressWithUser = {
                    ...addressData,
                    customerId: currentUser.uid,
                    customerEmail: currentUser.email,
                    customerName: currentUser.name
                };
                
                // Save to user's addresses collection
                const docRef = await db.collection('users').doc(currentUser.uid).collection('addresses').add(addressWithUser);
                
                // Also save to main addresses collection for shopkeeper access
                await db.collection('addresses').doc(docRef.id).set({
                    ...addressWithUser,
                    addressId: docRef.id
                });
                
                console.log('✅ Address saved for shopkeeper access:', docRef.id);
                return docRef.id;
                
            } catch (error) {
                console.error('Error saving address for shopkeeper:', error);
                return addressData.id || generateId();
            }
        }

        // ✅ NEW: Get selected shop function
        function getSelectedShop() {
            if (!cart || cart.length === 0) {
                return {
                    id: "default_shop",
                    name: "Default Shop",
                    address: "Shop address not available"
                };
            }
            
            // Get shop from first item in cart
            const firstItem = cart[0];
            return {
                id: firstItem.shopId || "default_shop",
                name: firstItem.shopName || "Default Shop",
                address: "Shop address not available"
            };
        }

        // ✅ NEW: Show loading function
        function showLoading(show) {
            const placeOrderBtn = document.getElementById('placeOrderBtn');
            if (!placeOrderBtn) return;
            
            if (show) {
                placeOrderBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                placeOrderBtn.disabled = true;
            } else {
                placeOrderBtn.innerHTML = '<i class="fas fa-lock"></i> Place Order Securely';
                placeOrderBtn.disabled = cart.length === 0;
            }
        }

        // ✅ NEW: Clear cart function
        function clearCart() {
            cart = [];
            localStorage.setItem('dukaan_cart', JSON.stringify(cart));
            updateCartUI();
        }

        // ✅ UPDATED: Complete placeOrder() function with FIXED ADDRESS
        async function placeOrder() {
            if (!isOnline) {
                showToast('Cannot place order while offline', 'error');
                return;
            }

            try {
                console.log('🛒 Place order called');
                
                // Validate checkout inputs
                const phone = document.getElementById('checkoutPhone')?.value?.trim();
                
                if (!phone || phone.length < 10) {
                    showToast('Please enter a valid phone number', 'error');
                    return;
                }
                
                if (!selectedPaymentMethod) {
                    showToast('Please select a payment method', 'error');
                    return;
                }
                
                // Validate selected address
                let addressData = addresses.find(addr => addr.isDefault) || addresses[0];

                if (!addressData) {
                    showToast('Please add a delivery address first', 'error');
                    return;
                }
                
                // Validate cart
                if (cart.length === 0) {
                    showToast('Your cart is empty', 'error');
                    return;
                }
                
                // Check if any item is invalid
                for (const item of cart) {
                    if (!item.id || !item.shopId) {
                        showToast('Some items in your cart are invalid', 'error');
                        return;
                    }
                }
                
                let utrNumberValue = '';
                
                // If QR payment, validate UTR number
                if (selectedPaymentMethod === 'qr') {
                    utrNumberValue = document.getElementById('utrNumber')?.value?.trim() || '';
                    if (!utrNumberValue) {
                        showToast('Please enter UTR number for QR payment', 'error');
                        return;
                    }
                }
                
                // Show loading
                showLoading(true);
                
                // Get current user
                const user = auth.currentUser;
                if (!user) {
                    showToast('Please login to place order', 'error');
                    showLoading(false);
                    return;
                }
                
                // Get selected shop info
                const selectedShop = getSelectedShop();
                
                if (!selectedShop) {
                    showToast('Please select a shop', 'error');
                    showLoading(false);
                    return;
                }
                
                // ✅ FIX 1: ENSURE ADDRESS HAS ALL REQUIRED FIELDS
                const completeAddress = {
                    id: addressData.id || generateId(),
                    fullName: addressData.name || user.displayName || 'Customer',
                    phone: addressData.phone || phone,
                    details: addressData.address || 'Address not specified',
                    city: addressData.city || 'City not specified',
                    pincode: addressData.pincode || '000000',
                    landmark: addressData.landmark || '',
                    type: addressData.type || 'home',
                    // ✅ ADD THESE FOR SHOPKEEPER APP
                    customerId: user.uid,
                    customerName: user.displayName || 'Customer',
                    customerEmail: user.email,
                    customerPhone: phone
                };
                
                // ✅ FIX 1: SAVE ADDRESS FOR SHOPKEEPER ACCESS
                const savedAddressId = await saveAddressForShopkeeper(completeAddress);
                completeAddress.addressId = savedAddressId;
                
                // Calculate totals
                const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const deliveryCharge = 40; // Example delivery charge
                let discount = 0;
                let total = subtotal + deliveryCharge;
                
                // ✅ FIX 2: CHECK COUPON SETTINGS BEFORE APPLYING
                let couponApplied = false;
                if (appliedCoupon) {
                    if (!SHOP_COUPON_SETTINGS.couponEnabled) {
                        showToast('Coupons are currently disabled by shopkeeper', 'warning');
                        appliedCoupon = null;
                    } else if (!SHOP_COUPON_SETTINGS.activeCoupons.includes(appliedCoupon.code)) {
                        showToast('This coupon is no longer active', 'warning');
                        appliedCoupon = null;
                    } else {
                        couponApplied = true;
                        if (appliedCoupon.type === 'percentage') {
                            discount = (subtotal * appliedCoupon.value) / 100;
                        } else {
                            discount = appliedCoupon.value;
                        }
                        total = subtotal + deliveryCharge - discount;
                        // Ensure total is not negative
                        total = Math.max(0, total);
                    }
                }
                
                // Prepare order items
                const orderItems = cart.map(item => ({
                    id: item.id,
                    name: item.name,
                    price: item.price,
                    quantity: item.quantity,
                    image: item.image,
                    shopId: item.shopId,
                    shopName: item.shopName
                }));
                
                // ✅ FIX 1: CREATE UNIFIED ORDER ID FIRST
                const unifiedOrderId = 'ORD_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6).toUpperCase();
                console.log('✅ Generated Unified Order ID:', unifiedOrderId);
                
                // Create order data WITH COMPLETE ADDRESS
                const orderData = {
                    // ✅ CRITICAL: Use the same orderId for both apps
                    orderId: unifiedOrderId,
                    id: unifiedOrderId, // Also set as id for consistency
                    customerId: user.uid,
                    customerName: user.displayName || 'Customer',
                    customerEmail: user.email,
                    phone: phone,
                    items: orderItems,
                    subtotal: subtotal,
                    deliveryCharge: deliveryCharge,
                    discount: discount,
                    total: total,
                    totalAmount: total,
                    address: completeAddress, // ✅ FIX 1: COMPLETE ADDRESS
                    deliveryType: 'delivery',
                    status: 'pending',
                    paymentMethod: selectedPaymentMethod,
                    paymentStatus: selectedPaymentMethod === 'qr' ? 'paid' : 'pending',
                    shopId: selectedShop.id,
                    shopName: selectedShop.name,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    // ✅ ADD THESE FOR SHOPKEEPER APP
                    customerAddress: completeAddress.details,
                    customerCity: completeAddress.city,
                    customerPincode: completeAddress.pincode,
                    customerLandmark: completeAddress.landmark,
                    customerAddressType: completeAddress.type
                };
                
                // Add UTR number if QR payment
                if (selectedPaymentMethod === 'qr' && utrNumberValue) {
                    orderData.utrNumber = utrNumberValue;
                }
                
                // Add coupon if applied
                if (appliedCoupon && couponApplied) {
                    orderData.couponCode = appliedCoupon.code;
                    orderData.couponDiscount = discount;
                }
                
                console.log('📦 Creating order with complete address:', completeAddress);
                
                // 1️⃣ First, add order to Firestore with unified orderId
                const docRef = await db.collection('orders').add(orderData);
                const firestoreDocId = docRef.id;
                console.log('🔥 Firestore Document ID:', firestoreDocId);
                
                // 2️⃣ IMPORTANT: Also save the firestore document ID for reference
                await db.collection('orders').doc(firestoreDocId).update({
                    firestoreId: firestoreDocId // Store firestore ID separately
                });
                
                console.log('✅ Order created with Complete Address');
                
                // 3️⃣ Clear cart after successful order
                clearCart();
                
                // 4️⃣ Hide loading
                showLoading(false);
                
                // 5️⃣ Show success message with UNIFIED ORDER ID
                showToast(`✅ Order placed successfully! Order ID: ${unifiedOrderId}`, 'success');
                
                // 6️⃣ Close bottom sheet
                closeBottomSheet();
                
                // 7️⃣ Redirect to orders page
                setTimeout(() => {
                    navigateToPage('orders');
                }, 2000);
                
            } catch (error) {
                console.error('❌ Error placing order:', error);
                showLoading(false);
                showToast('Error placing order: ' + error.message, 'error');
            }
        }

        // ✅ ADD THIS HELPER FUNCTION
        function calculateSubtotal() {
            return cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        }

        // ✅ INITIALIZE OFFLINE DETECTION
        function setupOfflineDetection() {
            // Initial check
            checkInternetConnection();
            
            // Listen for online/offline events
            window.addEventListener('online', handleOnlineStatus);
            window.addEventListener('offline', handleOfflineStatus);
            
            // Set up periodic check
            offlineCheckInterval = setInterval(checkInternetConnection, 30000); // Check every 30 seconds
            
            console.log('📶 Offline detection initialized');
        }
        
        // ✅ CHECK INTERNET CONNECTION
        function checkInternetConnection() {
            const wasOnline = isOnline;
            isOnline = navigator.onLine;
            
            if (wasOnline !== isOnline) {
                if (isOnline) {
                    handleOnlineStatus();
                } else {
                    handleOfflineStatus();
                }
            }
        }
        
        // ✅ HANDLE ONLINE STATUS
        function handleOnlineStatus() {
            isOnline = true;
            console.log('✅ Internet connection restored');
            
            // Hide offline notification
            document.getElementById('offlineNotification').style.display = 'none';
            document.getElementById('offlineOverlay').style.display = 'none';
            
            // Show online notification
            const onlineNotification = document.getElementById('onlineNotification');
            onlineNotification.style.display = 'block';
            onlineNotification.innerHTML = '<i class="fas fa-wifi"></i> You are back online';
            
            // Auto hide after 3 seconds
            setTimeout(() => {
                onlineNotification.style.display = 'none';
            }, 3000);
            
            // Reload data if needed
            if (currentUser) {
                loadProductsFromFirebase();
                loadOrderHistory();
                loadShopCouponSettings(); // ✅ Load coupon settings
                startRealTimeOrderListener(); // Restart listener
                setupPartialOrderRefundSystem(); // Restart refund listener
            }
        }
        
        // ✅ HANDLE OFFLINE STATUS
        function handleOfflineStatus() {
            isOnline = false;
            console.log('❌ Internet connection lost');
            
            // Show offline notification
            const offlineNotification = document.getElementById('offlineNotification');
            offlineNotification.style.display = 'block';
            offlineNotification.innerHTML = '<i class="fas fa-wifi-slash"></i> You are offline';
            
            // Show toast message
            showToast('You are offline. Some features may not work.', 'warning');
            
            // Don't show overlay if user is in auth screen
            if (appScreen.style.display !== 'none') {
                setTimeout(() => {
                    if (!isOnline) {
                        document.getElementById('offlineOverlay').style.display = 'flex';
                    }
                }, 5000);
            }
        }
        
        // ✅ CHECK INTERNET AND RELOAD
        function checkInternetAndReload() {
            if (navigator.onLine) {
                window.location.reload();
            } else {
                showToast('Still offline. Please check your connection.', 'error');
            }
        }

        // Initialize App
        function initApp() {
            setupEventListeners();
            setupFirebaseAuth();
            setupDemoLogin();
            renderProducts(PRODUCTS);
            updateCartUI();
            updateWishlistUI();
            renderOrders();
            renderAddresses();
            setupSorting();
            
            // ✅ SETUP OFFLINE DETECTION
            setupOfflineDetection();
            
            // ✅ FIX: START REAL-TIME ORDER LISTENER
            // Listener will start after successful login/auth change
            
            // ✅ NEW: START REFUND LISTENER
            // Listener will start after successful login/auth change
            
            // ✅ LOAD SHOP COUPON SETTINGS
            loadShopCouponSettings();

            // ✅ ISSUE #5: SETUP PUSH NOTIFICATIONS
            setupPushNotifications();
        }

        // ✅ UPDATED: Real-time Order Listener with UNIFIED ORDER ID
        function startRealTimeOrderListener() {
            if (!currentUser) return;
            
            // Clear any existing listener interval if needed
            if (orderTrackingInterval) clearInterval(orderTrackingInterval);
            
            console.log("🔔 Starting real-time order listener for user:", currentUser.uid);
            
            // Listen to orders collection for this customer
            db.collection('orders')
                .where('customerId', '==', currentUser.uid)
                .onSnapshot((snapshot) => {
                    console.log("🔄 Real-time order update received");
                    
                    let ordersChanged = false;

                    // Process all changes
                    snapshot.docChanges().forEach((change) => {
                        const updatedOrder = { 
                            id: change.doc.id, 
                            ...change.doc.data() 
                        };
                        
                        // ✅ CRITICAL: Use unified orderId if available
                        const orderIdToUse = updatedOrder.orderId || change.doc.id;
                        
                        // Convert Firestore timestamps to ISO strings
                        if (updatedOrder.createdAt && updatedOrder.createdAt.toDate) {
                            updatedOrder.createdAt = updatedOrder.createdAt.toDate().toISOString();
                        }
                        if (updatedOrder.updatedAt && updatedOrder.updatedAt.toDate) {
                            updatedOrder.updatedAt = updatedOrder.updatedAt.toDate().toISOString();
                        }
                        
                        console.log("📝 Order update type:", change.type, "Order ID:", orderIdToUse, "Status:", updatedOrder.status);
                        
                        if (change.type === 'added' || change.type === 'modified') {
                            handleOrderUpdate({...updatedOrder, id: orderIdToUse});
                            ordersChanged = true;
                        } else if (change.type === 'removed') {
                            // Handle order removal if needed
                            const orderIndex = orders.findIndex(order => order.id === orderIdToUse);
                            if (orderIndex !== -1) {
                                orders.splice(orderIndex, 1);
                                ordersChanged = true;
                            }
                        }
                    });

                    // Only update storage and render if changes occurred
                    if (ordersChanged) {
                        localStorage.setItem('dukaan_orders', JSON.stringify(orders));
                        renderOrders();
                        updateOrderBadges();
                    }
                    
                }, (error) => {
                    console.error("❌ Error in real-time order listener:", error);
                });

            // Also listen to orderItems for shopkeeper updates (less critical for customer, but good for sync)
            startOrderItemsListener();
        }
        
        // ✅ UPDATED: Listen to orderItems collection for shopkeeper actions
        function startOrderItemsListener() {
            if (!currentUser || !isOnline) return;
            
            console.log("🛍️ Starting orderItems listener");
            
            // Note: This is an expensive listener. In a real app, only listen to necessary fields.
            // Keeping it for demo purposes.
            db.collection('orderItems')
                .where('customerId', '==', currentUser.uid)
                .onSnapshot((snapshot) => {
                    console.log("🛍️ OrderItems update received:", snapshot.docChanges().length, "changes");
                    
                    let ordersChanged = false;

                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'modified') {
                            const orderItem = { 
                                id: change.doc.id, 
                                ...change.doc.data() 
                            };
                            
                            console.log("📦 OrderItem update:", orderItem.orderId, "Status:", orderItem.status);
                            
                            // Update the main order with shopkeeper's action
                            updateOrderFromShopkeeper(orderItem);
                            ordersChanged = true;
                        }
                    });

                    if (ordersChanged) {
                        localStorage.setItem('dukaan_orders', JSON.stringify(orders));
                        renderOrders();
                        updateOrderBadges();
                    }

                }, (error) => {
                    console.error("❌ Error in orderItems listener:", error);
                });
        }
        
        // ✅ UPDATED: Handle order updates from shopkeeper app with all statuses
        function updateOrderFromShopkeeper(orderItem) {
            const orderIndex = orders.findIndex(order => order.id === orderItem.orderId);
            
            if (orderIndex !== -1) {
                const order = orders[orderIndex];
                const oldStatus = order.status;
                const newStatus = orderItem.status;
                
                // Update order status based on shopkeeper's action
                if (newStatus && newStatus !== oldStatus) {
                    orders[orderIndex].status = newStatus;
                    
                    // Update tracking times based on status
                    const now = new Date().toISOString();
                    if (!orders[orderIndex].tracking) {
                        orders[orderIndex].tracking = { confirmed: order.createdAt || now };
                    }
                    
                    switch(newStatus) {
                        case 'preparing':
                            orders[orderIndex].tracking.preparing = now;
                            break;
                        case 'packed':
                            orders[orderIndex].tracking.packed = now;
                            break;
                        case 'dispatched':
                            orders[orderIndex].tracking.dispatched = now;
                            break;
                        case 'ready_for_pickup':
                            orders[orderIndex].tracking.readyForPickup = now;
                            break;
                        case 'out_for_delivery':
                            orders[orderIndex].tracking.outForDelivery = now;
                            break;
                        case 'delivered':
                            orders[orderIndex].tracking.delivered = now;
                            break;
                    }
                    
                    // Save to local storage (will be saved in startOrderItemsListener too, but keeping here for single update flow)
                    localStorage.setItem('dukaan_orders', JSON.stringify(orders));
                    
                    // Show notification
                    showOrderUpdateNotification(order.id, oldStatus, newStatus);
                    
                    // If this order is currently being tracked, update tracking UI
                    if (currentTrackingOrder && currentTrackingOrder.id === order.id) {
                        updateTrackingTimeline(orders[orderIndex]);
                        updateETACountdown(orders[orderIndex]);
                    }
                }
            }
        }
        // ✅ UPDATED: Show order update notification with all statuses
        function showOrderUpdateNotification(orderId, oldStatus, newStatus) {
            // Check if notification preference is enabled
            if (!notificationPreferences.orderUpdates) return;

            const statusMessages = {
                'preparing': 'is being prepared',
                'packed': 'has been packed',
                'dispatched': 'has been dispatched',
                'ready_for_pickup': 'is ready for pickup',
                'out_for_delivery': 'is out for delivery',
                'delivered': 'has been delivered'
            };
            
            const message = statusMessages[newStatus];
            if (message) {
                // Create in-app notification
                const notification = document.getElementById('orderUpdateNotification');
                notification.innerHTML = `<i class="fas fa-bell"></i> Order #${orderId.slice(-6)} ${message}!`;
                notification.style.display = 'block';
                
                // Also log to notifications page
                createNotification(
                    `Order Update: #${orderId.slice(-6)}`,
                    `Your order status changed from ${getStatusText(oldStatus)} to ${getStatusText(newStatus)}.`,
                    'success'
                );

                // Auto hide after 5 seconds
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 5000);
            }
        }
        
        // ✅ UPDATED: Handle order update with all statuses
        function handleOrderUpdate(updatedOrder) {
            const orderIndex = orders.findIndex(order => order.id === updatedOrder.id);
            const oldStatus = orderIndex !== -1 ? orders[orderIndex].status : null;
            
            if (orderIndex !== -1) {
                // Merge with existing order data
                orders[orderIndex] = {
                    ...orders[orderIndex],
                    ...updatedOrder,
                    tracking: updatedOrder.tracking || orders[orderIndex].tracking || {
                        confirmed: updatedOrder.createdAt || new Date().toISOString(),
                        preparing: null,
                        packed: null,
                        dispatched: null,
                        readyForPickup: null,
                        outForDelivery: null,
                        delivered: null
                    }
                };
            } else {
                // Add new order
                orders.push({
                    ...updatedOrder,
                    tracking: updatedOrder.tracking || {
                        confirmed: updatedOrder.createdAt || new Date().toISOString(),
                        preparing: null,
                        packed: null,
                        dispatched: null,
                        readyForPickup: null,
                        outForDelivery: null,
                        delivered: null
                    }
                });
            }
            
            // Save to local storage (will be saved in startRealTimeOrderListener too, but keeping here for consistency)
            localStorage.setItem('dukaan_orders', JSON.stringify(orders));
            
            // Update UI (will be updated in startRealTimeOrderListener too, but keeping here for consistency)
            // renderOrders();
            // updateOrderBadges();
            
            // Show notification if status changed
            if (oldStatus && oldStatus !== updatedOrder.status) {
                showOrderUpdateNotification(updatedOrder.id, oldStatus, updatedOrder.status);
            }
            
            // If this order is currently being tracked, update tracking UI
            if (currentTrackingOrder && currentTrackingOrder.id === updatedOrder.id) {
                updateTrackingTimeline(orders[orderIndex !== -1 ? orderIndex : orders.length - 1]);
                updateETACountdown(orders[orderIndex !== -1 ? orderIndex : orders.length - 1]);
            }
        }

        // Firebase Authentication - FIXED
        function setupFirebaseAuth() {
            auth.onAuthStateChanged((user) => {
                console.log('Auth state changed:', user);
                if (user) {
                    currentUser = {
                        uid: user.uid,
                        email: user.email,
                        name: user.displayName || user.email.split('@')[0]
                    };
                    showAppScreen();
                    loadUserData();
                    
                    // ✅ ADD DELAY - LET OTHER FUNCTIONS COMPLETE FIRST
                    setTimeout(() => {
                        console.log("🔄 Delayed loadOrderHistory call");
                        loadOrderHistory();
                        startRealTimeOrderListener();
                        setupPartialOrderRefundSystem(); // Start refund listener on login
                    }, 1000);
                    
                    updateCouponAuth();
                    showToast('Welcome back to Raashanmart!');
                } else {
                    currentUser = null;
                    showAuthScreen();
                }
            });
        }

        function setupDemoLogin() {
            // Auto-fill demo credentials
            document.getElementById('loginEmail').value = 'demo@dukaan.com';
            document.getElementById('loginPassword').value = 'demo123';
        }

        // ✅ UPDATED: Load user data including addresses from Firestore
        async function loadUserData() {
            if (!currentUser || !isOnline) return;
            
            try {
                // Load addresses
                const addressesSnapshot = await db.collection('users').doc(currentUser.uid).collection('addresses').get();
                addresses = [];
                addressesSnapshot.forEach(doc => {
                    addresses.push({ id: doc.id, ...doc.data() });
                });
                localStorage.setItem('userAddresses', JSON.stringify(addresses)); // Use correct local storage key
                renderAddresses();

                // Load orders (will be re-loaded by loadOrderHistory)
                // loadOrderHistory(); // Already called later

                // Load wishlist
                const wishlistSnapshot = await db.collection('users').doc(currentUser.uid).collection('wishlist').get();
                wishlist = [];
                wishlistSnapshot.forEach(doc => {
                    wishlist.push(doc.id);
                });
                localStorage.setItem('dukaan_wishlist', JSON.stringify(wishlist));
                updateWishlistUI();

                // Load reviews
                const reviewsSnapshot = await db.collection('productReviews').where('userId', '==', currentUser.uid).get();
                const userReviews = [];
                reviewsSnapshot.forEach(doc => {
                    userReviews.push(doc.data());
                });
                // Merge with existing reviews
                productReviews = productReviews.filter(r => r.userId !== currentUser.uid); // Remove old user reviews
                productReviews = [...productReviews, ...userReviews];
                localStorage.setItem('dukaan_product_reviews', JSON.stringify(productReviews));

            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // ✅ FIX: ORDER HISTORY LOADING with UNIFIED ORDER ID
        async function loadOrderHistory() {
            if (!currentUser || !isOnline) return;
            
            try {
                console.log("🔄 Loading order history for:", currentUser.uid);
                
                // Load from Firestore orders collection
                const snapshot = await db.collection('orders')
                    .where('customerId', '==', currentUser.uid)
                    .get();
                
                orders = [];
                snapshot.forEach(doc => {
                    const firebaseOrder = doc.data();
                    
                    // ✅ CRITICAL: Use unified orderId
                    const orderIdToUse = firebaseOrder.orderId || doc.id;
                    
                    // ✅ CONVERT FIREBASE DATA TO EXPECTED FORMAT
                    const mappedOrder = {
                        id: orderIdToUse, // Use unified order ID
                        orderId: orderIdToUse, // Also store as orderId
                        date: firebaseOrder.createdAt ? firebaseOrder.createdAt.toDate().toISOString() : new Date().toISOString(),
                        items: firebaseOrder.items || [],
                        address: firebaseOrder.address || {},
                        phone: firebaseOrder.phone || '',
                        paymentMethod: firebaseOrder.paymentMethod || 'cod',
                        status: firebaseOrder.status || 'confirmed',
                        subtotal: firebaseOrder.subtotal || firebaseOrder.total || 0,
                        discount: firebaseOrder.discount || 0,
                        total: firebaseOrder.total || 0,
                        tracking: firebaseOrder.tracking || {
                            confirmed: firebaseOrder.createdAt ? firebaseOrder.createdAt.toDate().toISOString() : new Date().toISOString(),
                            preparing: null,
                            packed: null,
                            dispatched: null,
                            readyForPickup: null,
                            outForDelivery: null,
                            delivered: null
                        },
                        // Add refund fields for proper handling
                        refundStatus: firebaseOrder.refundStatus || null,
                        refundAmount: firebaseOrder.refundAmount || 0,
                        refundEstimatedTime: firebaseOrder.refundEstimatedTime || null,
                        refundCompletedAt: firebaseOrder.refundCompletedAt || null
                    };
                    
                    orders.push(mappedOrder);
                });
                
                // ✅ MANUAL SORTING (NO INDEX NEEDED)
                orders.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                console.log("✅ Mapped orders:", orders.length, "Unified Order IDs used");
                
                // Also save to local storage for offline access
                localStorage.setItem('dukaan_orders', JSON.stringify(orders));
                
                // ✅ UPDATE ORDER BADGES
                updateOrderBadges();
                
                // ✅ FORCE RENDER ORDERS
                if (typeof renderOrders === 'function') {
                    renderOrders();
                }
                
            } catch (error) {
                console.error('Error loading order history:', error);
                // Fallback to local storage
                const savedOrders = localStorage.getItem('dukaan_orders');
                if (savedOrders) {
                    orders = JSON.parse(savedOrders);
                    updateOrderBadges(); // ✅ UPDATE BADGES
                    if (typeof renderOrders === 'function') {
                        renderOrders();
                    }
                }
            }
        }

        // ✅ UPDATED: Update order badges with all statuses
        function updateOrderBadges() {
            // Reset badges
            orderBadges = {
                pending: 0,
                preparing: 0,
                packed: 0,
                dispatched: 0,
                readyForPickup: 0,
                outForDelivery: 0
            };
            
            // Count orders by status
            orders.forEach(order => {
                switch(order.status) {
                    case 'pending':
                    case 'confirmed':
                        orderBadges.pending++;
                        break;
                    case 'preparing':
                        orderBadges.preparing++;
                        break;
                    case 'packed':
                        orderBadges.packed++;
                        break;
                    case 'dispatched':
                        orderBadges.dispatched++;
                        break;
                    case 'ready_for_pickup':
                        orderBadges.readyForPickup++;
                        break;
                    case 'out_for_delivery':
                        orderBadges.outForDelivery++;
                        break;
                }
            });
            
            // Calculate total active orders (excluding delivered and cancelled)
            const activeOrders = orders.filter(order => 
                !['delivered', 'cancelled', 'picked_up'].includes(order.status)
            ).length;
            
            // Update badges in UI
            if (ordersNavBadge) {
                if (activeOrders > 0) {
                    ordersNavBadge.textContent = activeOrders;
                    ordersNavBadge.style.display = 'block';
                } else {
                    ordersNavBadge.style.display = 'none';
                }
            }
            
            if (ordersBadge) {
                if (activeOrders > 0) {
                    ordersBadge.textContent = activeOrders;
                    ordersBadge.style.display = 'block';
                } else {
                    ordersBadge.style.display = 'none';
                }
            }
            
            console.log("📊 Order badges updated:", orderBadges, "Active orders:", activeOrders);
        }

        // Auth Functions - FIXED
        function showAuthScreen() {
            authScreen.style.display = 'block';
            appScreen.style.display = 'none';
            // Clear current user data on logout/auth screen switch
            currentUser = null;
        }
        
        function showAppScreen() {
            authScreen.style.display = 'none';
            appScreen.style.display = 'block';
            updateCouponAuth();
            renderProducts(PRODUCTS); // Ensure products are rendered
            
            // ✅ START REAL-TIME LISTENER
            if (currentUser) {
                setTimeout(() => {
                    startRealTimeOrderListener();
                    setupPartialOrderRefundSystem();
                }, 1000);
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // ✅ AUTO-CREATE USER DOCUMENT IF NOT EXISTS
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (!userDoc.exists) {
                    await db.collection('users').doc(user.uid).set({
                        email: user.email,
                        name: user.displayName || user.email.split('@')[0],
                        role: 'customer',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log("✅ New user document created");
                } else {
                    // Update last login time
                    await db.collection('users').doc(user.uid).update({
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                showToast('Welcome back to Raashanmart!');
                closeLoginModal();
                
            } catch (error) {
                console.error('Login error:', error);
                showToast('Login failed: ' + error.message);
            }
        }

        // Forgot Password System
        function showForgotPassword() {
            const email = prompt('Enter your email address to reset password:');
            if (email && email.includes('@')) {
                auth.sendPasswordResetEmail(email)
                    .then(() => {
                        alert('Password reset email sent! Check your inbox.');
                    })
                    .catch(error => {
                        alert('Error: ' + error.message);
                    });
            } else if (email) {
                alert('Please enter a valid email address.');
            }
        }

        // ✅ FIXED SIGNUP FUNCTION
        async function handleSignup(event) {
            event.preventDefault();
            
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                await userCredential.user.updateProfile({ displayName: name });
                
                // Save to Firestore
                await db.collection('users').doc(userCredential.user.uid).set({
                    name: name,
                    email: email,
                    role: 'customer',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showToast('Account created successfully!');
                
            } catch (error) {
                console.error('Signup error:', error);
                if (error.code === 'auth/email-already-in-use') {
                    showToast('Email already registered');
                } else {
                    showToast('Signup failed: ' + error.message);
                }
            }
        }
        
        function demoLogin() {
            document.getElementById('loginEmail').value = 'demo@dukaan.com';
            document.getElementById('loginPassword').value = 'demo123';
            // showToast('Demo credentials filled! Click Sign In');
        }

        // ★★★ ADD LOGOUT FUNCTION HERE ★★★
        function logout() {
            console.log("Logout function called");
            
            // Check if user is logged in with Firebase
            if (firebase.auth().currentUser) {
                firebase.auth().signOut().then(() => {
                    showToast("Logged out successfully!", 'success');
                    
                    // ✅ YEH LINE ADD KARO - UI IMMEDIATELY UPDATE
                    updateUIForAuth(null);
                    
                    // Switch to auth screen
                    document.getElementById('appScreen').style.display = 'none';
                    document.getElementById('authScreen').style.display = 'block';
                    // Reset forms
                    document.getElementById('loginForm').reset();
                    document.getElementById('signupForm').reset();
                    // Show login form by default
                    document.getElementById('loginForm').style.display = 'block';
                    document.getElementById('signupForm').style.display = 'none';
                    document.getElementById('loginFooter').style.display = 'block';
                    document.getElementById('signupFooter').style.display = 'none';
                    
                    // Clear tracking intervals if active
                    if (orderTrackingInterval) clearInterval(orderTrackingInterval);
                }).catch((error) => {
                    console.error("Logout error:", error);
                    showToast("Error logging out: " + error.message, 'error');
                });
            } else {
                // Fallback for any logged in state
                document.getElementById('appScreen').style.display = 'none';
                document.getElementById('authScreen').style.display = 'block';
                
                // ✅ YEH LINE ADD KARO - UI UPDATE
                updateUIForAuth(null);
                
                showToast("Logged out successfully!");
            }
        }

        // ★★★ ADD MISSING MODAL FUNCTIONS ★★★

        // Close Login Modal (Assuming this refers to a modal that might open on top of auth screen)
        function closeLoginModal() {
            const modal = document.getElementById('loginModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Close Any Modal
        function closeModal() {
            // Close all modals
            const modals = document.querySelectorAll('.modal-overlay.active, [class*="modal"].active');
            modals.forEach(modal => {
                modal.classList.remove('active');
                modal.style.display = 'none';
            });
        }

        // Show Modal
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
                modal.style.display = 'flex';
            }
        }       

        // ★★★ SAVED ADDRESSES FUNCTIONS (RE-IMPLEMENTED FOR ISSUE #6) ★★★

        // ✅ RE-IMPLEMENTED: savedAddresses() - For profile page
        function savedAddresses() {
            // Close existing modal if open
            closeSavedAddressesModal();

            const savedAddresses = JSON.parse(localStorage.getItem('userAddresses') || '[]');
            
            let addressListHTML = '';
            if (savedAddresses.length === 0) {
                addressListHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-map-marker-alt" style="font-size: 48px; color: var(--text-light); margin-bottom: 15px;"></i>
                        <h4 style="color: var(--text-light);">No Saved Addresses</h4>
                        <p style="color: var(--text-light);">You haven't saved any addresses yet</p>
                    </div>
                `;
            } else {
                addressListHTML = savedAddresses.map((address) => `
                    <div class="address-card" id="address-${address.id}">
                        <div class="address-title">
                            ${address.type === 'home' ? '🏠 Home' : address.type === 'work' ? '💼 Work' : '📍 Other'}
                            ${address.isDefault ? '<span class="badge bg-success ms-2">Default</span>' : ''}
                        </div>
                        <div class="address-details">${address.name} • ${address.address}</div>
                        <div class="address-phone">${address.phone} • ${address.city} - ${address.pincode}</div>
                        <div class="address-actions mt-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="editSavedAddress('${address.id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-outline-danger ms-2" onclick="deleteSavedAddress('${address.id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                            ${!address.isDefault ? `
                                <button class="btn btn-sm btn-outline-success ms-2" onclick="setDefaultAddress('${address.id}')">
                                    <i class="fas fa-check"></i> Set Default
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            }

            const modalHTML = `
            <div class="modal-overlay active" id="savedAddressesModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Saved Addresses</h3>
                        <button class="modal-close" onclick="closeSavedAddressesModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="addresses-list">
                            ${addressListHTML}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-outline" onclick="closeSavedAddressesModal()">Close</button>
                        <button type="button" class="btn-primary" onclick="addNewAddress()">
                            <i class="fas fa-plus"></i> Add New Address
                        </button>
                    </div>
                </div>
            </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeSavedAddressesModal() {
            const modal = document.getElementById('savedAddressesModal');
            if (modal) {
                modal.remove();
            }
        }

        function addNewAddress() {
            // Close existing modal first
            closeSavedAddressesModal(); 
            closeAddAddressModal();
            
            const modalHTML = `
            <div class="modal-overlay active" id="addAddressModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Add New Address</h3>
                        <button class="modal-close" onclick="closeAddAddressModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Full Name *</label>
                            <input type="text" class="form-control" id="addressName" placeholder="Enter full name" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone Number *</label>
                            <input type="tel" class="form-control" id="addressPhone" placeholder="Enter phone number" required oninput="validatePhoneModal(this)">
                            <small id="phoneValidationModal" class="validation-message"></small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Pincode *</label>
                            <input type="text" class="form-control" id="addressPincode" placeholder="Enter pincode" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Address *</label>
                            <textarea class="form-control" id="addressLine1" placeholder="House no., Building, Street" rows="2" required></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Landmark (Optional)</label>
                            <input type="text" class="form-control" id="addressLandmark" placeholder="Nearby landmark">
                        </div>
                        <div class="form-group">
                            <label class="form-label">City *</label>
                            <input type="text" class="form-control" id="addressCity" placeholder="Enter city" required>
                        </div>
                        <div class="form-group form-check">
                            <input type="checkbox" class="form-check-input" id="defaultAddress">
                            <label class="form-check-label" for="defaultAddress">Set as default address</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-outline" onclick="closeAddAddressModal()">Cancel</button>
                        <button type="button" class="btn-primary" onclick="saveNewAddressModal()">Save Address</button>
                    </div>
                </div>
            </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        function closeAddAddressModal() {
            const modal = document.getElementById('addAddressModal');
            if (modal) modal.remove();
        }

        // ✅ NEW: Validation for phone in modal
        function validatePhoneModal(inputElement) {
            const phone = inputElement.value.trim();
            const isValid = validatePhoneNumber(phone);
            const validationElement = document.getElementById('phoneValidationModal');
            
            inputElement.classList.remove('phone-valid', 'phone-invalid');
            validationElement.textContent = '';
            
            if (phone.length === 0) return;

            if (isValid) {
                inputElement.classList.add('phone-valid');
                validationElement.textContent = '✓ Valid phone number';
                validationElement.className = 'validation-message validation-success';
            } else {
                inputElement.classList.add('phone-invalid');
                validationElement.textContent = 'Please enter a valid 10-digit phone number';
                validationElement.className = 'validation-message validation-error';
            }
        }


        // ✅ RE-IMPLEMENTED: saveNewAddressModal() - Saves new address
        function saveNewAddressModal() {
            const name = document.getElementById('addressName').value.trim();
            const phone = document.getElementById('addressPhone').value.trim();
            const pincode = document.getElementById('addressPincode').value.trim();
            const address = document.getElementById('addressLine1').value.trim();
            const city = document.getElementById('addressCity').value.trim();
            const landmark = document.getElementById('addressLandmark').value.trim();
            const isDefault = document.getElementById('defaultAddress').checked;

            // Validation
            if (!name || !phone || !pincode || !address || !city) {
                showToast("Please fill all required fields", 'error');
                return;
            }
            if (!validatePhoneNumber(phone)) {
                showToast("Please enter a valid phone number", 'error');
                return;
            }

            try {
                // Get existing addresses or create empty array
                let addresses = JSON.parse(localStorage.getItem('userAddresses') || '[]');
                
                const newAddress = {
                    id: 'addr_' + Date.now() + Math.random().toString(36).substr(2, 4),
                    name: name,
                    phone: phone,
                    pincode: pincode,
                    address: address,
                    city: city,
                    landmark: landmark || '',
                    type: 'home', // Default type
                    isDefault: isDefault,
                    createdAt: new Date().toISOString()
                };

                // If setting as default, remove default from others
                if (isDefault) {
                    addresses.forEach(addr => addr.isDefault = false);
                    newAddress.isDefault = true;
                }
                if (addresses.length === 0) {
                    newAddress.isDefault = true;
                }


                addresses.push(newAddress);
                localStorage.setItem('userAddresses', JSON.stringify(addresses));
                
                // Also update the global addresses array
                window.addresses = addresses;
                
                // Save to Firebase (async, non-blocking)
                if (currentUser && isOnline) {
                    db.collection('users').doc(currentUser.uid).collection('addresses').add(newAddress).catch(error => {
                        console.error('Error saving address to Firebase:', error);
                    });
                }

                showToast('Address saved successfully!', 'success');
                closeAddAddressModal();
                
                // Refresh addresses list if open
                setTimeout(() => {
                    if (document.getElementById('savedAddressesModal')) {
                        savedAddresses(); // Reopen with updated list
                    }
                    renderAddresses(); // For checkout page update
                }, 50);

            } catch (error) {
                console.error("Error saving address:", error);
                showToast("Error saving address: " + error.message, 'error');
            }
        }
        
        // ✅ RE-IMPLEMENTED: editSavedAddress() - Edits existing address
        function editSavedAddress(addressId) {
            const addresses = JSON.parse(localStorage.getItem('userAddresses') || '[]');
            const address = addresses.find(addr => addr.id === addressId);
            
            if (!address) {
                showToast('Address not found', 'error');
                return;
            }

            const modalHTML = `
            <div class="modal-overlay active" id="editAddressModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Edit Address</h3>
                        <button class="modal-close" onclick="closeEditAddressModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Full Name *</label>
                            <input type="text" class="form-control" id="editAddressName" value="${address.name}" placeholder="Enter full name" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone Number *</label>
                            <input type="tel" class="form-control" id="editAddressPhone" value="${address.phone}" placeholder="Enter phone number" required oninput="validatePhoneModal(this)">
                            <small id="phoneValidationModal" class="validation-message"></small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Pincode *</label>
                            <input type="text" class="form-control" id="editAddressPincode" value="${address.pincode}" placeholder="Enter pincode" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Address *</label>
                            <textarea class="form-control" id="editAddressLine1" placeholder="House no., Building, Street" rows="2" required>${address.address}</textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Landmark (Optional)</label>
                            <input type="text" class="form-control" id="editAddressLandmark" value="${address.landmark || ''}" placeholder="Nearby landmark">
                        </div>
                        <div class="form-group">
                            <label class="form-label">City *</label>
                            <input type="text" class="form-control" id="editAddressCity" value="${address.city}" placeholder="Enter city" required>
                        </div>
                        <div class="form-group form-check">
                            <input type="checkbox" class="form-check-input" id="editDefaultAddress" ${address.isDefault ? 'checked' : ''}>
                            <label class="form-check-label" for="editDefaultAddress">Set as default address</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-outline" onclick="closeEditAddressModal()">Cancel</button>
                        <button type="button" class="btn-primary" onclick="updateAddress('${addressId}')">Update Address</button>
                    </div>
                </div>
            </div>
            `;
            
            closeSavedAddressesModal();
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeEditAddressModal() {
            const modal = document.getElementById('editAddressModal');
            if (modal) modal.remove();
            savedAddresses(); // Reopen addresses list
        }

        // ✅ RE-IMPLEMENTED: updateAddress() - Updates an existing address
        async function updateAddress(addressId) {
            const name = document.getElementById('editAddressName').value.trim();
            const phone = document.getElementById('editAddressPhone').value.trim();
            const pincode = document.getElementById('editAddressPincode').value.trim();
            const address = document.getElementById('editAddressLine1').value.trim();
            const city = document.getElementById('editAddressCity').value.trim();
            const landmark = document.getElementById('editAddressLandmark').value.trim();
            const isDefault = document.getElementById('editDefaultAddress').checked;

            // Validation
            if (!name || !phone || !pincode || !address || !city) { showToast("Please fill all required fields", 'error'); return; }
            if (!validatePhoneNumber(phone)) { showToast("Please enter a valid phone number", 'error'); return; }

            try {
                let addresses = JSON.parse(localStorage.getItem('userAddresses') || '[]');
                const addressIndex = addresses.findIndex(addr => addr.id === addressId);
                
                if (addressIndex === -1) {
                    showToast("Address not found", 'error');
                    return;
                }

                // If setting as default, remove default from others
                if (isDefault) {
                    addresses.forEach(addr => addr.isDefault = false);
                }

                addresses[addressIndex] = {
                    ...addresses[addressIndex],
                    name,
                    phone,
                    pincode,
                    address,
                    city,
                    landmark: landmark || '',
                    isDefault,
                    updatedAt: new Date().toISOString()
                };

                localStorage.setItem('userAddresses', JSON.stringify(addresses));
                window.addresses = addresses; // Update global array
                
                // Update in Firebase (async, non-blocking)
                if (currentUser && isOnline) {
                    const firebaseDocId = addresses[addressIndex].firebaseDocId; // Assuming you saved this ID
                    if (firebaseDocId) {
                        await db.collection('users').doc(currentUser.uid).collection('addresses').doc(firebaseDocId).update(addresses[addressIndex]);
                        await db.collection('addresses').doc(firebaseDocId).update(addresses[addressIndex]);
                    }
                    // For simplicity, handle new address save logic here if firebaseDocId is missing
                }
                
                showToast('Address updated successfully!', 'success');
                closeEditAddressModal();
                renderAddresses(); // Update checkout UI
                
            } catch (error) {
                console.error("Error updating address:", error);
                showToast("Error updating address: " + error.message, 'error');
            }
        }

        // ✅ RE-IMPLEMENTED: deleteSavedAddress() - Deletes an address
        async function deleteSavedAddress(addressId) {
            if (!confirm('Are you sure you want to delete this address?')) {
                return;
            }

            try {
                let addresses = JSON.parse(localStorage.getItem('userAddresses') || '[]');
                const addressToDelete = addresses.find(addr => addr.id === addressId);
                
                if (addressToDelete && addressToDelete.isDefault) {
                    showToast("Cannot delete default address. Set another address as default first.", 'error');
                    return;
                }

                addresses = addresses.filter(addr => addr.id !== addressId);
                localStorage.setItem('userAddresses', JSON.stringify(addresses));
                window.addresses = addresses; // Update global array

                // Delete from Firebase (async, non-blocking)
                if (currentUser && isOnline) {
                    const firebaseDocId = addressToDelete.firebaseDocId;
                    if (firebaseDocId) {
                        await db.collection('users').doc(currentUser.uid).collection('addresses').doc(firebaseDocId).delete();
                        await db.collection('addresses').doc(firebaseDocId).delete();
                    }
                }

                showToast('Address deleted successfully!', 'success');
                
                // Refresh addresses list
                closeSavedAddressesModal();
                setTimeout(() => savedAddresses(), 100);
                renderAddresses(); // Update checkout UI
                
            } catch (error) {
                console.error("Error deleting address:", error);
                showToast("Error deleting address: " + error.message, 'error');
            }
        }

        // ✅ RE-IMPLEMENTED: setDefaultAddress() - Sets default address
        function setDefaultAddress(addressId) {
            try {
                const addresses = JSON.parse(localStorage.getItem('userAddresses') || '[]');
                
                addresses.forEach(addr => {
                    addr.isDefault = (addr.id === addressId);
                });

                localStorage.setItem('userAddresses', JSON.stringify(addresses));
                window.addresses = addresses; // Update global array
                
                // Update in Firebase (async, non-blocking)
                if (currentUser && isOnline) {
                    // This would require iterating through all user addresses in Firestore and setting only one as default
                }

                showToast('Default address updated!', 'success');
                
                // Refresh addresses list
                closeSavedAddressesModal();
                setTimeout(() => savedAddresses(), 100);
                renderAddresses(); // Update checkout UI
                
            } catch (error) {
                console.error("Error setting default address:", error);
                showToast("Error setting default address: " + error.message, 'error');
            }
        }
        
        // ★★★ END OF ADDRESS FIXES ★★★

        // Add missing authentication form toggle functions
        function showLoginForm() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('signupForm').style.display = 'none';
            document.getElementById('loginFooter').style.display = 'block';
            document.getElementById('signupFooter').style.display = 'none';
        }

        function showSignupForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'block';
            document.getElementById('loginFooter').style.display = 'none';
            document.getElementById('signupFooter').style.display = 'block';
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Auth form listeners
            loginForm.addEventListener('submit', handleLogin);
            signupForm.addEventListener('submit', handleSignup);
            document.getElementById('showSignup').addEventListener('click', showSignupForm);
            document.getElementById('showLogin').addEventListener('click', showLoginForm);

            // ✅ FIX 3: UPDATED SEARCH EVENT LISTENERS
            searchInput.addEventListener('input', handleSearch);
            // Replaced focus/blur with click for enhanced search modal
            searchInput.addEventListener('click', openEnhancedSearch);
            
            // ✅ FIX 5: UPDATED FILTER LISTENERS
            shopFilter.addEventListener('change', applyFilters);
            categoryFilter.addEventListener('change', applyFilters);

            // Navigation listeners
            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = item.getAttribute('data-page');
                    navigateToPage(page);
                });
            });

            // Profile picture load on app start
            loadProfilePicture();

            // Enhanced Search Overlay Click
            document.getElementById('searchOverlay').addEventListener('click', closeEnhancedSearch);
            // Bottom sheet listeners
            closeSheetBtn.addEventListener('click', closeBottomSheet);
            bottomNavCart.addEventListener('click', (e) => {
                e.preventDefault();
                openBottomSheet();
            });

            // Checkout listeners
            applyCouponBtn.addEventListener('click', applyCoupon);

            // Payment method selection
            paymentOptions.forEach(option => {
                option.addEventListener('click', () => {
                    selectPaymentMethod(option.getAttribute('data-method'));
                });
            });

            // Address and phone validation
            checkoutPhone.addEventListener('input', validatePhone);
            // Removed addrPhone and saveAddr event listeners as they are now handled in the modals
            
            // QR payment
            confirmQrPayment.addEventListener('click', confirmQRPayment);
            utrNumber.addEventListener('input', validateUTR);
            
            // Auto-fill checkout name when user is logged in
            auth.onAuthStateChanged((user) => {
                if (user) {
                    document.getElementById('checkoutName').value = user.displayName || '';
                }
            });

            // Notification Toggles
            document.getElementById('orderUpdatesToggle')?.addEventListener('change', function() {
                updateNotificationPreference('orderUpdates', this.checked);
            });
            document.getElementById('priceAlertsToggle')?.addEventListener('change', function() {
                updateNotificationPreference('priceAlerts', this.checked);
            });
            document.getElementById('promotionsToggle')?.addEventListener('change', function() {
                updateNotificationPreference('promotions', this.checked);
            });
            document.getElementById('pushNotificationsToggle')?.addEventListener('change', function() {
                togglePushNotifications();
            });

            // Clear Notifications button
            document.getElementById('clearNotificationsBtn')?.addEventListener('click', clearAllNotifications);
        }

        // Navigation
        function navigateToPage(page) {
            // Hide all pages
            homePage.style.display = 'none';
            ordersPage.style.display = 'none';
            wishlistPage.style.display = 'none';
            productDetailPage.style.display = 'none';
            profilePage.style.display = 'none';
            notificationsPage.style.display = 'none';

            // Update nav items
            navItems.forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-page') === page) {
                    item.classList.add('active');
                }
            });

            // Show selected page
            switch(page) {
                case 'home':
                    homePage.style.display = 'block';
                    break;
                case 'orders':
                    ordersPage.style.display = 'block';
                    renderOrders();
                    break;
                case 'wishlist':
                    wishlistPage.style.display = 'block';
                    renderWishlistItems();
                    break;
                case 'account':
                    profilePage.style.display = 'block';
                    loadUserProfile();
                    break;
                case 'notifications':
                    notificationsPage.style.display = 'block';
                    loadNotificationsPage();
                    break;
                case 'cart':
                    openBottomSheet();
                    break;
                default:
                    homePage.style.display = 'block';
            }
        }

        // ✅ FIX 3: UPDATED SEARCH FUNCTIONALITY - Only handles input for now
        function handleSearch() {
            const query = searchInput.value.trim();
            if (query.length === 0) {
                searchResults.style.display = 'none';
                renderProducts(PRODUCTS);
                return;
            }
            
            performSearch(query);
        }

        // ✅ FIX 3: IMPROVED SEARCH FUNCTION
        function performSearch(query) {
            const lowerQuery = query.toLowerCase();
            
            const filteredProducts = PRODUCTS.filter(product => 
                product.name.toLowerCase().includes(lowerQuery) ||
                (product.category && product.category.toLowerCase().includes(lowerQuery)) ||
                (product.description && product.description.toLowerCase().includes(lowerQuery)) ||
                (product.brand && product.brand.toLowerCase().includes(lowerQuery))
            );
            
            // Show search results
            showSearchResults(filteredProducts, query);
            
            // Also update main grid
            renderProducts(filteredProducts);
            
            if (filteredProducts.length === 0) {
                // showToast(`No products found for "${query}"`); // Suppressing for cleaner UI
            } else {
                // showToast(`Found ${filteredProducts.length} products for "${query}"`); // Suppressing for cleaner UI
            }
        }

        // ✅ FIX 3: SHOW SEARCH RESULTS
        function showSearchResults(products, query) {
            searchResults.innerHTML = '';
            
            if (products.length === 0) {
                searchResults.style.display = 'none';
                return;
            }
            
            // Show limited results in dropdown
            const limitedResults = products.slice(0, 5);
            
            limitedResults.forEach(product => {
                const searchItem = document.createElement('div');
                searchItem.className = 'search-result-item';
                searchItem.innerHTML = `
                    <img src="${product.image}" alt="${product.name}" class="search-result-image">
                    <div class="search-result-info">
                        <div class="search-result-name">${product.name}</div>
                        <div class="search-result-category">${product.category} • ${product.shopName}</div>
                    </div>
                    <div class="search-result-price">₹${product.price}</div>
                `;
                searchItem.addEventListener('click', () => {
                    searchInput.value = product.name;
                    showProductDetail(product.id);
                    searchResults.style.display = 'none';
                });
                searchResults.appendChild(searchItem);
            });
            
            // Show "View all results" option
            if (products.length > 5) {
                const viewAllItem = document.createElement('div');
                viewAllItem.className = 'search-result-item';
                viewAllItem.style.justifyContent = 'center';
                viewAllItem.innerHTML = `
                    <div style="color: var(--accent); font-weight: 600;">
                        View all ${products.length} results for "${query}"
                    </div>
                `;
                viewAllItem.addEventListener('click', () => {
                    searchResults.style.display = 'none';
                    renderProducts(products);
                });
                searchResults.appendChild(viewAllItem);
            }
            
            searchResults.style.display = 'block';
        }

        // Product Rendering - FIXED
        function renderProducts(products) {
            const productGrid = document.getElementById('productGrid') || document.getElementById('grid'); // Use 'grid' as fallback
            const emptyState = document.getElementById('empty');
            
            if (!productGrid) return;

            productGrid.innerHTML = '';
            
            if (products.length === 0) {
                if (emptyState) emptyState.style.display = 'block';
                return;
            }
            
            if (emptyState) emptyState.style.display = 'none';
            
            products.forEach(product => {
                // ✅ USE MAPPED shopName FIELD
                const shopName = product.shopName || 
                                (product.shopId ? 'Shop ' + product.shopId.slice(-4) : 'Unknown Shop');
                
                const discount = product.mrp ? Math.round(((product.mrp - product.price) / product.mrp) * 100) : 0;
                const isInWishlist = wishlist.includes(product.id);
                
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.innerHTML = `
                    ${product.badge ? `<div class="product-badge">${product.badge}</div>` : ''}
                    <div class="shop-badge">${shopName}</div> <button class="wishlist-btn ${isInWishlist ? 'active' : ''}" onclick="toggleWishlist('${product.id}')">
                        <i class="fas fa-heart"></i>
                    </button>
                    <img src="${product.image}" alt="${product.name}" class="product-image" onclick="showProductDetail('${product.id}')">
                    <h3 class="product-title" onclick="showProductDetail('${product.id}')">${product.name}</h3>
                    <p class="product-category">${product.category} • ${product.deliveryTime || '10-15 min'}</p>
                    <div class="product-price">
                        <span class="current-price">₹${product.price}</span>
                        ${product.mrp ? `<span class="original-price">₹${product.mrp}</span>` : ''}
                        ${discount > 0 ? `<span class="discount">${discount}% OFF</span>` : ''}
                    </div>
                    <div class="card-actions">
                        <button class="btn-add-cart" onclick="addToCart('${product.id}')">
                            <i class="fas fa-shopping-cart"></i> Add to Cart
                        </button>
                    </div>
                `;
                productGrid.appendChild(productCard);
            });
        }
        
        // Enhanced Search Functionality - PHASE 2
        function openEnhancedSearch() {
            document.getElementById('searchOverlay').style.display = 'block';
            document.getElementById('searchModal').style.display = 'block';
            document.getElementById('enhancedSearchInput').focus();
            
            loadRecentSearches();
            loadPopularSearches();
            loadShopFilters();
            
            // Hide suggestions initially
            document.getElementById('searchSuggestionsSection').style.display = 'none';
            document.getElementById('searchSuggestions').style.display = 'none';
        }

        function closeEnhancedSearch() {
            document.getElementById('searchOverlay').style.display = 'none';
            document.getElementById('searchModal').style.display = 'none';
            document.getElementById('enhancedSearchInput').value = '';
        }

        function loadRecentSearches() {
            const recentSearches = JSON.parse(localStorage.getItem('dukaan_recent_searches')) || [];
            const recentSearchesList = document.getElementById('recentSearchesList');
            
            recentSearchesList.innerHTML = '';
            
            if (recentSearches.length === 0) {
                document.getElementById('recentSearchesSection').style.display = 'none';
                return;
            }
            
            document.getElementById('recentSearchesSection').style.display = 'block';
            
            recentSearches.slice(0, 8).forEach(search => {
                const searchItem = document.createElement('div');
                searchItem.className = 'recent-search-item';
                searchItem.textContent = search;
                searchItem.addEventListener('click', () => {
                    document.getElementById('enhancedSearchInput').value = search;
                    performEnhancedSearch(search);
                });
                recentSearchesList.appendChild(searchItem);
            });
        }

        function loadPopularSearches() {
            const popularSearches = [
                'Milk', 'Bread', 'Eggs', 'Shampoo', 
                'T-Shirt', 'Vegetables', 'Earbuds', 'Face Cream'
            ];
            
            const popularSearchesList = document.getElementById('popularSearchesList');
            popularSearchesList.innerHTML = '';
            
            popularSearches.forEach(search => {
                const searchItem = document.createElement('div');
                searchItem.className = 'popular-search-item';
                searchItem.innerHTML = `
                    <i class="fas fa-search suggestion-icon"></i>
                    ${search}
                `;
                searchItem.addEventListener('click', () => {
                    document.getElementById('enhancedSearchInput').value = search;
                    performEnhancedSearch(search);
                });
                popularSearchesList.appendChild(searchItem);
            });
        }

        function loadShopFilters() {
            const shopFiltersList = document.getElementById('shopFiltersList');
            shopFiltersList.innerHTML = '';
            
            Object.values(SHOPS).forEach(shop => {
                const shopItem = document.createElement('label');
                shopItem.className = 'shop-filter-item';
                shopItem.innerHTML = `
                    <input type="checkbox" class="shop-filter" value="${shop.id}">
                    <span>${shop.name}</span>
                `;
                shopFiltersList.appendChild(shopItem);
            });
        }

        function clearRecentSearches() {
            localStorage.removeItem('dukaan_recent_searches');
            loadRecentSearches();
            showToast('Recent searches cleared');
        }

        function addToRecentSearches(query) {
            if (!query.trim()) return;
            
            let recentSearches = JSON.parse(localStorage.getItem('dukaan_recent_searches')) || [];
            
            // Remove if already exists
            recentSearches = recentSearches.filter(item => item.toLowerCase() !== query.toLowerCase());
            
            // Add to beginning
            recentSearches.unshift(query);
            
            // Keep only last 10 searches
            recentSearches = recentSearches.slice(0, 10);
            
            localStorage.setItem('dukaan_recent_searches', JSON.stringify(recentSearches));
        }

        // Enhanced Search Core Functions
        function performEnhancedSearch(query) {
            if (!query.trim()) return;
            
            addToRecentSearches(query);
            closeEnhancedSearch();
            
            // Perform search and show results
            searchInput.value = query;
            const filteredProducts = PRODUCTS.filter(product => 
                product.name.toLowerCase().includes(query.toLowerCase()) ||
                product.category.toLowerCase().includes(query.toLowerCase()) ||
                product.shopName.toLowerCase().includes(query.toLowerCase())
            );
            
            renderProducts(filteredProducts);
            showToast(`Found ${filteredProducts.length} products for "${query}"`);
            
            // Scroll to products
            document.getElementById('homePage').scrollIntoView({ behavior: 'smooth' });
        }

        function applyAdvancedFilters() {
            const minPrice = parseInt(document.getElementById('minPrice').value) || 0;
            const maxPrice = parseInt(document.getElementById('maxPrice').value) || 5000;
            const selectedRatings = Array.from(document.querySelectorAll('.rating-filter:checked')).map(cb => parseInt(cb.value));
            const selectedShops = Array.from(document.querySelectorAll('.shop-filter:checked')).map(cb => cb.value);
            
            let filteredProducts = PRODUCTS;
            
            // Price filter
            filteredProducts = filteredProducts.filter(product => 
                product.price >= minPrice && product.price <= maxPrice
            );
            
            // Rating filter (placeholder - will implement when we have actual ratings)
            if (selectedRatings.length > 0) {
                // Filter logic for rating will be added here
                // For now, assume rating is 5 for all products if filter is applied
                filteredProducts = filteredProducts.filter(product => {
                    const productRating = 5; // Placeholder
                    return productRating >= Math.min(...selectedRatings);
                });
            }
            
            // Shop filter
            if (selectedShops.length > 0) {
                filteredProducts = filteredProducts.filter(product => 
                    selectedShops.includes(product.shopId)
                );
            }
            
            closeEnhancedSearch();
            renderProducts(filteredProducts);
            
            const filterText = [];
            if (minPrice > 0 || maxPrice < 5000) filterText.push(`Price: ₹${minPrice}-₹${maxPrice}`);
            if (selectedShops.length > 0) filterText.push(`${selectedShops.length} shops`);
            
            showToast(`Applied filters: ${filterText.join(', ')} - ${filteredProducts.length} products`);
        }

        function resetFilters() {
            document.getElementById('minPrice').value = 0;
            document.getElementById('maxPrice').value = 5000;
            document.getElementById('priceRange').value = 5000;
            
            document.querySelectorAll('.rating-filter').forEach(cb => cb.checked = false);
            document.querySelectorAll('.shop-filter').forEach(cb => cb.checked = false);
            
            showToast('Filters reset');
        }

        // Enhanced Search Event Listeners
        document.getElementById('enhancedSearchInput').addEventListener('input', function() {
            const query = this.value.trim();
            
            if (query.length === 0) {
                document.getElementById('searchSuggestionsSection').style.display = 'none';
                document.getElementById('searchSuggestions').style.display = 'none';
                return;
            }
            
            // Show search suggestions
            showSearchSuggestions(query);
        });

        document.getElementById('enhancedSearchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performEnhancedSearch(this.value);
            }
        });

        function showSearchSuggestions(query) {
            const suggestions = generateSearchSuggestions(query);
            const suggestionsList = document.getElementById('searchSuggestionsList');
            
            suggestionsList.innerHTML = '';
            
            if (suggestions.length === 0) {
                document.getElementById('searchSuggestionsSection').style.display = 'none';
                return;
            }
            
            document.getElementById('searchSuggestionsSection').style.display = 'block';
            
            suggestions.forEach(suggestion => {
                const suggestionItem = document.createElement('li');
                suggestionItem.className = 'search-suggestion-item';
                suggestionItem.innerHTML = `
                    <i class="fas fa-search suggestion-icon"></i>
                    <span>${suggestion}</span>
                `;
                suggestionItem.addEventListener('click', () => {
                    document.getElementById('enhancedSearchInput').value = suggestion;
                    performEnhancedSearch(suggestion);
                });
                suggestionsList.appendChild(suggestionItem);
            });
        }

        function generateSearchSuggestions(query) {
            const lowerQuery = query.toLowerCase();
            const suggestions = new Set();
            
            // Product name suggestions
            PRODUCTS.forEach(product => {
                if (product.name.toLowerCase().includes(lowerQuery)) {
                    suggestions.add(product.name);
                }
            });
            
            // Category suggestions
            const categories = [...new Set(PRODUCTS.map(p => p.category))];
            categories.forEach(category => {
                if (category.toLowerCase().includes(lowerQuery)) {
                    suggestions.add(category);
                }
            });
            
            // Shop suggestions
            Object.values(SHOPS).forEach(shop => {
                if (shop.name.toLowerCase().includes(lowerQuery)) {
                    suggestions.add(shop.name);
                }
            });
            
            return Array.from(suggestions).slice(0, 8);
        }

        // Price range sync
        document.getElementById('priceRange')?.addEventListener('input', function() {
            document.getElementById('maxPrice').value = this.value;
        });

        document.getElementById('minPrice')?.addEventListener('input', function() {
            document.getElementById('priceRange').min = this.value;
        });

        document.getElementById('maxPrice')?.addEventListener('input', function() {
            document.getElementById('priceRange').value = this.value;
        });

        // ✅ FIX 5: UPDATED FILTER FUNCTIONALITY
        function applyFilters() {
            const shopValue = shopFilter.value;
            const categoryValue = categoryFilter.value;
            const sortValue = document.getElementById('sortSelect').value;
            
            console.log('🔄 Applying filters - Shop:', shopValue, 'Category:', categoryValue);
            
            let filteredProducts = PRODUCTS;
            
            // ✅ FIX 5: PROPER SHOP FILTERING
            if (shopValue) {
                filteredProducts = filteredProducts.filter(product => {
                    const matchesShop = product.shopId === shopValue;
                    return matchesShop;
                });
                console.log(`✅ Filtered by shop ${shopValue}: ${filteredProducts.length} products`);
            }
            
            // ✅ FIX 5: PROPER CATEGORY FILTERING
            if (categoryValue) {
                filteredProducts = filteredProducts.filter(product => {
                    const matchesCategory = product.category === categoryValue;
                    return matchesCategory;
                });
                console.log(`✅ Filtered by category ${categoryValue}: ${filteredProducts.length} products`);
            }
            
            // Apply sorting to filtered products
            applySortingToProducts(filteredProducts, sortValue);
        }

        // Sorting Functionality - PHASE 2.1
        function setupSorting() {
            document.getElementById('sortSelect')?.addEventListener('change', function() {
                // Apply sort to currently filtered view
                applyFilters();
            });
        }

        function applySorting(sortType) {
            let productsToSort = [...PRODUCTS];
            
            switch(sortType) {
                case 'price_high_low':
                    productsToSort.sort((a, b) => b.price - a.price);
                    showToast('Sorted: Price High to Low');
                    break;
                case 'price_low_high':
                    productsToSort.sort((a, b) => a.price - b.price);
                    showToast('Sorted: Price Low to High');
                    break;
                case 'newest':
                    // For demo, we'll sort by ID (assuming newer products have higher IDs)
                    productsToSort.sort((a, b) => b.id.localeCompare(a.id));
                    showToast('Sorted: Newest First');
                    break;
                default:
                    // Fallback to original order, but still filter is needed
                    productsToSort = PRODUCTS;
            }
            
            renderProducts(productsToSort);
        }

        function applySortingToProducts(products, sortType) {
            let sortedProducts = [...products];
            
            switch(sortType) {
                case 'price_high_low':
                    sortedProducts.sort((a, b) => b.price - a.price);
                    break;
                case 'price_low_high':
                    sortedProducts.sort((a, b) => a.price - b.price);
                    break;
                case 'newest':
                    sortedProducts.sort((a, b) => b.id.localeCompare(a.id));
                    break;
            }
            
            renderProducts(sortedProducts);
        }

        // Cart Functionality
        // Cart Functionality - FIXED: Inventory sync
        async function addToCart(productId) {
            if (!isOnline) {
                showToast('Cannot check stock while offline. Try again later.', 'warning');
            }

            try {
                // Check real-time stock from Firebase
                let currentStock = Infinity;
                if (isOnline) {
                    const productDoc = await db.collection('products').doc(productId).get();
                    if (!productDoc.exists) {
                        showToast('Product not available');
                        return;
                    }
                    
                    const productData = productDoc.data();
                    currentStock = productData.stock || 0;
                    
                    if (currentStock === 0) {
                        showToast('Sorry, this product is out of stock');
                        return;
                    }
                }
                
                const product = PRODUCTS.find(p => p.id === productId);
                if (!product) return;
                
                const existingItem = cart.find(item => item.id === productId);
                
                if (existingItem) {
                    // Check if adding more exceeds available stock
                    if (isOnline && existingItem.quantity + 1 > currentStock) {
                        showToast(`Only ${currentStock} items available`);
                        return;
                    }
                    existingItem.quantity += 1;
                } else {
                    cart.push({
                        id: product.id,
                        name: product.name,
                        price: product.price,
                        image: product.image,
                        quantity: 1,
                        shop: product.shop,
                        shopId: product.shopId,
                        shopName: product.shopName
                    });
                }
                
                localStorage.setItem('dukaan_cart', JSON.stringify(cart));
                updateCartUI();
                showToast('Product added to cart!');
                
            } catch (error) {
                console.error('Error adding to cart:', error);
                showToast('Error adding product to cart');
            }
        }

        function addToCartFromDetail() {
            if (!currentProductDetail) return;
            
            const quantity = parseInt(document.getElementById('quantityValue').textContent);
            const product = PRODUCTS.find(p => p.id === currentProductDetail.id);
            
            if (!product) return;
            
            // Stock check (basic client-side check)
            if (product.stock > 0 && quantity > product.stock) {
                 showToast(`Only ${product.stock} items available`);
                 return;
            }
            
            const existingItem = cart.find(item => item.id === product.id);
            
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    image: product.image,
                    quantity: quantity,
                    shop: product.shop,
                    shopId: product.shopId,
                    shopName: product.shopName
                });
            }
            
            localStorage.setItem('dukaan_cart', JSON.stringify(cart));
            updateCartUI();
            showToast('Product added to cart!');
            closeProductDetail();
        }

        function updateCartUI() {
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            bottomCartCount.textContent = totalItems;
            
            // HIDE BADGE WHEN 0
            if (totalItems === 0) {
                bottomCartCount.style.display = 'none';
            } else {
                bottomCartCount.style.display = 'block';
            }
            
            // Update order summary in bottom sheet
            updateOrderSummary();
        }

        // ADD THIS NEW FUNCTION FOR QUANTITY UPDATES
        async function updateCartQuantity(index, change) {
            if (cart[index]) {
                const itemId = cart[index].id;
                let currentStock = Infinity;
                
                if (isOnline) {
                    try {
                        const productDoc = await db.collection('products').doc(itemId).get();
                        if (productDoc.exists) {
                            currentStock = productDoc.data().stock || 0;
                        }
                    } catch (error) {
                        console.error('Error fetching stock:', error);
                    }
                }

                const newQuantity = cart[index].quantity + change;

                if (newQuantity <= 0) {
                    cart.splice(index, 1);
                    showToast('Item removed from cart');
                } else if (newQuantity > 10) {
                    cart[index].quantity = 10;
                    showToast('Maximum 10 items allowed');
                    return;
                } else if (isOnline && newQuantity > currentStock) {
                    cart[index].quantity = currentStock;
                    showToast(`Only ${currentStock} items available. Quantity set to max available.`);
                    return;
                } else {
                    cart[index].quantity = newQuantity;
                    showToast('Quantity updated');
                }
                
                localStorage.setItem('dukaan_cart', JSON.stringify(cart));
                updateCartUI();
                updateOrderSummary();
            }
        }

        function updateOrderSummary() {
            if (!orderList) return;
            
            orderList.innerHTML = '';
            let subtotal = 0;
            
            cart.forEach((item, index) => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;
                
                const orderItem = document.createElement('div');
                orderItem.className = 'order-item-summary';
                orderItem.innerHTML = `
                    <div style="flex: 1;">
                        <strong>${item.name}</strong>
                        <div class="text-muted">₹${item.price} each</div>
                        <div class="quantity-controls" style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">
                            <button class="btn-quantity-minus" onclick="updateCartQuantity(${index}, -1)" 
                                    style="width: 30px; height: 30px; border-radius: 50%; border: 1px solid var(--border); background: var(--neutral); display: flex; align-items: center; justify-content: center;">-</button>
                            <span style="font-weight: 600; min-width: 20px; text-align: center;">${item.quantity}</span>
                            <button class="btn-quantity-plus" onclick="updateCartQuantity(${index}, 1)" 
                                    style="width: 30px; height: 30px; border-radius: 50%; border: 1px solid var(--border); background: var(--neutral); display: flex; align-items: center; justify-content: center;">+</button>
                        </div>
                    </div>
                    <div>₹${itemTotal}</div>
                `;
                orderList.appendChild(orderItem);
            });
            
            // Apply coupon discount if any
            let discount = 0;
            if (appliedCoupon) {
                if (appliedCoupon.type === 'percentage') {
                    discount = (subtotal * appliedCoupon.value) / 100;
                } else {
                    discount = appliedCoupon.value;
                }
                // Ensure discount doesn't exceed subtotal
                discount = Math.min(discount, subtotal);
            }
            
            const total = subtotal + 40 - discount; // Assuming 40 is delivery charge
            
            orderTotal.textContent = `₹${Math.max(0, total)}`;
            qrAmount.textContent = `₹${Math.max(0, total)}`;
            
            // Update discount section (assuming discountSection and discountAmount elements exist)
            const discountSection = document.getElementById('discountSection');
            const discountAmount = document.getElementById('discountAmount');
            
            if (discount > 0 && discountSection && discountAmount) {
                discountSection.style.display = 'flex';
                discountAmount.textContent = `-₹${discount.toFixed(2)}`;
            } else if (discountSection) {
                discountSection.style.display = 'none';
            }
        }

        // Wishlist Functionality
        function toggleWishlist(productId) {
            const index = wishlist.indexOf(productId);
            
            if (index > -1) {
                wishlist.splice(index, 1);
                showToast('Removed from wishlist');
            } else {
                wishlist.push(productId);
                showToast('Added to wishlist');
            }
            
            localStorage.setItem('dukaan_wishlist', JSON.stringify(wishlist));
            updateWishlistUI();
            renderProducts(PRODUCTS); // Re-render to update heart icons
        }

        function toggleWishlistFromDetail() {
            if (!currentProductDetail) return;
            toggleWishlist(currentProductDetail.id);
            
            // Update heart icon in detail page
            const wishlistBtn = document.getElementById('wishlistDetailBtn');
            const isInWishlist = wishlist.includes(currentProductDetail.id);
            wishlistBtn?.classList.toggle('active', isInWishlist);
        }

        function updateWishlistUI() {
            // Safely update wishlist count if element exists
            if (wishlistCount) {
                wishlistCount.textContent = wishlist.length;
                wishlistCount.style.display = wishlist.length > 0 ? 'block' : 'none';
            }
            
            // Update hamburger wishlist count safely (This is usually hidden in your CSS, but keeping logic)
            const hamburgerWishlistCount = document.getElementById('hamburgerWishlistCount');
            if (hamburgerWishlistCount) {
                hamburgerWishlistCount.textContent = wishlist.length;
                hamburgerWishlistCount.style.display = 'none'; // Keep hidden as per CSS
            }
            
            if (wishlistItems) {
                if (wishlist.length === 0) {
                    wishlistItems.style.display = 'none';
                    noWishlist.style.display = 'block';
                } else {
                    wishlistItems.style.display = 'block';
                    noWishlist.style.display = 'none';
                }
            }
        }

        function renderWishlistItems() {
            if (!wishlistItems) return;
            
            wishlistItems.innerHTML = '';
            
            if (wishlist.length === 0) {
                noWishlist.style.display = 'block';
                return;
            }
            
            noWishlist.style.display = 'none';
            
            wishlist.forEach(productId => {
                const product = PRODUCTS.find(p => p.id === productId);
                if (!product) return;
                
                // ✅ FIXED: Use mapped shopName
                const shopName = product.shopName || 
                                (product.shopId ? 'Shop ' + product.shopId.slice(-4) : 'Unknown Shop');

                const wishlistCard = document.createElement('div');
                wishlistCard.className = 'wishlist-card';
                wishlistCard.innerHTML = `
                    <img src="${product.image}" alt="${product.name}" class="wishlist-image">
                    <div class="wishlist-info">
                        <h4>${product.name}</h4>
                        <p class="text-muted">${shopName} • ${product.category}</p>
                        <div class="product-price">
                            <span class="current-price">₹${product.price}</span>
                            <span class="original-price">₹${product.mrp || ''}</span>
                        </div>
                    </div>
                    <div class="wishlist-actions">
                        <button class="btn-primary" onclick="addToCart('${product.id}')">
                            <i class="fas fa-shopping-cart"></i>
                        </button>
                        <button class="btn-outline" onclick="toggleWishlist('${product.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                wishlistItems.appendChild(wishlistCard);
            });
        }
        // ✅ FIX 4: UPDATED PRODUCT DETAIL PAGE WITH SPECIFICATIONS
        function showProductDetail(productId) {
            const product = PRODUCTS.find(p => p.id === productId);
            if (!product) return;
            
            currentProductDetail = product;
            
            // Ensure shop is not null/undefined
            const shop = SHOPS[product.shopId] || { name: product.shopName || 'Unknown Shop', deliveryTime: product.deliveryTime || '10-15 min' };

            const discount = product.mrp ? Math.round(((product.mrp - product.price) / product.mrp) * 100) : 0;
            const isInWishlist = wishlist.includes(product.id);
            
            // Update product detail page
            document.getElementById('productDetailImage').src = product.image;
            document.getElementById('productDetailTitle').textContent = product.name;
            document.getElementById('productDetailCategory').textContent = `${product.category} • ${shop.name} • ${shop.deliveryTime}`;
            document.getElementById('productDetailCurrent').textContent = `₹${product.price}`;
            document.getElementById('productDetailOriginal').textContent = `₹${product.mrp || ''}`;
            document.getElementById('productDetailDiscount').textContent = `${discount}% OFF`;
            
            // ✅ FIX 4: Update product description
            document.getElementById('productDetailDescription').textContent = product.description || 'No description available';
            
            // ✅ FIX 4: Load product specifications
            loadProductSpecifications(product);
            
            // ✅ FIX 4: Load return policy
            loadReturnPolicy(product);
            
            // Update wishlist button
            const wishlistBtn = document.getElementById('wishlistDetailBtn');
            wishlistBtn?.classList.toggle('active', isInWishlist);
            
            // Reset quantity
            document.getElementById('quantityValue').textContent = '1';
            
            // Load reviews for this product
            loadProductReviews(product.id);
            
            // Show product detail page
            homePage.style.display = 'none';
            productDetailPage.style.display = 'block';
            
            // Update navigation
            navItems.forEach(item => item.classList.remove('active'));
        }

        // ✅ FIX 4: LOAD PRODUCT SPECIFICATIONS
        function loadProductSpecifications(product) {
            const specsContainer = document.getElementById('productSpecifications');
            if (!specsContainer) return;

            specsContainer.innerHTML = '';
            
            // Default specifications
            const defaultSpecs = {
                'Brand': product.brand || 'Generic',
                'Category': product.category || 'Uncategorized',
                'Delivery Time': product.deliveryTime || '10-15 min',
                'Stock': product.stock > 0 ? 'In Stock' : 'Out of Stock',
                'Shop': product.shopName || 'Unknown Shop'
            };
            
            // Merge with product specifications
            const specifications = { ...defaultSpecs, ...product.specifications };
            
            // Create specification items
            Object.entries(specifications).forEach(([key, value]) => {
                if (value) {
                    const specItem = document.createElement('div');
                    specItem.className = 'spec-item';
                    specItem.innerHTML = `
                        <span class="spec-label">${key}:</span>
                        <span class="spec-value">${value}</span>
                    `;
                    specsContainer.appendChild(specItem);
                }
            });
            
            // If no specifications, show message
            if (specsContainer.children.length === 0) {
                specsContainer.innerHTML = '<p class="text-muted">No specifications available for this product.</p>';
            }
        }

        // ✅ FIX 4: LOAD RETURN POLICY
        function loadReturnPolicy(product) {
            const policyList = document.getElementById('returnPolicyList');
            if (!policyList) return;
            
            policyList.innerHTML = '';
            
            // Default return policy points
            const defaultPolicy = [
                'Items must be returned within 7 days of delivery',
                'Products must be unused and in original packaging',
                'Provide proof of purchase (order details)',
                'Contact shopkeeper directly for returns/replacements',
                'Refunds will be processed within 5-7 business days'
            ];
            
            // Add custom return policy if available
            let policyPoints = defaultPolicy;
            if (product.returnPolicy && product.returnPolicy !== 'No returns. Contact shopkeeper for any issues.') {
                // Split custom policy by common delimiters or treat as one point
                const customPoints = product.returnPolicy.split(/[\r\n.]+/).filter(p => p.trim() !== '');
                policyPoints = [...customPoints, ...defaultPolicy.filter(p => !customPoints.includes(p))];
            }
            
            // Create policy list items
            policyPoints.forEach(point => {
                const li = document.createElement('li');
                li.innerHTML = `<i class="fas fa-check"></i> ${point}`;
                policyList.appendChild(li);
            });
        }

        function closeProductDetail() {
            productDetailPage.style.display = 'none';
            homePage.style.display = 'block';
            navItems.forEach(item => item.classList.remove('active'));
            navItems[0]?.classList.add('active');
        }

        function changeQuantity(change) {
            const quantityElement = document.getElementById('quantityValue');
            if (!quantityElement) return;

            let quantity = parseInt(quantityElement.textContent);
            quantity += change;
            
            if (quantity < 1) quantity = 1;
            if (quantity > 10) quantity = 10;
            
            quantityElement.textContent = quantity;
        }

        // Reviews System
        function loadProductReviews(productId) {
            const productReviews = getProductReviews(productId);
            const averageRating = calculateAverageRating(productReviews);
            const ratingDistribution = calculateRatingDistribution(productReviews);
            
            // Update average rating
            document.getElementById('averageRatingValue').textContent = averageRating.toFixed(1);
            updateRatingStars('averageRatingStars', averageRating);
            document.getElementById('totalReviewsCount').textContent = `${productReviews.length} reviews`;
            
            // Update rating distribution
            updateRatingDistribution(ratingDistribution, productReviews.length);
            
            // Show/hide review form based on user purchase status
            const reviewFormSection = document.getElementById('reviewFormSection');
            const noReviews = document.getElementById('noReviews');
            const reviewsList = document.getElementById('reviewsList');
            
            if (productReviews.length === 0) {
                noReviews.style.display = 'block';
                reviewsList.style.display = 'none';
            } else {
                noReviews.style.display = 'none';
                reviewsList.style.display = 'block';
                renderReviewsList(productReviews);
            }
            
            // Show review form if user is logged in and has purchased the product
            const hasPurchased = checkIfUserPurchasedProduct(productId);
            if (currentUser && hasPurchased && !hasUserReviewedProduct(productId)) {
                reviewFormSection.style.display = 'block';
                setupStarRatingInput();
                document.getElementById('reviewSubmitBtn').onclick = submitReview; // Attach event listener here
            } else {
                reviewFormSection.style.display = 'none';
            }
        }

        function getProductReviews(productId) {
            return productReviews.filter(review => review.productId === productId);
        }

        function calculateAverageRating(reviews) {
            if (reviews.length === 0) return 0;
            const sum = reviews.reduce((total, review) => total + review.rating, 0);
            return sum / reviews.length;
        }

        function calculateRatingDistribution(reviews) {
            const distribution = {5: 0, 4: 0, 3: 0, 2: 0, 1: 0};
            reviews.forEach(review => {
                distribution[review.rating]++;
            });
            return distribution;
        }

        function updateRatingStars(elementId, rating) {
            const starsContainer = document.getElementById(elementId);
            if (!starsContainer) return;
            starsContainer.innerHTML = '';
            
            for (let i = 1; i <= 5; i++) {
                const star = document.createElement('span');
                star.className = `rating-star ${i <= rating ? 'filled' : ''}`;
                star.innerHTML = '★';
                starsContainer.appendChild(star);
            }
        }

        function updateRatingDistribution(distribution, totalReviews) {
            const distributionContainer = document.querySelector('.rating-distribution');
            if (!distributionContainer) return;

            distributionContainer.innerHTML = '';
            
            for (let rating = 5; rating >= 1; rating--) {
                const count = distribution[rating];
                const percentage = totalReviews > 0 ? (count / totalReviews) * 100 : 0;
                
                const bar = document.createElement('div');
                bar.className = 'rating-bar';
                bar.innerHTML = `
                    <div class="bar-label">${rating} ★</div>
                    <div class="bar-container">
                        <div class="bar-fill" style="width: ${percentage}%"></div>
                    </div>
                    <div class="bar-count">${count}</div>
                `;
                distributionContainer.appendChild(bar);
            }
        }

        function renderReviewsList(reviews) {
            const reviewsList = document.getElementById('reviewsList');
            if (!reviewsList) return;
            
            reviewsList.innerHTML = '';
            
            reviews.forEach(review => {
                const reviewCard = document.createElement('div');
                reviewCard.className = 'review-card';
                reviewCard.innerHTML = `
                    <div class="review-header">
                        <div class="review-user">
                            <div class="user-avatar">${review.userName.charAt(0).toUpperCase()}</div>
                            <div>
                                <h5>${review.userName}</h5>
                                <div class="verified-badge">Verified Purchase</div>
                            </div>
                        </div>
                        <div class="review-rating">
                            ${'★'.repeat(review.rating)}${'☆'.repeat(5 - review.rating)}
                        </div>
                    </div>
                    <div class="review-date">${new Date(review.date).toLocaleDateString()}</div>
                    <div class="review-content">${review.comment}</div>
                `;
                reviewsList.appendChild(reviewCard);
            });
        }

        function setupStarRatingInput() {
            const starInputs = document.querySelectorAll('.star-input');
            starInputs.forEach(star => {
                star.onclick = () => { // Use onclick instead of addEventListener for simplicity
                    const rating = parseInt(star.getAttribute('data-rating'));
                    selectedRating = rating;
                    
                    // Update star appearance
                    starInputs.forEach((s, index) => {
                        if (index < rating) {
                            s.classList.add('active');
                        } else {
                            s.classList.remove('active');
                        }
                    });
                };
            });
        }

        function checkIfUserPurchasedProduct(productId) {
            if (!currentUser) return false;
            
            return orders.some(order => 
                order.status === 'delivered' &&
                order.items.some(item => item.id === productId)
            );
        }

        function hasUserReviewedProduct(productId) {
            if (!currentUser) return false;
            
            return productReviews.some(review => 
                review.productId === productId && review.userId === currentUser.uid
            );
        }

        function submitReview() {
            if (!currentUser || !currentProductDetail || selectedRating === 0) {
                showToast('Please select a rating');
                return;
            }
            
            const reviewText = document.getElementById('reviewText').value.trim();
            if (reviewText.length < REVIEW_RULES.minReviewLength) {
                showToast(`Review must be at least ${REVIEW_RULES.minReviewLength} characters long`);
                return;
            }
            
            if (!checkIfUserPurchasedProduct(currentProductDetail.id)) {
                showToast('You can only review products you have purchased');
                return;
            }
            
            if (hasUserReviewedProduct(currentProductDetail.id)) {
                showToast('You have already reviewed this product');
                return;
            }
            
            const newReview = {
                id: generateId(),
                productId: currentProductDetail.id,
                userId: currentUser.uid,
                userName: currentUser.name,
                rating: selectedRating,
                comment: reviewText,
                date: new Date().toISOString()
            };
            
            productReviews.push(newReview);
            localStorage.setItem('dukaan_product_reviews', JSON.stringify(productReviews));
            
            // Save to Firebase if user is logged in
            if (currentUser && isOnline) {
                db.collection('productReviews').add(newReview).catch(error => {
                    console.error('Error saving review to Firebase:', error);
                });
            }
            
            showToast('Review submitted successfully!');
            loadProductReviews(currentProductDetail.id);
            
            // Reset form
            selectedRating = 0;
            document.getElementById('reviewText').value = '';
            document.querySelectorAll('.star-input').forEach(star => star.classList.remove('active'));
        }

        // Bottom Sheet (Checkout)
        function openBottomSheet() {
            if (cart.length === 0) {
                showToast('Your cart is empty');
                return;
            }
            
            updateOrderSummary();
            bottomSheet?.classList.add('open');
            // Select default address if none is selected
            if (!selectedAddress && addresses.length > 0) {
                selectedAddress = addresses.find(addr => addr.isDefault)?.id || addresses[0].id;
            }
            renderAddresses();
        }

        function closeBottomSheet() {
            bottomSheet?.classList.remove('open');
            qrCodeSection?.style.display = 'none';
            selectedPaymentMethod = null;
            paymentOptions.forEach(option => option.classList.remove('selected'));
        }

        // Address Management
        // ✅ RE-IMPLEMENTED: renderAddresses() - For Checkout Page
        function renderAddresses() {
            if (!addressesContainer) return;
            
            addressesContainer.innerHTML = '';
            
            if (addresses.length === 0) {
                addressesContainer.innerHTML = '<p class="text-muted">No addresses saved. Add your first address below.</p>';
                return;
            }
            
            const defaultAddress = addresses.find(addr => addr.isDefault) || addresses[0];
            selectedAddress = selectedAddress || defaultAddress.id;
            
            addresses.forEach(address => {
                const isSelected = selectedAddress === address.id;
                const addressCard = document.createElement('div');
                addressCard.className = `address-card ${isSelected ? 'selected' : ''}`;
                addressCard.innerHTML = `
    <div class="address-title">
        ${address.type === 'home' ? '🏠 Home' : address.type === 'work' ? '💼 Work' : '📍 Other'}
        ${address.isDefault ? '<span class="badge bg-success ms-2">Default</span>' : ''}
    </div>
    <div class="address-details">${address.name || address.fullName || 'Customer'} • ${address.address}</div>
    <div class="address-phone">${address.phone} • ${address.city} - ${address.pincode}</div>
`;
                addressCard.onclick = () => {
                    selectedAddress = address.id;
                    renderAddresses();
                };
                addressesContainer.appendChild(addressCard);
            });
        }
        
        // This function is now superseded by saveNewAddressModal and editAddressModal in the Profile section
        function saveNewAddress_DEPRECATED() {
            // ... (old logic for adding address, now moved to saveNewAddressModal)
        }

        // Payment Methods - CORRECTED ORDER FLOW
        function selectPaymentMethod(method) {
            selectedPaymentMethod = method;
            
            paymentOptions.forEach(option => {
                option.classList.remove('selected');
                if (option.getAttribute('data-method') === method) {
                    option.classList.add('selected');
                }
            });
            
            if (qrCodeSection) {
                qrCodeSection.style.display = method === 'qr' ? 'block' : 'none';
            }
        }

        // Validation Functions
        function validatePhone() {
            const phone = checkoutPhone.value.trim();
            const isValid = validatePhoneNumber(phone);
            
            if (phone.length === 0) {
                checkoutPhone.classList.remove('phone-valid', 'phone-invalid');
                phoneValidation.textContent = '';
                return;
            }
            
            if (isValid) {
                checkoutPhone.classList.add('phone-valid');
                checkoutPhone.classList.remove('phone-invalid');
                phoneValidation.textContent = '✓ Valid phone number';
                phoneValidation.className = 'validation-message validation-success';
            } else {
                checkoutPhone.classList.add('phone-invalid');
                checkoutPhone.classList.remove('phone-valid');
                phoneValidation.textContent = 'Please enter a valid 10-digit phone number';
                phoneValidation.className = 'validation-message validation-error';
            }
        }

        function validateAddrPhone() {
            // DEPRECATED - Now handled by validatePhoneModal in the modal
        }

        function validatePhoneNumber(phone) {
            return /^[6-9]\d{9}$/.test(phone);
        }

        function validateUTR() {
            const utr = utrNumber.value.trim();
            const isValid = /^\d{12}$/.test(utr);
            
            if (utr.length === 0) {
                utrValidation.textContent = '';
                return;
            }
            
            if (isValid) {
                utrValidation.textContent = '✓ Valid UTR number';
                utrValidation.className = 'validation-message validation-success';
            } else {
                utrValidation.textContent = 'Please enter a valid 12-digit UTR number';
                utrValidation.className = 'validation-message validation-error';
            }
        }

        // ✅ FIX 2: UPDATED COUPON SYSTEM WITH SHOPKEEPER SETTINGS
        function applyCoupon() {
            if (!currentUser) {
                showToast('Please login to apply coupons');
                return;
            }
            
            // ✅ FIX 2: CHECK IF COUPONS ARE ENABLED
            if (!SHOP_COUPON_SETTINGS.couponEnabled) {
                showToast('Coupons are currently disabled by shopkeeper', 'warning');
                couponMessage.textContent = 'Coupons are currently disabled';
                couponMessage.className = 'coupon-error';
                appliedCoupon = null;
                updateOrderSummary();
                return;
            }
            
            const couponCode = couponCodeInput.value.trim().toUpperCase();
            
            // If coupon code is empty, just remove any applied coupon
            if (!couponCode) {
                appliedCoupon = null;
                couponMessage.textContent = '';
                updateOrderSummary();
                showToast('Coupon removed');
                return;
            }
            
            const coupon = AVAILABLE_COUPONS.find(c => c.code === couponCode);
            
            if (!coupon) {
                couponMessage.textContent = 'Invalid coupon code';
                couponMessage.className = 'coupon-error';
                appliedCoupon = null;
                updateOrderSummary();
                return;
            }
            
            // ✅ FIX 2: CHECK IF COUPON IS ACTIVE
            if (!SHOP_COUPON_SETTINGS.activeCoupons.includes(couponCode)) {
                couponMessage.textContent = 'This coupon is no longer active';
                couponMessage.className = 'coupon-error';
                appliedCoupon = null;
                updateOrderSummary();
                return;
            }
            
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            if (subtotal < coupon.minOrder) {
                couponMessage.textContent = `Minimum order amount of ₹${coupon.minOrder} required`;
                couponMessage.className = 'coupon-error';
                appliedCoupon = null;
                updateOrderSummary();
                return;
            }
            
            appliedCoupon = coupon;
            couponMessage.textContent = `🎉 ${coupon.description}`;
            couponMessage.className = 'coupon-success';
            updateOrderSummary();
            showToast('Coupon applied successfully!');
        }

        function updateCouponAuth() {
            if (currentUser) {
                couponCodeInput.disabled = false;
                applyCouponBtn.disabled = false;
                couponLoginRequired.style.display = 'none';
            } else {
                couponCodeInput.disabled = true;
                applyCouponBtn.disabled = true;
                couponLoginRequired.style.display = 'block';
            }
        }

        // QR Payment Confirmation - FIXED: Only confirms QR payment, doesn't place order
        function confirmQRPayment() {
            const utr = utrNumber.value.trim();
            if (!/^\d{12}$/.test(utr)) {
                showToast('Please enter a valid UTR number');
                return;
            }
            
            // Show confirmation modal for QR payment only
            showConfirmationModal(
                'Confirm QR Payment',
                `You are about to confirm your QR payment with UTR: ${utr}. Total amount: ${qrAmount.textContent}. Please ensure you have completed the payment via QR scan.`,
                () => {
                    // Just confirm the QR payment, don't place order
                    showToast('QR payment confirmed! Please click "Place Order Securely" to complete your order.');
                    // You can add any QR-specific confirmation logic here
                }
            );
        }

        // Confirmation Modal System
        function showConfirmationModal(title, message, onConfirm) {
            document.getElementById('confirmationTitle').textContent = title;
            document.getElementById('confirmationMessage').textContent = message;
            
            const confirmButton = document.getElementById('confirmAction');
            const modalElement = document.getElementById('confirmationModal');
            const modal = new bootstrap.Modal(modalElement);
            
            // Set up one-time event listener
            const handleConfirm = () => {
                onConfirm();
                modal.hide();
                confirmButton.removeEventListener('click', handleConfirm);
            };
            
            confirmButton.addEventListener('click', handleConfirm);
            
            // Clean up when modal is hidden
            modalElement.addEventListener('hidden.bs.modal', () => {
                confirmButton.removeEventListener('click', handleConfirm);
            });
            
            modal.show();
        }

        // Order Management
        function renderOrders() {
            if (!ordersList) return;
            
            ordersList.innerHTML = '';
            
            if (orders.length === 0) {
                noOrders.style.display = 'block';
                return;
            }
            
            noOrders.style.display = 'none';
            
            // Sort orders by date (newest first)
            const sortedOrders = [...orders].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedOrders.forEach(order => {
                const orderCard = document.createElement('div');
                orderCard.className = 'order-card';
                orderCard.setAttribute('data-order-id', order.id);
                
                const statusClass = `status-${order.status.replace(/_/g, '-')}`; // Convert status for CSS class
                const statusText = getStatusText(order.status);
                
                // ✅ FIXED: Use unified orderId
                const displayOrderId = order.orderId || order.id;
                
                // ✅ ADD: Get refund message if applicable
                const refundMessage = addRefundMessageToOrder(order);
                
                orderCard.innerHTML = `
                    <div class="order-header">
                        <div class="order-id">Order #${displayOrderId.slice(-6)}</div>
                        <div class="order-status ${statusClass}">${statusText}</div>
                    </div>
                    <div class="order-items">
                        ${order.items.map(item => `
                            <div class="order-item">
                                <span>${item.name} × ${item.quantity}</span>
                                <span>₹${item.price * item.quantity}</span>
                            </div>
                        `).join('')}
                    </div>
                    
                    ${refundMessage}
                    
                    <div class="order-footer">
                        <div class="order-total">₹${order.total}</div>
                        <div class="order-actions">
                            <button class="btn-reorder" onclick="reorder('${order.id}')">
                                <i class="fas fa-redo"></i> Reorder
                            </button>
                            <button class="btn-outline" onclick="shareOrder('${order.id}')">
                                <i class="fas fa-share"></i> Share
                            </button>
                            ${['pending', 'confirmed', 'preparing'].includes(order.status) ? `
                                <button class="btn-outline btn-danger" onclick="cancelOrder('${order.id}')" style="background: var(--danger); color: white;">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
                ordersList.appendChild(orderCard);
            });
        }
        
        // ✅ UPDATED: Get status text for all statuses
        function getStatusText(status) {
            const statusMap = {
                'pending': 'Pending',
                'confirmed': 'Confirmed',
                'preparing': 'Preparing',
                'packed': 'Packed',
                'dispatched': 'Dispatched',
                'ready_for_pickup': 'Ready for Pickup',
                'out_for_delivery': 'Out for Delivery',
                'delivered': 'Delivered',
                'cancelled': 'Cancelled',
                'picked_up': 'Picked Up'
            };
            return statusMap[status] || status.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        }

        /* ✅ ADD PICKUP LOCATION FUNCTION - ADD THIS FUNCTION */
        function showPickupLocation(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            // Get shop address from order items
            const shopAddress = order.items && order.items[0] ? 
                (order.items[0].shopAddress || 'Shop address not available') : 
                'Shop address not available';
            
            const shopName = order.items && order.items[0] ? 
                (order.items[0].shopName || 'Shop') : 'Shop';
            
            alert(`📍 ${shopName} Pickup Location:\n\n${shopAddress}\n\nPlease collect your order during shop hours.`);
        }

        function reorder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            order.items.forEach(item => {
                const existingItem = cart.find(cartItem => cartItem.id === item.id);
                if (existingItem) {
                    existingItem.quantity += item.quantity;
                } else {
                    cart.push({...item});
                }
            });
            
            localStorage.setItem('dukaan_cart', JSON.stringify(cart));
            updateCartUI();
            showToast('Items added to cart!');
            openBottomSheet();
        }

        // ✅ FIXED: IMPROVED ORDER TRACKING TIMELINE WITH ALL STEPS
        function updateTrackingTimeline(order) {
            // Note: This function is still present for internal use (e.g., if you decide to show tracking later)
            console.log('🔄 Updating tracking timeline for order (UI is hidden):', order.id, 'Status:', order.status);
        }
        
        // ✅ NEW FUNCTION: Get correct status sequence based on delivery type
        function getStatusSequence(deliveryType) {
            if (deliveryType === 'pickup') {
                return [
                    { id: 'pending', label: 'Order Placed' },
                    { id: 'confirmed', label: 'Confirmed' },
                    { id: 'preparing', label: 'Preparing' },
                    { id: 'ready_for_pickup', label: 'Ready for Pickup' },
                    { id: 'picked_up', label: 'Picked Up' }
                ];
            } else {
                return [
                    { id: 'pending', label: 'Order Placed' },
                    { id: 'confirmed', label: 'Confirmed' },
                    { id: 'preparing', label: 'Preparing' },
                    { id: 'dispatched', label: 'Dispatched' },
                    { id: 'out_for_delivery', label: 'Out for Delivery' },
                    { id: 'delivered', label: 'Delivered' }
                ];
            }
        }
        
        // ✅ UPDATE: Also update the updateETACountdown() function
        function updateETACountdown(order) {
            // Note: This function is still present for internal use (e.g., if you decide to show tracking later)
            const etaElement = document.getElementById('etaCountdown');
            if (!etaElement) return;
            
            let etaMinutes = 0;
            let statusText = '';
            
            // GET CORRECT STATUS SEQUENCE
            const statusSequence = getStatusSequence(order.deliveryType);
            const currentStatus = order.status;
            
            switch(currentStatus) {
                case 'pending':
                    etaMinutes = 45;
                    statusText = 'Order will be confirmed soon';
                    break;
                case 'confirmed':
                    etaMinutes = 40;
                    statusText = 'Preparing will start soon';
                    break;
                case 'preparing':
                    etaMinutes = 30;
                    statusText = 'Your order is being prepared';
                    break;
                case 'packed':
                    etaMinutes = 25;
                    statusText = 'Order packed, ready for dispatch';
                    break;
                case 'dispatched':
                    if (order.deliveryType === 'pickup') {
                        etaMinutes = 15;
                        statusText = 'Will be ready for pickup soon';
                    } else {
                        etaMinutes = 20;
                        statusText = 'Out for delivery soon';
                    }
                    break;
                case 'ready_for_pickup':
                    etaMinutes = 0;
                    statusText = 'Ready for pickup';
                    break;
                case 'out_for_delivery':
                    etaMinutes = 15;
                    statusText = 'On the way to you';
                    break;
                case 'delivered':
                case 'picked_up':
                    etaMinutes = 0;
                    statusText = order.deliveryType === 'pickup' ? 'Picked up successfully!' : 'Delivered successfully!';
                    break;
                default:
                    etaMinutes = 0;
                    statusText = getStatusText(currentStatus);
            }
            
            if (etaMinutes > 0) {
                const deliveryTime = new Date(new Date().getTime() + etaMinutes * 60000);
                etaElement.innerHTML = `
                    <div>${statusText}</div>
                    <div class="text-primary fw-bold">ETA: ${deliveryTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} (${etaMinutes} min)</div>
                `;
            } else {
                etaElement.innerHTML = `<div class="text-success fw-bold">${statusText}</div>`;
            }
        }

        function shareOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            const orderDetails = `
Order #${orderId.slice(-6)}
Status: ${getStatusText(order.status)}
Total: ₹${order.total}
Items: ${order.items.map(item => `${item.name} (Qty: ${item.quantity})`).join(', ')}
Placed on: ${new Date(order.date).toLocaleDateString()}

Track your order: ${window.location.href}
    `.trim();
            
            // Check if Web Share API is available
            if (navigator.share) {
                navigator.share({
                    title: `My Dukaan Order #${orderId.slice(-6)}`,
                    text: orderDetails,
                    url: window.location.href
                }).then(() => {
                    showToast('Order shared successfully!');
                }).catch(error => {
                    console.log('Error sharing:', error);
                    fallbackShare(orderDetails);
                });
            } else {
                fallbackShare(orderDetails);
            }
        }

        function fallbackShare(orderDetails) {
            // Copy to clipboard as fallback
            navigator.clipboard.writeText(orderDetails).then(() => {
                showToast('Order details copied to clipboard!');
            }).catch(() => {
                // Final fallback - show in alert
                alert('Order Details:\n\n' + orderDetails);
            });
        }

        // Removed modifyOrder and contactDeliveryAgent as per user request (Issue #2 & #3)

        // User Profile Functions - PHASE 1
        function loadUserProfile() {
            if (!currentUser) return;
            
            // Update profile information
            document.getElementById('profileUserName').textContent = currentUser.name;
            document.getElementById('profileUserEmail').textContent = currentUser.email;
            document.getElementById('avatarText').textContent = currentUser.name.charAt(0).toUpperCase();
            
            // Load user preferences
            loadUserPreferences();
            loadLoginHistory();
        }

        function loadUserPreferences() {
            const preferences = JSON.parse(localStorage.getItem('dukaan_preferences')) || {
                pushNotifications: notificationPreferences.pushEnabled, // Sync with actual preference
                emailNotifications: true,
                smsNotifications: false,
                language: 'english'
            };
            
            document.getElementById('pushNotifications').checked = preferences.pushNotifications;
            document.getElementById('emailNotifications').checked = preferences.emailNotifications;
            document.getElementById('smsNotifications').checked = preferences.smsNotifications;
        }

        function loadLoginHistory() {
            const loginHistory = JSON.parse(localStorage.getItem('dukaan_login_history')) || [];
            const historyList = document.getElementById('loginHistoryList');
            
            if (loginHistory.length === 0) {
                // Add current session as first history
                const currentSession = {
                    device: 'Current Device',
                    location: 'Current Location',
                    time: new Date().toISOString(),
                    active: true
                };
                loginHistory.unshift(currentSession);
                localStorage.setItem('dukaan_login_history', JSON.stringify(loginHistory));
            }
            
            renderLoginHistory(loginHistory);
        }

        function renderLoginHistory(history) {
            const historyList = document.getElementById('loginHistoryList');
            if (!historyList) return;

            historyList.innerHTML = '';
            
            history.forEach((session, index) => {
                const sessionElement = document.createElement('div');
                sessionElement.className = `login-session ${session.active ? 'session-active' : 'session-inactive'}`;
                sessionElement.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <strong>${session.device}</strong>
                            <div style="font-size: 0.9rem; color: var(--text-light); margin-top: 4px;">
                                ${session.location}
                            </div>
                            <div style="font-size: 0.8rem; color: var(--text-light); margin-top: 2px;">
                                ${new Date(session.time).toLocaleString()}
                            </div>
                        </div>
                        ${session.active ? '<div class="security-badge">Active</div>' : ''}
                    </div>
                `;
                historyList.appendChild(sessionElement);
            });
        }

        // ✅ FIX 4: Updated to handle phone number update in Firebase
        function editPersonalDetails() {
            const user = firebase.auth().currentUser;
            const currentName = user.displayName || "";
            const currentEmail = user.email || "";
            // Assuming phone is stored in the Firestore user document
            let currentPhone = '';
            
            // Fetch phone from Firestore first
            if (currentUser && isOnline) {
                db.collection('users').doc(currentUser.uid).get().then(doc => {
                    if (doc.exists) {
                        currentPhone = doc.data().phone || '';
                        
                        // Proceed to show modal after fetching phone
                        showEditProfileModal(currentName, currentEmail, currentPhone);
                    } else {
                        showEditProfileModal(currentName, currentEmail, currentPhone);
                    }
                }).catch(error => {
                    console.error('Error fetching user phone:', error);
                    showEditProfileModal(currentName, currentEmail, currentPhone);
                });
            } else {
                showEditProfileModal(currentName, currentEmail, currentPhone);
            }
        }
        
        function showEditProfileModal(currentName, currentEmail, currentPhone) {
            const modalHTML = `
            <div class="modal-overlay active" id="editProfileModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Edit Profile</h3>
                        <button class="modal-close" onclick="closeEditProfileModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="editUserName" value="${currentName}" placeholder="Enter your full name">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email Address</label>
                            <input type="email" class="form-control" id="editUserEmail" value="${currentEmail}" readonly style="background: #f8f9fa;">
                            <small class="text-muted">Email cannot be changed</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="editUserPhone" value="${currentPhone}" placeholder="Enter phone number" oninput="validatePhoneModal(this)">
                             <small id="phoneValidationModal" class="validation-message"></small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-outline" onclick="closeEditProfileModal()">Cancel</button>
                        <button type="button" class="btn-primary" onclick="processProfileUpdate()">Save Changes</button>
                    </div>
                </div>
            </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeEditProfileModal() {
            const modal = document.getElementById('editProfileModal');
            if (modal) modal.remove();
        }

        async function processProfileUpdate() {
            const newName = document.getElementById('editUserName').value.trim();
            const newPhone = document.getElementById('editUserPhone').value.trim();
            
            if (!newName) {
                showToast("Name cannot be empty", 'error');
                return;
            }
            if (newPhone && !validatePhoneNumber(newPhone)) {
                showToast("Please enter a valid phone number", 'error');
                return;
            }
            
            const user = firebase.auth().currentUser;
            
            try {
                // 1. Update Firebase Auth display name
                if (newName !== user.displayName) {
                    await user.updateProfile({ displayName: newName });
                    currentUser.name = newName;
                }
                
                // 2. Update Firestore document (for phone number and name)
                if (currentUser && isOnline) {
                    const updateData = {
                        name: newName,
                        phone: newPhone
                    };
                    await db.collection('users').doc(currentUser.uid).update(updateData);
                    currentUser.phone = newPhone;
                }

                showToast("Profile updated successfully!", 'success');
                
                // Update UI elements
                document.getElementById('profileUserName').textContent = newName;
                document.getElementById('avatarText').textContent = newName.charAt(0).toUpperCase();

                closeEditProfileModal();
                
            } catch (error) {
                console.error("Profile update error:", error);
                showToast("Error updating profile: " + error.message, 'error');
            }
        }

        function changeProfilePicture() {
            document.getElementById('avatarUpload').click();
        }

        function changePassword() {
            // Create a custom modal for password change
            const modalHTML = `
            <div class="modal-overlay active" id="passwordModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Change Password</h3>
                        <button class="modal-close" onclick="closePasswordModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Current Password</label>
                            <input type="password" class="form-control" id="currentPassword" placeholder="Enter your current password" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">New Password</label>
                            <input type="password" class="form-control" id="newPassword" placeholder="Enter new password (min. 6 characters)" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Confirm New Password</label>
                            <input type="password" class="form-control" id="confirmPassword" placeholder="Confirm your new password" required>
                        </div>
                        <div class="alert alert-info">
                            <small><i class="fas fa-info-circle"></i> You'll need to re-enter your current password for security</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-outline" onclick="closePasswordModal()">Cancel</button>
                        <button type="button" class="btn-primary" onclick="processPasswordChange()">Update Password</button>
                    </div>
                </div>
            </div>
            `;
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closePasswordModal() {
            const modal = document.getElementById('passwordModal');
            if (modal) {
                modal.remove();
            }
        }

        async function processPasswordChange() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Validation
            if (!isOnline) { showToast("Cannot change password while offline", 'error'); return; }
            if (!currentPassword) { showToast("Please enter your current password", 'error'); return; }
            if (!newPassword || newPassword.length < 6) { showToast("New password must be at least 6 characters", 'error'); return; }
            if (newPassword !== confirmPassword) { showToast("New passwords don't match", 'error'); return; }
            if (currentPassword === newPassword) { showToast("New password cannot be same as current password", 'error'); return; }
            
            const user = firebase.auth().currentUser;
            const email = user.email;
            
            try {
                showToast("Verifying your current password...", 'info');
                
                // Re-authenticate user first
                const credential = firebase.auth.EmailAuthProvider.credential(email, currentPassword);
                await user.reauthenticateWithCredential(credential);
                
                // Now update password
                await user.updatePassword(newPassword);
                
                showToast("Password updated successfully!", 'success');
                closePasswordModal();
                
            } catch (error) {
                console.error("Password change error:", error);
                
                if (error.code === 'auth/wrong-password') {
                    showToast("Current password is incorrect", 'error');
                } else if (error.code === 'auth/requires-recent-login') {
                    showToast("Session expired. Please sign in again", 'error');
                } else {
                    showToast("Error: " + error.message, 'error');
                }
            }
        }

        function showLoginHistory() {
            document.getElementById('loginHistorySection').style.display = 'block';
            // Scroll to login history section
            setTimeout(() => {
                document.getElementById('loginHistorySection')?.scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }

        function changeLanguage() {
            showConfirmationModal(
                'Change Language',
                'You will be able to select your preferred language. This feature is coming in the next update!',
                () => {
                    showToast('Language selection feature coming soon!');
                }
            );
        }

        // Handle profile picture upload
        document.getElementById('avatarUpload')?.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const avatar = document.getElementById('profileAvatar');
                    const avatarText = document.getElementById('avatarText');
                    
                    avatarText.style.display = 'none';
                    avatar.style.backgroundImage = `url(${e.target.result})`;
                    avatar.style.backgroundSize = 'cover';
                    avatar.style.backgroundPosition = 'center';
                    
                    // Save to localStorage
                    localStorage.setItem('dukaan_profile_picture', e.target.result);
                    showToast('Profile picture updated successfully!');
                };
                reader.readAsDataURL(file);
            }
        });

        // Handle preference changes
        document.getElementById('pushNotifications')?.addEventListener('change', function() {
            savePreference('pushNotifications', this.checked);
        });

        document.getElementById('emailNotifications')?.addEventListener('change', function() {
            savePreference('emailNotifications', this.checked);
        });

        document.getElementById('smsNotifications')?.addEventListener('change', function() {
            savePreference('smsNotifications', this.checked);
        });

        function savePreference(key, value) {
            const preferences = JSON.parse(localStorage.getItem('dukaan_preferences')) || {};
            preferences[key] = value;
            localStorage.setItem('dukaan_preferences', JSON.stringify(preferences));
            showToast('Preferences updated!');
        }

        // Load saved profile picture on app start
        function loadProfilePicture() {
            const savedPicture = localStorage.getItem('dukaan_profile_picture');
            if (savedPicture) {
                const avatar = document.getElementById('profileAvatar');
                const avatarText = document.getElementById('avatarText');
                
                if (avatar && avatarText) {
                    avatarText.style.display = 'none';
                    avatar.style.backgroundImage = `url(${savedPicture})`;
                    avatar.style.backgroundSize = 'cover';
                    avatar.style.backgroundPosition = 'center';
                }
            }
        }

        // Notification Core Functions
        function loadNotificationsPage() {
            renderNotificationsList();
            updateNotificationPreferencesUI();
            updateNotificationBadge();
        }

        function createNotification(title, message, type = 'info', action = null) {
            const notification = {
                id: generateId(),
                title,
                message, 
                type,
                action,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            notifications.unshift(notification);
            localStorage.setItem('dukaan_notifications', JSON.stringify(notifications));
            updateNotificationBadge();
            
            // Show browser notification if enabled (Issue #5)
            if (notificationPreferences.pushEnabled && 'Notification' in window && Notification.permission === 'granted') {
                new Notification(title, { body: message, icon: 'https://cdn-icons-png.flaticon.com/512/3082/3082383.png' });
            }
        }

        function renderNotificationsList() {
            const list = document.getElementById('notificationsList');
            const empty = document.getElementById('noNotifications');
            
            if (!list || !empty) return;

            if (notifications.length === 0) {
                list.innerHTML = '';
                empty.style.display = 'block';
                return;
            }
            
            empty.style.display = 'none';
            list.innerHTML = notifications.map(notif => `
                <div class="notification-item ${notif.read ? '' : 'notification-unread'}" 
                     onclick="markNotificationRead('${notif.id}')">
                    <div style="flex: 1;">
                        <strong>${notif.title}</strong>
                        <p style="margin: 5px 0; color: var(--text-light);">${notif.message}</p>
                        <small>${new Date(notif.timestamp).toLocaleString()}</small>
                    </div>
                </div>
            `).join('');
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notificationCount');
            const unreadCount = notifications.filter(n => !n.read).length;
            
            if (badge) {
                if (unreadCount > 0) {
                    badge.textContent = unreadCount;
                    badge.style.display = 'block';
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        function updateNotificationPreference(key, value) {
            notificationPreferences[key] = value;
            localStorage.setItem('dukaan_notification_prefs', JSON.stringify(notificationPreferences));
            showToast('Notification preference updated');
        }

        // ✅ ISSUE #5: PUSH NOTIFICATION LOGIC
        function togglePushNotifications() {
            if (!('Notification' in window)) {
                showToast('Browser does not support notifications');
                document.getElementById('pushNotificationsToggle').checked = false;
                return;
            }
            
            if (Notification.permission === 'granted') {
                // If permission is already granted, toggle the internal preference state
                notificationPreferences.pushEnabled = !notificationPreferences.pushEnabled;
                document.getElementById('pushNotificationsToggle').checked = notificationPreferences.pushEnabled;
                showToast(`Push notifications ${notificationPreferences.pushEnabled ? 'enabled' : 'disabled'}`);
            } else if (Notification.permission === 'denied') {
                showToast('Push notifications blocked by browser. Please change settings manually.', 'error');
                document.getElementById('pushNotificationsToggle').checked = false;
                notificationPreferences.pushEnabled = false;
            } else {
                // Request permission
                Notification.requestPermission().then(permission => {
                    notificationPreferences.pushEnabled = permission === 'granted';
                    document.getElementById('pushNotificationsToggle').checked = permission === 'granted';
                    
                    if (permission === 'granted') {
                        showToast('Push notifications enabled!');
                    } else {
                        showToast('Push notification permission denied.', 'warning');
                    }
                });
            }
            
            localStorage.setItem('dukaan_notification_prefs', JSON.stringify(notificationPreferences));
        }

        function updateNotificationPreferencesUI() {
            document.getElementById('orderUpdatesToggle').checked = notificationPreferences.orderUpdates;
            document.getElementById('priceAlertsToggle').checked = notificationPreferences.priceAlerts;
            document.getElementById('promotionsToggle').checked = notificationPreferences.promotions;
            document.getElementById('pushNotificationsToggle').checked = notificationPreferences.pushEnabled;
        }

        // Social Sharing Features - PHASE 5.2
        function showComingSoon(featureName) {
            showToast(`${featureName} - Coming Soon! 🚀`);
        }

        // Share Product Functionality
        function shareProduct(productId) {
            const product = PRODUCTS.find(p => p.id === productId);
            if (!product) return;
            
            const discount = product.mrp ? Math.round(((product.mrp - product.price) / product.mrp) * 100) : 0;
            const shareText = `Check out ${product.name} on Dukaan - ₹${product.price} (${discount}% OFF)!`;
            const shareUrl = window.location.href.split('?')[0] + `?product=${productId}`;
            
            if (navigator.share) {
                navigator.share({
                    title: product.name,
                    text: shareText,
                    url: shareUrl
                }).then(() => {
                    showToast('Product shared successfully!');
                }).catch(() => {
                    fallbackShareProduct(shareText, shareUrl);
                });
            } else {
                fallbackShareProduct(shareText, shareUrl);
            }
        }

        function fallbackShareProduct(text, url) {
            const shareData = `${text}\n\n${url}`;
            navigator.clipboard.writeText(shareData).then(() => {
                showToast('Product link copied to clipboard!');
            }).catch(() => {
                alert(`Share this product:\n\n${shareData}`);
            });
        }

        // Hamburger Menu Functions
        function openHamburgerMenu() {
            document.getElementById('hamburgerMenu')?.classList.add('open');
        }

        function closeHamburgerMenu() {
            document.getElementById('hamburgerMenu')?.classList.remove('open');
        }

        // Utility Functions
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        }

        function showToast(message, type = 'info') {
            // Create toast element
            const toast = document.createElement('div');
            toast.className = 'position-fixed top-0 start-50 translate-middle-x mt-3';
            toast.style.zIndex = '9999';
            
            let bgColor = 'var(--accent)';
            if (type === 'error') bgColor = 'var(--danger)';
            if (type === 'success') bgColor = 'var(--success)';
            if (type === 'warning') bgColor = 'var(--warning)';
            
            toast.innerHTML = `
                <div class="toast show" role="alert" style="background: ${bgColor}; color: white; border: none;">
                    <div class="toast-body d-flex justify-content-between align-items-center">
                        <span>${message}</span>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        // ✅ ADD THESE POLICY FUNCTIONS HERE:
        function openPrivacyPolicy() {
            closeHamburgerMenu();
            showPolicyModal('Privacy Policy');
        }

        function openTermsConditions() {
            closeHamburgerMenu();
            showPolicyModal('Terms & Conditions');
        }

        function openRefundPolicy() {
            closeHamburgerMenu();
            showPolicyModal('Refund Policy');
        }

        // ✅ SHOW POLICY MODAL
        function showPolicyModal(title) {
            const modalHTML = `
                <div class="modal-overlay active" id="policyModal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">${title}</h3>
                            <button class="modal-close" onclick="closePolicyModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            ${getPolicyContent(title)}
                        </div>
                        <div class="modal-footer">
                            <button class="btn-outline" onclick="closePolicyModal()">
                                <i class="fas fa-times"></i> Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // ✅ POLICY CONTENT
        function getPolicyContent(title) {
            if (title === 'Privacy Policy') {
                return `
                    <div style="padding: 1rem; line-height: 1.6;">
                        <h4 style="color: var(--primary); margin-bottom: 1rem;">
                            Privacy Policy
                        </h4>
                        <p>We respect your privacy and are committed to protecting your personal data.</p>
                        <h5>What We Collect:</h5>
                        <ul>
                            <li>Name and contact information</li>
                            <li>Delivery addresses</li>
                            <li>Order history</li>
                            <li>Payment information (secured)</li>
                        </ul>
                        <h5>How We Use Your Data:</h5>
                        <ul>
                            <li>To process your orders</li>
                            <li>To improve our services</li>
                            <li>To send order updates</li>
                            <li>For customer support</li>
                        </ul>
                        <p>We never share your personal data with third parties without your consent.</p>
                    </div>
                `;
            } else if (title === 'Terms & Conditions') {
                return `
                    <div style="padding: 1rem; line-height: 1.6;">
                        <h4 style="color: var(--primary); margin-bottom: 1rem;">
                            Terms & Conditions
                        </h4>
                        <p>By using Raashanmart, you agree to these terms:</p>
                        <h5>User Responsibilities:</h5>
                        <ul>
                            <li>Provide accurate information</li>
                            <li>Keep your account secure</li>
                            <li>Use services legally</li>
                            <li>Respect shopkeeper policies</li>
                        </ul>
                        <h5>Order Policies:</h5>
                        <ul>
                            <li>Prices may change</li>
                            <li>Availability is subject to stock</li>
                            <li>Delivery times are estimates</li>
                            <li>Shopkeepers may cancel orders</li>
                        </ul>
                        <h5>Account Termination:</h5>
                        <p>We may suspend accounts for violations of terms.</p>
                    </div>
                `;
            } else if (title === 'Refund Policy') {
                return `
                    <div style="padding: 1rem; line-height: 1.6;">
                        <h4 style="color: var(--primary); margin-bottom: 1rem;">
                            Refund Policy
                        </h4>
                        <h5>Refund Eligibility:</h5>
                        <ul>
                            <li>Damaged or incorrect items</li>
                            <li>Orders not delivered</li>
                            <li>Cancelled orders</li>
                            <li>Shopkeeper discretion</li>
                        </ul>
                        <h5>Refund Process:</h5>
                        <ul>
                            <li>Contact shopkeeper within 24 hours</li>
                            <li>Provide order details</li>
                            <li>Share photos if applicable</li>
                            <li>Wait for verification</li>
                        </ul>
                        <h5>Refund Time:</h5>
                        <ul>
                            <li>UPI: 1-3 business days</li>
                            <li>Bank Transfer: 3-7 business days</li>
                            <li>Wallet: 1-2 business days</li>
                        </ul>
                        <p>Partial refunds may be issued for damaged items.</p>
                    </div>
                `;
            }
            return '<p>Policy content not available.</p>';
        }

        function closePolicyModal() {
            const modal = document.getElementById('policyModal');
            if (modal) modal.remove();
        }

        // ✅ ADD THIS FUNCTION TO UPDATE UI FOR AUTH
        function updateUIForAuth(user) {
            // Update profile info if user exists
            if (user) {
                const userName = user.displayName || user.email.split('@')[0];
                currentUser = {
                    uid: user.uid,
                    email: user.email,
                    name: userName
                };
                document.getElementById('profileUserName').textContent = userName;
                document.getElementById('profileUserEmail').textContent = user.email;
                document.getElementById('avatarText').textContent = userName.charAt(0).toUpperCase();
                
                // Show user-specific elements
                document.getElementById('checkoutName').value = userName;
            } else {
                // Reset to default
                document.getElementById('profileUserName').textContent = 'User Name';
                document.getElementById('profileUserEmail').textContent = 'user@email.com';
                document.getElementById('avatarText').textContent = 'U';
                document.getElementById('checkoutName').value = '';

                // Clear local data that depends on user
                cart = [];
                wishlist = [];
                orders = [];
                addresses = [];
                localStorage.removeItem('dukaan_cart');
                localStorage.removeItem('dukaan_wishlist');
                localStorage.removeItem('dukaan_orders');
                localStorage.removeItem('userAddresses');
                
                updateCartUI();
                updateWishlistUI();
                renderOrders();
                renderAddresses();
                updateOrderBadges();
            }
        }

        // ✅ ADD PUSH NOTIFICATION FUNCTIONALITY (Defined above)

        // ✅ ADD MISSING FUNCTIONS
        function showOrderTracking(orderId) {
            // This function is now hidden as requested (Issue #3)
            console.log('Order tracking is hidden. Only real-time updates flashed.');
            showToast('Order tracking is currently disabled.', 'info');
        }

        function closeOrderTracking() {
            const trackingSheet = document.getElementById('orderTracking');
            trackingSheet?.classList.remove('open');
            currentTrackingOrder = null;
        }

        // ✅ UPDATED: Cancel order with Firebase update
        async function cancelOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            if (!['pending', 'confirmed', 'preparing'].includes(order.status)) {
                showToast('Order cannot be cancelled after processing started.', 'error');
                return;
            }

            showConfirmationModal(
                'Cancel Order',
                `Are you sure you want to cancel Order #${orderId.slice(-6)}? This action cannot be undone.`,
                async () => {
                    const orderIndex = orders.findIndex(o => o.id === orderId);
                    if (orderIndex !== -1) {
                        orders[orderIndex].status = 'cancelled';
                        localStorage.setItem('dukaan_orders', JSON.stringify(orders));
                        renderOrders();
                        
                        // Update in Firebase
                        if (isOnline) {
                            try {
                                const docToUpdate = await db.collection('orders').where('orderId', '==', orderId).get();
                                if (!docToUpdate.empty) {
                                    const firestoreDocId = docToUpdate.docs[0].id;
                                    await db.collection('orders').doc(firestoreDocId).update({
                                        status: 'cancelled',
                                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                    });
                                }
                            } catch(error) {
                                console.error("Firebase update failed on cancel:", error);
                            }
                        }

                        showToast('Order cancelled successfully', 'success');
                        closeOrderTracking();
                    }
                }
            );
        }
        
        // Final Event Listener Setup
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
            loadProductsFromFirebase(); // ✅ Load real products from Firebase
            
            // Auto login demo user (remove in production)
            // setTimeout(() => {
            //     if (!currentUser) {
            //         demoLogin();
            //     }
            // }, 500);
        });
    </script>
