<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raashanmart - Online Shopping</title>
    <!-- âœ… RAASHANMART FAVICON ADD HERE -->
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/3082/3082383.png" type="image/x-icon">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        /* All CSS remains exactly the same as original */
        :root {
            --primary: #0F2C59; --primary-dark: #0A1F3D; --secondary: #FFFFFF; --accent: #3A8EF6; 
            --accent-hover: #2D7AE6; --success: #10B981; --warning: #F59E0B; --danger: #EF4444;
            --neutral: #F8FAFC; --text-dark: #1E293B; --text-light: #64748B; --border: #E2E8F0;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08); --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.12);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--neutral); color: var(--text-dark); line-height: 1.6; padding-bottom: 80px; }
        .app-header { background: var(--primary); color: white; padding: 12px 0; position: sticky; top: 0; z-index: 1000; }
        .header-container { max-width: 1200px; margin: 0 auto; padding: 0 16px; display: flex; align-items: center; justify-content: space-between; gap: 20px; }
        .brand { display: flex; align-items: center; gap: 12px; font-weight: 800; font-size: 1.4rem; text-decoration: none; color: white; }
        .brand-logo { width: 40px; height: 40px; background: var(--accent); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; }
        .search-container { flex: 1; position: relative; margin: 0 20px; max-width: 600px; }
        .search-bar { width: 100%; padding: 12px 45px 12px 16px; border-radius: 10px; border: none; font-size: 15px; background: white; box-shadow: var(--shadow); transition: all 0.3s ease; }
        .search-bar:focus { outline: none; box-shadow: 0 4px 20px rgba(58, 142, 246, 0.25); }
        .search-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--text-light); }
        .search-results { position: absolute; top: 100%; left: 0; right: 0; background: white; border-radius: 0 0 10px 10px; box-shadow: var(--shadow-lg); max-height: 300px; overflow-y: auto; z-index: 1001; display: none; }
        .search-result-item { padding: 12px 16px; border-bottom: 1px solid var(--border); cursor: pointer; display: flex; align-items: center; gap: 12px; }
        .search-result-item:hover { background: var(--neutral); }
        .search-result-image { width: 40px; height: 40px; border-radius: 8px; object-fit: cover; }
        .search-result-info { flex: 1; }
        .search-result-name { font-weight: 600; font-size: 14px; margin-bottom: 2px; }
        .search-result-category { font-size: 12px; color: var(--text-light); }
        .search-result-price { font-weight: 700; color: var(--accent); font-size: 14px; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding: 12px 0; z-index: 1000; box-shadow: 0 -2px 20px rgba(0, 0, 0, 0.1); }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; text-decoration: none; color: var(--text-light); transition: all 0.2s; flex: 1; position: relative; }
        .nav-item.active { color: var(--accent); }
        .nav-icon { font-size: 20px; }
        .nav-label { font-size: 12px; font-weight: 500; }
        .nav-badge {
            position: absolute;
            top: -5px;
            right: 50px;
            background: var(--accent);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 700;
            min-width: 18px;
            text-align: center;
        }
        .container-main { max-width: 1200px; margin: 24px auto; padding: 0 16px; }
        .hero-banner { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 40px 20px; border-radius: 20px; margin-bottom: 30px; position: relative; overflow: hidden; }
        .hero-content { position: relative; z-index: 2; max-width: 600px; }
        .hero-badge { display: inline-flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600; margin-bottom: 20px; }
        .hero-title { font-size: 2.5rem; font-weight: 800; margin-bottom: 15px; line-height: 1.2; }
        .hero-subtitle { font-size: 1.1rem; margin-bottom: 25px; opacity: 0.9; }
        .btn-primary { background: var(--accent); color: white; border: none; padding: 12px 30px; border-radius: 10px; font-weight: 600; font-size: 16px; cursor: pointer; transition: all 0.3s ease; }
        .btn-primary:hover { background: var(--accent-hover); transform: translateY(-2px); }
        .btn-outline { background: transparent; color: var(--accent); border: 2px solid var(--accent); padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .btn-outline:hover { background: var(--accent); color: white; }
        .hero-pattern { position: absolute; top: 0; right: 0; bottom: 0; width: 50%; background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" fill="rgba(255,255,255,0.05)"><circle cx="20" cy="20" r="5"/><circle cx="50" cy="50" r="8"/><circle cx="80" cy="80" r="5"/></svg>'); }
        .orders-page { display: none; }
        .wishlist-page { display: none; }
        .product-detail-page { display: none; }
        .order-card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: var(--shadow); border: 1px solid var(--border); }
        .wishlist-card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: var(--shadow); border: 1px solid var(--border); display: flex; gap: 15px; align-items: center; }
        .wishlist-image { width: 80px; height: 80px; border-radius: 8px; object-fit: cover; }
        .wishlist-info { flex: 1; }
        .wishlist-actions { display: flex; gap: 10px; }
        .order-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--border); }
        .order-id { font-weight: 700; color: var(--text-dark); }
        .order-status { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .status-delivered { background: var(--success); color: white; }
        .status-pending { background: var(--warning); color: white; }
        .status-cancelled { background: var(--danger); color: white; }
        .status-preparing { background: var(--accent); color: white; }
        .status-dispatched { background: #8B5CF6; color: white; }
        /* âœ… NEW STATUS COLORS ADDED */
        .status-packed { background: #7C3AED; color: white; }
        .status-ready-for-pickup { background: #10B981; color: white; }
        .status-out-for-delivery { background: #3A8EF6; color: white; }
        .order-items { margin-bottom: 12px; }
        .order-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; }
        .order-footer { display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 1px solid var(--border); }
        .order-total { font-weight: 700; font-size: 16px; color: var(--text-dark); }
        .btn-reorder { background: var(--accent); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; }
        .product-card { background: white; border-radius: 16px; padding: 16px; box-shadow: var(--shadow); transition: all 0.3s ease; border: 1px solid var(--border); display: flex; flex-direction: column; height: 100%; position: relative; overflow: hidden; }
        .product-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); }
        .product-badge { position: absolute; top: 12px; left: 12px; background: var(--success); color: white; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .wishlist-btn { position: absolute; top: 12px; right: 12px; background: rgba(255,255,255,0.9); border: none; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; color: var(--text-light); }
        .wishlist-btn:hover { background: white; transform: scale(1.1); }
        .wishlist-btn.active { background: var(--danger); color: white; }
        .product-image { height: 160px; border-radius: 12px; object-fit: cover; width: 100%; background: var(--neutral); margin-bottom: 12px; cursor: pointer; }
        .product-title { font-weight: 700; font-size: 16px; margin-bottom: 6px; color: var(--text-dark); cursor: pointer; }
        .product-category { font-size: 13px; color: var(--text-light); margin-bottom: 10px; }
        .product-price { display: flex; align-items: center; gap: 8px; margin-top: auto; }
        .current-price { font-weight: 800; font-size: 18px; color: var(--accent); }
        .original-price { color: var(--text-light); text-decoration: line-through; font-size: 14px; }
        .discount { color: var(--success); font-size: 13px; font-weight: 600; }
        .card-actions { display: flex; justify-content: center; margin-top: 15px; }
        .btn-add-cart { background: var(--accent); color: white; border: none; padding: 10px 16px; border-radius: 10px; font-weight: 600; width: 100%; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; white-space: nowrap; font-size: 14px; }
        .btn-add-cart:hover { background: var(--accent-hover); transform: scale(1.02); }
        .shop-badge { position: absolute; top: 12px; right: 55px; background: var(--primary); color: white; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 600; }
        .bottom-sheet { position: fixed; left: 0; right: 0; bottom: 0; background: white; border-top-left-radius: 20px; border-top-right-radius: 20px; box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.15); transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.22, 1, 0.36, 1); z-index: 1001; max-height: 85vh; overflow: auto; }
        .bottom-sheet.open { transform: translateY(0); }
        .sheet-handle { width: 60px; height: 5px; background: #E2E8F0; border-radius: 99px; margin: 12px auto; display: block; }
        .sheet-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .sheet-title { font-weight: 700; font-size: 1.3rem; color: var(--text-dark); }
        .sheet-close { background: none; border: none; font-size: 24px; color: var(--text-light); cursor: pointer; }
        .sheet-body { padding: 20px; }
        .coupon-section { margin: 20px 0; padding: 15px; background: var(--neutral); border-radius: 12px; border: 1px solid var(--border); }
        .coupon-input-group { display: flex; gap: 10px; margin-bottom: 10px; }
        .coupon-input { flex: 1; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; }
        .btn-apply-coupon { background: var(--accent); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .btn-apply-coupon:disabled { background: var(--text-light); cursor: not-allowed; }
        .coupon-login-required { color: var(--warning); font-size: 14px; margin-top: 8px; text-align: center; }
        .coupon-success { color: var(--success); font-size: 14px; font-weight: 600; margin-top: 8px; }
        .coupon-error { color: var(--danger); font-size: 14px; margin-top: 8px; }
        .phone-valid { border-color: var(--success) !important; }
        .phone-invalid { border-color: var(--danger) !important; }
        .validation-message { font-size: 12px; margin-top: 4px; }
        .validation-success { color: var(--success); }
        .validation-error { color: var(--danger); }
        .order-item-summary { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border); }
        .discount-row { display: flex; justify-content: space-between; padding: 8px 0; color: var(--success); font-weight: 600; }
        .order-total-summary { display: flex; justify-content: space-between; padding: 15px 0; margin-top: 10px; border-top: 2px solid var(--border); font-weight: 800; font-size: 18px; }
        .payment-methods { margin: 20px 0; }
        .payment-option { display: flex; align-items: center; gap: 12px; padding: 15px; border: 2px solid var(--border); border-radius: 10px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s ease; }
        .payment-option.selected { border-color: var(--accent); background: rgba(58, 142, 246, 0.05); }
        .payment-icon { width: 40px; height: 40px; background: var(--neutral); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .payment-info { flex: 1; }
        .payment-title { font-weight: 600; margin-bottom: 4px; }
        .payment-desc { font-size: 12px; color: var(--text-light); }
        .qr-modal { text-align: center; padding: 20px; position: relative; }
        .qr-code { width: 100%; max-width: 280px; margin: 20px auto; padding: 20px; background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 2px solid #f1f3f4; }
        .qr-code-content { display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .qr-image-container { width: 200px; height: 200px; border-radius: 12px; overflow: hidden; border: 2px solid #34A853; background: white; }
        .qr-image-container img { width: 100%; height: 100%; object-fit: contain; }
        .upi-details { background: #f8f9fa; padding: 12px; border-radius: 10px; width: 100%; text-align: center; }
        .utr-input { margin: 15px 0; }
        .utr-input .form-control { margin-top: 8px; }
        .empty-state { text-align: center; padding: 40px 20px; }
        .empty-icon { font-size: 60px; color: var(--border); margin-bottom: 15px; }
        .empty-text { color: var(--text-light); font-size: 16px; }
        .auth-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); padding: 20px; }
        .auth-card { background: white; border-radius: 20px; padding: 40px; box-shadow: var(--shadow-lg); width: 100%; max-width: 450px; }
        .auth-header { text-align: center; margin-bottom: 30px; }
        .auth-logo { width: 60px; height: 60px; background: var(--accent); border-radius: 15px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.5rem; color: white; margin: 0 auto 15px; }
        .auth-title { font-size: 1.8rem; font-weight: 700; color: var(--text-dark); margin-bottom: 8px; }
        .auth-subtitle { color: var(--text-light); font-size: 1rem; }
        .form-group { margin-bottom: 20px; }
        .form-label { font-weight: 600; margin-bottom: 8px; color: var(--text-dark); display: block; }
        .form-control { width: 100%; padding: 12px 16px; border: 1px solid var(--border); border-radius: 10px; font-size: 15px; transition: all 0.2s; }
        .form-control:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(58, 142, 246, 0.1); }
        .auth-footer { text-align: center; margin-top: 25px; color: var(--text-light); }
        .auth-link { color: var(--accent); text-decoration: none; font-weight: 600; }
        .auth-link:hover { text-decoration: underline; }
        .address-grid { display: grid; gap: 12px; margin-bottom: 15px; }
        .address-card { padding: 15px; border: 2px solid var(--border); border-radius: 10px; cursor: pointer; transition: all 0.3s ease; }
        .address-card.selected { border-color: var(--accent); background: rgba(58, 142, 246, 0.05); }
        .address-title { font-weight: 600; margin-bottom: 5px; }
        .address-details { color: var(--text-light); font-size: 14px; margin-bottom: 5px; }
        .address-phone { font-size: 12px; color: var(--text-light); }
        .address-form { background: var(--neutral); padding: 20px; border-radius: 12px; margin-top: 15px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        /* âœ… UPDATED ORDER TIMELINE WITH MORE STEPS */
        .order-timeline {
            display: flex;
            justify-content: space-between;
            position: relative;
            margin: 20px 0;
            padding: 0 10px;
        }
        .order-timeline::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 5%;
            right: 5%;
            height: 3px;
            background: var(--border);
            z-index: 1;
        }
        .timeline-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
            flex: 1;
        }
        .step-icon {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }
        .step-icon.active {
            background: var(--accent);
            color: white;
        }
        .step-icon.completed {
            background: var(--success);
            color: white;
        }
        .step-label {
            font-size: 11px;
            text-align: center;
            color: var(--text-light);
            font-weight: 500;
            line-height: 1.2;
        }
        .step-label.active {
            color: var(--accent);
            font-weight: 600;
        }
        .step-label.completed {
            color: var(--success);
            font-weight: 600;
        }
        .step-time {
            font-size: 9px;
            color: var(--text-light);
            margin-top: 2px;
            text-align: center;
            line-height: 1.2;
        }
        /* Product Detail Page Styles */
        .product-detail-container {
            background: white;
            border-radius: 20px;
            padding: 0;
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        .product-detail-image {
            width: 100%;
            height: 400px;
            object-fit: cover;
        }
        .product-detail-content {
            padding: 30px;
        }
        .product-detail-header {
            margin-bottom: 20px;
        }
        .product-detail-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        .product-detail-category {
            color: var(--text-light);
            font-size: 1rem;
            margin-bottom: 15px;
        }
        .product-detail-price {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        .product-detail-current {
            font-size: 2rem;
            font-weight: 800;
            color: var(--accent);
        }
        .product-detail-original {
            font-size: 1.5rem;
            color: var(--text-light);
            text-decoration: line-through;
        }
        .product-detail-discount {
            background: var(--success);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
        }
        .product-detail-actions {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }
        .btn-quantity {
            display: flex;
            align-items: center;
            gap: 15px;
            background: var(--neutral);
            padding: 10px 15px;
            border-radius: 10px;
        }
        .quantity-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--accent);
        }
        .quantity-value {
            font-weight: 600;
            min-width: 30px;
            text-align: center;
        }
        /* Reviews Section Styles */
        .reviews-section {
            margin-top: 40px;
            padding: 30px;
            background: white;
            border-radius: 20px;
            box-shadow: var(--shadow);
        }
        .rating-summary {
            display: flex;
            align-items: center;
            gap: 40px;
            margin-bottom: 30px;
            padding-bottom: 30px;
            border-bottom: 2px solid var(--border);
        }
        .average-rating {
            text-align: center;
        }
        .rating-stars {
            display: flex;
            gap: 2px;
            margin-bottom: 10px;
            justify-content: center;
        }
        .rating-star {
            color: #ddd;
            font-size: 24px;
        }
        .rating-star.filled {
            color: #FFB800;
        }
        .rating-value {
            font-size: 3rem;
            font-weight: 700;
            color: var(--text-dark);
            line-height: 1;
        }
        .rating-count {
            color: var(--text-light);
            font-size: 16px;
        }
        .rating-distribution {
            flex: 1;
        }
        .rating-bar {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 12px;
        }
        .bar-label {
            width: 80px;
            font-size: 14px;
            color: var(--text-light);
        }
        .bar-container {
            flex: 1;
            height: 10px;
            background: #f0f0f0;
            border-radius: 5px;
            overflow: hidden;
        }
        .bar-fill {
            height: 100%;
            background: #FFB800;
            border-radius: 5px;
            transition: width 0.3s ease;
        }
        .bar-count {
            width: 40px;
            text-align: right;
            font-size: 14px;
            color: var(--text-light);
        }
        .reviews-list {
            margin-bottom: 30px;
        }
        .review-card {
            padding: 20px;
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 20px;
            background: var(--neutral);
        }
        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        .review-user {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 18px;
        }
        .user-info h5 {
            margin: 0;
            font-size: 16px;
            margin-bottom: 5px;
        }
        .verified-badge {
            background: var(--success);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        .review-rating {
            display: flex;
            gap: 2px;
        }
        .review-star {
            color: #FFB800;
            font-size: 16px;
        }
        .review-date {
            color: var(--text-light);
            font-size: 14px;
        }
        .review-content {
            color: var(--text-dark);
            line-height: 1.6;
            font-size: 15px;
        }
        .review-form-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            border: 2px solid var(--border);
        }
        .review-form-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-dark);
        }
        .star-rating-input {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }
        .star-input {
            background: none;
            border: none;
            font-size: 28px;
            color: #ddd;
            cursor: pointer;
            transition: all 0.2s;
            padding: 5px;
        }
        .star-input:hover,
        .star-input.active {
            color: #FFB800;
            transform: scale(1.1);
        }
        .review-textarea {
            width: 100%;
            padding: 15px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 15px;
            resize: vertical;
            min-height: 120px;
            margin-bottom: 15px;
            transition: all 0.2s;
        }
        .review-textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(58, 142, 246, 0.1);
        }
        .review-requirements {
            background: var(--neutral);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .requirements-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-dark);
        }
        .requirements-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .requirements-list li {
            padding: 5px 0;
            color: var(--text-light);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .requirements-list li i {
            color: var(--success);
            font-size: 12px;
        }
        .no-reviews {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-light);
        }
        .no-reviews-icon {
            font-size: 60px;
            margin-bottom: 15px;
            color: var(--border);
        }
        /* User Profile Styles */
        .profile-page { display: none; }
        .profile-header { 
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 30px 20px;
            text-align: center;
            border-radius: 20px;
            margin-bottom: 30px;
            position: relative;
        }
        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 2.5rem;
            font-weight: bold;
            color: white;
            border: 4px solid white;
            position: relative;
            overflow: hidden;
        }
        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .avatar-upload {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: var(--accent);
            border: 2px solid white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            font-size: 14px;
        }
        .profile-name {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        .profile-email {
            opacity: 0.9;
            font-size: 1rem;
        }
        .profile-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }
        .section-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .profile-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .profile-menu-item {
            padding: 15px 0;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .profile-menu-item:last-child {
            border-bottom: none;
        }
        .profile-menu-item:hover {
            background: var(--neutral);
            margin: 0 -20px;
            padding: 15px 20px;
        }
        .menu-item-content {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }
        .menu-item-icon {
            width: 40px;
            height: 40px;
            background: var(--neutral);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent);
            font-size: 1.2rem;
        }
        .menu-item-text {
            flex: 1;
        }
        .menu-item-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-dark);
        }
        .menu-item-desc {
            font-size: 0.9rem;
            color: var(--text-light);
        }
        .menu-item-arrow {
            color: var(--text-light);
        }
        .security-badge {
            background: var(--success);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .login-session {
            padding: 15px;
            border: 1px solid var(--border);
            border-radius: 10px;
            margin-bottom: 10px;
            background: var(--neutral);
        }
        .session-active {
            border-left: 4px solid var(--success);
        }
        .session-inactive {
            border-left: 4px solid var(--text-light);
        }
        .preference-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border);
        }
        .preference-item:last-child {
            border-bottom: none;
        }
        .preference-info {
            flex: 1;
        }
        .preference-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        .preference-desc {
            font-size: 0.9rem;
            color: var(--text-light);
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--accent);
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        /* Enhanced Search Styles */
        .search-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9998;
            display: none;
        }
        .search-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: white;
            z-index: 9999;
            border-radius: 0 0 20px 20px;
            box-shadow: var(--shadow-lg);
            display: none;
        }
        .search-modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .search-modal-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            outline: none;
        }
        .search-modal-input:focus {
            border-color: var(--accent);
        }
        .search-modal-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: var(--text-light);
            cursor: pointer;
        }
        .search-modal-body {
            max-height: 60vh;
            overflow-y: auto;
            padding: 20px;
        }
        .search-section {
            margin-bottom: 25px;
        }
        .search-section-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .clear-recent {
            background: none;
            border: none;
            color: var(--accent);
            font-size: 0.9rem;
            cursor: pointer;
        }
        .recent-searches {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .recent-search-item {
            background: var(--neutral);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid var(--border);
        }
        .recent-search-item:hover {
            background: var(--accent);
            color: white;
        }
        .popular-searches {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .popular-search-item {
            background: white;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .popular-search-item:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }
        .search-suggestions {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .search-suggestion-item {
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .search-suggestion-item:last-child {
            border-bottom: none;
        }
        .search-suggestion-item:hover {
            background: var(--neutral);
            margin: 0 -20px;
            padding: 12px 20px;
        }
        .suggestion-icon {
            color: var(--text-light);
            font-size: 1rem;
        }
        .advanced-filters {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-top: 15px;
            box-shadow: var(--shadow);
        }
        .filter-group {
            margin-bottom: 20px;
        }
        .filter-title {
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-dark);
        }
        .price-range {
            padding: 0 10px;
        }
        .price-inputs {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .price-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
        }
        .rating-filters {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .rating-filter-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            cursor: pointer;
        }
        .rating-stars-small {
            display: flex;
            gap: 2px;
        }
        .rating-star-small {
            color: #FFB800;
            font-size: 14px;
        }
        .shop-filters {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .shop-filter-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .shop-filter-item:hover {
            border-color: var(--accent);
        }
        .shop-filter-item.selected {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        .filter-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        /* Sorting Styles */
        .sorting-options {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        .sort-label {
            font-weight: 600;
            color: var(--text-dark);
            white-space: nowrap;
        }
        .sort-select {
            padding: 10px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            background: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 160px;
        }
        .sort-select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(58, 142, 246, 0.1);
        }
        .sort-select:hover {
            border-color: var(--accent);
        }
        .sort-badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .sort-badge {
            padding: 8px 16px;
            background: var(--neutral);
            border: 2px solid var(--border);
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        .sort-badge:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }
        .sort-badge.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        /* ORDER ENHANCEMENTS CSS */
        .order-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .order-actions button {
            font-size: 12px;
            padding: 6px 12px;
        }
        .delivery-agent-info {
            border-left: 4px solid var(--accent);
        }
        .eta-section {
            border-left: 4px solid var(--success);
        }
        .order-tracking-details p {
            margin-bottom: 8px;
        }
        /* Notifications Page */
        .notifications-page { display: none; }
        .notification-item { 
            padding: 15px; 
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 12px;
        }
        .notification-unread { background: rgba(58, 142, 246, 0.05); }
        .quantity-cart-container {
            display: flex;
            gap: 15px;
            align-items: center;
            width: 100%;
        }
        .btn-add-cart-detail {
            flex: 1;
            min-width: 200px;
        }
        .product-detail-actions {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        /* HIDE ALL BADGES IN HAMBURGER MENU */
        #hamburgerMenu .nav-badge {
            display: none !important;
        }
        .quantity-cart-container {
            display: flex;
            gap: 15px;
            align-items: center;
            flex: 1;
        }
        .btn-quantity {
            display: flex;
            align-items: center;
            gap: 15px;
            background: var(--neutral);
            padding: 10px 15px;
            border-radius: 10px;
            border: 1px solid var(--border);
        }
        .product-detail-actions {
            display: flex;
            gap: 15px;
            align-items: center;
            width: 100%;
        }
        .btn-add-cart-detail {
            flex: 1;
            min-width: 160px;
        }
        /* FINAL FIX - QUANTITY & CART LAYOUT */
        .quantity-cart-container {
            display: flex;
            align-items: center;
            gap: 15px;
            width: 100%;
        }
        .btn-quantity {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--neutral);
            padding: 10px 15px;
            border-radius: 10px;
            border: 1px solid var(--border);
        }
        .btn-add-cart-detail {
            flex: 1;
        }
        .product-detail-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        /* HIDE ALL BADGES IN HAMBURGER MENU */
        #hamburgerMenu .nav-badge {
            display: none !important;
        }
        /* Bottom nav badge proper position fix */
        .bottom-nav .nav-item {
            position: relative;
        }
        .bottom-nav .nav-badge {
            position: absolute;
            top: -6px;
            left: 50%;
            right: auto;
            transform: translateX(4px);
            background: var(--accent);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 700;
            min-width: 18px;
            text-align: center;
        }
        /* FINAL QUANTITY FIX */
        .product-detail-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .quantity-cart-container {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }
        #hamburgerWishlistCount {
            display: none !important;
        }
        /* DEBUG - COLOR CODE BADGES */
        #bottomCartCount { background: red !important; }
        #hamburgerWishlistCount { background: blue !important; }
        /* HIDE WISHLIST BADGE IN HAMBURGER MENU */
        #hamburgerWishlistCount {
            display: none !important;
        }
        /* HIDE ALL BADGES IN HAMBURGER MENU */
        #hamburgerMenu .nav-badge {
            display: none !important;
        }
        /* FIX QUANTITY LAYOUT */
        .quantity-cart-container {
            display: flex !important;
            flex-direction: row !important;
            align-items: center !important;
            gap: 15px !important;
            width: 100% !important;
        }
        .btn-quantity {
            display: flex !important;
            flex-direction: row !important;
            align-items: center !important;
            gap: 10px !important;
            white-space: nowrap !important;
        }
        /* REMOVE BADGE FROM HAMBURGER MENU ITEMS */
        #hamburgerMenu .nav-badge,
        .nav-item[onclick*="openHamburgerMenu"] .nav-badge {
            display: none !important;
        }
        /* KEEP BADGES FOR OTHER NAV ITEMS */
        .nav-item[data-page] .nav-badge {
            display: block; /* This keeps badges for Home, Orders, Account, Cart */
        }
        .delivery-options {
            margin: 10px 0;
        }
        .delivery-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            border: 2px solid var(--border);
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .delivery-option.selected {
            border-color: var(--accent);
            background: rgba(58, 142, 246, 0.05);
        }
        .delivery-option:hover {
            border-color: var(--accent);
        }
        /* SOCIAL SHARE STYLES */
        .btn-outline:hover {
            background: var(--accent);
            color: white;
        }
        .share-options-modal {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: var(--shadow-lg);
            max-width: 300px;
            margin: 20px auto;
        }
        .share-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .btn-share {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-share.whatsapp {
            background: #25D366;
            color: white;
        }
        .btn-share.copy {
            background: var(--accent);
            color: white;
        }
        /* Modal Overlay - Fixed Position */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.12);
            position: relative;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-dark);
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-light);
            cursor: pointer;
        }
        .modal-body {
            margin-bottom: 20px;
        }
        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }
        /* ðŸŽ¯ MOBILE LAYOUT FIXES */
        @media (max-width: 768px) {
            /* Better product grid - 2 products with proper spacing */
            .product-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 12px !important;
                padding: 0 8px !important;
            }
            
            /* Better product card proportions */
            .product-card {
                padding: 12px !important;
                border-radius: 12px !important;
                min-height: 280px !important;
                display: flex !important;
                flex-direction: column !important;
            }
            
            /* Optimized product image */
            .product-image {
                height: 120px !important;
                border-radius: 8px !important;
                margin-bottom: 8px !important;
            }
            
            /* Better text sizing */
            .product-title {
                font-size: 14px !important;
                line-height: 1.3 !important;
                margin-bottom: 4px !important;
                display: -webkit-box !important;
                -webkit-line-clamp: 2 !important;
                -webkit-box-orient: vertical !important;
                overflow: hidden !important;
            }
            
            .product-category {
                font-size: 11px !important;
                margin-bottom: 8px !important;
            }
            
            /* Better price layout */
            .product-price {
                margin-top: auto !important;
                padding-top: 8px !important;
            }
            
            .current-price {
                font-size: 16px !important;
            }
            
            .original-price {
                font-size: 12px !important;
            }
            
            .discount {
                font-size: 11px !important;
            }
            
            /* Better button sizing */
            .btn-add-cart {
                padding: 8px 12px !important;
                font-size: 12px !important;
                border-radius: 8px !important;
            }
            
            /* Badge optimization */
            .product-badge {
                font-size: 10px !important;
                padding: 3px 8px !important;
                top: 8px !important;
                left: 8px !important;
            }
            
            .shop-badge {
                font-size: 9px !important;
                padding: 2px 6px !important;
                top: 8px !important;
                right: 8px !important;
            }
            
            .wishlist-btn {
                position: absolute !important;
                bottom: 60px !important;
                right: 12px !important;
                top: auto !important;
                width: 32px !important;
                height: 32px !important;
                background: rgba(255,255,255,0.9) !important;
                border: none !important;
                border-radius: 50% !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                cursor: pointer !important;
                transition: all 0.3s ease !important;
                color: var(--text-light) !important;
                z-index: 3 !important;
            }
            
            .wishlist-btn:hover {
                background: white !important;
                transform: scale(1.1) !important;
            }
            
            .wishlist-btn.active {
                background: var(--danger) !important;
                color: white !important;
            }
            
            /* Mobile adjustment */
            @media (max-width: 768px) {
                .wishlist-btn {
                    bottom: 50px !important;
                    right: 8px !important;
                    width: 28px !important;
                    height: 28px !important;
                }
            }
            
            /* Header optimization */
            .header-container { 
                flex-direction: column; 
                gap: 12px; 
                position: relative;
            }
            
            .search-container { 
                margin: 0 auto; 
                width: 100%; 
                max-width: 500px;
            }
            
            /* Container optimization */
            .container-main {
                margin: 16px auto !important;
                padding: 0 8px !important;
            }
            
            /* Container optimization */
            .container-main {
                margin: 16px auto !important;
                padding: 0 8px !important;
            }
            
            /* Hero section optimization */
            .hero-banner {
                padding: 20px 16px !important;
                margin-bottom: 20px !important;
                border-radius: 16px !important;
            }
            
            .hero-content { 
                max-width: 100%; 
            }
            
            .hero-title { 
                font-size: 1.5rem !important;
                margin-bottom: 10px !important;
            }
            
            .hero-subtitle {
                font-size: 0.9rem !important;
                margin-bottom: 15px !important;
            }
            
            /* Filter section optimization */
            .filter-section > div {
                flex-direction: column !important;
                gap: 12px !important;
            }
            
            .filter-section .d-flex {
                width: 100% !important;
                justify-content: space-between !important;
                margin-bottom: 15px !important;
            }
            
            .category-filter {
                flex: 1 !important;
                margin: 0 4px !important;
            }
            
            .sorting-options {
                width: 100% !important;
                justify-content: space-between !important;
            }
            
            .sort-select {
                min-width: 140px !important;
            }
            
            /* Auth optimization */
            .auth-card { 
                padding: 30px 25px; 
            }
            
            .form-row { 
                grid-template-columns: 1fr; 
            }
            
            /* Wishlist optimization */
            .wishlist-card { 
                flex-direction: column; 
                text-align: center; 
            }
            
            .wishlist-actions { 
                justify-content: center; 
            }
            
            /* Reviews optimization */
            .rating-summary { 
                flex-direction: column; 
                gap: 20px; 
                text-align: center; 
            }
            
            /* Product detail optimization */
            .product-detail-actions { 
                flex-direction: column; 
            }
            
            .product-detail-image { 
                height: 300px; 
            }
            
            /* Order actions */
            .order-actions {
                justify-content: center;
            }
            
            .order-actions button {
                flex: 1;
                min-width: 80px;
            }
            
            /* Enhanced Search Mobile Styles */
            .search-modal-body {
                max-height: 70vh;
            }
            
            .popular-searches {
                grid-template-columns: 1fr;
            }
            
            .shop-filters {
                grid-template-columns: 1fr;
            }
            
            .recent-searches {
                flex-direction: column;
            }
            
            .recent-search-item {
                text-align: center;
            }
            
            /* âœ… MOBILE ORDER TRACKING FIX */
            .order-timeline {
                padding: 0 5px !important;
            }
            
            .step-label {
                font-size: 9px !important;
            }
            
            .step-time {
                font-size: 8px !important;
            }
            
            .step-icon {
                width: 30px !important;
                height: 30px !important;
                font-size: 12px !important;
            }
        }
        /* Header Layout Fix */
        .app-header .header-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            position: relative;
        }
        .app-header .search-container {
            flex: 1;
            max-width: 500px;
            margin: 0 auto;
            position: relative;
        }
        .app-header .header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: auto;
        }
        /* Center search bar on desktop */
        @media (min-width: 769px) {
            .app-header .header-container {
                position: relative;
            }
            
            .app-header .search-container {
                position: absolute;
                left: 50%;
                transform: translateX(-50%);
                width: 400px;
            }
            
            .app-header .header-actions {
                margin-left: auto;
            }
        }
        /* Mobile responsive */
        @media (max-width: 768px) {
            .app-header .header-container {
                flex-direction: column;
                gap: 12px;
            }
            
            .app-header .search-container {
                order: 2;
                width: 100%;
                max-width: none;
            }
            
            .app-header .header-actions {
                order: 3;
                width: 100%;
                justify-content: flex-end;
            }
        }
        /* Logout option styling */
        .preference-item[style*="color: var(--danger)"] {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .preference-item[style*="color: var(--danger)"]:hover {
            background: #FEE2E2;
            border-radius: 8px;
            padding: 12px;
            margin: -12px -12px -12px -12px;
        }
        /* ðŸŽ¯ EXTRA SMALL DEVICES */
        @media (max-width: 480px) {
            .product-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 8px !important;
                padding: 0 4px !important;
            }
            
            .product-card {
                padding: 10px !important;
                min-height: 260px !important;
            }
            
            .product-image {
                height: 110px !important;
            }
            
            .product-title {
                font-size: 13px !important;
            }
            
            .current-price {
                font-size: 15px !important;
            }
            
            .container-main { 
                padding: 0 12px; 
            }
            
            .hero-banner { 
                padding: 20px; 
            }
            
            .product-detail-content { 
                padding: 20px; 
            }
            
            .reviews-section { 
                padding: 20px; 
            }
            
            /* âœ… EXTRA SMALL ORDER TRACKING */
            .order-timeline {
                padding: 0 2px !important;
            }
            
            .step-label {
                font-size: 8px !important;
            }
            
            .step-time {
                font-size: 7px !important;
            }
            
            .step-icon {
                width: 25px !important;
                height: 25px !important;
                font-size: 10px !important;
            }
        }
        /* ðŸŽ¯ TABLET OPTIMIZATION */
        @media (min-width: 769px) and (max-width: 1024px) {
            .product-grid {
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 16px !important;
            }
        }
        /* Desktop remains unchanged */
        @media (min-width: 769px) {
            .product-grid {
                grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
                gap: 20px;
            }
        }
        
        /* âœ… FIX: ORDER STATUS BADGES */
        .orders-count-badge {
            position: absolute;
            top: -8px;
            right: 10px;
            background: var(--danger);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 700;
            min-width: 18px;
            text-align: center;
        }
        
        /* Order status specific colors */
        .status-preparing { background: #F59E0B; color: white; }
        .status-dispatched { background: #8B5CF6; color: white; }
        .status-packed { background: #7C3AED; color: white; }
        .status-ready-for-pickup { background: #10B981; color: white; }
        .status-out-for-delivery { background: #3A8EF6; color: white; }
        
        /* Real-time update notification */
        .order-update-notification {
            position: fixed;
            top: 70px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            box-shadow: var(--shadow-lg);
            z-index: 9999;
            display: none;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Login/Signup Screen -->
    <div id="authScreen">
        <div class="auth-container">
            <div class="auth-card">
                <div class="auth-header">
                    <div class="auth-logo">R</div>
                    <h1 class="auth-title">Welcome to Raashanmart</h1>
                    <p class="auth-subtitle">Sign in to your account</p>
                </div>
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="loginEmail" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" id="loginPassword" placeholder="Enter your password" required>
                    </div>
                    <button type="submit" class="btn-primary w-100" style="padding: 12px;">Sign In</button>
                    <div class="forgot-password">
                 <a href="#" onclick="showForgotPassword()">Forgot Password?</a>
                    </div>
                </form>
                <form id="signupForm" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="signupName" placeholder="Enter your full name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="signupEmail" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" id="signupPassword" placeholder="Create a password" required>
                    </div>
                    <button type="submit" class="btn-primary w-100" style="padding: 12px;">Create Account</button>
                </form>
                <div class="auth-footer">
                    <p id="loginFooter">Don't have an account? <a href="#" class="auth-link" id="showSignup">Sign up</a></p>
                    <p id="signupFooter" style="display: none;">Already have an account? <a href="#" class="auth-link" id="showLogin">Sign in</a></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App Screen -->
    <div id="appScreen" style="display: none;">
        <header class="app-header">
            <div class="header-container">
                <a href="#" class="brand">
                    <div class="brand-logo">R</div>
                    <span>Raashanmart</span>
                </a>
                <div class="search-container">
                    <input type="text" id="search" class="search-bar" placeholder="Search for products, categories...">
                    <div class="search-icon"><i class="fas fa-search"></i></div>
                    <div class="search-results" id="searchResults"></div>
                </div>
                <div class="header-actions">
                </div>
            </div>
        </header>
        
        <!-- Real-time order update notification -->
        <div id="orderUpdateNotification" class="order-update-notification">
            <i class="fas fa-bell"></i> Order status updated!
        </div>
        
        <div class="container-main">
            <div id="homePage">
                <div class="hero-banner">
                    <div class="hero-content">
                        <div class="hero-badge">
                            <i class="fas fa-bolt"></i>
                            <span>Fast Delivery â€¢ Best Prices</span>
                        </div>
                        <h1 class="hero-title">Groceries Delivered to Your Doorstep</h1>
                        <p class="hero-subtitle">Fresh products, competitive prices, and quick delivery</p>
                        <button class="btn-primary">Shop Now</button>
                    </div>
                    <div class="hero-pattern"></div>
                </div>
                
                <!-- Enhanced Search Modal -->
                <div id="searchOverlay" class="search-overlay"></div>
                <div id="searchModal" class="search-modal">
                    <div class="search-modal-header">
                        <div style="position: relative; flex: 1;">
                            <input type="text" id="enhancedSearchInput" class="search-modal-input" placeholder="Search for products, shops, categories...">
                            <div id="searchSuggestions" class="search-results" style="display: none;"></div>
                        </div>
                        <button class="search-modal-close" onclick="closeEnhancedSearch()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="search-modal-body">
                        <!-- Recent Searches -->
                        <div class="search-section" id="recentSearchesSection">
                            <div class="search-section-title">
                                <span>Recent Searches</span>
                                <button class="clear-recent" onclick="clearRecentSearches()">Clear all</button>
                            </div>
                            <div class="recent-searches" id="recentSearchesList">
                                <!-- Recent searches will be populated here -->
                            </div>
                        </div>

                        <!-- Popular Searches -->
                        <div class="search-section">
                            <div class="search-section-title">
                                <span>Popular Searches</span>
                            </div>
                            <div class="popular-searches" id="popularSearchesList">
                                <!-- Popular searches will be populated here -->
                            </div>
                        </div>

                        <!-- Search Suggestions -->
                        <div class="search-section" id="searchSuggestionsSection" style="display: none;">
                            <div class="search-section-title">
                                <span>Suggestions</span>
                            </div>
                            <ul class="search-suggestions" id="searchSuggestionsList">
                                <!-- Search suggestions will be populated here -->
                            </ul>
                        </div>

                        <!-- Advanced Filters -->
                        <div class="advanced-filters" id="advancedFilters">
                            <div class="filter-group">
                                <div class="filter-title">Price Range</div>
                                <div class="price-range">
                                    <input type="range" id="priceRange" min="0" max="5000" value="5000" class="form-range">
                                    <div class="price-inputs">
                                        <input type="number" id="minPrice" class="price-input" placeholder="Min" value="0">
                                        <input type="number" id="maxPrice" class="price-input" placeholder="Max" value="5000">
                                    </div>
                                </div>
                            </div>

                            <div class="filter-group">
                                <div class="filter-title">Customer Rating</div>
                                <div class="rating-filters">
                                    <label class="rating-filter-item">
                                        <input type="checkbox" class="rating-filter" value="4">
                                        <div class="rating-stars-small">
                                            <i class="fas fa-star rating-star-small"></i>
                                            <i class="fas fa-star rating-star-small"></i>
                                            <i class="fas fa-star rating-star-small"></i>
                                            <i class="fas fa-star rating-star-small"></i>
                                            <i class="fas fa-star rating-star-small"></i>
                                        </div>
                                        <span>4+ Stars</span>
                                    </label>
                                    <label class="rating-filter-item">
                                        <input type="checkbox" class="rating-filter" value="3">
                                        <div class="rating-stars-small">
                                            <i class="fas fa-star rating-star-small"></i>
                                            <i class="fas fa-star rating-star-small"></i>
                                            <i class="fas fa-star rating-star-small"></i>
                                            <i class="fas fa-star rating-star-small"></i>
                                            <i class="far fa-star rating-star-small"></i>
                                        </div>
                                        <span>3+ Stars</span>
                                    </label>
                                </div>
                            </div>

                            <div class="filter-group">
                                <div class="filter-title">Shops</div>
                                <div class="shop-filters" id="shopFiltersList">
                                    <!-- Shop filters will be populated here -->
                                </div>
                            </div>

                            <div class="filter-actions">
                                <button class="btn-outline" onclick="resetFilters()" style="flex: 1;">
                                    <i class="fas fa-refresh"></i> Reset
                                </button>
                                <button class="btn-primary" onclick="applyAdvancedFilters()" style="flex: 1;">
                                    <i class="fas fa-check"></i> Apply
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="filter-section mb-4">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                        <!-- LEFT SIDE - Filters -->
                        <div class="d-flex gap-3 flex-wrap" style="flex: 1;">
                            <select id="shopFilter" class="category-filter">
                                <option value="">All Shops</option>
                                <option value="freshmart">FreshMart</option>
                                <option value="cosmeticstore">CosmeticStore</option>
                                <option value="fashionhub">FashionHub</option>
                                <option value="veggieking">VeggieKing</option>
                                <option value="gadgetzone">GadgetZone</option>
                            </select>
                            <select id="categoryFilter" class="category-filter">
                                <option value="">All Categories</option>
                                <option value="groceries">Groceries</option>
                                <option value="cosmetics">Cosmetics</option>
                                <option value="clothing">Clothing</option>
                                <option value="vegetables">Vegetables</option>
                                <option value="electronics">Electronics</option>
                            </select>
                        </div>
                        
                        <!-- RIGHT SIDE - Sorting -->
                        <div class="sorting-options" style="margin: 0;">
                            <span class="sort-label">Sort by:</span>
                            <select id="sortSelect" class="sort-select">
                                <option value="newest">ðŸ†• Newest</option>
                                <option value="price_high_low">ðŸ”¼ High to Low</option>
                                <option value="price_low_high">ðŸ”½ Low to High</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div id="grid" class="product-grid"></div>
                
                <div id="empty" class="empty-state" style="display:none">
                    <div class="empty-icon"><i class="fas fa-search"></i></div>
                    <h3 class="empty-text">No products found</h3>
                    <p class="text-muted">Try changing your search or filter</p>
                </div>
            </div>

            <div id="ordersPage" class="orders-page">
                <h2 class="section-title">Your Orders
                    <span id="ordersBadge" class="orders-count-badge" style="display: none;">0</span>
                </h2>
                <div id="ordersList"></div>
                <div id="noOrders" class="empty-state">
                    <div class="empty-icon"><i class="fas fa-shopping-bag"></i></div>
                    <h3 class="empty-text">No orders yet</h3>
                    <p class="text-muted">Start shopping to see your orders here</p>
                </div>
            </div>

            <div id="wishlistPage" class="wishlist-page">
                <h2 class="section-title">Your Wishlist</h2>
                <div id="wishlistItems"></div>
                <div id="noWishlist" class="empty-state">
                    <div class="empty-icon"><i class="fas fa-heart"></i></div>
                    <h3 class="empty-text">Your wishlist is empty</h3>
                    <p class="text-muted">Start adding products you love</p>
                </div>
            </div>

            <!-- Product Detail Page -->
            <div id="productDetailPage" class="product-detail-page">
                <div class="product-detail-container">
                    <img id="productDetailImage" src="" alt="" class="product-detail-image">
                    <div class="product-detail-content">
                        <div class="product-detail-header">
                            <h1 id="productDetailTitle" class="product-detail-title"></h1>
                            <p id="productDetailCategory" class="product-detail-category"></p>
                            <div class="product-detail-price">
                                <span id="productDetailCurrent" class="product-detail-current"></span>
                                <span id="productDetailOriginal" class="product-detail-original"></span>
                                <span id="productDetailDiscount" class="product-detail-discount"></span>
                            </div>
                        </div>
                        
                        <!-- CORRECTED PRODUCT DETAIL ACTIONS - NO DUPLICATES -->
                        <div class="product-detail-actions">
                            <div class="quantity-cart-container">
                                <div class="btn-quantity">
                                    <button class="quantity-btn" onclick="changeQuantity(-1)">-</button>
                                    <span id="quantityValue" class="quantity-value">1</span>
                                    <button class="quantity-btn" onclick="changeQuantity(1)">+</button>
                                </div>
                                <button class="btn-primary btn-add-cart-detail" onclick="addToCartFromDetail()">
                                    <i class="fas fa-shopping-cart"></i> Add to Cart
                                </button>
                            </div>
                            
                            <!-- SHARE BUTTON -->
                            <button class="btn-outline" onclick="shareProduct(currentProductDetail.id)" 
                                    style="padding: 10px 15px; border-radius: 10px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-share-alt"></i> Share
                            </button>
                            
                            <button id="wishlistDetailBtn" class="wishlist-btn" onclick="toggleWishlistFromDetail()">
                                <i class="fas fa-heart"></i>
                            </button>
                        </div>
                        
                        <!-- Reviews Section -->
                        <div class="reviews-section">
                            <h3 class="section-title">Customer Reviews</h3>
                            
                            <div class="rating-summary">
                                <div class="average-rating">
                                    <div class="rating-stars" id="averageRatingStars"></div>
                                    <div id="averageRatingValue" class="rating-value">0.0</div>
                                    <div id="totalReviewsCount" class="rating-count">0 reviews</div>
                                </div>
                                <div class="rating-distribution">
                                    <!-- Rating bars will be populated by JavaScript -->
                                </div>
                            </div>

                            <div class="reviews-list" id="reviewsList">
                                <!-- Reviews will be populated by JavaScript -->
                            </div>

                            <!-- Review Form -->
                            <div class="review-form-section" id="reviewFormSection" style="display: none;">
                                <h4 class="review-form-title">Write a Review</h4>
                                <div class="review-requirements">
                                    <div class="requirements-title">Review Requirements:</div>
                                    <ul class="requirements-list">
                                        <li><i class="fas fa-check"></i> Must be a registered user</li>
                                        <li><i class="fas fa-check"></i> Must have purchased this product</li>
                                        <li><i class="fas fa-check"></i> Order must be delivered</li>
                                        <li><i class="fas fa-check"></i> One review per product</li>
                                    </ul>
                                </div>
                                <div class="star-rating-input">
                                    <button class="star-input" data-rating="1">â˜…</button>
                                    <button class="star-input" data-rating="2">â˜…</button>
                                    <button class="star-input" data-rating="3">â˜…</button>
                                    <button class="star-input" data-rating="4">â˜…</button>
                                    <button class="star-input" data-rating="5">â˜…</button>
                                </div>
                                <textarea id="reviewText" class="review-textarea" placeholder="Share your experience with this product... (Minimum 10 characters)" minlength="10" maxlength="500"></textarea>
                                <button id="submitReviewBtn" class="btn-primary w-100" onclick="submitReview()">
                                    <i class="fas fa-paper-plane"></i> Submit Review
                                </button>
                            </div>

                            <div id="noReviews" class="no-reviews">
                                <div class="no-reviews-icon">
                                    <i class="fas fa-comment-dots"></i>
                                </div>
                                <h4>No Reviews Yet</h4>
                                <p>Be the first to review this product!</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- User Profile Page -->
            <div id="profilePage" class="profile-page">
                <div class="profile-header">
                    <div class="profile-avatar" id="profileAvatar">
                        <span id="avatarText">U</span>
                        <input type="file" id="avatarUpload" accept="image/*" style="display: none;">
                        <div class="avatar-upload" onclick="document.getElementById('avatarUpload').click()">
                            <i class="fas fa-camera"></i>
                        </div>
                    </div>
                    <h2 class="profile-name" id="profileUserName">User Name</h2>
                    <p class="profile-email" id="profileUserEmail">user@email.com</p>
                </div>

                <!-- Personal Details Section -->
                <div class="profile-section">
                    <h3 class="section-title">
                        <i class="fas fa-user"></i>
                        Personal Details
                    </h3>
                    <ul class="profile-menu">
                        <li class="profile-menu-item" onclick="editPersonalDetails()">
                            <div class="menu-item-content">
                                <div class="menu-item-icon">
                                    <i class="fas fa-edit"></i>
                                </div>
                                <div class="menu-item-text">
                                    <div class="menu-item-title">Edit Profile</div>
                                    <div class="menu-item-desc">Update your name, email and phone</div>
                                </div>
                            </div>
                            <div class="menu-item-arrow">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </li>
                        <li class="profile-menu-item" onclick="changeProfilePicture()">
                            <div class="menu-item-content">
                                <div class="menu-item-icon">
                                    <i class="fas fa-camera"></i>
                                </div>
                                <div class="menu-item-text">
                                    <div class="menu-item-title">Profile Picture</div>
                                    <div class="menu-item-desc">Change your profile photo</div>
                                </div>
                            </div>
                            <div class="menu-item-arrow">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </li>
                    </ul>
                </div>

                <!-- Security Section -->
                <div class="profile-section">
                    <h3 class="section-title">
                        <i class="fas fa-shield-alt"></i>
                        Security
                    </h3>
                    <ul class="profile-menu">
                        <li class="profile-menu-item" onclick="changePassword()">
                            <div class="menu-item-content">
                                <div class="menu-item-icon">
                                    <i class="fas fa-key"></i>
                                </div>
                                <div class="menu-item-text">
                                    <div class="menu-item-title">Change Password</div>
                                    <div class="menu-item-desc">Update your login password</div>
                                </div>
                            </div>
                            <div class="menu-item-arrow">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </li>
                        <li class="profile-menu-item" onclick="showLoginHistory()">
                            <div class="menu-item-content">
                                <div class="menu-item-icon">
                                    <i class="fas fa-history"></i>
                                </div>
                                <div class="menu-item-text">
                                    <div class="menu-item-title">Login History</div>
                                    <div class="menu-item-desc">View your recent login activity</div>
                                </div>
                            </div>
                            <div class="menu-item-arrow">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </li>
                        <li class="profile-menu-item">
                            <div class="menu-item-content">
                                <div class="menu-item-icon">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="menu-item-text">
                                    <div class="menu-item-title">Account Verification</div>
                                    <div class="menu-item-desc">Your account is verified</div>
                                </div>
                            </div>
                            <div class="security-badge">Verified</div>
                        </li>
                    </ul>
                </div>

                <li class="profile-menu-item" onclick="savedAddresses()">
                    <div class="menu-item-content">
                        <div class="menu-item-icon">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="menu-item-text">
                            <div class="menu-item-title">Saved Addresses</div>
                            <div class="menu-item-desc">Manage your delivery addresses</div>
                        </div>
                    </div>
                    <div class="menu-item-arrow">
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </li>

                <!-- Preferences Section -->
                <div class="profile-section">
                    <h3 class="section-title">
                        <i class="fas fa-cog"></i>
                        Preferences
                    </h3>
                    <div class="preference-item">
                        <div class="preference-info">
                            <div class="preference-title">Push Notifications</div>
                            <div class="preference-desc">Receive order updates and offers</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="pushNotifications" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="preference-item">
                        <div class="preference-info">
                            <div class="preference-title">Email Notifications</div>
                            <div class="preference-desc">Get updates via email</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="emailNotifications" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="preference-item">
                        <div class="preference-info">
                            <div class="preference-title">SMS Notifications</div>
                            <div class="preference-desc">Receive order alerts via SMS</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="smsNotifications">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="preference-item" onclick="changeLanguage()">
                        <div class="preference-info">
                            <div class="preference-title">Language</div>
                            <div class="preference-desc">English</div>
                        </div>
                        <div class="menu-item-arrow">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                    
                    <!-- â˜…â˜…â˜… ADD LOGOUT HERE â˜…â˜…â˜… -->
                    <div class="preference-item" onclick="logout()" style="color: var(--danger); border-top: 1px solid var(--border); margin-top: 10px; padding-top: 15px;">
                        <div class="preference-info">
                            <div class="preference-title" style="color: var(--danger);">Logout</div>
                            <div class="preference-desc" style="color: var(--danger);">Sign out from your account</div>
                        </div>
                        <div class="menu-item-arrow" style="color: var(--danger);">
                            <i class="fas fa-sign-out-alt"></i>
                        </div>
                    </div>
                </div>

                <!-- Login History Section (Hidden by default) -->
                <div class="profile-section" id="loginHistorySection" style="display: none;">
                    <h3 class="section-title">
                        <i class="fas fa-history"></i>
                        Login History
                    </h3>
                    <div id="loginHistoryList">
                        <!-- Login sessions will be populated here -->
                    </div>
                </div>
            </div>
            
            <!-- Notifications Page -->
            <div id="notificationsPage" class="notifications-page" style="display: none;">
                <div class="profile-header">
                    <h2 class="profile-name">
                        <i class="fas fa-bell"></i>
                        Notifications
                    </h2>
                    <p class="profile-email">Manage your alerts and preferences</p>
                </div>

                <!-- Notification Preferences -->
                <div class="profile-section">
                    <h3 class="section-title">
                        <i class="fas fa-cog"></i>
                        Notification Preferences
                    </h3>
                    <div class="preference-item">
                        <div class="preference-info">
                            <div class="preference-title">Push Notifications</div>
                            <div class="preference-desc">Receive browser push notifications</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="pushNotificationsToggle" onchange="togglePushNotifications()">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="preference-item">
                        <div class="preference-info">
                            <div class="preference-title">Order Updates</div>
                            <div class="preference-desc">Order status and delivery alerts</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="orderUpdatesToggle" checked onchange="updateNotificationPreference('orderUpdates', this.checked)">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="preference-item">
                        <div class="preference-info">
                            <div class="preference-title">Price Alerts</div>
                            <div class="preference-desc">Price drops on wishlist items</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="priceAlertsToggle" checked onchange="updateNotificationPreference('priceAlerts', this.checked)">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="preference-item">
                        <div class="preference-info">
                            <div class="preference-title">Promotions</div>
                            <div class="preference-desc">Offers, discounts and new arrivals</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="promotionsToggle" checked onchange="updateNotificationPreference('promotions', this.checked)">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <!-- Notifications List -->
                <div class="profile-section">
                    <div class="section-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>
                            <i class="fas fa-bell"></i>
                            Recent Notifications
                        </span>
                        <button class="btn-outline btn-sm" onclick="clearAllNotifications()">
                            <i class="fas fa-trash"></i> Clear All
                        </button>
                    </div>
                    <div id="notificationsList">
                        <!-- Notifications will be loaded here -->
                    </div>
                    <div id="noNotifications" class="empty-state">
                        <div class="empty-icon"><i class="fas fa-bell-slash"></i></div>
                        <h3 class="empty-text">No notifications yet</h3>
                        <p class="text-muted">You're all caught up!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hamburger Menu -->
        <div id="hamburgerMenu" class="bottom-sheet">
            <span class="sheet-handle"></span>
            <div class="sheet-header">
                <strong class="sheet-title">Menu</strong>
                <button class="sheet-close" onclick="closeHamburgerMenu()">&times;</button>
            </div>
            <div class="sheet-body">
                <div class="profile-section">
                    <div class="profile-menu">
                        <div class="profile-menu-item" onclick="navigateToPage('categories'); closeHamburgerMenu();">
                            <div class="menu-item-content">
                                <div class="menu-item-icon"><i class="fas fa-th-large"></i></div>
                                <div class="menu-item-text">
                                    <div class="menu-item-title">Categories</div>
                                    <div class="menu-item-desc">Browse all product categories</div>
                                </div>
                            </div>
                        </div>
                        <div class="profile-menu-item" onclick="navigateToPage('wishlist'); closeHamburgerMenu();">
                            <div class="menu-item-content">
                                <div class="menu-item-icon"><i class="fas fa-heart"></i></div>
                                <div class="menu-item-text">
                                    <div class="menu-item-title">Wishlist</div>
                                    <div class="menu-item-desc">Your saved items</div>
                                </div>
                            </div>
                            <span class="nav-badge" id="hamburgerWishlistCount">0</span>
                        </div>
                        <div class="profile-menu-item" onclick="navigateToPage('notifications'); closeHamburgerMenu();">
                            <div class="menu-item-content">
                                <div class="menu-item-icon"><i class="fas fa-bell"></i></div>
                                <div class="menu-item-text">
                                    <div class="menu-item-title">Notifications</div>
                                    <div class="menu-item-desc">Alerts and updates</div>
                                </div>
                            </div>
                        </div>
                        <!-- Referral Program Menu Item - Coming Soon -->
                        <div class="profile-menu-item" onclick="showComingSoon('Referral Program')">
                            <div class="menu-item-content">
                                <div class="menu-item-icon"><i class="fas fa-user-plus"></i></div>
                                <div class="menu-item-text">
                                    <div class="menu-item-title">Referral Program</div>
                                    <div class="menu-item-desc">Invite friends & earn rewards</div>
                                </div>
                            </div>
                            <div class="security-badge" style="background: var(--warning);">Soon</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <nav class="bottom-nav">
            <a href="#" class="nav-item active" data-page="home">
                <i class="fas fa-home nav-icon"></i>
                <span class="nav-label">Home</span>
            </a>
            
            <a href="#" class="nav-item" data-page="orders">
                <i class="fas fa-shopping-bag nav-icon"></i>
                <span class="nav-label">Orders</span>
                <span class="nav-badge" id="ordersNavBadge" style="display: none;">0</span>
            </a>
            
            <a href="#" class="nav-item" data-page="account" id="accountNav">
                <i class="fas fa-user nav-icon"></i>
                <span class="nav-label">Account</span>
                <span class="nav-badge" id="accountBadge" style="display: none;">!</span>
            </a>
            
            <a href="#" class="nav-item" data-page="cart" id="bottomNavCart">
                <i class="fas fa-shopping-cart nav-icon"></i>
                <span class="nav-label">Cart</span>
                <span class="nav-badge" id="bottomCartCount">0</span>
            </a>
            
            <a href="#" class="nav-item" onclick="openHamburgerMenu()">
                <i class="fas fa-bars nav-icon"></i>
                <span class="nav-label">Menu</span>
            </a>
        </nav>

        <!-- Bottom Sheet for Checkout -->
        <div id="bsheet" class="bottom-sheet" aria-hidden="true">
            <span class="sheet-handle"></span>
            <div class="sheet-header">
                <strong class="sheet-title">Checkout</strong>
                <button id="closeB" class="sheet-close">&times;</button>
            </div>
            <div class="sheet-body">
                <div class="mb-4">
                    <label class="section-label">Delivery Address</label>
                    <div id="addresses" class="address-grid"></div>
                    
                    <div class="address-form">
                        <h6>Add New Address</h6>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Full Name</label>
                                <input type="text" class="form-control" id="addrFullName" placeholder="Enter full name">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Phone Number</label>
                                <input type="text" class="form-control" id="addrPhone" placeholder="10-digit mobile number" maxlength="10">
                                <div id="addrPhoneValidation" class="validation-message"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Address Type</label>
                            <select class="form-control" id="addrType">
                                <option value="home">Home</option>
                                <option value="work">Work</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Complete Address</label>
                            <textarea class="form-control" id="addrDetails" placeholder="House no, Building, Street, Area" rows="3"></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">City</label>
                                <input type="text" class="form-control" id="addrCity" placeholder="City">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Pincode</label>
                                <input type="text" class="form-control" id="addrPincode" placeholder="Pincode" maxlength="6">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Landmark (Optional)</label>
                            <input type="text" class="form-control" id="addrLandmark" placeholder="Nearby landmark">
                        </div>
                        <button id="saveAddr" class="btn-primary w-100">Save Address</button>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="section-label">Contact Information</label>
                    <input id="checkoutName" class="form-control mb-3" placeholder="Full name">
                    <input id="checkoutPhone" class="form-control" placeholder="Phone number" maxlength="10">
                    <div id="phoneValidation" class="validation-message"></div>
                </div>

                <div class="payment-methods">
                    <label class="section-label">Payment Method</label>
                    <div class="payment-option" data-method="cod">
                        <div class="payment-icon">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div class="payment-info">
                            <div class="payment-title">Cash on Delivery</div>
                            <div class="payment-desc">Pay when you receive your order</div>
                        </div>
                    </div>
                    <div class="payment-option" data-method="qr">
                        <div class="payment-icon">
                            <i class="fas fa-qrcode"></i>
                        </div>
                        <div class="payment-info">
                            <div class="payment-title">QR Code Payment</div>
                            <div class="payment-desc">Scan & pay using UPI</div>
                        </div>
                    </div>
                </div>

                <div id="qrCodeSection" style="display: none;" class="qr-modal">
                    <h5>Scan QR Code to Pay</h5>
                    <div class="qr-code">
                        <div class="qr-code-content">
                            <div style="color: #5F6368; font-size: 18px; font-weight: 700;">
                                Google Pay
                            </div>
                            
                            <div style="background: #000; color: white; padding: 10px 20px; border-radius: 25px; font-size: 14px; font-weight: 600;">
                                Scan to Pay
                            </div>
                            
                            <div class="qr-image-container">
                                <img src="https://res.cloudinary.com/db1rbtgpe/image/upload/v1763973608/GooglePay_QR_qvu0wv.png" 
                                     alt="Google Pay QR Code">
                            </div>
                            
                            <div class="upi-details">
                                <div style="font-size: 13px; color: #5F6368; margin-bottom: 5px;">
                                    <strong>UPI ID:</strong>
                                </div>
                                <div style="font-size: 14px; color: #000; font-weight: 600; font-family: monospace;">
                                    damazingdeals-1@okaxis
                                </div>
                            </div>
                        </div>
                    </div>
                    <p class="text-muted">Amount: <span id="qrAmount">â‚¹0</span></p>
                    
                    <div class="utr-input">
                        <label class="form-label">Enter UTR Number</label>
                        <input type="text" class="form-control" id="utrNumber" placeholder="Enter 12-digit UTR number" maxlength="12">
                        <div id="utrValidation" class="validation-message"></div>
                    </div>
                    
                    <button id="confirmQrPayment" class="btn-primary w-100 mt-3">
                        <i class="fas fa-check"></i> Confirm Payment
                    </button>
                </div>

                <div class="coupon-section">
                    <label class="section-label">Apply Coupon</label>
                    <div class="coupon-input-group">
                        <input type="text" id="couponCode" class="coupon-input" placeholder="Enter coupon code" disabled>
                        <button type="button" id="applyCouponBtn" class="btn-apply-coupon" disabled>Apply</button>
                    </div>
                    <div id="couponLoginRequired" class="coupon-login-required" style="display: block;">
                        <i class="fas fa-info-circle"></i> Please login to apply coupons
                    </div>
                    <div id="couponMessage"></div>
                </div>
                
                <div class="mb-4">
                    <label class="section-label">Order Summary</label>
                    <div id="orderList"></div>
                    
                    <div id="discountSection" style="display: none;">
                        <div class="discount-row">
                            <span>Discount Applied:</span>
                            <span id="discountAmount">-â‚¹0</span>
                        </div>
                    </div>
                    
                    <div class="order-total-summary">
                        <span>Total Amount</span>
                        <span id="orderTotal">â‚¹0</span>
                    </div>
                </div>
                
                <button id="placeOrderBtn" class="btn-primary w-100 py-3" 
        onclick="placeOrder()" 
        ${cart.length === 0 ? 'disabled' : ''}>
    <i class="fas fa-lock"></i> Place Order Securely
</button>
            </div>
        </div>

        <!-- âœ… UPDATED ORDER TRACKING MODAL WITH MORE STEPS -->
        <div class="bottom-sheet" id="orderTracking">
            <span class="sheet-handle"></span>
            <div class="sheet-header">
                <strong class="sheet-title">Track Your Order</strong>
                <button class="sheet-close" onclick="closeOrderTracking()">&times;</button>
            </div>
            <div class="sheet-body">
                <div class="order-timeline" id="orderTimeline">
                    <div class="timeline-step">
                        <div class="step-icon completed" id="stepConfirmed">
                            <i class="fas fa-check"></i>
                        </div>
                        <div class="step-label completed">Order Confirmed</div>
                        <div class="step-time" id="timeConfirmed">Today, 10:30 AM</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-icon active" id="stepPreparing">
                            <i class="fas fa-utensils"></i>
                        </div>
                        <div class="step-label active">Preparing</div>
                        <div class="step-time" id="timePreparing">In progress</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-icon" id="stepPacked">
                            <i class="fas fa-box"></i>
                        </div>
                        <div class="step-label">Packed</div>
                        <div class="step-time" id="timePacked">--</div>
                    </div>
                    <div class="timeline-step" id="stepDispatchedContainer">
                        <div class="step-icon" id="stepDispatched">
                            <i class="fas fa-shipping-fast"></i>
                        </div>
                        <div class="step-label">Dispatched</div>
                        <div class="step-time" id="timeDispatched">--</div>
                    </div>
                    <!-- DELIVERY OR PICKUP STEP (DYNAMIC) -->
                    <div class="timeline-step" id="finalStepContainer">
                        <div class="step-icon" id="stepFinal">
                            <i class="fas fa-home" id="finalIcon"></i>
                        </div>
                        <div class="step-label" id="finalLabel">Delivered</div>
                        <div class="step-time" id="timeFinal">--</div>
                    </div>
                </div>
                
                <div class="order-details-card">
                    <h5>Order Details</h5>
                    <div id="trackingOrderDetails"></div>
                </div>
                
                <!-- PICKUP LOCATION BUTTON (SHOW ONLY FOR PICKUP ORDERS) -->
                <button class="btn-outline w-100 mt-3" id="pickupLocationBtn" onclick="showPickupLocation()" style="display: none;">
                    <i class="fas fa-map-marker-alt"></i> View Pickup Location
                </button>
                
                <button class="btn-outline w-100 mt-3" id="cancelOrderBtn" onclick="cancelOrder()">
                    <i class="fas fa-times"></i> Cancel Order
                </button>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div class="modal fade" id="confirmationModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header" style="background: var(--primary); color: white;">
                        <h5 class="modal-title" id="confirmationTitle">Confirm Action</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="confirmationMessage">
                        <!-- Message will be inserted here -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-outline" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn-primary" id="confirmAction">Confirm</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // âœ… FIX 1: ORDER BADGES UPDATING
        // âœ… FIX 2: SHOPKEEPER APP ACTIONS REAL-TIME SYNC
        
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD2-yz4xwYD5S_oXs6ryhNP8XIC94jzda4",
            authDomain: "dukaan-platform.firebaseapp.com",
            projectId: "dukaan-platform", 
            storageBucket: "dukaan-platform.firebasestorage.app",
            messagingSenderId: "75765851780",
            appId: "1:75765851780:web:dd9567db1d39c3b09c84d1"
        };

        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.log('Firebase already initialized');
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // âœ… AUTH PERSISTENCE
        auth.setPersistence(firebase.auth.Auth.Persistence.SESSION);

        // âœ… DYNAMIC SHOPS - WILL BE POPULATED FROM FIREBASE
        let SHOPS = {};

        let PRODUCTS = [];

        // Firebase se real products load karne ka function
        async function loadProductsFromFirebase() {
            try {
                // âœ… SIMPLE QUERY - NO FILTERS
                const productsSnapshot = await db.collection('products').get();
                
                PRODUCTS = [];
                productsSnapshot.forEach(doc => {
                    const firebaseProduct = doc.data();
                    
                    // âœ… FILTER LOCALLY
                    // Skip if status is not active
                    if (firebaseProduct.status !== 'active') {
                        console.log('Skipping inactive:', firebaseProduct.name);
                        return;
                    }
                    
                    // Skip if stock is 0 or less
                    if (firebaseProduct.stock <= 0) {
                        console.log('Skipping out of stock:', firebaseProduct.name);
                        return;
                    }
                    
                    // âœ… MAP FIELDS
                    const mappedProduct = {
                        id: doc.id,
                        name: firebaseProduct.name,
                        price: firebaseProduct.price,
                        mrp: firebaseProduct.mrp,
                        category: firebaseProduct.category,
                        shopId: firebaseProduct.shopId || firebaseProduct.shop,
                        shopName: firebaseProduct.shopName || firebaseProduct.shop,
                        image: firebaseProduct.image,
                        stock: firebaseProduct.stock,
                        description: firebaseProduct.description || '',
                        isAvailable: firebaseProduct.isAvailable !== false,
                        status: firebaseProduct.status || 'active',
                        deliveryTime: firebaseProduct.deliveryTime || '10-15 min'
                    };
                    
                    PRODUCTS.push(mappedProduct);
                });
                
                console.log('ðŸ“¦ Products loaded:', PRODUCTS.length);
                
                // âœ… UPDATE DYNAMIC SHOPS FROM PRODUCTS
                updateDynamicShops();
                
                // âœ… UPDATE FILTER DROPDOWNS
                updateShopAndCategoryFilters();
                
                if (typeof renderProducts === 'function') {
                    renderProducts(PRODUCTS);
                }
                
            } catch (error) {
                console.error('Error loading products:', error);
                PRODUCTS = getDemoProducts();
                updateDynamicShops();
                updateShopAndCategoryFilters();
                if (typeof renderProducts === 'function') {
                    renderProducts(PRODUCTS);
                }
            }
        }

        // âœ… DYNAMIC SHOPS FROM PRODUCTS
        function updateDynamicShops() {
            SHOPS = {};
            
            PRODUCTS.forEach(product => {
                const shopId = product.shopId;
                const shopName = product.shopName;
                
                if (shopId && shopName && !SHOPS[shopId]) {
                    SHOPS[shopId] = {
                        id: shopId,
                        name: shopName,
                        category: product.category || 'general',
                        rating: 4.5,
                        deliveryTime: product.deliveryTime || '10-15 min'
                    };
                }
            });
            
            console.log('ðŸ›ï¸ Dynamic shops updated:', Object.keys(SHOPS).length, 'shops');
        }

        // âœ… UPDATE SHOP AND CATEGORY FILTERS
        function updateShopAndCategoryFilters() {
            // Shop Filter
            const shopFilter = document.getElementById('shopFilter');
            const categoryFilter = document.getElementById('categoryFilter');
            
            if (shopFilter) {
                shopFilter.innerHTML = '<option value="">All Shops</option>';
                Object.keys(SHOPS).forEach(shopId => {
                    const shop = SHOPS[shopId];
                    shopFilter.innerHTML += `<option value="${shopId}">${shop.name}</option>`;
                });
                console.log('âœ… Shop filter updated');
            }
            
            // Category Filter
            if (categoryFilter) {
                const categories = [...new Set(PRODUCTS.map(p => p.category).filter(Boolean))];
                categoryFilter.innerHTML = '<option value="">All Categories</option>';
                categories.forEach(category => {
                    categoryFilter.innerHTML += `<option value="${category}">${category}</option>`;
                });
                console.log('âœ… Category filter updated:', categories.length, 'categories');
            }
        }

        // Emergency fallback demo products
        function getDemoProducts() {
            return [
                { id: 'demo1', name: 'Fresh Cow Milk', price: 60, mrp: 70, category: 'dairy', shopId: 'freshmart', shopName: 'FreshMart', image: 'https://images.unsplash.com/photo-1563636619-e9143da7973b?w=400&h=300&fit=crop', badge: 'Fresh', size: '1 Litre', brand: 'Amul', description: 'Fresh pasteurized cow milk rich in calcium and protein.', features: ['Pasteurized', 'Rich in Calcium', 'No Preservatives'], specifications: { type: 'Cow Milk', fat: '3.5%', shelfLife: '7 days' }, returnPolicy: 'No returns. Contact shopkeeper for any issues.' },
                { id: 'demo2', name: 'Face Cream', price: 199, mrp: 249, category: 'cosmetics', shopId: 'cosmeticstore', shopName: 'CosmeticStore', image: 'https://images.unsplash.com/photo-1596462502278-27bfdc403348?w=400&h=300&fit=crop', badge: 'New', size: '50ml', brand: 'Lakme', description: 'Moisturizing face cream with SPF protection.', features: ['SPF 30', 'Moisturizing', 'Non-Greasy'], specifications: { skinType: 'All Skin Types', spf: 'SPF 30' }, returnPolicy: 'No returns. Contact shopkeeper for damaged products.' }
            ];
        }

        const AVAILABLE_COUPONS = [
            { code: "WELCOME10", type: "percentage", value: 10, minOrder: 500, description: "Get 10% OFF on orders above â‚¹500" },
            { code: "FLAT50", type: "fixed", value: 50, minOrder: 300, description: "Get â‚¹50 OFF on orders above â‚¹300" }
        ];

        // REVIEWS SYSTEM
        const REVIEW_RULES = {
            minRating: 1,
            maxRating: 5,
            minReviewLength: 10,
            maxReviewLength: 500
        };

        // App State
        let currentUser = null;
        let cart = JSON.parse(localStorage.getItem('dukaan_cart')) || [];
        let wishlist = JSON.parse(localStorage.getItem('dukaan_wishlist')) || [];
        let orderTrackingInterval = null;
        let currentTrackingOrder = null;
        let productReviews = JSON.parse(localStorage.getItem('dukaan_product_reviews')) || [];
        let addresses = JSON.parse(localStorage.getItem('dukaan_addresses')) || [];
        let appliedCoupon = null;
        let orders = JSON.parse(localStorage.getItem('dukaan_orders')) || [];
        let selectedPaymentMethod = null;
        let selectedAddress = null;
        let currentProductDetail = null;
        let selectedRating = 0;
        // Notification System State
        let notifications = JSON.parse(localStorage.getItem('dukaan_notifications')) || [];
        let notificationPreferences = JSON.parse(localStorage.getItem('dukaan_notification_prefs')) || {
            orderUpdates: true,
            priceAlerts: true,
            promotions: true,
            pushEnabled: false
        };

        // Order Badges State
        let orderBadges = {
            pending: 0,
            preparing: 0,
            packed: 0,
            dispatched: 0,
            readyForPickup: 0,
            outForDelivery: 0
        };

        // DOM Elements
        const authScreen = document.getElementById('authScreen');
        const appScreen = document.getElementById('appScreen');
        const homePage = document.getElementById('homePage');
        const ordersPage = document.getElementById('ordersPage');
        const wishlistPage = document.getElementById('wishlistPage');
        const productDetailPage = document.getElementById('productDetailPage');
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');
        const searchInput = document.getElementById('search');
        const searchResults = document.getElementById('searchResults');
        const shopFilter = document.getElementById('shopFilter');
        const categoryFilter = document.getElementById('categoryFilter');
        const productGrid = document.getElementById('grid');
        const emptyState = document.getElementById('empty');
        const bottomSheet = document.getElementById('bsheet');
        const closeSheetBtn = document.getElementById('closeB');
        const orderList = document.getElementById('orderList');
        const orderTotal = document.getElementById('orderTotal');
        const placeOrderBtn = document.getElementById('placeOrderBtn');
        const addressesContainer = document.getElementById('addresses');
        const bottomNavCart = document.getElementById('bottomNavCart');
        const bottomCartCount = document.getElementById('bottomCartCount');
        const wishlistNav = document.getElementById('wishlistNav');
        const wishlistCount = document.getElementById('wishlistCount');
        const wishlistItems = document.getElementById('wishlistItems');
        const noWishlist = document.getElementById('noWishlist');
        const navItems = document.querySelectorAll('.nav-item');
        const ordersList = document.getElementById('ordersList');
        const noOrders = document.getElementById('noOrders');
        const couponCodeInput = document.getElementById('couponCode');
        const applyCouponBtn = document.getElementById('applyCouponBtn');
        const couponMessage = document.getElementById('couponMessage');
        const couponLoginRequired = document.getElementById('couponLoginRequired');
        const checkoutPhone = document.getElementById('checkoutPhone');
        const phoneValidation = document.getElementById('phoneValidation');
        const addrPhone = document.getElementById('addrPhone');
        const addrPhoneValidation = document.getElementById('addrPhoneValidation');
        const paymentOptions = document.querySelectorAll('.payment-option');
        const qrCodeSection = document.getElementById('qrCodeSection');
        const qrAmount = document.getElementById('qrAmount');
        const confirmQrPayment = document.getElementById('confirmQrPayment');
        const utrNumber = document.getElementById('utrNumber');
        const utrValidation = document.getElementById('utrValidation');
        const saveAddr = document.getElementById('saveAddr');
        const orderTracking = document.getElementById('orderTracking');
        const ordersNavBadge = document.getElementById('ordersNavBadge');
        const ordersBadge = document.getElementById('ordersBadge');

        // Initialize App
        function initApp() {
            setupEventListeners();
            setupFirebaseAuth();
            setupDemoLogin();
            renderProducts(PRODUCTS);
            updateCartUI();
            updateWishlistUI();
            renderOrders();
            renderAddresses();
            setupSorting();
            
            // âœ… FIX: START REAL-TIME ORDER LISTENER
            startRealTimeOrderListener();
        }

        // âœ… UPDATED: Real-time Order Listener with all statuses
        function startRealTimeOrderListener() {
            if (!currentUser) return;
            
            console.log("ðŸ”” Starting real-time order listener for user:", currentUser.uid);
            
            // Listen to orders collection for this customer
            db.collection('orders')
                .where('customerId', '==', currentUser.uid)
                .onSnapshot((snapshot) => {
                    console.log("ðŸ”„ Real-time order update received");
                    
                    // Process all changes
                    snapshot.docChanges().forEach((change) => {
                        const updatedOrder = { 
                            id: change.doc.id, 
                            ...change.doc.data() 
                        };
                        
                        // Convert Firestore timestamps to ISO strings
                        if (updatedOrder.createdAt && updatedOrder.createdAt.toDate) {
                            updatedOrder.createdAt = updatedOrder.createdAt.toDate().toISOString();
                        }
                        if (updatedOrder.updatedAt && updatedOrder.updatedAt.toDate) {
                            updatedOrder.updatedAt = updatedOrder.updatedAt.toDate().toISOString();
                        }
                        
                        console.log("ðŸ“ Order update type:", change.type, "Order ID:", updatedOrder.id, "Status:", updatedOrder.status);
                        
                        if (change.type === 'added' || change.type === 'modified') {
                            handleOrderUpdate(updatedOrder);
                        } else if (change.type === 'removed') {
                            // Handle order removal if needed
                            const orderIndex = orders.findIndex(order => order.id === updatedOrder.id);
                            if (orderIndex !== -1) {
                                orders.splice(orderIndex, 1);
                                localStorage.setItem('dukaan_orders', JSON.stringify(orders));
                                renderOrders();
                            }
                        }
                    });
                    
                    // Also listen to orderItems for shopkeeper updates
                    startOrderItemsListener();
                }, (error) => {
                    console.error("âŒ Error in real-time order listener:", error);
                });
        }
        
        // âœ… UPDATED: Listen to orderItems collection for shopkeeper actions
        function startOrderItemsListener() {
            if (!currentUser) return;
            
            console.log("ðŸ›ï¸ Starting orderItems listener");
            
            db.collection('orderItems')
                .where('customerId', '==', currentUser.uid)
                .onSnapshot((snapshot) => {
                    console.log("ðŸ›ï¸ OrderItems update received:", snapshot.docChanges().length, "changes");
                    
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'modified') {
                            const orderItem = { 
                                id: change.doc.id, 
                                ...change.doc.data() 
                            };
                            
                            console.log("ðŸ“¦ OrderItem update:", orderItem.orderId, "Status:", orderItem.status);
                            
                            // Update the main order with shopkeeper's action
                            updateOrderFromShopkeeper(orderItem);
                        }
                    });
                }, (error) => {
                    console.error("âŒ Error in orderItems listener:", error);
                });
        }
        
        // âœ… UPDATED: Handle order updates from shopkeeper app with all statuses
        function updateOrderFromShopkeeper(orderItem) {
            const orderIndex = orders.findIndex(order => order.id === orderItem.orderId);
            
            if (orderIndex !== -1) {
                const order = orders[orderIndex];
                const oldStatus = order.status;
                const newStatus = orderItem.status;
                
                // Update order status based on shopkeeper's action
                if (newStatus && newStatus !== oldStatus) {
                    orders[orderIndex].status = newStatus;
                    
                    // Update tracking times based on status
                    const now = new Date().toISOString();
                    if (!orders[orderIndex].tracking) {
                        orders[orderIndex].tracking = {};
                    }
                    
                    switch(newStatus) {
                        case 'preparing':
                            orders[orderIndex].tracking.preparing = now;
                            break;
                        case 'packed':
                            orders[orderIndex].tracking.packed = now;
                            break;
                        case 'dispatched':
                            orders[orderIndex].tracking.dispatched = now;
                            break;
                        case 'ready_for_pickup':
                            orders[orderIndex].tracking.readyForPickup = now;
                            break;
                        case 'out_for_delivery':
                            orders[orderIndex].tracking.outForDelivery = now;
                            break;
                        case 'delivered':
                            orders[orderIndex].tracking.delivered = now;
                            break;
                    }
                    
                    // Save to local storage
                    localStorage.setItem('dukaan_orders', JSON.stringify(orders));
                    
                    // Update UI
                    renderOrders();
                    updateOrderBadges();
                    
                    // Show notification
                    showOrderUpdateNotification(order.id, oldStatus, newStatus);
                    
                    // If this order is currently being tracked, update tracking UI
                    if (currentTrackingOrder && currentTrackingOrder.id === order.id) {
                        updateTrackingTimeline(orders[orderIndex]);
                        updateETACountdown(orders[orderIndex]);
                    }
                }
            }
        }
        
        // âœ… UPDATED: Show order update notification with all statuses
        function showOrderUpdateNotification(orderId, oldStatus, newStatus) {
            const statusMessages = {
                'preparing': 'is being prepared',
                'packed': 'has been packed',
                'dispatched': 'has been dispatched',
                'ready_for_pickup': 'is ready for pickup',
                'out_for_delivery': 'is out for delivery',
                'delivered': 'has been delivered'
            };
            
            const message = statusMessages[newStatus];
            if (message) {
                const notification = document.getElementById('orderUpdateNotification');
                notification.innerHTML = `<i class="fas fa-bell"></i> Order #${orderId.slice(-6)} ${message}!`;
                notification.style.display = 'block';
                
                // Auto hide after 5 seconds
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 5000);
            }
        }
        
        // âœ… UPDATED: Handle order update with all statuses
        function handleOrderUpdate(updatedOrder) {
            const orderIndex = orders.findIndex(order => order.id === updatedOrder.id);
            const oldStatus = orderIndex !== -1 ? orders[orderIndex].status : null;
            
            if (orderIndex !== -1) {
                // Merge with existing order data
                orders[orderIndex] = {
                    ...orders[orderIndex],
                    ...updatedOrder,
                    tracking: updatedOrder.tracking || orders[orderIndex].tracking || {
                        confirmed: updatedOrder.createdAt || new Date().toISOString(),
                        preparing: null,
                        packed: null,
                        dispatched: null,
                        readyForPickup: null,
                        outForDelivery: null,
                        delivered: null
                    }
                };
            } else {
                // Add new order
                orders.push({
                    ...updatedOrder,
                    tracking: updatedOrder.tracking || {
                        confirmed: updatedOrder.createdAt || new Date().toISOString(),
                        preparing: null,
                        packed: null,
                        dispatched: null,
                        readyForPickup: null,
                        outForDelivery: null,
                        delivered: null
                    }
                });
            }
            
            // Save to local storage
            localStorage.setItem('dukaan_orders', JSON.stringify(orders));
            
            // Update UI
            renderOrders();
            updateOrderBadges();
            
            // Show notification if status changed
            if (oldStatus && oldStatus !== updatedOrder.status) {
                showOrderUpdateNotification(updatedOrder.id, oldStatus, updatedOrder.status);
            }
            
            // If this order is currently being tracked, update tracking UI
            if (currentTrackingOrder && currentTrackingOrder.id === updatedOrder.id) {
                updateTrackingTimeline(orders[orderIndex !== -1 ? orderIndex : orders.length - 1]);
                updateETACountdown(orders[orderIndex !== -1 ? orderIndex : orders.length - 1]);
            }
        }

        // Firebase Authentication - FIXED
        function setupFirebaseAuth() {
            auth.onAuthStateChanged((user) => {
                console.log('Auth state changed:', user);
                if (user) {
                    currentUser = {
                        uid: user.uid,
                        email: user.email,
                        name: user.displayName || user.email.split('@')[0]
                    };
                    showAppScreen();
                    loadUserData();
                    
                    // âœ… ADD DELAY - LET OTHER FUNCTIONS COMPLETE FIRST
                    setTimeout(() => {
                        console.log("ðŸ”„ Delayed loadOrderHistory call");
                        loadOrderHistory();
                        startRealTimeOrderListener();
                    }, 1000);
                    
                    updateCouponAuth();
                    showToast('Welcome back to Raashanmart!');
                } else {
                    currentUser = null;
                    showAuthScreen();
                }
            });
        }

        function setupDemoLogin() {
            // Auto-fill demo credentials
            document.getElementById('loginEmail').value = 'demo@dukaan.com';
            document.getElementById('loginPassword').value = 'demo123';
        }

        async function loadUserData() {
            if (!currentUser) return;
            
            try {
                // Load addresses
                const addressesSnapshot = await db.collection('users').doc(currentUser.uid).collection('addresses').get();
                addresses = [];
                addressesSnapshot.forEach(doc => {
                    addresses.push({ id: doc.id, ...doc.data() });
                });
                localStorage.setItem('dukaan_addresses', JSON.stringify(addresses));
                renderAddresses();

                // Load orders
                const ordersSnapshot = await db.collection('users').doc(currentUser.uid).collection('orders').get();
                orders = [];
                ordersSnapshot.forEach(doc => {
                    orders.push({ id: doc.id, ...doc.data() });
                });
                localStorage.setItem('dukaan_orders', JSON.stringify(orders));
                renderOrders();
                updateOrderBadges(); // âœ… UPDATE BADGES

                // Load wishlist
                const wishlistSnapshot = await db.collection('users').doc(currentUser.uid).collection('wishlist').get();
                wishlist = [];
                wishlistSnapshot.forEach(doc => {
                    wishlist.push(doc.id);
                });
                localStorage.setItem('dukaan_wishlist', JSON.stringify(wishlist));
                updateWishlistUI();

                // Load reviews
                const reviewsSnapshot = await db.collection('productReviews').where('userId', '==', currentUser.uid).get();
                const userReviews = [];
                reviewsSnapshot.forEach(doc => {
                    userReviews.push(doc.data());
                });
                // Merge with existing reviews
                productReviews = [...productReviews, ...userReviews];
                localStorage.setItem('dukaan_product_reviews', JSON.stringify(productReviews));

            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // âœ… FIX: ORDER HISTORY LOADING
        async function loadOrderHistory() {
            if (!currentUser) return;
            
            try {
                console.log("ðŸ”„ Loading order history for:", currentUser.uid);
                
                // âœ… TEMPORARY FIX: REMOVE ORDERBY - NO INDEX NEEDED
                const snapshot = await db.collection('orders')
                    .where('customerId', '==', currentUser.uid)
                    .get();
                
                orders = [];
                snapshot.forEach(doc => {
                    const firebaseOrder = doc.data();
                    
                    // âœ… CONVERT FIREBASE DATA TO EXPECTED FORMAT
                    const mappedOrder = {
                        id: firebaseOrder.orderId || doc.id,
                        date: firebaseOrder.createdAt ? firebaseOrder.createdAt.toDate().toISOString() : new Date().toISOString(),
                        items: firebaseOrder.items || [],
                        address: firebaseOrder.address || {},
                        phone: firebaseOrder.phone || '',
                        paymentMethod: firebaseOrder.paymentMethod || 'cod',
                        status: firebaseOrder.status || 'confirmed',
                        subtotal: firebaseOrder.subtotal || firebaseOrder.total || 0,
                        discount: firebaseOrder.discount || 0,
                        total: firebaseOrder.total || 0,
                        tracking: firebaseOrder.tracking || {
                            confirmed: firebaseOrder.createdAt ? firebaseOrder.createdAt.toDate().toISOString() : new Date().toISOString(),
                            preparing: null,
                            packed: null,
                            dispatched: null,
                            readyForPickup: null,
                            outForDelivery: null,
                            delivered: null
                        }
                    };
                    
                    orders.push(mappedOrder);
                });
                
                // âœ… MANUAL SORTING (NO INDEX NEEDED)
                orders.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                console.log("âœ… Mapped orders:", orders.length);
                
                // Also save to local storage for offline access
                localStorage.setItem('dukaan_orders', JSON.stringify(orders));
                
                // âœ… UPDATE ORDER BADGES
                updateOrderBadges();
                
                // âœ… FORCE RENDER ORDERS
                if (typeof renderOrders === 'function') {
                    renderOrders();
                }
                
            } catch (error) {
                console.error('Error loading order history:', error);
                // Fallback to local storage
                const savedOrders = localStorage.getItem('dukaan_orders');
                if (savedOrders) {
                    orders = JSON.parse(savedOrders);
                    updateOrderBadges(); // âœ… UPDATE BADGES
                    if (typeof renderOrders === 'function') {
                        renderOrders();
                    }
                }
            }
        }

        // âœ… UPDATED: Update order badges with all statuses
        function updateOrderBadges() {
            // Reset badges
            orderBadges = {
                pending: 0,
                preparing: 0,
                packed: 0,
                dispatched: 0,
                readyForPickup: 0,
                outForDelivery: 0
            };
            
            // Count orders by status
            orders.forEach(order => {
                switch(order.status) {
                    case 'pending':
                    case 'confirmed':
                        orderBadges.pending++;
                        break;
                    case 'preparing':
                        orderBadges.preparing++;
                        break;
                    case 'packed':
                        orderBadges.packed++;
                        break;
                    case 'dispatched':
                        orderBadges.dispatched++;
                        break;
                    case 'ready_for_pickup':
                        orderBadges.readyForPickup++;
                        break;
                    case 'out_for_delivery':
                        orderBadges.outForDelivery++;
                        break;
                }
            });
            
            // Calculate total active orders (excluding delivered and cancelled)
            const activeOrders = orders.filter(order => 
                !['delivered', 'cancelled'].includes(order.status)
            ).length;
            
            // Update badges in UI
            if (ordersNavBadge) {
                if (activeOrders > 0) {
                    ordersNavBadge.textContent = activeOrders;
                    ordersNavBadge.style.display = 'block';
                } else {
                    ordersNavBadge.style.display = 'none';
                }
            }
            
            if (ordersBadge) {
                if (activeOrders > 0) {
                    ordersBadge.textContent = activeOrders;
                    ordersBadge.style.display = 'block';
                } else {
                    ordersBadge.style.display = 'none';
                }
            }
            
            console.log("ðŸ“Š Order badges updated:", orderBadges, "Active orders:", activeOrders);
        }

        // Auth Functions - FIXED
        function showAuthScreen() {
            authScreen.style.display = 'block';
            appScreen.style.display = 'none';
        }
        
        function showAppScreen() {
            authScreen.style.display = 'none';
            appScreen.style.display = 'block';
            updateCouponAuth();
            renderProducts(PRODUCTS); // Ensure products are rendered
            
            // âœ… START REAL-TIME LISTENER
            if (currentUser) {
                setTimeout(() => {
                    startRealTimeOrderListener();
                }, 1000);
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // âœ… AUTO-CREATE USER DOCUMENT IF NOT EXISTS
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (!userDoc.exists) {
                    await db.collection('users').doc(user.uid).set({
                        email: user.email,
                        name: user.displayName || user.email.split('@')[0],
                        role: 'customer',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log("âœ… New user document created");
                } else {
                    // Update last login time
                    await db.collection('users').doc(user.uid).update({
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                showToast('Welcome back to Raashanmart!');
                closeLoginModal();
                
            } catch (error) {
                console.error('Login error:', error);
                showToast('Login failed: ' + error.message);
            }
        }

        // Forgot Password System
        function showForgotPassword() {
            const email = prompt('Enter your email address to reset password:');
            if (email && email.includes('@')) {
                auth.sendPasswordResetEmail(email)
                    .then(() => {
                        alert('Password reset email sent! Check your inbox.');
                    })
                    .catch(error => {
                        alert('Error: ' + error.message);
                    });
            } else if (email) {
                alert('Please enter a valid email address.');
            }
        }

        // âœ… FIXED SIGNUP FUNCTION
        async function handleSignup(event) {
            event.preventDefault();
            
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                await userCredential.user.updateProfile({ displayName: name });
                
                // Save to Firestore
                await db.collection('users').doc(userCredential.user.uid).set({
                    name: name,
                    email: email,
                    role: 'customer',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showToast('Account created successfully!');
                
            } catch (error) {
                console.error('Signup error:', error);
                if (error.code === 'auth/email-already-in-use') {
                    showToast('Email already registered');
                } else {
                    showToast('Signup failed: ' + error.message);
                }
            }
        }
        
        function demoLogin() {
            document.getElementById('loginEmail').value = 'demo@dukaan.com';
            document.getElementById('loginPassword').value = 'demo123';
            showToast('Demo credentials filled! Click Sign In');
        }

        // â˜…â˜…â˜… ADD LOGOUT FUNCTION HERE â˜…â˜…â˜…
        function logout() {
            console.log("Logout function called");
            
            // Check if user is logged in with Firebase
            if (firebase.auth().currentUser) {
                firebase.auth().signOut().then(() => {
                    showToast("Logged out successfully!", 'success');
                    
                    // âœ… YEH LINE ADD KARO - UI IMMEDIATELY UPDATE
                    updateUIForAuth(null);
                    
                    // Switch to auth screen
                    document.getElementById('appScreen').style.display = 'none';
                    document.getElementById('authScreen').style.display = 'block';
                    // Reset forms
                    document.getElementById('loginForm').reset();
                    document.getElementById('signupForm').reset();
                    // Show login form by default
                    document.getElementById('loginForm').style.display = 'block';
                    document.getElementById('signupForm').style.display = 'none';
                    document.getElementById('loginFooter').style.display = 'block';
                    document.getElementById('signupFooter').style.display = 'none';
                }).catch((error) => {
                    console.error("Logout error:", error);
                    showToast("Error logging out: " + error.message, 'error');
                });
            } else {
                // Fallback for any logged in state
                document.getElementById('appScreen').style.display = 'none';
                document.getElementById('authScreen').style.display = 'block';
                
                // âœ… YEH LINE ADD KARO - UI UPDATE
                updateUIForAuth(null);
                
                showToast("Logged out successfully!");
            }
        }

        // â˜…â˜…â˜… ADD MISSING MODAL FUNCTIONS â˜…â˜…â˜…

        // Close Login Modal
        function closeLoginModal() {
            const modal = document.getElementById('loginModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Close Any Modal
        function closeModal() {
            // Close all modals
            const modals = document.querySelectorAll('.modal-overlay.active, [class*="modal"].active');
            modals.forEach(modal => {
                modal.classList.remove('active');
                modal.style.display = 'none';
            });
        }

        // Show Modal
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
                modal.style.display = 'flex';
            }
        }       

        // â˜…â˜…â˜… SAVED ADDRESSES FUNCTIONS â˜…â˜…â˜…
        function savedAddresses() {
            const modalHTML = `
            <div class="modal-overlay active" id="savedAddressesModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Saved Addresses</h3>
                        <button class="modal-close" onclick="closeSavedAddressesModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="addresses-list">
                            <div class="text-center py-4">
                                <i class="fas fa-map-marker-alt" style="font-size: 48px; color: var(--text-light); margin-bottom: 15px;"></i>
                                <h4 style="color: var(--text-light);">No Saved Addresses</h4>
                                <p style="color: var(--text-light);">You haven't saved any addresses yet</p>
                                <button class="btn-primary mt-2" onclick="addNewAddress()">
                                    <i class="fas fa-plus"></i> Add New Address
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-outline" onclick="closeSavedAddressesModal()">Close</button>
                    </div>
                </div>
            </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeSavedAddressesModal() {
            const modal = document.getElementById('savedAddressesModal');
            if (modal) {
                modal.remove();
            }
        }

        function addNewAddress() {
            // Close any existing address modal first
            closeAddAddressModal();
            
            const modalHTML = `
            <div class="modal-overlay active" id="addAddressModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Add New Address</h3>
                        <button class="modal-close" onclick="closeAddAddressModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Full Name *</label>
                            <input type="text" class="form-control" id="addressName" placeholder="Enter full name" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone Number *</label>
                            <input type="tel" class="form-control" id="addressPhone" placeholder="Enter phone number" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Pincode *</label>
                            <input type="text" class="form-control" id="addressPincode" placeholder="Enter pincode" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Address *</label>
                            <textarea class="form-control" id="addressLine1" placeholder="House no., Building, Street" rows="2" required></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Landmark (Optional)</label>
                            <input type="text" class="form-control" id="addressLandmark" placeholder="Nearby landmark">
                        </div>
                        <div class="form-group">
                            <label class="form-label">City *</label>
                            <input type="text" class="form-control" id="addressCity" placeholder="Enter city" required>
                        </div>
                        <div class="form-group form-check">
                            <input type="checkbox" class="form-check-input" id="defaultAddress">
                            <label class="form-check-label" for="defaultAddress">Set as default address</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-outline" onclick="closeAddAddressModal()">Cancel</button>
                        <button type="button" class="btn-primary" onclick="saveNewAddress()">Save Address</button>
                    </div>
                </div>
            </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        function closeAddAddressModal() {
            const modal = document.getElementById('addAddressModal');
            if (modal) modal.remove();
        }

        function saveNewAddress() {
            const name = document.getElementById('addressName').value.trim();
            const phone = document.getElementById('addressPhone').value.trim();
            const pincode = document.getElementById('addressPincode').value.trim();
            const address = document.getElementById('addressLine1').value.trim();
            const city = document.getElementById('addressCity').value.trim();
            const landmark = document.getElementById('addressLandmark').value.trim();
            const isDefault = document.getElementById('defaultAddress').checked;

            console.log("Address form values:", { name, phone, pincode, address, city, landmark, isDefault });

            // Validation
            if (!name) {
                showToast("Please enter full name", 'error');
                return;
            }
            
            if (!phone) {
                showToast("Please enter phone number", 'error');
                return;
            }
            
            if (!pincode) {
                showToast("Please enter pincode", 'error');
                return;
            }
            
            if (!address) {
                showToast("Please enter address", 'error');
                return;
            }
            
            if (!city) {
                showToast("Please enter city", 'error');
                return;
            }

            try {
                // Get existing addresses or create empty array
                const addresses = JSON.parse(localStorage.getItem('userAddresses') || '[]');
                
                const newAddress = {
                    id: 'addr_' + Date.now(),
                    name: name,
                    phone: phone,
                    pincode: pincode,
                    address: address,
                    city: city,
                    landmark: landmark,
                    isDefault: isDefault,
                    createdAt: new Date().toISOString()
                };

                // If setting as default, remove default from others
                if (isDefault) {
                    addresses.forEach(addr => addr.isDefault = false);
                }

                addresses.push(newAddress);
                localStorage.setItem('userAddresses', JSON.stringify(addresses));
                
                showToast('Address saved successfully!', 'success');
                closeAddAddressModal();
                
                // Refresh addresses list if open
                setTimeout(() => {
                    if (document.getElementById('savedAddressesModal')) {
                        closeSavedAddressesModal();
                        savedAddresses(); // Reopen with updated list
                    }
                }, 500);

            } catch (error) {
                console.error("Error saving address:", error);
                showToast("Error saving address: " + error.message, 'error');
            }
        }
        
        // â˜…â˜…â˜… SAVED ADDRESSES FUNCTIONS ADDED â˜…â˜…â˜…

        // Add missing authentication form toggle functions
        function showLoginForm() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('signupForm').style.display = 'none';
            document.getElementById('loginFooter').style.display = 'block';
            document.getElementById('signupFooter').style.display = 'none';
        }

        function showSignupForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'block';
            document.getElementById('loginFooter').style.display = 'none';
            document.getElementById('signupFooter').style.display = 'block';
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Auth form listeners
            loginForm.addEventListener('submit', handleLogin);
            signupForm.addEventListener('submit', handleSignup);
            document.getElementById('showSignup').addEventListener('click', showSignupForm);
            document.getElementById('showLogin').addEventListener('click', showLoginForm);

            // Search and filter listeners
            searchInput.addEventListener('input', handleSearch);
            shopFilter.addEventListener('change', applyFilters);
            categoryFilter.addEventListener('change', applyFilters);

            // Navigation listeners
            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = item.getAttribute('data-page');
                    navigateToPage(page);
                });
            });

            // Profile picture load on app start
            loadProfilePicture();

            // Enhanced Search Overlay Click
            document.getElementById('searchOverlay').addEventListener('click', closeEnhancedSearch);
            // Bottom sheet listeners
            closeSheetBtn.addEventListener('click', closeBottomSheet);
            bottomNavCart.addEventListener('click', (e) => {
                e.preventDefault();
                openBottomSheet();
            });

            // Checkout listeners
            placeOrderBtn.addEventListener('click', placeOrder);
            applyCouponBtn.addEventListener('click', applyCoupon);

            // Payment method selection
            paymentOptions.forEach(option => {
                option.addEventListener('click', () => {
                    selectPaymentMethod(option.getAttribute('data-method'));
                });
            });

            // Address and phone validation
            checkoutPhone.addEventListener('input', validatePhone);
            addrPhone.addEventListener('input', validateAddrPhone);
            saveAddr.addEventListener('click', saveNewAddress);
            
            // QR payment
            confirmQrPayment.addEventListener('click', confirmQRPayment);
            utrNumber.addEventListener('input', validateUTR);
            
            // Auto-fill checkout name when user is logged in
            auth.onAuthStateChanged((user) => {
                if (user) {
                    document.getElementById('checkoutName').value = user.displayName || '';
                }
            });
        }

        // Navigation
        function navigateToPage(page) {
            // Hide all pages
            homePage.style.display = 'none';
            ordersPage.style.display = 'none';
            wishlistPage.style.display = 'none';
            productDetailPage.style.display = 'none';
            profilePage.style.display = 'none';
            notificationsPage.style.display = 'none';

            // Update nav items
            navItems.forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-page') === page) {
                    item.classList.add('active');
                }
            });

            // Show selected page
            switch(page) {
                case 'home':
                    homePage.style.display = 'block';
                    break;
                case 'orders':
                    ordersPage.style.display = 'block';
                    renderOrders();
                    break;
                case 'wishlist':
                    wishlistPage.style.display = 'block';
                    renderWishlistItems();
                    break;
                case 'account':
                    profilePage.style.display = 'block';
                    loadUserProfile();
                    break;
                case 'notifications':
                    notificationsPage.style.display = 'block';
                    loadNotificationsPage();
                    break;
                case 'cart':
                    openBottomSheet();
                    break;
                default:
                    homePage.style.display = 'block';
            }
        }

        // Product Rendering - FIXED
        function renderProducts(products) {
            productGrid.innerHTML = '';
            
            if (products.length === 0) {
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            products.forEach(product => {
                // âœ… USE MAPPED shopName FIELD
                const shopName = product.shopName || 
                                (product.shopId ? 'Shop ' + product.shopId.slice(-4) : 'Unknown Shop');
                
                const discount = product.mrp ? Math.round(((product.mrp - product.price) / product.mrp) * 100) : 0;
                const isInWishlist = wishlist.includes(product.id);
                
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.innerHTML = `
                    ${product.badge ? `<div class="product-badge">${product.badge}</div>` : ''}
                    <div class="shop-badge">${shopName}</div> <!-- âœ… FIXED HERE -->
                    <button class="wishlist-btn ${isInWishlist ? 'active' : ''}" onclick="toggleWishlist('${product.id}')">
                        <i class="fas fa-heart"></i>
                    </button>
                    <img src="${product.image}" alt="${product.name}" class="product-image" onclick="showProductDetail('${product.id}')">
                    <h3 class="product-title" onclick="showProductDetail('${product.id}')">${product.name}</h3>
                    <p class="product-category">${product.category} â€¢ ${product.deliveryTime || '10-15 min'}</p>
                    <div class="product-price">
                        <span class="current-price">â‚¹${product.price}</span>
                        ${product.mrp ? `<span class="original-price">â‚¹${product.mrp}</span>` : ''}
                        ${discount > 0 ? `<span class="discount">${discount}% OFF</span>` : ''}
                    </div>
                    <div class="card-actions">
                        <button class="btn-add-cart" onclick="addToCart('${product.id}')">
                            <i class="fas fa-shopping-cart"></i> Add to Cart
                        </button>
                    </div>
                `;
                productGrid.appendChild(productCard);
            });
        }
        
        // Enhanced Search Functionality - PHASE 2
        function handleSearch() {
            openEnhancedSearch();
        }

        function openEnhancedSearch() {
            document.getElementById('searchOverlay').style.display = 'block';
            document.getElementById('searchModal').style.display = 'block';
            document.getElementById('enhancedSearchInput').focus();
            
            loadRecentSearches();
            loadPopularSearches();
            loadShopFilters();
            
            // Hide suggestions initially
            document.getElementById('searchSuggestionsSection').style.display = 'none';
            document.getElementById('searchSuggestions').style.display = 'none';
        }

        function closeEnhancedSearch() {
            document.getElementById('searchOverlay').style.display = 'none';
            document.getElementById('searchModal').style.display = 'none';
            document.getElementById('enhancedSearchInput').value = '';
        }

        function loadRecentSearches() {
            const recentSearches = JSON.parse(localStorage.getItem('dukaan_recent_searches')) || [];
            const recentSearchesList = document.getElementById('recentSearchesList');
            
            recentSearchesList.innerHTML = '';
            
            if (recentSearches.length === 0) {
                document.getElementById('recentSearchesSection').style.display = 'none';
                return;
            }
            
            document.getElementById('recentSearchesSection').style.display = 'block';
            
            recentSearches.slice(0, 8).forEach(search => {
                const searchItem = document.createElement('div');
                searchItem.className = 'recent-search-item';
                searchItem.textContent = search;
                searchItem.addEventListener('click', () => {
                    document.getElementById('enhancedSearchInput').value = search;
                    performEnhancedSearch(search);
                });
                recentSearchesList.appendChild(searchItem);
            });
        }

        function loadPopularSearches() {
            const popularSearches = [
                'Milk', 'Bread', 'Eggs', 'Shampoo', 
                'T-Shirt', 'Vegetables', 'Earbuds', 'Face Cream'
            ];
            
            const popularSearchesList = document.getElementById('popularSearchesList');
            popularSearchesList.innerHTML = '';
            
            popularSearches.forEach(search => {
                const searchItem = document.createElement('div');
                searchItem.className = 'popular-search-item';
                searchItem.innerHTML = `
                    <i class="fas fa-search suggestion-icon"></i>
                    ${search}
                `;
                searchItem.addEventListener('click', () => {
                    document.getElementById('enhancedSearchInput').value = search;
                    performEnhancedSearch(search);
                });
                popularSearchesList.appendChild(searchItem);
            });
        }

        function loadShopFilters() {
            const shopFiltersList = document.getElementById('shopFiltersList');
            shopFiltersList.innerHTML = '';
            
            Object.values(SHOPS).forEach(shop => {
                const shopItem = document.createElement('label');
                shopItem.className = 'shop-filter-item';
                shopItem.innerHTML = `
                    <input type="checkbox" class="shop-filter" value="${shop.id}">
                    <span>${shop.name}</span>
                `;
                shopFiltersList.appendChild(shopItem);
            });
        }

        function clearRecentSearches() {
            localStorage.removeItem('dukaan_recent_searches');
            loadRecentSearches();
            showToast('Recent searches cleared');
        }

        function addToRecentSearches(query) {
            if (!query.trim()) return;
            
            let recentSearches = JSON.parse(localStorage.getItem('dukaan_recent_searches')) || [];
            
            // Remove if already exists
            recentSearches = recentSearches.filter(item => item.toLowerCase() !== query.toLowerCase());
            
            // Add to beginning
            recentSearches.unshift(query);
            
            // Keep only last 10 searches
            recentSearches = recentSearches.slice(0, 10);
            
            localStorage.setItem('dukaan_recent_searches', JSON.stringify(recentSearches));
        }

        // Enhanced Search Core Functions
        function performEnhancedSearch(query) {
            if (!query.trim()) return;
            
            addToRecentSearches(query);
            closeEnhancedSearch();
            
            // Perform search and show results
            searchInput.value = query;
            const filteredProducts = PRODUCTS.filter(product => 
                product.name.toLowerCase().includes(query.toLowerCase()) ||
                product.category.toLowerCase().includes(query.toLowerCase()) ||
                SHOPS[product.shop].name.toLowerCase().includes(query.toLowerCase())
            );
            
            renderProducts(filteredProducts);
            showToast(`Found ${filteredProducts.length} products for "${query}"`);
            
            // Scroll to products
            document.getElementById('homePage').scrollIntoView({ behavior: 'smooth' });
        }

        function applyAdvancedFilters() {
            const minPrice = parseInt(document.getElementById('minPrice').value) || 0;
            const maxPrice = parseInt(document.getElementById('maxPrice').value) || 5000;
            const selectedRatings = Array.from(document.querySelectorAll('.rating-filter:checked')).map(cb => parseInt(cb.value));
            const selectedShops = Array.from(document.querySelectorAll('.shop-filter:checked')).map(cb => cb.value);
            
            let filteredProducts = PRODUCTS;
            
            // Price filter
            filteredProducts = filteredProducts.filter(product => 
                product.price >= minPrice && product.price <= maxPrice
            );
            
            // Rating filter (placeholder - will implement when we have actual ratings)
            if (selectedRatings.length > 0) {
                // For now, just show a message
                showToast('Rating filter will work when products have actual ratings');
            }
            
            // Shop filter
            if (selectedShops.length > 0) {
                filteredProducts = filteredProducts.filter(product => 
                    selectedShops.includes(product.shop)
                );
            }
            
            closeEnhancedSearch();
            renderProducts(filteredProducts);
            
            const filterText = [];
            if (minPrice > 0 || maxPrice < 5000) filterText.push(`Price: â‚¹${minPrice}-â‚¹${maxPrice}`);
            if (selectedShops.length > 0) filterText.push(`${selectedShops.length} shops`);
            
            showToast(`Applied filters: ${filterText.join(', ')} - ${filteredProducts.length} products`);
        }

        function resetFilters() {
            document.getElementById('minPrice').value = 0;
            document.getElementById('maxPrice').value = 5000;
            document.getElementById('priceRange').value = 5000;
            
            document.querySelectorAll('.rating-filter').forEach(cb => cb.checked = false);
            document.querySelectorAll('.shop-filter').forEach(cb => cb.checked = false);
            
            showToast('Filters reset');
        }

        // Enhanced Search Event Listeners
        document.getElementById('enhancedSearchInput').addEventListener('input', function() {
            const query = this.value.trim();
            
            if (query.length === 0) {
                document.getElementById('searchSuggestionsSection').style.display = 'none';
                document.getElementById('searchSuggestions').style.display = 'none';
                return;
            }
            
            // Show search suggestions
            showSearchSuggestions(query);
        });

        document.getElementById('enhancedSearchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performEnhancedSearch(this.value);
            }
        });

        function showSearchSuggestions(query) {
            const suggestions = generateSearchSuggestions(query);
            const suggestionsList = document.getElementById('searchSuggestionsList');
            
            suggestionsList.innerHTML = '';
            
            if (suggestions.length === 0) {
                document.getElementById('searchSuggestionsSection').style.display = 'none';
                return;
            }
            
            document.getElementById('searchSuggestionsSection').style.display = 'block';
            
            suggestions.forEach(suggestion => {
                const suggestionItem = document.createElement('li');
                suggestionItem.className = 'search-suggestion-item';
                suggestionItem.innerHTML = `
                    <i class="fas fa-search suggestion-icon"></i>
                    <span>${suggestion}</span>
                `;
                suggestionItem.addEventListener('click', () => {
                    document.getElementById('enhancedSearchInput').value = suggestion;
                    performEnhancedSearch(suggestion);
                });
                suggestionsList.appendChild(suggestionItem);
            });
        }

        function generateSearchSuggestions(query) {
            const lowerQuery = query.toLowerCase();
            const suggestions = new Set();
            
            // Product name suggestions
            PRODUCTS.forEach(product => {
                if (product.name.toLowerCase().includes(lowerQuery)) {
                    suggestions.add(product.name);
                }
            });
            
            // Category suggestions
            const categories = [...new Set(PRODUCTS.map(p => p.category))];
            categories.forEach(category => {
                if (category.toLowerCase().includes(lowerQuery)) {
                    suggestions.add(category);
                }
            });
            
            // Shop suggestions
            Object.values(SHOPS).forEach(shop => {
                if (shop.name.toLowerCase().includes(lowerQuery)) {
                    suggestions.add(shop.name);
                }
            });
            
            return Array.from(suggestions).slice(0, 8);
        }

        // Price range sync
        document.getElementById('priceRange').addEventListener('input', function() {
            document.getElementById('maxPrice').value = this.value;
        });

        document.getElementById('minPrice').addEventListener('input', function() {
            document.getElementById('priceRange').min = this.value;
        });

        document.getElementById('maxPrice').addEventListener('input', function() {
            document.getElementById('priceRange').value = this.value;
        });

        // Filter Functionality
        function applyFilters() {
            const shopValue = shopFilter.value;
            const categoryValue = categoryFilter.value;
            
            let filteredProducts = PRODUCTS;
            
            if (shopValue) {
                filteredProducts = filteredProducts.filter(product => product.shop === shopValue);
            }
            
            if (categoryValue) {
                filteredProducts = filteredProducts.filter(product => product.category === categoryValue);
            }
            
            renderProducts(filteredProducts);
        }

        // Sorting Functionality - PHASE 2.1
        function setupSorting() {
            document.getElementById('sortSelect').addEventListener('change', function() {
                applySorting(this.value);
            });
        }

        function applySorting(sortType) {
            let productsToSort = [...PRODUCTS];
            
            switch(sortType) {
                case 'price_high_low':
                    productsToSort.sort((a, b) => b.price - a.price);
                    showToast('Sorted: High to Low');
                    break;
                case 'price_low_high':
                    productsToSort.sort((a, b) => a.price - b.price);
                    showToast('Sorted: Low to High');
                    break;
                case 'newest':
                    // For demo, we'll sort by ID (assuming newer products have higher IDs)
                    productsToSort.sort((a, b) => b.id.localeCompare(a.id));
                    showToast('Sorted: Newest First');
                    break;
                default:
                    productsToSort = PRODUCTS;
            }
            
            renderProducts(productsToSort);
        }

        function applyFilters() {
            const shopValue = shopFilter.value;
            const categoryValue = categoryFilter.value;
            const sortValue = document.getElementById('sortSelect').value;
            
            let filteredProducts = PRODUCTS;
            
            if (shopValue) {
                filteredProducts = filteredProducts.filter(product => product.shop === shopValue);
            }
            
            if (categoryValue) {
                filteredProducts = filteredProducts.filter(product => product.category === categoryValue);
            }
            
            // Apply sorting to filtered products
            applySortingToProducts(filteredProducts, sortValue);
        }

        function applySortingToProducts(products, sortType) {
            let sortedProducts = [...products];
            
            switch(sortType) {
                case 'price_high_low':
                    sortedProducts.sort((a, b) => b.price - a.price);
                    break;
                case 'price_low_high':
                    sortedProducts.sort((a, b) => a.price - b.price);
                    break;
                case 'newest':
                    sortedProducts.sort((a, b) => b.id.localeCompare(a.id));
                    break;
            }
            
            renderProducts(sortedProducts);
        }

        // Cart Functionality
        // Cart Functionality - FIXED: Inventory sync
        async function addToCart(productId) {
            try {
                // Check real-time stock from Firebase
                const productDoc = await db.collection('products').doc(productId).get();
                if (!productDoc.exists) {
                    showToast('Product not available');
                    return;
                }
                
                const productData = productDoc.data();
                const currentStock = productData.stock;
                
                if (currentStock === 0) {
                    showToast('Sorry, this product is out of stock');
                    return;
                }
                
                const product = PRODUCTS.find(p => p.id === productId);
                if (!product) return;
                
                const existingItem = cart.find(item => item.id === productId);
                
                if (existingItem) {
                    // Check if adding more exceeds available stock
                    if (existingItem.quantity + 1 > currentStock) {
                        showToast(`Only ${currentStock} items available`);
                        return;
                    }
                    existingItem.quantity += 1;
                } else {
                    cart.push({
                        id: product.id,
                        name: product.name,
                        price: product.price,
                        image: product.image,
                        quantity: 1,
                        shop: product.shop,
                        shopId: productData.shopId,
                        shopName: productData.shopName
                    });
                }
                
                localStorage.setItem('dukaan_cart', JSON.stringify(cart));
                updateCartUI();
                showToast('Product added to cart!');
                
            } catch (error) {
                console.error('Error adding to cart:', error);
                showToast('Error adding product to cart');
            }
        }

        function addToCartFromDetail() {
            if (!currentProductDetail) return;
            
            const quantity = parseInt(document.getElementById('quantityValue').textContent);
            const product = PRODUCTS.find(p => p.id === currentProductDetail.id);
            
            if (!product) return;
            
            const existingItem = cart.find(item => item.id === product.id);
            
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    image: product.image,
                    quantity: quantity,
                    shop: product.shop
                });
            }
            
            localStorage.setItem('dukaan_cart', JSON.stringify(cart));
            updateCartUI();
            showToast('Product added to cart!');
            closeProductDetail();
        }

        function updateCartUI() {
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            bottomCartCount.textContent = totalItems;
            
            // HIDE BADGE WHEN 0
            if (totalItems === 0) {
                bottomCartCount.style.display = 'none';
            } else {
                bottomCartCount.style.display = 'block';
            }
            
            // Update order summary in bottom sheet
            updateOrderSummary();
        }

        // ADD THIS NEW FUNCTION FOR QUANTITY UPDATES
        function updateCartQuantity(index, change) {
            if (cart[index]) {
                cart[index].quantity += change;
                
                // Remove item if quantity becomes 0
                if (cart[index].quantity <= 0) {
                    cart.splice(index, 1);
                    showToast('Item removed from cart');
                } else if (cart[index].quantity > 10) {
                    cart[index].quantity = 10;
                    showToast('Maximum 10 items allowed');
                } else {
                    showToast('Quantity updated');
                }
                
                localStorage.setItem('dukaan_cart', JSON.stringify(cart));
                updateCartUI();
                updateOrderSummary();
            }
        }

        function updateOrderSummary() {
            if (!orderList) return;
            
            orderList.innerHTML = '';
            let subtotal = 0;
            
            cart.forEach((item, index) => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;
                
                const orderItem = document.createElement('div');
                orderItem.className = 'order-item-summary';
                orderItem.innerHTML = `
                    <div style="flex: 1;">
                        <strong>${item.name}</strong>
                        <div class="text-muted">â‚¹${item.price} each</div>
                        <div class="quantity-controls" style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">
                            <button class="btn-quantity-minus" onclick="updateCartQuantity(${index}, -1)" 
                                    style="width: 30px; height: 30px; border-radius: 50%; border: 1px solid var(--border); background: white; display: flex; align-items: center; justify-content: center;">-</button>
                            <span style="font-weight: 600; min-width: 20px; text-align: center;">${item.quantity}</span>
                            <button class="btn-quantity-plus" onclick="updateCartQuantity(${index}, 1)" 
                                    style="width: 30px; height: 30px; border-radius: 50%; border: 1px solid var(--border); background: white; display: flex; align-items: center; justify-content: center;">+</button>
                        </div>
                    </div>
                    <div>â‚¹${itemTotal}</div>
                `;
                orderList.appendChild(orderItem);
            });
            
            // Apply coupon discount if any
            let discount = 0;
            if (appliedCoupon) {
                if (appliedCoupon.type === 'percentage') {
                    discount = (subtotal * appliedCoupon.value) / 100;
                } else {
                    discount = appliedCoupon.value;
                }
                // Ensure discount doesn't exceed subtotal
                discount = Math.min(discount, subtotal);
            }
            
            const total = subtotal - discount;
            
            orderTotal.textContent = `â‚¹${total}`;
            qrAmount.textContent = `â‚¹${total}`;
            
            // Update discount section
            const discountSection = document.getElementById('discountSection');
            const discountAmount = document.getElementById('discountAmount');
            
            if (discount > 0) {
                discountSection.style.display = 'block';
                discountAmount.textContent = `-â‚¹${discount}`;
            } else {
                discountSection.style.display = 'none';
            }
        }

        // Wishlist Functionality
        function toggleWishlist(productId) {
            const index = wishlist.indexOf(productId);
            
            if (index > -1) {
                wishlist.splice(index, 1);
                showToast('Removed from wishlist');
            } else {
                wishlist.push(productId);
                showToast('Added to wishlist');
            }
            
            localStorage.setItem('dukaan_wishlist', JSON.stringify(wishlist));
            updateWishlistUI();
            renderProducts(PRODUCTS); // Re-render to update heart icons
        }

        function toggleWishlistFromDetail() {
            if (!currentProductDetail) return;
            toggleWishlist(currentProductDetail.id);
            
            // Update heart icon in detail page
            const wishlistBtn = document.getElementById('wishlistDetailBtn');
            const isInWishlist = wishlist.includes(currentProductDetail.id);
            wishlistBtn.classList.toggle('active', isInWishlist);
        }

        function updateWishlistUI() {
            // Safely update wishlist count if element exists
            if (wishlistCount) {
                wishlistCount.textContent = wishlist.length;
            }
            
            // Update hamburger wishlist count safely
            const hamburgerWishlistCount = document.getElementById('hamburgerWishlistCount');
            if (hamburgerWishlistCount) {
                hamburgerWishlistCount.textContent = wishlist.length;
            }
            
            if (wishlistItems) {
                if (wishlist.length === 0) {
                    wishlistItems.style.display = 'none';
                    noWishlist.style.display = 'block';
                } else {
                    wishlistItems.style.display = 'block';
                    noWishlist.style.display = 'none';
                }
            }
        }

        function renderWishlistItems() {
            if (!wishlistItems) return;
            
            wishlistItems.innerHTML = '';
            
            if (wishlist.length === 0) {
                noWishlist.style.display = 'block';
                return;
            }
            
            noWishlist.style.display = 'none';
            
            wishlist.forEach(productId => {
                const product = PRODUCTS.find(p => p.id === productId);
                if (!product) return;
                
                const shop = SHOPS[product.shop];
                const wishlistCard = document.createElement('div');
                wishlistCard.className = 'wishlist-card';
                wishlistCard.innerHTML = `
                    <img src="${product.image}" alt="${product.name}" class="wishlist-image">
                    <div class="wishlist-info">
                        <h4>${product.name}</h4>
                        <p class="text-muted">${shop.name} â€¢ ${product.category}</p>
                        <div class="product-price">
                            <span class="current-price">â‚¹${product.price}</span>
                            <span class="original-price">â‚¹${product.mrp}</span>
                        </div>
                    </div>
                    <div class="wishlist-actions">
                        <button class="btn-primary" onclick="addToCart('${product.id}')">
                            <i class="fas fa-shopping-cart"></i>
                        </button>
                        <button class="btn-outline" onclick="toggleWishlist('${product.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                wishlistItems.appendChild(wishlistCard);
            });
        }

        // Product Detail Page
        function showProductDetail(productId) {
            const product = PRODUCTS.find(p => p.id === productId);
            if (!product) return;
            
            currentProductDetail = product;
            const shop = SHOPS[product.shop];
            const discount = Math.round(((product.mrp - product.price) / product.mrp) * 100);
            const isInWishlist = wishlist.includes(product.id);
            
            // Update product detail page
            document.getElementById('productDetailImage').src = product.image;
            document.getElementById('productDetailTitle').textContent = product.name;
            document.getElementById('productDetailCategory').textContent = `${product.category} â€¢ ${shop.name} â€¢ ${shop.deliveryTime}`;
            document.getElementById('productDetailCurrent').textContent = `â‚¹${product.price}`;
            document.getElementById('productDetailOriginal').textContent = `â‚¹${product.mrp}`;
            document.getElementById('productDetailDiscount').textContent = `${discount}% OFF`;
            
            // Update wishlist button
            const wishlistBtn = document.getElementById('wishlistDetailBtn');
            wishlistBtn.classList.toggle('active', isInWishlist);
            
            // Reset quantity
            document.getElementById('quantityValue').textContent = '1';
            
            // Load reviews for this product
            loadProductReviews(product.id);
            
            // Show product detail page
            homePage.style.display = 'none';
            productDetailPage.style.display = 'block';
            
            // Update navigation
            navItems.forEach(item => item.classList.remove('active'));
        }

        function closeProductDetail() {
            productDetailPage.style.display = 'none';
            homePage.style.display = 'block';
            navItems[0].classList.add('active');
        }

        function changeQuantity(change) {
            const quantityElement = document.getElementById('quantityValue');
            let quantity = parseInt(quantityElement.textContent);
            quantity += change;
            
            if (quantity < 1) quantity = 1;
            if (quantity > 10) quantity = 10;
            
            quantityElement.textContent = quantity;
        }

        // Reviews System
        function loadProductReviews(productId) {
            const productReviews = getProductReviews(productId);
            const averageRating = calculateAverageRating(productReviews);
            const ratingDistribution = calculateRatingDistribution(productReviews);
            
            // Update average rating
            document.getElementById('averageRatingValue').textContent = averageRating.toFixed(1);
            updateRatingStars('averageRatingStars', averageRating);
            document.getElementById('totalReviewsCount').textContent = `${productReviews.length} reviews`;
            
            // Update rating distribution
            updateRatingDistribution(ratingDistribution, productReviews.length);
            
            // Show/hide review form based on user purchase status
            const reviewFormSection = document.getElementById('reviewFormSection');
            const noReviews = document.getElementById('noReviews');
            const reviewsList = document.getElementById('reviewsList');
            
            if (productReviews.length === 0) {
                noReviews.style.display = 'block';
                reviewsList.style.display = 'none';
            } else {
                noReviews.style.display = 'none';
                reviewsList.style.display = 'block';
                renderReviewsList(productReviews);
            }
            
            // Show review form if user is logged in and has purchased the product
            const hasPurchased = checkIfUserPurchasedProduct(productId);
            if (currentUser && hasPurchased && !hasUserReviewedProduct(productId)) {
                reviewFormSection.style.display = 'block';
                setupStarRatingInput();
            } else {
                reviewFormSection.style.display = 'none';
            }
        }

        function getProductReviews(productId) {
            return productReviews.filter(review => review.productId === productId);
        }

        function calculateAverageRating(reviews) {
            if (reviews.length === 0) return 0;
            const sum = reviews.reduce((total, review) => total + review.rating, 0);
            return sum / reviews.length;
        }

        function calculateRatingDistribution(reviews) {
            const distribution = {5: 0, 4: 0, 3: 0, 2: 0, 1: 0};
            reviews.forEach(review => {
                distribution[review.rating]++;
            });
            return distribution;
        }

        function updateRatingStars(elementId, rating) {
            const starsContainer = document.getElementById(elementId);
            starsContainer.innerHTML = '';
            
            for (let i = 1; i <= 5; i++) {
                const star = document.createElement('span');
                star.className = `rating-star ${i <= rating ? 'filled' : ''}`;
                star.innerHTML = 'â˜…';
                starsContainer.appendChild(star);
            }
        }

        function updateRatingDistribution(distribution, totalReviews) {
            const distributionContainer = document.querySelector('.rating-distribution');
            distributionContainer.innerHTML = '';
            
            for (let rating = 5; rating >= 1; rating--) {
                const count = distribution[rating];
                const percentage = totalReviews > 0 ? (count / totalReviews) * 100 : 0;
                
                const bar = document.createElement('div');
                bar.className = 'rating-bar';
                bar.innerHTML = `
                    <div class="bar-label">${rating} â˜…</div>
                    <div class="bar-container">
                        <div class="bar-fill" style="width: ${percentage}%"></div>
                    </div>
                    <div class="bar-count">${count}</div>
                `;
                distributionContainer.appendChild(bar);
            }
        }

        function renderReviewsList(reviews) {
            const reviewsList = document.getElementById('reviewsList');
            reviewsList.innerHTML = '';
            
            reviews.forEach(review => {
                const reviewCard = document.createElement('div');
                reviewCard.className = 'review-card';
                reviewCard.innerHTML = `
                    <div class="review-header">
                        <div class="review-user">
                            <div class="user-avatar">${review.userName.charAt(0).toUpperCase()}</div>
                            <div>
                                <h5>${review.userName}</h5>
                                <div class="verified-badge">Verified Purchase</div>
                            </div>
                        </div>
                        <div class="review-rating">
                            ${'â˜…'.repeat(review.rating)}${'â˜†'.repeat(5 - review.rating)}
                        </div>
                    </div>
                    <div class="review-date">${new Date(review.date).toLocaleDateString()}</div>
                    <div class="review-content">${review.comment}</div>
                `;
                reviewsList.appendChild(reviewCard);
            });
        }

        function setupStarRatingInput() {
            const starInputs = document.querySelectorAll('.star-input');
            starInputs.forEach(star => {
                star.addEventListener('click', () => {
                    const rating = parseInt(star.getAttribute('data-rating'));
                    selectedRating = rating;
                    
                    // Update star appearance
                    starInputs.forEach((s, index) => {
                        if (index < rating) {
                            s.classList.add('active');
                        } else {
                            s.classList.remove('active');
                        }
                    });
                });
            });
        }

        function checkIfUserPurchasedProduct(productId) {
            if (!currentUser) return false;
            
            return orders.some(order => 
                order.status === 'delivered' &&
                order.items.some(item => item.id === productId)
            );
        }

        function hasUserReviewedProduct(productId) {
            if (!currentUser) return false;
            
            return productReviews.some(review => 
                review.productId === productId && review.userId === currentUser.uid
            );
        }

        function submitReview() {
            if (!currentUser || !currentProductDetail || selectedRating === 0) {
                showToast('Please select a rating');
                return;
            }
            
            const reviewText = document.getElementById('reviewText').value.trim();
            if (reviewText.length < REVIEW_RULES.minReviewLength) {
                showToast(`Review must be at least ${REVIEW_RULES.minReviewLength} characters long`);
                return;
            }
            
            if (!checkIfUserPurchasedProduct(currentProductDetail.id)) {
                showToast('You can only review products you have purchased');
                return;
            }
            
            if (hasUserReviewedProduct(currentProductDetail.id)) {
                showToast('You have already reviewed this product');
                return;
            }
            
            const newReview = {
                id: generateId(),
                productId: currentProductDetail.id,
                userId: currentUser.uid,
                userName: currentUser.name,
                rating: selectedRating,
                comment: reviewText,
                date: new Date().toISOString()
            };
            
            productReviews.push(newReview);
            localStorage.setItem('dukaan_product_reviews', JSON.stringify(productReviews));
            
            // Save to Firebase if user is logged in
            if (currentUser) {
                db.collection('productReviews').add(newReview).catch(error => {
                    console.error('Error saving review to Firebase:', error);
                });
            }
            
            showToast('Review submitted successfully!');
            loadProductReviews(currentProductDetail.id);
            
            // Reset form
            selectedRating = 0;
            document.getElementById('reviewText').value = '';
            document.querySelectorAll('.star-input').forEach(star => star.classList.remove('active'));
        }

        // Bottom Sheet (Checkout)
        function openBottomSheet() {
            if (cart.length === 0) {
                showToast('Your cart is empty');
                return;
            }
            
            updateOrderSummary();
            bottomSheet.classList.add('open');
        }

        function closeBottomSheet() {
            bottomSheet.classList.remove('open');
            qrCodeSection.style.display = 'none';
            selectedPaymentMethod = null;
            paymentOptions.forEach(option => option.classList.remove('selected'));
        }

        // Address Management
        function renderAddresses() {
            if (!addressesContainer) return;
            
            addressesContainer.innerHTML = '';
            
            if (addresses.length === 0) {
                addressesContainer.innerHTML = '<p class="text-muted">No addresses saved. Add your first address below.</p>';
                return;
            }
            
            addresses.forEach(address => {
                const addressCard = document.createElement('div');
                addressCard.className = `address-card ${selectedAddress === address.id ? 'selected' : ''}`;
                addressCard.innerHTML = `
                    <div class="address-title">${address.type === 'home' ? 'ðŸ  Home' : address.type === 'work' ? 'ðŸ’¼ Work' : 'ðŸ“ Other'}</div>
                    <div class="address-details">${address.fullName} â€¢ ${address.details}</div>
                    <div class="address-phone">${address.phone} â€¢ ${address.city} - ${address.pincode}</div>
                `;
                addressCard.addEventListener('click', () => {
                    selectedAddress = address.id;
                    renderAddresses();
                });
                addressesContainer.appendChild(addressCard);
            });
        }

        function saveNewAddress() {
            const fullName = document.getElementById('addrFullName').value.trim();
            const phone = document.getElementById('addrPhone').value.trim();
            const type = document.getElementById('addrType').value;
            const details = document.getElementById('addrDetails').value.trim();
            const city = document.getElementById('addrCity').value.trim();
            const pincode = document.getElementById('addrPincode').value.trim();
            const landmark = document.getElementById('addrLandmark').value.trim();
            
            if (!fullName || !phone || !details || !city || !pincode) {
                showToast('Please fill all required fields');
                return;
            }
            
            if (!validatePhoneNumber(phone)) {
                showToast('Please enter a valid phone number');
                return;
            }
            
            const newAddress = {
                id: generateId(),
                fullName,
                phone,
                type,
                details,
                city,
                pincode,
                landmark,
                isDefault: addresses.length === 0
            };
            
            addresses.push(newAddress);
            localStorage.setItem('dukaan_addresses', JSON.stringify(addresses));
            
            // Save to Firebase if user is logged in
            if (currentUser) {
                db.collection('users').doc(currentUser.uid).collection('addresses').add(newAddress).catch(error => {
                    console.error('Error saving address to Firebase:', error);
                });
            }
            
            renderAddresses();
            showToast('Address saved successfully!');
            
            // Clear form
            document.getElementById('addrFullName').value = '';
            document.getElementById('addrPhone').value = '';
            document.getElementById('addrDetails').value = '';
            document.getElementById('addrCity').value = '';
            document.getElementById('addrPincode').value = '';
            document.getElementById('addrLandmark').value = '';
        }

        // Payment Methods - CORRECTED ORDER FLOW
        function selectPaymentMethod(method) {
            selectedPaymentMethod = method;
            
            paymentOptions.forEach(option => {
                option.classList.remove('selected');
                if (option.getAttribute('data-method') === method) {
                    option.classList.add('selected');
                }
            });
            
            if (method === 'qr') {
                qrCodeSection.style.display = 'block';
            } else {
                qrCodeSection.style.display = 'none';
            }
        }

        // Validation Functions
        function validatePhone() {
            const phone = checkoutPhone.value.trim();
            const isValid = validatePhoneNumber(phone);
            
            if (phone.length === 0) {
                checkoutPhone.classList.remove('phone-valid', 'phone-invalid');
                phoneValidation.textContent = '';
                return;
            }
            
            if (isValid) {
                checkoutPhone.classList.add('phone-valid');
                checkoutPhone.classList.remove('phone-invalid');
                phoneValidation.textContent = 'âœ“ Valid phone number';
                phoneValidation.className = 'validation-message validation-success';
            } else {
                checkoutPhone.classList.add('phone-invalid');
                checkoutPhone.classList.remove('phone-valid');
                phoneValidation.textContent = 'Please enter a valid 10-digit phone number';
                phoneValidation.className = 'validation-message validation-error';
            }
        }

        function validateAddrPhone() {
            const phone = addrPhone.value.trim();
            const isValid = validatePhoneNumber(phone);
            
            if (phone.length === 0) {
                addrPhone.classList.remove('phone-valid', 'phone-invalid');
                addrPhoneValidation.textContent = '';
                return;
            }
            
            if (isValid) {
                addrPhone.classList.add('phone-valid');
                addrPhone.classList.remove('phone-invalid');
                addrPhoneValidation.textContent = 'âœ“ Valid phone number';
                addrPhoneValidation.className = 'validation-message validation-success';
            } else {
                addrPhone.classList.add('phone-invalid');
                addrPhone.classList.remove('phone-valid');
                addrPhoneValidation.textContent = 'Please enter a valid 10-digit phone number';
                addrPhoneValidation.className = 'validation-message validation-error';
            }
        }

        function validatePhoneNumber(phone) {
            return /^[6-9]\d{9}$/.test(phone);
        }

        function validateUTR() {
            const utr = utrNumber.value.trim();
            const isValid = /^\d{12}$/.test(utr);
            
            if (utr.length === 0) {
                utrValidation.textContent = '';
                return;
            }
            
            if (isValid) {
                utrValidation.textContent = 'âœ“ Valid UTR number';
                utrValidation.className = 'validation-message validation-success';
            } else {
                utrValidation.textContent = 'Please enter a valid 12-digit UTR number';
                utrValidation.className = 'validation-message validation-error';
            }
        }

        // Coupon System - FIXED: Optional coupon, not required
        function applyCoupon() {
            if (!currentUser) {
                showToast('Please login to apply coupons');
                return;
            }
            
            const couponCode = couponCodeInput.value.trim().toUpperCase();
            
            // If coupon code is empty, just remove any applied coupon
            if (!couponCode) {
                appliedCoupon = null;
                couponMessage.textContent = '';
                updateOrderSummary();
                showToast('Coupon removed');
                return;
            }
            
            const coupon = AVAILABLE_COUPONS.find(c => c.code === couponCode);
            
            if (!coupon) {
                couponMessage.textContent = 'Invalid coupon code';
                couponMessage.className = 'coupon-error';
                appliedCoupon = null;
                updateOrderSummary();
                return;
            }
            
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            if (subtotal < coupon.minOrder) {
                couponMessage.textContent = `Minimum order amount of â‚¹${coupon.minOrder} required`;
                couponMessage.className = 'coupon-error';
                appliedCoupon = null;
                updateOrderSummary();
                return;
            }
            
            appliedCoupon = coupon;
            couponMessage.textContent = `ðŸŽ‰ ${coupon.description}`;
            couponMessage.className = 'coupon-success';
            updateOrderSummary();
            showToast('Coupon applied successfully!');
        }

        function updateCouponAuth() {
            if (currentUser) {
                couponCodeInput.disabled = false;
                applyCouponBtn.disabled = false;
                couponLoginRequired.style.display = 'none';
            } else {
                couponCodeInput.disabled = true;
                applyCouponBtn.disabled = true;
                couponLoginRequired.style.display = 'block';
            }
        }

        // QR Payment Confirmation - FIXED: Only confirms QR payment, doesn't place order
        function confirmQRPayment() {
            const utr = utrNumber.value.trim();
            if (!/^\d{12}$/.test(utr)) {
                showToast('Please enter a valid UTR number');
                return;
            }
            
            // Show confirmation modal for QR payment only
            showConfirmationModal(
                'Confirm QR Payment',
                `You are about to confirm your QR payment with UTR: ${utr}. Total amount: ${qrAmount.textContent}. Please ensure you have completed the payment via QR scan.`,
                () => {
                    // Just confirm the QR payment, don't place order
                    showToast('QR payment confirmed! Please click "Place Order Securely" to complete your order.');
                    // You can add any QR-specific confirmation logic here
                }
            );
        }

        // âœ… FIX 1: ORDER PLACEMENT WITHOUT COUPON - FIXED
async function placeOrder() {
    try {
        console.log('ðŸ›’ Place order called');
        
        // Validate checkout inputs
        const phone = document.getElementById('checkoutPhone')?.value?.trim();
        
        if (!phone || phone.length < 10) {
            showToast('Please enter a valid phone number', 'error');
            return;
        }
        
        if (!selectedPaymentMethod) {
            showToast('Please select a payment method', 'error');
            return;
        }
        
        if (!selectedAddress) {
            showToast('Please select a delivery address', 'error');
            return;
        }
        
        // Validate cart
        if (cart.length === 0) {
            showToast('Your cart is empty', 'error');
            return;
        }
        
        // Check if any item is invalid
        for (const item of cart) {
            if (!item.id || !item.shopId) {
                showToast('Some items in your cart are invalid', 'error');
                return;
            }
        }
        
        let utrNumberValue = '';
        
        // If QR payment, validate UTR number
        if (selectedPaymentMethod === 'qr') {
            utrNumberValue = document.getElementById('utrNumber')?.value?.trim() || '';
            if (!utrNumberValue) {
                showToast('Please enter UTR number for QR payment', 'error');
                return;
            }
        }
        
        // Show loading
        showLoading(true);
        
        // Get current user
        const user = auth.currentUser;
        if (!user) {
            showToast('Please login to place order', 'error');
            showLoading(false);
            return;
        }
        
        // Get selected shop info (assuming you have this)
        const selectedShop = getSelectedShop(); // Ye function aapke app mein hoga
        
        if (!selectedShop) {
            showToast('Please select a shop', 'error');
            showLoading(false);
            return;
        }
        
        // Calculate totals
        const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const deliveryCharge = 40; // Example delivery charge
        let discount = 0;
        let total = subtotal + deliveryCharge;
        
        // Apply coupon if any
        if (selectedCoupon) {
            discount = (subtotal * selectedCoupon.discountPercent) / 100;
            total = subtotal + deliveryCharge - discount;
        }
        
        // Prepare order items
        const orderItems = cart.map(item => ({
            id: item.id,
            name: item.name,
            price: item.price,
            quantity: item.quantity,
            image: item.image,
            shopId: item.shopId,
            shopName: item.shopName
        }));
        
        // First, create a temporary order ID
        const tempOrderId = 'temp_' + Date.now();
        
        // Create order data WITHOUT orderId initially
        const orderData = {
            // âŒ DON'T add orderId here - we'll update it after getting Firestore ID
            customerId: user.uid,
            customerName: user.displayName || 'Customer',
            customerEmail: user.email,
            phone: phone,
            items: orderItems,
            subtotal: subtotal,
            deliveryCharge: deliveryCharge,
            discount: discount,
            total: total,
            totalAmount: total,
            address: selectedAddress,
            deliveryType: 'delivery',
            status: 'pending',
            paymentMethod: selectedPaymentMethod,
            paymentStatus: selectedPaymentMethod === 'qr' ? 'paid' : 'pending',
            shopId: selectedShop.id,
            shopName: selectedShop.name,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // Add UTR number if QR payment
        if (selectedPaymentMethod === 'qr' && utrNumberValue) {
            orderData.utrNumber = utrNumberValue;
        }
        
        // Add coupon if applied
        if (selectedCoupon) {
            orderData.couponCode = selectedCoupon.code;
            orderData.couponDiscount = discount;
        }
        
        console.log('ðŸ“¦ Creating order with data:', orderData);
        
        // 1ï¸âƒ£ First, add order to Firestore (without orderId)
        const docRef = await db.collection('orders').add(orderData);
        const firestoreOrderId = docRef.id;
        console.log('ðŸ”¥ Firestore Order ID created:', firestoreOrderId);
        
        // 2ï¸âƒ£ IMPORTANT: Now update the order with orderId = Firestore document ID
        await db.collection('orders').doc(firestoreOrderId).update({
            orderId: firestoreOrderId, // âœ… Set orderId to Firestore ID
            id: firestoreOrderId // âœ… Also update id field if exists
        });
        
        console.log('âœ… Order updated with orderId:', firestoreOrderId);
        
        // 3ï¸âƒ£ Clear cart after successful order
        clearCart();
        
        // 4ï¸âƒ£ Hide loading
        showLoading(false);
        
        // 5ï¸âƒ£ Show success message with ORDER ID
        showToast(`âœ… Order placed successfully! Order ID: #${firestoreOrderId.substring(0, 6)}`, 'success');
        
        // 6ï¸âƒ£ Redirect to order confirmation page
        setTimeout(() => {
            window.location.href = `order-confirmation.html?orderId=${firestoreOrderId}`;
        }, 2000);
        
    } catch (error) {
        console.error('âŒ Error placing order:', error);
        showLoading(false);
        showToast('Error placing order: ' + error.message, 'error');
    }
}

        // âœ… ADD THIS HELPER FUNCTION
        function calculateSubtotal() {
            return cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        }

        // âœ… FIXED: Updated completeOrderPlacement function for guest users
        function completeOrderPlacement(newOrder) {
            try {
                // Generate order ID for guest
                const orderId = 'guest_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                newOrder.id = orderId;
                
                // Save to local storage
                orders.push(newOrder);
                localStorage.setItem('dukaan_orders', JSON.stringify(orders));
                
                // Clear cart
                cart = [];
                localStorage.setItem('dukaan_cart', JSON.stringify(cart));
                updateCartUI();
                
                // Reset checkout state
                appliedCoupon = null;
                selectedAddress = null;
                
                // Clear inputs
                const couponCodeInput = document.getElementById('couponCode');
                const couponMessage = document.getElementById('couponMessage');
                const checkoutPhone = document.getElementById('checkoutPhone');
                const utrNumber = document.getElementById('utrNumber');
                
                if (couponCodeInput) couponCodeInput.value = '';
                if (couponMessage) couponMessage.textContent = '';
                if (checkoutPhone) checkoutPhone.value = '';
                if (utrNumber) utrNumber.value = '';
                
                // Close bottom sheet
                closeBottomSheet();
                
                showToast('ðŸŽ‰ Order placed successfully!', 'success');
                
                // Show order tracking
                setTimeout(() => {
                    showOrderTracking(orderId);
                }, 1500);
                
            } catch (error) {
                console.error('âŒ Error in guest order placement:', error);
                showToast('Error placing order: ' + error.message, 'error');
            }
        }

        // âœ… FIXED: Updated completeOrderPlacementWithShopkeeper function
        async function completeOrderPlacementWithShopkeeper(newOrder) {
            try {
                console.log('ðŸ›ï¸ Starting order placement with shopkeeper...');
                
                // Check stock availability
                for (const item of cart) {
                    if (!item.id) {
                        showToast(`Error: Invalid product item`, 'error');
                        return;
                    }
                    
                    try {
                        const productDoc = await db.collection('products').doc(item.id).get();
                        if (!productDoc.exists) {
                            showToast(`Sorry, ${item.name || 'product'} is not available`, 'error');
                            return;
                        }
                        
                        const productData = productDoc.data();
                        const currentStock = productData.stock || 0;
                        const requestedQuantity = item.quantity || 1;
                        
                        if (currentStock < requestedQuantity) {
                            showToast(`Sorry, ${item.name || 'product'} is out of stock. Available: ${currentStock}`, 'error');
                            return;
                        }
                    } catch (error) {
                        console.error('Stock check error:', error);
                        showToast('Error checking stock availability', 'error');
                        return;
                    }
                }

                // âœ… GENERATE SINGLE ORDER ID FOR ALL COLLECTIONS
                const orderId = db.collection('orders').doc().id;
                console.log('ðŸ“‹ Generated Order ID:', orderId);
                
                // Save to local storage
                newOrder.id = orderId;
                orders.push(newOrder);
                localStorage.setItem('dukaan_orders', JSON.stringify(orders));
                
                // Also save to user orders history
                const userOrders = JSON.parse(localStorage.getItem('dukaan_user_orders') || '[]');
                userOrders.unshift(newOrder);
                localStorage.setItem('dukaan_user_orders', JSON.stringify(userOrders));

                // Check delivery type
                let hasPickupOnlyShop = false;
                try {
                    // Check first item's shop for delivery type
                    const firstItem = cart[0];
                    if (firstItem && firstItem.shopId) {
                        const shopDoc = await db.collection('shops').doc(firstItem.shopId).get();
                        if (shopDoc.exists) {
                            const shopData = shopDoc.data();
                            hasPickupOnlyShop = shopData.deliveryType === 'pickup_only';
                        }
                    }
                } catch (error) {
                    console.error('Error checking shop delivery type:', error);
                    // Continue with delivery as default
                }

                // âœ… CREATE MAIN ORDER IN FIREBASE
                const orderData = {
                    id: orderId,
                    customerId: currentUser.uid || '',
                    customerEmail: currentUser.email || '',
                    customerName: currentUser.displayName || currentUser.email?.split('@')[0] || 'Customer',
                    deliveryType: hasPickupOnlyShop ? 'pickup' : 'delivery',
                    items: cart.map(item => ({
                        id: item.id || '',
                        name: item.name || '',
                        price: item.price || 0,
                        quantity: item.quantity || 1,
                        shopId: item.shopId || '',
                        shopName: item.shopName || '',
                        image: item.image || 'https://images.unsplash.com/photo-1563636619-e9143da7973b?w=400&h=300&fit=crop'
                    })),
                    total: newOrder.total || 0,
                    subtotal: newOrder.subtotal || newOrder.total || 0,
                    discount: newOrder.discount || 0,
                    deliveryCharge: newOrder.deliveryCharge || 40,
                    status: 'pending',
                    address: newOrder.address || {},
                    phone: newOrder.phone || '',
                    paymentMethod: newOrder.paymentMethod || 'cod',
                    utrNumber: (newOrder.paymentMethod === 'qr' && newOrder.utrNumber) || null,
                    couponCode: newOrder.couponCode || null, // âœ… CAN BE NULL
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    orderId: orderId
                };

                // Remove undefined/null fields
                Object.keys(orderData).forEach(key => {
                    if (orderData[key] === undefined || orderData[key] === null) {
                        delete orderData[key];
                    }
                });

                console.log('ðŸ“¤ Saving main order to Firestore:', orderData);

                // âœ… SAVE MAIN ORDER
                await db.collection('orders').doc(orderId).set(orderData);
                console.log('âœ… Main order saved:', orderId);

                // âœ… CREATE ORDER ITEMS FOR EACH SHOP
                let orderItemsCount = 0;
                
                for (const item of cart) {
                    if (!item.id || !item.shopId) {
                        console.warn('âš ï¸ Skipping invalid cart item:', item);
                        continue;
                    }
                    
                    try {
                        // Create order item for shopkeeper
                        const orderItemData = {
                            orderId: orderId,
                            productId: item.id || '',
                            productName: item.name || '',
                            shopId: item.shopId || '',
                            shopName: item.shopName || '',
                            quantity: item.quantity || 1,
                            price: item.price || 0,
                            totalAmount: (item.price || 0) * (item.quantity || 1),
                            status: 'pending',
                            customerId: currentUser.uid || '',
                            customerEmail: currentUser.email || '',
                            customerName: currentUser.displayName || currentUser.email?.split('@')[0] || 'Customer',
                            paymentMethod: newOrder.paymentMethod || 'cod',
                            address: newOrder.address || {},
                            phone: newOrder.phone || '',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        };

                        // Remove undefined fields
                        Object.keys(orderItemData).forEach(key => {
                            if (orderItemData[key] === undefined || orderItemData[key] === null) {
                                delete orderItemData[key];
                            }
                        });

                        await db.collection('orderItems').add(orderItemData);
                        orderItemsCount++;
                        console.log('âœ… Order item created for shop:', item.shopId);

                        // Update product stock
                        if (item.id) {
                            await db.collection('products').doc(item.id).update({
                                stock: firebase.firestore.FieldValue.increment(-(item.quantity || 1)),
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            console.log('âœ… Stock updated for product:', item.id);
                        }
                        
                    } catch (itemError) {
                        console.error('âŒ Error creating order item:', itemError);
                        // Continue with other items
                    }
                }

                console.log(`âœ… Created ${orderItemsCount} order items`);

                // Clear cart
                cart = [];
                localStorage.setItem('dukaan_cart', JSON.stringify(cart));
                updateCartUI();
                
                // Reset checkout state
                appliedCoupon = null;
                selectedAddress = null;
                
                const couponCodeInput = document.getElementById('couponCode');
                const couponMessage = document.getElementById('couponMessage');
                const checkoutPhone = document.getElementById('checkoutPhone');
                const utrNumber = document.getElementById('utrNumber');
                
                if (couponCodeInput) couponCodeInput.value = '';
                if (couponMessage) couponMessage.textContent = '';
                if (checkoutPhone) checkoutPhone.value = '';
                if (utrNumber) utrNumber.value = '';
                
                closeBottomSheet();
                showToast('ðŸŽ‰ Order placed successfully! Shopkeeper will process your order.', 'success');
                
                // âœ… UPDATE ORDER BADGES
                updateOrderBadges();
                
                // Show order tracking
                setTimeout(() => {
                    showOrderTracking(orderId);
                }, 1500);

            } catch (error) {
                console.error('âŒ Error placing order:', error);
                console.error('âŒ Error stack:', error.stack);
                showToast('Error placing order: ' + error.message, 'error');
            }
        }
        
        // Separate function for actual order placement after confirmation
        function completeOrderPlacement(newOrder) {
            orders.push(newOrder);
            localStorage.setItem('dukaan_orders', JSON.stringify(orders));
            
            // Save to Firebase if user is logged in
            if (currentUser) {
                db.collection('users').doc(currentUser.uid).collection('orders').add(newOrder).catch(error => {
                    console.error('Error saving order to Firebase:', error);
                });
            }
            
            // Clear cart
            cart = [];
            localStorage.setItem('dukaan_cart', JSON.stringify(cart));
            updateCartUI();
            
            // Reset checkout state
            appliedCoupon = null;
            selectedAddress = null;
            selectedPaymentMethod = null;
            couponCodeInput.value = '';
            couponMessage.textContent = '';
            checkoutPhone.value = '';
            utrNumber.value = '';
            
            closeBottomSheet();
            showToast('ðŸŽ‰ Order placed successfully!');
            
            // âœ… UPDATE ORDER BADGES
            updateOrderBadges();
            
            // Show order tracking
            setTimeout(() => {
                showOrderTracking(newOrder.id);
            }, 1500);
        }

        // Confirmation Modal System
        function showConfirmationModal(title, message, onConfirm) {
            document.getElementById('confirmationTitle').textContent = title;
            document.getElementById('confirmationMessage').textContent = message;
            
            const confirmButton = document.getElementById('confirmAction');
            const modalElement = document.getElementById('confirmationModal');
            const modal = new bootstrap.Modal(modalElement);
            
            // Set up one-time event listener
            const handleConfirm = () => {
                onConfirm();
                modal.hide();
                confirmButton.removeEventListener('click', handleConfirm);
            };
            
            confirmButton.addEventListener('click', handleConfirm);
            
            // Clean up when modal is hidden
            modalElement.addEventListener('hidden.bs.modal', () => {
                confirmButton.removeEventListener('click', handleConfirm);
            });
            
            modal.show();
        }

        // Order Management
        function renderOrders() {
            if (!ordersList) return;
            
            ordersList.innerHTML = '';
            
            if (orders.length === 0) {
                noOrders.style.display = 'block';
                return;
            }
            
            noOrders.style.display = 'none';
            
            // Sort orders by date (newest first)
            const sortedOrders = [...orders].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedOrders.forEach(order => {
                const orderCard = document.createElement('div');
                orderCard.className = 'order-card';
                
                const statusClass = `status-${order.status}`;
                const statusText = getStatusText(order.status);
                
                orderCard.innerHTML = `
                    <div class="order-header">
                        <div class="order-id">Order #${order.id.slice(-6)}</div>
                        <div class="order-status ${statusClass}">${statusText}</div>
                    </div>
                    <div class="order-items">
                        ${order.items.map(item => `
                            <div class="order-item">
                                <span>${item.name} Ã— ${item.quantity}</span>
                                <span>â‚¹${item.price * item.quantity}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="order-footer">
                        <div class="order-total">â‚¹${order.total}</div>
                        <div class="order-actions">
                            <button class="btn-reorder" onclick="reorder('${order.id}')">
                                <i class="fas fa-redo"></i> Reorder
                            </button>
                            <button class="btn-outline" onclick="showOrderTracking('${order.id}')">
                                <i class="fas fa-map-marker-alt"></i> Track
                            </button>
                            ${order.status === 'confirmed' || order.status === 'pending' ? `
                                <button class="btn-outline" onclick="modifyOrder('${order.id}')">
                                    <i class="fas fa-edit"></i> Modify
                                </button>
                            ` : ''}
                            <button class="btn-outline" onclick="shareOrder('${order.id}')">
                                <i class="fas fa-share"></i> Share
                            </button>
                        </div>
                    </div>
                    ${order.deliveryAgent ? `
                        <div class="delivery-agent-info mt-3 p-3 bg-light rounded">
                            <h6><i class="fas fa-motorcycle"></i> Delivery Agent</h6>
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${order.deliveryAgent.name}</strong>
                                    <div class="text-muted small">
                                        ${order.deliveryAgent.vehicle} â€¢ â­ ${order.deliveryAgent.rating}
                                    </div>
                                </div>
                                <button class="btn-primary btn-sm" onclick="contactDeliveryAgent('${order.id}')">
                                    <i class="fas fa-phone"></i> Call
                                </button>
                            </div>
                        </div>
                    ` : ''}
                `;
                ordersList.appendChild(orderCard);
            });
        }
        
        // âœ… UPDATED: Get status text for all statuses
        function getStatusText(status) {
            const statusMap = {
                'pending': 'Pending',
                'confirmed': 'Confirmed',
                'preparing': 'Preparing',
                'packed': 'Packed',
                'dispatched': 'Dispatched',
                'ready_for_pickup': 'Ready for Pickup',
                'out_for_delivery': 'Out for Delivery',
                'delivered': 'Delivered',
                'cancelled': 'Cancelled'
            };
            return statusMap[status] || status.charAt(0).toUpperCase() + status.slice(1);
        }

        /* âœ… ADD PICKUP LOCATION FUNCTION - ADD THIS FUNCTION */
        function showPickupLocation(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            // Get shop address from order items
            const shopAddress = order.items && order.items[0] ? 
                (order.items[0].shopAddress || 'Shop address not available') : 
                'Shop address not available';
            
            const shopName = order.items && order.items[0] ? 
                (order.items[0].shopName || 'Shop') : 'Shop';
            
            alert(`ðŸ“ ${shopName} Pickup Location:\n\n${shopAddress}\n\nPlease collect your order during shop hours.`);
        }

        function reorder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            order.items.forEach(item => {
                const existingItem = cart.find(cartItem => cartItem.id === item.id);
                if (existingItem) {
                    existingItem.quantity += item.quantity;
                } else {
                    cart.push({...item});
                }
            });
            
            localStorage.setItem('dukaan_cart', JSON.stringify(cart));
            updateCartUI();
            showToast('Items added to cart!');
            openBottomSheet();
        }

        // âœ… FIXED: IMPROVED ORDER TRACKING TIMELINE WITH ALL STEPS
function updateTrackingTimeline(order) {
    console.log('ðŸ”„ Updating tracking timeline for order:', order.id, 'Status:', order.status);
    
    const tracking = order.tracking || {
        confirmed: order.date || new Date().toISOString(),
        preparing: null,
        packed: null,
        dispatched: null,
        readyForPickup: null,
        outForDelivery: null,
        delivered: null
    };
    
    // Get status sequence based on delivery type
    const statusSequence = getStatusSequence(order.deliveryType);
    const currentStatus = order.status;
    const currentIndex = statusSequence.findIndex(s => s.id === currentStatus);
    
    console.log('Status Sequence:', statusSequence);
    console.log('Current Status:', currentStatus, 'Index:', currentIndex);
    
    // Reset all steps
    ['stepConfirmed', 'stepPreparing', 'stepPacked', 'stepDispatched', 'stepFinal'].forEach(stepId => {
        const element = document.getElementById(stepId);
        if (element) element.className = 'step-icon';
    });
    
    ['timeConfirmed', 'timePreparing', 'timePacked', 'timeDispatched', 'timeFinal'].forEach(timeId => {
        const element = document.getElementById(timeId);
        if (element) element.textContent = '--';
    });
    
    const finalIcon = document.getElementById('finalIcon');
    const finalLabel = document.getElementById('finalLabel');
    const stepFinal = document.getElementById('stepFinal');
    const timeFinal = document.getElementById('timeFinal');
    
    // Mark completed steps
    for (let i = 0; i <= currentIndex; i++) {
        const step = statusSequence[i];
        if (!step) continue;
        
        // Mark step as completed
        switch(step.id) {
            case 'pending':
                // Already handled by confirmed
                break;
            case 'confirmed':
                document.getElementById('stepConfirmed').className = 'step-icon completed';
                document.getElementById('timeConfirmed').textContent = tracking.confirmed ? 
                    new Date(tracking.confirmed).toLocaleString() : 'Recently';
                break;
            case 'preparing':
                document.getElementById('stepPreparing').className = 'step-icon completed';
                document.getElementById('timePreparing').textContent = tracking.preparing ? 
                    new Date(tracking.preparing).toLocaleString() : 'Recently';
                break;
            case 'packed':
                document.getElementById('stepPacked').className = 'step-icon completed';
                document.getElementById('timePacked').textContent = tracking.packed ? 
                    new Date(tracking.packed).toLocaleString() : 'Recently';
                break;
            case 'dispatched':
                document.getElementById('stepDispatched').className = 'step-icon completed';
                document.getElementById('timeDispatched').textContent = tracking.dispatched ? 
                    new Date(tracking.dispatched).toLocaleString() : 'Recently';
                break;
            case 'ready_for_pickup':
                finalIcon.className = 'fas fa-box-open';
                finalLabel.textContent = 'Ready for Pickup';
                stepFinal.className = 'step-icon completed';
                timeFinal.textContent = tracking.readyForPickup ? 
                    new Date(tracking.readyForPickup).toLocaleString() : 'Recently';
                break;
            case 'out_for_delivery':
                finalIcon.className = 'fas fa-motorcycle';
                finalLabel.textContent = 'Out for Delivery';
                stepFinal.className = 'step-icon completed';
                timeFinal.textContent = tracking.outForDelivery ? 
                    new Date(tracking.outForDelivery).toLocaleString() : 'Recently';
                break;
            case 'delivered':
                finalIcon.className = 'fas fa-home';
                finalLabel.textContent = 'Delivered';
                stepFinal.className = 'step-icon completed';
                timeFinal.textContent = tracking.delivered ? 
                    new Date(tracking.delivered).toLocaleString() : 'Recently';
                break;
            case 'picked_up':
                finalIcon.className = 'fas fa-store';
                finalLabel.textContent = 'Picked Up';
                stepFinal.className = 'step-icon completed';
                timeFinal.textContent = tracking.delivered ? 
                    new Date(tracking.delivered).toLocaleString() : 'Recently';
                break;
        }
    }
    
    // Mark current step as active (if not already delivered/picked up)
    if (currentIndex >= 0 && currentIndex < statusSequence.length) {
        const currentStep = statusSequence[currentIndex];
        
        if (currentStep.id === 'out_for_delivery') {
            finalIcon.className = 'fas fa-motorcycle';
            finalLabel.textContent = 'Out for Delivery';
            stepFinal.className = 'step-icon active';
            timeFinal.textContent = tracking.outForDelivery ? 
                new Date(tracking.outForDelivery).toLocaleString() : 'In progress';
        } else if (currentStep.id === 'ready_for_pickup') {
            finalIcon.className = 'fas fa-box-open';
            finalLabel.textContent = 'Ready for Pickup';
            stepFinal.className = 'step-icon active';
            timeFinal.textContent = tracking.readyForPickup ? 
                new Date(tracking.readyForPickup).toLocaleString() : 'In progress';
        }
    }
    
    // Update ETA
    updateETACountdown(order);
}

// âœ… NEW FUNCTION: Get correct status sequence based on delivery type
function getStatusSequence(deliveryType) {
    if (deliveryType === 'pickup') {
        return [
            { id: 'pending', label: 'Order Placed' },
            { id: 'confirmed', label: 'Confirmed' },
            { id: 'preparing', label: 'Preparing' },
            { id: 'ready_for_pickup', label: 'Ready for Pickup' },
            { id: 'picked_up', label: 'Picked Up' }
        ];
    } else {
        return [
            { id: 'pending', label: 'Order Placed' },
            { id: 'confirmed', label: 'Confirmed' },
            { id: 'preparing', label: 'Preparing' },
            { id: 'dispatched', label: 'Dispatched' },
            { id: 'out_for_delivery', label: 'Out for Delivery' },
            { id: 'delivered', label: 'Delivered' }
        ];
    }
}
// âœ… UPDATE: Also update the updateETACountdown() function
function updateETACountdown(order) {
    const etaElement = document.getElementById('etaCountdown');
    if (!etaElement) return;
    
    let etaMinutes = 0;
    let statusText = '';
    
    // GET CORRECT STATUS SEQUENCE
    const statusSequence = getStatusSequence(order.deliveryType);
    const currentStatus = order.status;
    
    switch(currentStatus) {
        case 'pending':
            etaMinutes = 45;
            statusText = 'Order will be confirmed soon';
            break;
        case 'confirmed':
            etaMinutes = 40;
            statusText = 'Preparing will start soon';
            break;
        case 'preparing':
            etaMinutes = 30;
            statusText = 'Your order is being prepared';
            break;
        case 'packed':
            etaMinutes = 25;
            statusText = 'Order packed, ready for dispatch';
            break;
        case 'dispatched':
            if (order.deliveryType === 'pickup') {
                etaMinutes = 15;
                statusText = 'Will be ready for pickup soon';
            } else {
                etaMinutes = 20;
                statusText = 'Out for delivery soon';
            }
            break;
        case 'ready_for_pickup':
            etaMinutes = 0;
            statusText = 'Ready for pickup';
            break;
        case 'out_for_delivery':
            etaMinutes = 15;
            statusText = 'On the way to you';
            break;
        case 'delivered':
        case 'picked_up':
            etaMinutes = 0;
            statusText = order.deliveryType === 'pickup' ? 'Picked up successfully!' : 'Delivered successfully!';
            break;
        default:
            etaMinutes = 0;
            statusText = getStatusText(currentStatus);
    }
    
    if (etaMinutes > 0) {
        const deliveryTime = new Date(new Date().getTime() + etaMinutes * 60000);
        etaElement.innerHTML = `
            <div>${statusText}</div>
            <div class="text-primary fw-bold">ETA: ${deliveryTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} (${etaMinutes} min)</div>
        `;
    } else {
        etaElement.innerHTML = `<div class="text-success fw-bold">${statusText}</div>`;
    }
}

        function shareOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            const orderDetails = `
Order #${orderId.slice(-6)}
Status: ${getStatusText(order.status)}
Total: â‚¹${order.total}
Items: ${order.items.map(item => `${item.name} (Qty: ${item.quantity})`).join(', ')}
Placed on: ${new Date(order.date).toLocaleDateString()}

Track your order: ${window.location.href}
    `.trim();
            
            // Check if Web Share API is available
            if (navigator.share) {
                navigator.share({
                    title: `My Dukaan Order #${orderId.slice(-6)}`,
                    text: orderDetails,
                    url: window.location.href
                }).then(() => {
                    showToast('Order shared successfully!');
                }).catch(error => {
                    console.log('Error sharing:', error);
                    fallbackShare(orderDetails);
                });
            } else {
                fallbackShare(orderDetails);
            }
        }

        function fallbackShare(orderDetails) {
            // Copy to clipboard as fallback
            navigator.clipboard.writeText(orderDetails).then(() => {
                showToast('Order details copied to clipboard!');
            }).catch(() => {
                // Final fallback - show in alert
                alert('Order Details:\n\n' + orderDetails);
            });
        }

        function modifyOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            if (order.status !== 'confirmed' && order.status !== 'pending') {
                showToast('Order cannot be modified after preparation has started.');
                return;
            }
            
            showConfirmationModal(
                'Modify Order',
                'You will be able to add or remove items from this order. The order total will be updated accordingly.',
                () => {
                    // Add order items to cart for modification
                    order.items.forEach(item => {
                        const existingItem = cart.find(cartItem => cartItem.id === item.id);
                        if (existingItem) {
                            existingItem.quantity += item.quantity;
                        } else {
                            cart.push({...item});
                        }
                    });
                    
                    localStorage.setItem('dukaan_cart', JSON.stringify(cart));
                    updateCartUI();
                    
                    // Cancel the original order
                    cancelOrder(orderId);
                    
                    showToast('Order items added to cart. Please review and place your modified order.');
                    openBottomSheet();
                }
            );
        }

        function contactDeliveryAgent(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order || !order.deliveryAgent) {
                showToast('Delivery agent not assigned yet.');
                return;
            }
            
            const agent = order.deliveryAgent;
            
            showConfirmationModal(
                'Contact Delivery Agent',
                `Would you like to call ${agent.name}?`,
                () => {
                    window.location.href = `tel:${agent.phone}`;
                }
            );
        }

        // User Profile Functions - PHASE 1
        function loadUserProfile() {
            if (!currentUser) return;
            
            // Update profile information
            document.getElementById('profileUserName').textContent = currentUser.name;
            document.getElementById('profileUserEmail').textContent = currentUser.email;
            document.getElementById('avatarText').textContent = currentUser.name.charAt(0).toUpperCase();
            
            // Load user preferences
            loadUserPreferences();
            loadLoginHistory();
        }

        function loadUserPreferences() {
            const preferences = JSON.parse(localStorage.getItem('dukaan_preferences')) || {
                pushNotifications: true,
                emailNotifications: true,
                smsNotifications: false,
                language: 'english'
            };
            
            document.getElementById('pushNotifications').checked = preferences.pushNotifications;
            document.getElementById('emailNotifications').checked = preferences.emailNotifications;
            document.getElementById('smsNotifications').checked = preferences.smsNotifications;
        }

        function loadLoginHistory() {
            const loginHistory = JSON.parse(localStorage.getItem('dukaan_login_history')) || [];
            const historyList = document.getElementById('loginHistoryList');
            
            if (loginHistory.length === 0) {
                // Add current session as first history
                const currentSession = {
                    device: 'Current Device',
                    location: 'Current Location',
                    time: new Date().toISOString(),
                    active: true
                };
                loginHistory.unshift(currentSession);
                localStorage.setItem('dukaan_login_history', JSON.stringify(loginHistory));
            }
            
            renderLoginHistory(loginHistory);
        }

        function renderLoginHistory(history) {
            const historyList = document.getElementById('loginHistoryList');
            historyList.innerHTML = '';
            
            history.forEach((session, index) => {
                const sessionElement = document.createElement('div');
                sessionElement.className = `login-session ${session.active ? 'session-active' : 'session-inactive'}`;
                sessionElement.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <strong>${session.device}</strong>
                            <div style="font-size: 0.9rem; color: var(--text-light); margin-top: 4px;">
                                ${session.location}
                            </div>
                            <div style="font-size: 0.8rem; color: var(--text-light); margin-top: 2px;">
                                ${new Date(session.time).toLocaleString()}
                            </div>
                        </div>
                        ${session.active ? '<div class="security-badge">Active</div>' : ''}
                    </div>
                `;
                historyList.appendChild(sessionElement);
            });
        }

        function editPersonalDetails() {
            const user = firebase.auth().currentUser;
            const currentName = user.displayName || "";
            const currentEmail = user.email || "";
            
            const modalHTML = `
            <div class="modal-overlay active" id="editProfileModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Edit Profile</h3>
                        <button class="modal-close" onclick="closeEditProfileModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="editUserName" value="${currentName}" placeholder="Enter your full name">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email Address</label>
                            <input type="email" class="form-control" id="editUserEmail" value="${currentEmail}" readonly style="background: #f8f9fa;">
                            <small class="text-muted">Email cannot be changed</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="editUserPhone" placeholder="Enter phone number">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-outline" onclick="closeEditProfileModal()">Cancel</button>
                        <button type="button" class="btn-primary" onclick="processProfileUpdate()">Save Changes</button>
                    </div>
                </div>
            </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeEditProfileModal() {
            const modal = document.getElementById('editProfileModal');
            if (modal) modal.remove();
        }

        function processProfileUpdate() {
            const newName = document.getElementById('editUserName').value.trim();
            
            if (!newName) {
                showToast("Name cannot be empty", 'error');
                return;
            }
            
            const user = firebase.auth().currentUser;
            user.updateProfile({
                displayName: newName
            }).then(() => {
                showToast("Profile updated successfully!", 'success');
                
                // Update UI
                const userNameElements = document.querySelectorAll('.user-name, #userName');
                userNameElements.forEach(element => {
                    element.textContent = newName;
                });
                
                closeEditProfileModal();
            }).catch(error => {
                console.error("Profile update error:", error);
                showToast("Error updating profile: " + error.message, 'error');
            });
        }

        function changeProfilePicture() {
            document.getElementById('avatarUpload').click();
        }

        function changePassword() {
            // Create a custom modal for password change
            const modalHTML = `
            <div class="modal-overlay active" id="passwordModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Change Password</h3>
                        <button class="modal-close" onclick="closePasswordModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Current Password</label>
                            <input type="password" class="form-control" id="currentPassword" placeholder="Enter your current password" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">New Password</label>
                            <input type="password" class="form-control" id="newPassword" placeholder="Enter new password (min. 6 characters)" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Confirm New Password</label>
                            <input type="password" class="form-control" id="confirmPassword" placeholder="Confirm your new password" required>
                        </div>
                        <div class="alert alert-info">
                            <small><i class="fas fa-info-circle"></i> You'll need to re-enter your current password for security</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-outline" onclick="closePasswordModal()">Cancel</button>
                        <button type="button" class="btn-primary" onclick="processPasswordChange()">Update Password</button>
                    </div>
                </div>
            </div>
            `;
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closePasswordModal() {
            const modal = document.getElementById('passwordModal');
            if (modal) {
                modal.remove();
            }
        }

        async function processPasswordChange() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Validation
            if (!currentPassword) {
                showToast("Please enter your current password", 'error');
                return;
            }
            
            if (!newPassword || newPassword.length < 6) {
                showToast("New password must be at least 6 characters", 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showToast("New passwords don't match", 'error');
                return;
            }
            
            if (currentPassword === newPassword) {
                showToast("New password cannot be same as current password", 'error');
                return;
            }
            
            const user = firebase.auth().currentUser;
            const email = user.email;
            
            try {
                showToast("Verifying your current password...", 'info');
                
                // Re-authenticate user first
                const credential = firebase.auth.EmailAuthProvider.credential(email, currentPassword);
                await user.reauthenticateWithCredential(credential);
                
                // Now update password
                await user.updatePassword(newPassword);
                
                showToast("Password updated successfully!", 'success');
                closePasswordModal();
                
            } catch (error) {
                console.error("Password change error:", error);
                
                if (error.code === 'auth/wrong-password') {
                    showToast("Current password is incorrect", 'error');
                } else if (error.code === 'auth/requires-recent-login') {
                    showToast("Session expired. Please sign in again", 'error');
                } else {
                    showToast("Error: " + error.message, 'error');
                }
            }
        }

        function showLoginHistory() {
            document.getElementById('loginHistorySection').style.display = 'block';
            // Scroll to login history section
            setTimeout(() => {
                document.getElementById('loginHistorySection').scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }

        function changeLanguage() {
            showConfirmationModal(
                'Change Language',
                'You will be able to select your preferred language. This feature is coming in the next update!',
                () => {
                    showToast('Language selection feature coming soon!');
                }
            );
        }

        // Handle profile picture upload
        document.getElementById('avatarUpload').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const avatar = document.getElementById('profileAvatar');
                    const avatarText = document.getElementById('avatarText');
                    
                    avatarText.style.display = 'none';
                    avatar.style.backgroundImage = `url(${e.target.result})`;
                    avatar.style.backgroundSize = 'cover';
                    avatar.style.backgroundPosition = 'center';
                    
                    // Save to localStorage
                    localStorage.setItem('dukaan_profile_picture', e.target.result);
                    showToast('Profile picture updated successfully!');
                };
                reader.readAsDataURL(file);
            }
        });

        // Handle preference changes
        document.getElementById('pushNotifications').addEventListener('change', function() {
            savePreference('pushNotifications', this.checked);
        });

        document.getElementById('emailNotifications').addEventListener('change', function() {
            savePreference('emailNotifications', this.checked);
        });

        document.getElementById('smsNotifications').addEventListener('change', function() {
            savePreference('smsNotifications', this.checked);
        });

        function savePreference(key, value) {
            const preferences = JSON.parse(localStorage.getItem('dukaan_preferences')) || {};
            preferences[key] = value;
            localStorage.setItem('dukaan_preferences', JSON.stringify(preferences));
            showToast('Preferences updated!');
        }

        // Load saved profile picture on app start
        function loadProfilePicture() {
            const savedPicture = localStorage.getItem('dukaan_profile_picture');
            if (savedPicture) {
                const avatar = document.getElementById('profileAvatar');
                const avatarText = document.getElementById('avatarText');
                
                avatarText.style.display = 'none';
                avatar.style.backgroundImage = `url(${savedPicture})`;
                avatar.style.backgroundSize = 'cover';
                avatar.style.backgroundPosition = 'center';
            }
        }

        // Notification Core Functions
        function loadNotificationsPage() {
            renderNotificationsList();
            updateNotificationPreferencesUI();
        }

        function createNotification(title, message, type = 'info', action = null) {
            const notification = {
                id: generateId(),
                title,
                message, 
                type,
                action,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            notifications.unshift(notification);
            localStorage.setItem('dukaan_notifications', JSON.stringify(notifications));
            updateNotificationBadge();
            
            // Show browser notification if enabled
            if (notificationPreferences.pushEnabled && 'Notification' in window) {
                new Notification(title, { body: message, icon: '/favicon.ico' });
            }
        }

        function renderNotificationsList() {
            const list = document.getElementById('notificationsList');
            const empty = document.getElementById('noNotifications');
            
            if (notifications.length === 0) {
                list.innerHTML = '';
                empty.style.display = 'block';
                return;
            }
            
            empty.style.display = 'none';
            list.innerHTML = notifications.map(notif => `
                <div class="notification-item ${notif.read ? '' : 'notification-unread'}" 
                     onclick="markNotificationRead('${notif.id}')">
                    <div style="flex: 1;">
                        <strong>${notif.title}</strong>
                        <p style="margin: 5px 0; color: var(--text-light);">${notif.message}</p>
                        <small>${new Date(notif.timestamp).toLocaleString()}</small>
                    </div>
                </div>
            `).join('');
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notificationCount');
            const unreadCount = notifications.filter(n => !n.read).length;
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
        }

        function updateNotificationPreference(key, value) {
            notificationPreferences[key] = value;
            localStorage.setItem('dukaan_notification_prefs', JSON.stringify(notificationPreferences));
        }

        function togglePushNotifications() {
            if (!('Notification' in window)) {
                showToast('Browser does not support notifications');
                document.getElementById('pushNotificationsToggle').checked = false;
                return;
            }
            
            if (Notification.permission === 'granted') {
                notificationPreferences.pushEnabled = !notificationPreferences.pushEnabled;
            } else {
                Notification.requestPermission().then(permission => {
                    notificationPreferences.pushEnabled = permission === 'granted';
                    document.getElementById('pushNotificationsToggle').checked = permission === 'granted';
                });
            }
            
            localStorage.setItem('dukaan_notification_prefs', JSON.stringify(notificationPreferences));
        }

        function updateNotificationPreferencesUI() {
            document.getElementById('orderUpdatesToggle').checked = notificationPreferences.orderUpdates;
            document.getElementById('priceAlertsToggle').checked = notificationPreferences.priceAlerts;
            document.getElementById('promotionsToggle').checked = notificationPreferences.promotions;
            document.getElementById('pushNotificationsToggle').checked = notificationPreferences.pushEnabled;
        }

        // Social Sharing Features - PHASE 5.2
        function showComingSoon(featureName) {
            showToast(`${featureName} - Coming Soon! ðŸš€`);
        }

        // Share Product Functionality
        function shareProduct(productId) {
            const product = PRODUCTS.find(p => p.id === productId);
            if (!product) return;
            
            const shareText = `Check out ${product.name} on Dukaan - ${product.price} (${Math.round(((product.mrp - product.price) / product.mrp) * 100)}% OFF)!`;
            const shareUrl = window.location.href.split('?')[0] + `?product=${productId}`;
            
            if (navigator.share) {
                navigator.share({
                    title: product.name,
                    text: shareText,
                    url: shareUrl
                }).then(() => {
                    showToast('Product shared successfully!');
                }).catch(() => {
                    fallbackShareProduct(shareText, shareUrl);
                });
            } else {
                fallbackShareProduct(shareText, shareUrl);
            }
        }

        function fallbackShareProduct(text, url) {
            const shareData = `${text}\n\n${url}`;
            navigator.clipboard.writeText(shareData).then(() => {
                showToast('Product link copied to clipboard!');
            }).catch(() => {
                alert(`Share this product:\n\n${shareData}`);
            });
        }

        // Hamburger Menu Functions
        function openHamburgerMenu() {
            document.getElementById('hamburgerMenu').classList.add('open');
        }

        function closeHamburgerMenu() {
            document.getElementById('hamburgerMenu').classList.remove('open');
        }

        // Utility Functions
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        }

        function showToast(message) {
            // Create toast element
            const toast = document.createElement('div');
            toast.className = 'position-fixed top-0 start-50 translate-middle-x mt-3';
            toast.style.zIndex = '9999';
            toast.innerHTML = `
                <div class="toast show" role="alert">
                    <div class="toast-body d-flex justify-content-between align-items-center">
                        <span>${message}</span>
                        <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // SOCIAL SHARE FUNCTIONALITY - PHASE 5.2
        function shareProduct(productId) {
            if (!currentProductDetail) {
                showToast('Please open a product to share');
                return;
            }
            
            const product = currentProductDetail;
            const discount = Math.round(((product.mrp - product.price) / product.mrp) * 100);
            
            const shareText = `Check out ${product.name} on Dukaan - â‚¹${product.price} (${discount}% OFF)! ðŸ›ï¸`;
            const shareUrl = window.location.href.split('?')[0] + `?product=${productId}`;
            
            // Check if Web Share API is supported
            if (navigator.share) {
                navigator.share({
                    title: product.name + ' - Dukaan',
                    text: shareText,
                    url: shareUrl
                }).then(() => {
                    showToast('Product shared successfully! ðŸ“¤');
                }).catch((error) => {
                    console.log('Share failed:', error);
                    fallbackShareProduct(shareText, shareUrl);
                });
            } else {
                fallbackShareProduct(shareText, shareUrl);
            }
        }

        // Fallback for browsers that don't support Web Share API
        function fallbackShareProduct(text, url) {
            const shareData = `${text}\n\n${url}`;
            
            // Try to copy to clipboard first
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(shareData).then(() => {
                    showToast('Product link copied to clipboard! ðŸ“‹');
                }).catch(() => {
                    // If clipboard fails, show share options
                    showShareOptions(text, url);
                });
            } else {
                showShareOptions(text, url);
            }
        }

        // Show custom share options modal
        function showShareOptions(text, url) {
            const shareModal = `
                <div class="share-options-modal">
                    <h4>Share Product</h4>
                    <p>${text}</p>
                    <div class="share-buttons">
                        <button onclick="shareToWhatsApp('${text}', '${url}')" class="btn-share whatsapp">
                            <i class="fab fa-whatsapp"></i> WhatsApp
                        </button>
                        <button onclick="copyToClipboard('${text} ${url}')" class="btn-share copy">
                            <i class="fas fa-copy"></i> Copy Link
                        </button>
                    </div>
                </div>
            `;
            
            // You can implement a proper modal here
            // For now, just copy to clipboard
            copyToClipboard(text + ' ' + url);
        }

        // Share to WhatsApp
        function shareToWhatsApp(text, url) {
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(text + ' ' + url)}`;
            window.open(whatsappUrl, '_blank');
        }

        // Copy to clipboard utility
        function copyToClipboard(text) {
            const tempInput = document.createElement('input');
            tempInput.value = text;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            showToast('Link copied to clipboard! ðŸ“‹');
        }

        // âœ… NEW: Update UI for auth state
        function updateUIForAuth(user) {
            if (!user) {
                // Clear user data
                orders = [];
                cart = [];
                wishlist = [];
                addresses = [];
                localStorage.removeItem('dukaan_orders');
                localStorage.removeItem('dukaan_cart');
                localStorage.removeItem('dukaan_wishlist');
                localStorage.removeItem('dukaan_addresses');
                
                // Update UI
                updateCartUI();
                updateWishlistUI();
                updateOrderBadges();
                if (typeof renderOrders === 'function') {
                    renderOrders();
                }
            }
        }

        // App load hone par products load karo
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
            loadProductsFromFirebase();
        });
    </script>
</body>
</html>
